<!DOCTYPE html>
<!-- MOBILE-COMPLETE-V8.4-20251113-FAILOVER - 9-Node API Failover + 5-Tag System + Custom Tags UI -->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="description" content="Archive web content with cryptographic verification - 100% client-side processing">
    <meta name="theme-color" content="#1e3c72">
    <title>ArcHive</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    
    <!-- PWA Support -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <!-- Cache Control -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    
    <style>
        /* ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
         * MOBILE-FIRST RESPONSIVE STYLES
         * Base: Mobile (320px+)
         * Breakpoints: Tablet (768px+), Desktop (1024px+)
         * ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ */
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        :root {
            /* Colors */
            --primary-gradient: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            --success-gradient: linear-gradient(135deg, #10b981 0%, #059669 100%);
            --danger-gradient: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            --surface-bg: rgba(255, 255, 255, 0.95);
            --card-bg: #ffffff;
            --text-primary: #0f172a;
            --text-secondary: #334155;
            --text-tertiary: #475569;
            --text-inverse: #f8fafc;
            --border-color: #d0d7e2;
            
            /* Spacing */
            --spacing-xs: 0.5rem;
            --spacing-sm: 1rem;
            --spacing-md: 1.5rem;
            --spacing-lg: 2rem;
            --spacing-xl: 3rem;
            
            /* Touch targets */
            --touch-target: 44px;
            
            /* Typography - Responsive with clamp() */
            --text-base: clamp(1rem, 2.5vw, 1.125rem);
            --text-sm: clamp(0.875rem, 2vw, 1rem);
            --text-xs: clamp(0.75rem, 1.8vw, 0.875rem);
            --text-lg: clamp(1.125rem, 3vw, 1.25rem);
            --text-xl: clamp(1.25rem, 3.5vw, 1.5rem);
            --text-2xl: clamp(1.5rem, 4vw, 2rem);
            --text-3xl: clamp(2rem, 5vw, 2.5rem);
        }
        
        html {
            font-size: 16px;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 25%, #c31432 75%, #240b36 100%);
            background-attachment: fixed;
            min-height: 100vh;
            color: var(--text-primary);
            font-size: var(--text-base);
            line-height: 1.6;
            padding: var(--spacing-sm);
            padding-bottom: calc(var(--spacing-xl) + env(safe-area-inset-bottom));
        }
        
        @media (min-width: 768px) {
            body {
                padding: var(--spacing-lg);
            }
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: var(--surface-bg);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }
        
        /* Header */
        .header {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #334155 100%);
            color: white;
            padding: var(--spacing-lg) var(--spacing-md);
            text-align: center;
        }
        
        .header h1 {
            font-size: var(--text-3xl);
            margin-bottom: var(--spacing-xs);
            font-weight: 800;
        }
        
        .tagline {
            font-size: var(--text-lg);
            font-weight: 600;
            color: #e8eaed;
            margin-bottom: var(--spacing-xs);
        }
        
        .subtitle {
            font-size: var(--text-sm);
            color: #94a3b8;
        }
        
        /* Content Area */
        .content {
            padding: var(--spacing-md);
        }
        
        @media (min-width: 768px) {
            .content {
                padding: var(--spacing-xl) var(--spacing-lg);
            }
        }
        
        /* Input Card */
        .input-card {
            background: var(--card-bg);
            border: 2px solid var(--border-color);
            border-radius: 16px;
            padding: var(--spacing-md);
            margin-bottom: var(--spacing-md);
        }
        
        .input-title {
            font-size: var(--text-xl);
            font-weight: 700;
            margin-bottom: var(--spacing-md);
            color: var(--text-primary);
        }
        
        /* Textarea - Mobile Optimized */
        .input-area {
            width: 100%;
            min-height: 200px;
            padding: var(--spacing-md);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Courier New', monospace;
            font-size: var(--text-sm);
            line-height: 1.5;
            resize: vertical;
            transition: border-color 0.2s;
            touch-action: manipulation;
        }
        
        .input-area:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        @media (min-width: 768px) {
            .input-area {
                min-height: 250px;
            }
        }
        
        /* Buttons - Touch Optimized */
        .btn {
            min-height: var(--touch-target);
            padding: 12px 24px;
            background: var(--primary-gradient);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: var(--text-base);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-xs);
            text-decoration: none;
            user-select: none;
            touch-action: manipulation;
        }
        
        .btn:active {
            transform: scale(0.95);
        }
        
        .btn:hover:not(:active) {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.3);
        }
        
        .btn-success {
            background: var(--success-gradient);
        }
        
        .btn-danger {
            background: var(--danger-gradient);
        }
        
        .btn-full {
            width: 100%;
        }
        
        .btn-group {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-sm);
            margin-top: var(--spacing-md);
        }
        
        /* Search Bar Icon Button */
        .search-icon-btn {
            background: transparent;
            border: none;
            font-size: 24px;
            cursor: pointer;
            padding: 8px 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s;
            opacity: 0.7;
            flex-shrink: 0;
            min-width: 44px;
            min-height: 44px;
        }
        
        .search-icon-btn:hover {
            opacity: 1;
            transform: scale(1.1);
        }
        
        .search-icon-btn:active {
            transform: scale(0.95);
        }
        
        @media (max-width: 639px) {
            .search-icon-btn {
                padding: 10px 14px;
                font-size: 22px;
                min-width: 48px;
                min-height: 48px;
            }
        }
        
        /* Archive Action Button - Minimal */
        .archive-action-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 20px;
            padding: 8px 20px;
            font-weight: 600;
            cursor: pointer;
            white-space: nowrap;
            font-size: 14px;
            transition: all 0.2s;
            letter-spacing: 0.3px;
        }
        
        .archive-action-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.35);
        }
        
        .archive-action-btn:active {
            transform: translateY(0);
        }
        
        /* Mobile-Optimized Buttons */
        @media (max-width: 639px) {
            .btn {
                min-height: 52px;
                padding: 16px 24px;
                font-size: 16px;
                border-radius: 14px;
                line-height: 1.2;
                text-align: center;
            }
            
            .btn-group {
                gap: 14px;
            }
        }
        
        @media (min-width: 640px) {
            .btn-group {
                flex-direction: row;
                flex-wrap: wrap;
            }
            
            .btn-full {
                flex: 1;
            }
        }
        
        /* Results Section */
        .results {
            display: none;
            margin-top: var(--spacing-lg);
            padding: var(--spacing-md);
            background: var(--card-bg);
            border-radius: 16px;
            border: 2px solid var(--border-color);
        }
        
        .results.show {
            display: block;
        }
        
        .result-title {
            font-size: var(--text-xl);
            font-weight: 700;
            margin-bottom: var(--spacing-md);
            word-break: break-word;
        }
        
        .result-meta {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-md);
        }
        
        .meta-item {
            background: white;
            padding: var(--spacing-sm);
            border-radius: 8px;
            text-align: center;
        }
        
        .meta-label {
            font-size: var(--text-xs);
            color: var(--text-secondary);
            margin-bottom: 4px;
        }
        
        .meta-value {
            font-size: var(--text-lg);
            font-weight: 700;
            color: var(--text-primary);
        }
        
        /* Hash Display - Color-Coded Badges */
        .hash-section {
            margin: var(--spacing-md) 0;
        }
        
        .hash-type {
            font-size: var(--text-sm);
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: var(--spacing-xs);
        }
        
        .hash-group {
            background: #f1f5f9;
            border-radius: 12px;
            padding: var(--spacing-sm);
            margin-bottom: var(--spacing-sm);
        }
        
        .hash-item {
            margin: 8px 0;
            display: flex;
            gap: 8px;
            align-items: stretch;
        }
        
        .hash-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: var(--text-xs);
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            white-space: nowrap;
            flex-shrink: 0;
            align-self: flex-start;
        }
        
        .hash-badge-sha256 {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
        }
        
        .hash-badge-blake2b {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }
        
        .hash-badge-md5 {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
        }
        
        .hash-value-container {
            flex: 1;
            display: flex;
            gap: 6px;
            align-items: stretch;
        }
        
        .hash-value {
            flex: 1;
            background: #1e293b;
            color: #e2e8f0;
            padding: 10px 12px;
            border-radius: 8px;
            font-family: 'SF Mono', Monaco, monospace;
            font-size: var(--text-xs);
            word-break: break-all;
            line-height: 1.4;
        }
        
        .hash-copy-btn {
            background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 0 14px;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 44px;
            flex-shrink: 0;
        }
        
        .hash-copy-btn:hover {
            background: linear-gradient(135deg, #4f46e5 0%, #4338ca 100%);
            transform: scale(1.05);
        }
        
        .hash-copy-btn:active {
            transform: scale(0.95);
        }
        
        @media (max-width: 640px) {
            .hash-item {
                flex-direction: column;
            }
            
            .hash-value-container {
                flex-direction: row;
            }
        }
        
        /* History Section - Sleek Minimal Design */
        .history {
            margin-top: var(--spacing-xl);
        }
        
        .history-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            color: var(--text-primary);
        }
        
        .history-cards {
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 500px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .history-card {
            background: #ffffff;
            border: 1px solid #e5e7eb;
            border-radius: 16px;
            padding: 16px 20px;
            transition: all 0.2s ease;
            cursor: pointer;
            position: relative;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }
        
        .history-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .history-card:active {
            transform: scale(0.98);
        }
        
        .history-card-title {
            font-weight: 600;
            font-size: 15px;
            margin-bottom: 8px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            color: var(--text-primary);
        }
        
        .history-card-meta {
            font-size: 12px;
            color: var(--text-tertiary);
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            font-weight: 500;
        }
        
        .history-card-hash {
            font-family: 'SF Mono', 'Monaco', 'Menlo', 'Courier New', monospace;
            font-size: 11px;
            color: var(--text-primary);
            background: #f1f5f9;
            padding: 6px 10px;
            border-radius: 8px;
            margin-top: 8px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        /* Status Messages */
        .status {
            padding: var(--spacing-md);
            border-radius: 12px;
            margin: var(--spacing-sm) 0;
            font-size: var(--text-sm);
        }
        
        .status-loading {
            background: #dbeafe;
            border: 1px solid #3b82f6;
            color: #1e40af;
        }
        
        .status-success {
            background: #d1fae5;
            border: 1px solid #10b981;
            color: #065f46;
        }
        
        .status-error {
            background: #fee2e2;
            border: 1px solid #ef4444;
            color: #991b1b;
        }
        
        .status-warning {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            color: #92400e;
        }
        
        /* Info Tip Box */
        .info-tip {
            background: linear-gradient(135deg, #e0f2fe 0%, #dbeafe 100%);
            border: 2px solid #3b82f6;
            border-radius: 12px;
            padding: var(--spacing-md);
            margin-top: var(--spacing-md);
            font-size: var(--text-sm);
            line-height: 1.6;
        }
        
        .info-tip strong {
            color: #1e40af;
            display: block;
            margin-bottom: 6px;
        }
        
        /* Simple info tip - light version */
        .info-tip-light {
            text-align: center;
            color: var(--text-tertiary);
            font-size: 13px;
            margin-top: 12px;
            margin-bottom: 24px;
            font-weight: 500;
        }
        
        /* Paywall Warning Box */
        .paywall-warning {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border: 3px solid #f59e0b;
            border-radius: 12px;
            padding: var(--spacing-md);
            margin: var(--spacing-md) 0;
            animation: warningPulse 2s ease-in-out infinite;
        }
        
        .paywall-warning-header {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            font-size: var(--text-lg);
            font-weight: 700;
            color: #92400e;
            margin-bottom: var(--spacing-sm);
        }
        
        .paywall-warning-body {
            font-size: var(--text-sm);
            color: #78350f;
            line-height: 1.6;
        }
        
        .paywall-warning ul {
            margin: var(--spacing-sm) 0 0 var(--spacing-md);
            padding: 0;
        }
        
        .paywall-warning li {
            margin: 4px 0;
        }
        
        @keyframes warningPulse {
            0%, 100% {
                box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.4);
            }
            50% {
                box-shadow: 0 0 0 8px rgba(245, 158, 11, 0);
            }
        }
        
        /* Loading Spinner */
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: currentColor;
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Modal - Mobile Friendly */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            padding: var(--spacing-md);
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: white;
            border-radius: 20px;
            padding: var(--spacing-lg);
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .modal-header {
            font-size: var(--text-xl);
            font-weight: 700;
            margin-bottom: var(--spacing-md);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-close {
            width: 44px;
            height: 44px;
            min-width: 44px;
            min-height: 44px;
            border: none;
            background: transparent;
            font-size: 32px;
            cursor: pointer;
            color: #64748b;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            flex-shrink: 0;
            border-radius: 8px;
            transition: all 0.2s;
        }
        
        .modal-close:active {
            background: rgba(0,0,0,0.05);
        }
        
        /* Utility Classes */
        .mb-sm { margin-bottom: var(--spacing-sm); }
        .mb-md { margin-bottom: var(--spacing-md); }
        .mb-lg { margin-bottom: var(--spacing-lg); }
        .mt-sm { margin-top: var(--spacing-sm); }
        .mt-md { margin-top: var(--spacing-md); }
        .mt-lg { margin-top: var(--spacing-lg); }
        
        .text-center { text-align: center; }
        .hidden { display: none !important; }
        
        /* Features List */
        .features {
            list-style: none;
            margin: var(--spacing-md) 0;
        }
        
        .features li {
            padding: var(--spacing-xs) 0;
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }
        
        .features li::before {
            content: "✓";
            color: #10b981;
            font-weight: bold;
            font-size: var(--text-lg);
        }
        
        /* Empty State */
        .empty-state {
            text-align: center;
            padding: var(--spacing-xl);
            color: var(--text-secondary);
        }
        
        .empty-icon {
            font-size: 4rem;
            margin-bottom: var(--spacing-md);
            opacity: 0.5;
        }
        
        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
        
        /* Safe Area Insets for Notched Devices */
        @supports (padding: max(0px)) {
            body {
                padding-left: max(var(--spacing-sm), env(safe-area-inset-left));
                padding-right: max(var(--spacing-sm), env(safe-area-inset-right));
                padding-top: max(var(--spacing-sm), env(safe-area-inset-top));
            }
        }
        
        /* ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
         * UX IMPROVEMENTS - Toast Notifications, Loading States, Status Chips
         * ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ */
        
        /* Toast Notification System */
        #toastHost {
            position: fixed;
            top: var(--spacing-lg);
            right: var(--spacing-md);
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: var(--spacing-xs);
            max-width: 400px;
        }
        
        @media (max-width: 640px) {
            #toastHost {
                top: var(--spacing-sm);
                right: var(--spacing-sm);
                left: var(--spacing-sm);
                max-width: none;
            }
        }
        
        .toast {
            background: white;
            border-radius: 12px;
            padding: var(--spacing-md);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            animation: slideIn 0.3s ease-out;
            border-left: 4px solid #3b82f6;
        }
        
        .toast--success {
            border-left-color: #10b981;
        }
        
        .toast--error {
            border-left-color: #ef4444;
        }
        
        .toast--info {
            border-left-color: #3b82f6;
        }
        
        .toast--warning {
            border-left-color: #f59e0b;
        }
        
        .toast-icon {
            font-size: var(--text-xl);
            flex-shrink: 0;
        }
        
        .toast-message {
            flex: 1;
            font-size: var(--text-sm);
            font-weight: 500;
            color: var(--text-primary);
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(400px);
                opacity: 0;
            }
        }
        
        .toast.toast-exit {
            animation: slideOut 0.3s ease-in;
        }
        
        /* Loading States */
        .btn.is-loading {
            opacity: 0.7;
            cursor: wait;
            pointer-events: none;
        }
        
        .btn.is-loading .spinner {
            display: inline-block;
            margin-right: 8px;
        }
        
        /* Status Chips for HAS Authentication */
        .status-chip {
            display: inline-flex;
            align-items: center;
            gap: var(--spacing-xs);
            padding: 10px 16px;
            border-radius: 20px;
            font-size: var(--text-sm);
            font-weight: 600;
            transition: all 0.3s ease;
            border: 2px solid;
        }
        
        .status-chip--disconnected {
            background: #f1f5f9;
            border-color: #cbd5e1;
            color: #64748b;
            padding: 6px 12px;
            font-size: 0.8rem;
        }
        
        .status-chip--connecting {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border-color: #f59e0b;
            color: #92400e;
            animation: pulse 2s ease-in-out infinite;
        }
        
        .status-chip--connected {
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
            border-color: #10b981;
            color: #065f46;
        }
        
        @keyframes pulse {
            0%, 100% {
                box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.4);
            }
            50% {
                box-shadow: 0 0 0 8px rgba(245, 158, 11, 0);
            }
        }
        
        /* Onboarding Banner */
        .onboarding-banner {
            background: linear-gradient(135deg, #e0f2fe 0%, #dbeafe 100%);
            border: 2px solid #3b82f6;
            border-radius: 16px;
            padding: var(--spacing-md);
            margin-bottom: var(--spacing-md);
            position: relative;
        }
        
        .onboarding-banner h3 {
            font-size: var(--text-lg);
            font-weight: 700;
            color: #1e40af;
            margin-bottom: var(--spacing-sm);
        }
        
        .onboarding-banner ol {
            margin: 0;
            padding-left: var(--spacing-lg);
            color: #1e40af;
            font-size: var(--text-sm);
            line-height: 1.8;
        }
        
        .onboarding-banner ol li {
            margin: 6px 0;
        }
        
        .onboarding-banner .close-btn {
            position: absolute;
            top: var(--spacing-sm);
            right: var(--spacing-sm);
            background: rgba(255, 255, 255, 0.9);
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            font-size: 24px;
            line-height: 1;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #1e40af;
            transition: all 0.2s;
        }
        
        .onboarding-banner .close-btn:hover {
            background: white;
            transform: scale(1.1);
        }
        
        /* Phase 9: Resume Banner */
        .resume-banner {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border: 2px solid #f59e0b;
            border-radius: 16px;
            padding: var(--spacing-md);
            margin-bottom: var(--spacing-md);
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.2);
        }
        
        .resume-banner-content h3 {
            font-size: var(--text-lg);
            font-weight: 700;
            color: #92400e;
            margin-bottom: var(--spacing-sm);
        }
        
        .resume-banner-content p {
            color: #92400e;
            margin-bottom: var(--spacing-sm);
            line-height: 1.6;
        }
        
        .resume-banner-actions {
            display: flex;
            gap: var(--spacing-sm);
            margin-top: var(--spacing-sm);
        }
        
        .resume-banner-actions button {
            flex: 1;
            padding: 10px 16px;
            font-weight: 600;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .resume-banner-actions .btn-primary {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }
        
        .resume-banner-actions .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }
        
        .resume-banner-actions .btn-secondary {
            background: #e5e7eb;
            color: #374151;
        }
        
        .resume-banner-actions .btn-secondary:hover {
            background: #d1d5db;
        }
        
        /* Phase 9: Resume Modal Styles */
        .resume-info {
            padding: var(--spacing-md);
            background: #f9fafb;
            border-radius: 8px;
            margin-bottom: var(--spacing-md);
        }
        
        .resume-info p {
            margin: 8px 0;
            color: var(--text-secondary);
        }
        
        .resume-info .info-text {
            color: #0891b2;
            font-style: italic;
            margin-top: var(--spacing-sm);
        }
        
        .verification-status {
            padding: var(--spacing-sm);
            background: #f0f9ff;
            border-radius: 8px;
            margin-top: var(--spacing-md);
        }
        
        .verification-status h4 {
            color: #0c4a6e;
            margin-bottom: var(--spacing-sm);
        }
        
        .verification-summary {
            margin-top: var(--spacing-md);
            padding: var(--spacing-md);
            background: #e8f5e9;
            border-radius: 8px;
        }
        
        .verification-summary p {
            margin: 4px 0;
            color: #1b5e20;
        }
        
        .error-text {
            font-size: 12px;
            color: #666;
            margin-top: var(--spacing-sm);
        }
        
        /* Character Counter */
        .char-counter {
            font-size: var(--text-xs);
            color: var(--text-secondary);
            text-align: right;
            margin-top: 6px;
            font-weight: 500;
        }
        
        /* Hash Ready Badge */
        .hash-ready-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: var(--text-sm);
            font-weight: 600;
            margin-top: var(--spacing-sm);
            animation: fadeIn 0.5s ease-out;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Keychain Warning Box */
        .info-box {
            padding: var(--spacing-md);
            border-radius: 12px;
            margin: var(--spacing-sm) 0;
            font-size: var(--text-sm);
            line-height: 1.6;
        }
        
        .info-box--warning {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border: 2px solid #f59e0b;
            color: #92400e;
        }
        
        .info-box--warning a {
            color: #92400e;
            font-weight: 700;
            text-decoration: underline;
        }
        
        /* Progress Steps for Snippet Instructions */
        .progress-steps {
            list-style: none;
            padding: 0;
            margin: var(--spacing-md) 0;
        }
        
        .progress-steps li {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            padding: var(--spacing-sm);
            margin: var(--spacing-xs) 0;
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        
        .progress-steps .step-pending {
            background: #f1f5f9;
        }
        
        /* ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
         * iOS SHORTCUTS MANUAL SETUP GUIDE STYLES
         * ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ */
        
        /* Giant Copy Code Button */
        .copy-code-btn {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            font-size: clamp(20px, 5vw, 28px);
            font-weight: 800;
            padding: 24px 48px;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            width: 100%;
            text-align: center;
            box-shadow: 0 8px 30px rgba(16, 185, 129, 0.4);
            transition: all 0.3s ease;
            min-height: 70px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            position: relative;
            overflow: hidden;
        }
        
        .copy-code-btn:active {
            transform: scale(0.97);
        }
        
        .copy-code-btn:hover:not(:active) {
            transform: translateY(-2px);
            box-shadow: 0 12px 40px rgba(16, 185, 129, 0.5);
        }
        
        .copy-code-btn.copied {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        }
        
        @keyframes successPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .copy-code-btn.copied {
            animation: successPulse 0.5s ease-out;
        }
        
        /* Step Container */
        .setup-step {
            background: rgba(255,255,255,0.15);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 20px;
            border: 3px solid rgba(255,255,255,0.25);
        }
        
        .setup-step-header {
            display: flex;
            align-items: center;
            margin-bottom: 14px;
        }
        
        .step-number {
            width: 44px;
            height: 44px;
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            font-size: 20px;
            margin-right: 12px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            flex-shrink: 0;
        }
        
        .step-title {
            font-size: clamp(18px, 4vw, 22px);
            font-weight: 700;
            line-height: 1.3;
        }
        
        .step-content {
            margin: 0 0 16px 0;
            font-size: 15px;
            opacity: 0.95;
            line-height: 1.7;
        }
        
        .step-content p {
            margin: 0 0 12px 0;
        }
        
        .step-content strong {
            color: white;
            font-weight: 700;
        }
        
        /* Code Display Box */
        .code-display {
            background: #1e293b;
            border-radius: 12px;
            padding: 16px;
            margin: 16px 0;
            max-height: 200px;
            overflow-y: auto;
            font-family: 'SF Mono', Monaco, 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.6;
            color: #e2e8f0;
            word-break: break-all;
            white-space: pre-wrap;
        }
        
        /* Visual Aids */
        .visual-aid {
            background: rgba(255,255,255,0.1);
            border: 2px dashed rgba(255,255,255,0.3);
            border-radius: 12px;
            padding: 16px;
            margin: 12px 0;
            text-align: center;
            font-size: 16px;
        }
        
        .visual-aid-icon {
            font-size: 48px;
            margin-bottom: 8px;
        }
        
        /* Collapsible Sections */
        .collapsible-section {
            background: rgba(255,255,255,0.1);
            border-radius: 12px;
            margin: 16px 0;
            overflow: hidden;
        }
        
        .collapsible-header {
            padding: 16px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 700;
            font-size: 16px;
            transition: all 0.2s;
        }
        
        .collapsible-header:hover {
            background: rgba(255,255,255,0.05);
        }
        
        .collapsible-icon {
            font-size: 20px;
            transition: transform 0.3s;
        }
        
        .collapsible-icon.open {
            transform: rotate(180deg);
        }
        
        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }
        
        .collapsible-content.open {
            max-height: 1000px;
        }
        
        .collapsible-body {
            padding: 0 16px 16px 16px;
            font-size: 14px;
            line-height: 1.6;
            opacity: 0.95;
        }
        
        /* Progress Indicator */
        .progress-indicator {
            text-align: center;
            font-size: 14px;
            opacity: 0.8;
            margin-bottom: 8px;
            font-weight: 600;
        }
        
        /* Success Badge */
        .success-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: rgba(16,185,129,0.25);
            padding: 10px 20px;
            border-radius: 20px;
            font-weight: 700;
            border: 2px solid rgba(16,185,129,0.5);
            margin: 12px 0;
        }
        
        /* Fallback Textarea */
        .fallback-textarea {
            width: 100%;
            min-height: 120px;
            background: #1e293b;
            color: #e2e8f0;
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            padding: 12px;
            font-family: 'SF Mono', Monaco, 'Courier New', monospace;
            font-size: 11px;
            line-height: 1.4;
            margin-top: 12px;
            resize: vertical;
        }
        
        /* Content Preview Section */
        .content-preview {
            margin-top: var(--spacing-md);
        }
        
        .preview-header {
            cursor: pointer;
            padding: 12px 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            font-weight: 600;
            font-size: 15px;
            transition: all 0.2s;
        }
        
        .preview-header:hover {
            opacity: 0.95;
            transform: translateY(-1px);
        }
        
        .preview-toggle {
            font-size: 20px;
            transition: transform 0.3s;
        }
        
        .preview-body {
            max-height: 500px;
            overflow-y: auto;
            padding: 20px;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            line-height: 1.6;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }
        
        /* Preview Content Typography */
        .preview-body h1 {
            color: #000;
            margin-bottom: 20px;
            font-weight: 800;
            font-size: 28px;
            line-height: 1.2;
        }
        
        .preview-body h2 {
            color: #1a202c;
            margin-top: 24px;
            margin-bottom: 12px;
            font-weight: 700;
            font-size: 22px;
            line-height: 1.3;
        }
        
        .preview-body h3 {
            color: #2d3748;
            margin-top: 20px;
            margin-bottom: 10px;
            font-weight: 700;
            font-size: 18px;
            line-height: 1.4;
        }
        
        .preview-body h4 {
            color: #4a5568;
            margin-top: 16px;
            margin-bottom: 8px;
            font-weight: 600;
            font-size: 16px;
            line-height: 1.4;
        }
        
        .preview-body p {
            margin-bottom: 12px;
            color: #2d3748;
            font-size: 15px;
            line-height: 1.7;
        }
        
        .preview-body img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            margin: 16px 0;
            display: block;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .preview-body a {
            color: #667eea;
            text-decoration: underline;
            word-break: break-word;
        }
        
        .preview-body strong {
            font-weight: 600;
        }
        
        .preview-body code {
            background: #f7fafc;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.9em;
            color: #e53e3e;
            word-break: break-all;
        }
        
        /* Code blocks (multi-line) - REGRESSION FIX for hash display */
        .preview-body pre {
            background: #f7fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 16px;
            overflow-x: auto;
            margin: 16px 0;
        }
        
        .preview-body pre code {
            background: transparent;
            padding: 0;
            color: #2d3748;
            font-size: 0.85em;
            line-height: 1.6;
            word-break: normal;
        }
        
        .preview-body hr {
            border: none;
            border-top: 2px solid #e2e8f0;
            margin: 24px 0;
        }
        
        /* Fix emoji sizing in preview */
        .preview-body .emoji {
            font-size: 16px !important;
            vertical-align: middle;
            display: inline-block;
        }
        
        .preview-body img.emoji {
            max-height: 1.2em;
            max-width: 1.2em;
            vertical-align: middle;
            display: inline-block;
        }
        
        /* Mobile Optimizations for Preview */
        @media (max-width: 600px) {
            .preview-header {
                padding: 10px 12px;
                font-size: 13px;
            }
            
            .preview-toggle {
                font-size: 16px;
            }
            
            .preview-body {
                padding: 18px;
                max-height: 60vh;
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            }
            
            .preview-body h1 {
                font-size: 1.5rem;
                margin-bottom: 16px;
                line-height: 1.3;
            }
            
            .preview-body h2 {
                font-size: 1.25rem;
                margin-top: 20px;
                margin-bottom: 12px;
                line-height: 1.3;
            }
            
            .preview-body h3 {
                font-size: 1.1rem;
                margin-top: 16px;
                margin-bottom: 10px;
            }
            
            .preview-body h4 {
                font-size: 1rem;
                margin-top: 14px;
                margin-bottom: 8px;
            }
            
            .preview-body p {
                font-size: 1.05rem;
                line-height: 1.7;
                margin-bottom: 14px;
                word-break: break-word;
            }
            
            .preview-body img {
                margin: 12px 0;
                border-radius: 6px;
            }
            
            .preview-body code {
                font-size: 0.75em;
                padding: 1px 4px;
                word-break: break-all;
            }
            
            /* Hash section (pre blocks) - compact barcode style */
            .preview-body pre {
                padding: 8px 10px;
                margin: 8px 0;
                overflow-x: hidden;
                white-space: pre-wrap;
                word-break: break-all;
                background: #1e293b;
                border-radius: 6px;
                border: none;
            }
            
            .preview-body pre code {
                font-size: 0.6em;
                line-height: 1.2;
                word-break: break-all;
                white-space: pre-wrap;
                color: #94a3b8;
                font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
                letter-spacing: -0.5px;
            }
            
            .preview-body hr {
                margin: 18px 0;
            }
        }
        
        /* Mobile Preview Teaser Mode */
        .preview-teaser {
            position: relative;
        }
        
        .preview-teaser::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: linear-gradient(transparent, white);
            pointer-events: none;
        }
        
        .preview-teaser .preview-body {
            max-height: 150px;
            overflow: hidden;
        }
        
        .expand-teaser-btn {
            display: block;
            width: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 14px;
            font-size: 15px;
            font-weight: 600;
            border-radius: 0 0 12px 12px;
            cursor: pointer;
            margin-top: -1px;
            min-height: 48px;
        }
        
        /* Mobile Touch-Friendly Buttons */
        @media (max-width: 600px) {
            #searchBarContainer {
                position: fixed !important;
                bottom: 0 !important;
                left: 0 !important;
                right: 0 !important;
                margin: 0 !important;
                border-radius: 0 !important;
                z-index: 998 !important;
                padding: 12px 16px !important;
                box-shadow: 0 -2px 8px rgba(0,0,0,0.1) !important;
            }
            
            .content {
                padding-bottom: 100px !important;
            }
            
            .mobile-action-row {
                flex-direction: column !important;
                gap: 12px !important;
            }
            
            .mobile-action-row button {
                min-height: 48px;
                font-size: 15px !important;
                padding: 14px !important;
            }
            
            .preview-header {
                min-height: 48px;
                padding: 14px 16px !important;
            }
            
            .expand-teaser-btn {
                min-height: 52px;
                font-size: 16px;
                padding: 16px;
            }
            
            /* Fullscreen preview modal - compact hash styling */
            .fullscreen-preview pre {
                background: #1e293b;
                padding: 10px 12px;
                border-radius: 8px;
                margin: 10px 0;
            }
            
            .fullscreen-preview pre code {
                font-size: 11px;
                line-height: 1.3;
                color: #94a3b8;
                font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
                letter-spacing: -0.3px;
            }
            
            /* Use full width for content preview on mobile */
            .content-preview {
                margin-left: -8px;
                margin-right: -8px;
                width: calc(100% + 16px);
            }
        }
        
        .progress-steps .step-complete {
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
            border: 2px solid #10b981;
        }
        
        .progress-steps .step-number {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: white;
            font-weight: 700;
            font-size: var(--text-sm);
            flex-shrink: 0;
        }
        
        .progress-steps .step-pending .step-number {
            color: #64748b;
            border: 2px solid #cbd5e1;
        }
        
        .progress-steps .step-complete .step-number {
            color: #059669;
            border: 2px solid #10b981;
        }
        
        .progress-steps .step-text {
            flex: 1;
            font-weight: 500;
            color: var(--text-primary);
        }
        
        .progress-steps .step-check {
            font-size: 24px;
            color: #10b981;
            display: none;
        }
        
        .progress-steps .step-complete .step-check {
            display: block;
        }
        
        /* Error Recovery Modal */
        .error-recovery {
            text-align: center;
            padding: var(--spacing-md);
        }
        
        .error-recovery p {
            font-size: var(--text-base);
            margin-bottom: var(--spacing-md);
            color: #991b1b;
            font-weight: 600;
        }
        
        .error-recovery .btn-group {
            display: flex;
            gap: var(--spacing-sm);
            flex-direction: column;
        }
        
        @media (min-width: 640px) {
            .error-recovery .btn-group {
                flex-direction: row;
            }
        }
        
        /* Smooth Transitions for Hash Display */
        #hashesDisplay {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-out;
        }
        
        #hashesDisplay.expanded {
            max-height: 2000px;
        }
        
        /* ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
         * MULTI-PART POSTING UI - Phase 7
         * ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ */
        
        /* Multi-Part Summary Card */
        .multipart-summary-card {
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
            border: 2px solid #3b82f6;
            border-radius: 16px;
            padding: var(--spacing-lg);
            margin: var(--spacing-lg) 0;
            animation: fadeIn 0.5s ease-out;
        }
        
        .multipart-summary-header {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            font-size: var(--text-2xl);
            font-weight: 700;
            color: #1e40af;
            margin-bottom: var(--spacing-md);
        }
        
        .multipart-summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--spacing-sm);
            margin: var(--spacing-md) 0;
        }
        
        .multipart-stat-item {
            background: white;
            padding: var(--spacing-md);
            border-radius: 12px;
            border: 2px solid #93c5fd;
        }
        
        .multipart-stat-label {
            font-size: var(--text-xs);
            color: #1e40af;
            font-weight: 600;
            margin-bottom: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .multipart-stat-value {
            font-size: var(--text-xl);
            font-weight: 700;
            color: #1e3a8a;
        }
        
        .multipart-series-badge {
            display: inline-flex;
            align-items: center;
            gap: var(--spacing-xs);
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: var(--text-sm);
            font-weight: 700;
            letter-spacing: 0.5px;
        }
        
        .multipart-info-text {
            font-size: var(--text-sm);
            color: #1e40af;
            line-height: 1.6;
            margin-top: var(--spacing-md);
        }
        
        /* Part Preview Table */
        .multipart-table-container {
            margin: var(--spacing-lg) 0;
            border-radius: 12px;
            overflow: hidden;
            border: 2px solid #e5e7eb;
        }
        
        .multipart-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }
        
        .multipart-table thead {
            background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%);
            color: white;
        }
        
        .multipart-table th {
            padding: var(--spacing-md);
            text-align: left;
            font-size: var(--text-sm);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .multipart-table td {
            padding: var(--spacing-md);
            border-bottom: 1px solid #e5e7eb;
            font-size: var(--text-sm);
        }
        
        .multipart-table tbody tr:nth-child(even) {
            background: #f9fafb;
        }
        
        .multipart-table tbody tr:hover {
            background: #f3f4f6;
        }
        
        .multipart-part-number {
            font-weight: 700;
            color: #1e40af;
            font-size: var(--text-lg);
        }
        
        .multipart-split-preview {
            font-family: 'SF Mono', Monaco, monospace;
            font-size: var(--text-xs);
            color: var(--text-secondary);
            max-width: 300px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .multipart-hash-preview {
            font-family: 'SF Mono', Monaco, monospace;
            font-size: var(--text-xs);
            background: #f1f5f9;
            padding: 4px 8px;
            border-radius: 4px;
            color: #334155;
        }
        
        .multipart-expand-btn {
            background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 8px;
            font-size: var(--text-xs);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .multipart-expand-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(99, 102, 241, 0.3);
        }
        
        .multipart-part-excerpt {
            display: none;
            margin-top: var(--spacing-sm);
            padding: var(--spacing-md);
            background: #f8fafc;
            border-radius: 8px;
            font-family: 'SF Mono', Monaco, monospace;
            font-size: var(--text-xs);
            color: var(--text-secondary);
            max-height: 200px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-break: break-word;
        }
        
        .multipart-part-excerpt.show {
            display: block;
        }
        
        /* Confirmation Modal */
        .multipart-confirm-modal-content {
            text-align: center;
        }
        
        .multipart-confirm-header {
            font-size: var(--text-2xl);
            font-weight: 700;
            color: #dc2626;
            margin-bottom: var(--spacing-md);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-sm);
        }
        
        .multipart-confirm-message {
            font-size: var(--text-base);
            color: var(--text-primary);
            margin-bottom: var(--spacing-md);
            line-height: 1.6;
        }
        
        .multipart-confirm-warning {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border: 2px solid #f59e0b;
            border-radius: 12px;
            padding: var(--spacing-md);
            margin: var(--spacing-md) 0;
            font-size: var(--text-sm);
            color: #92400e;
            font-weight: 600;
        }
        
        .multipart-confirm-checkbox {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            margin: var(--spacing-lg) 0;
            padding: var(--spacing-md);
            background: #f9fafb;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .multipart-confirm-checkbox:hover {
            background: #f3f4f6;
        }
        
        .multipart-confirm-checkbox input[type="checkbox"] {
            width: 24px;
            height: 24px;
            cursor: pointer;
        }
        
        .multipart-confirm-checkbox label {
            font-size: var(--text-base);
            font-weight: 500;
            color: var(--text-primary);
            cursor: pointer;
        }
        
        /* Progress Indicator */
        .multipart-progress-container {
            background: white;
            border: 2px solid #3b82f6;
            border-radius: 16px;
            padding: var(--spacing-lg);
            margin: var(--spacing-lg) 0;
        }
        
        .multipart-progress-header {
            font-size: var(--text-xl);
            font-weight: 700;
            color: #1e40af;
            margin-bottom: var(--spacing-md);
            text-align: center;
        }
        
        .multipart-progress-bar-container {
            background: #e5e7eb;
            border-radius: 12px;
            height: 32px;
            overflow: hidden;
            margin: var(--spacing-md) 0;
            position: relative;
        }
        
        .multipart-progress-bar {
            background: linear-gradient(90deg, #3b82f6 0%, #2563eb 100%);
            height: 100%;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: var(--text-sm);
        }
        
        .multipart-progress-list {
            list-style: none;
            padding: 0;
            margin: var(--spacing-md) 0;
        }
        
        .multipart-progress-item {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            padding: var(--spacing-sm);
            margin: var(--spacing-xs) 0;
            border-radius: 8px;
            transition: all 0.2s;
        }
        
        .multipart-progress-item.posted {
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
        }
        
        .multipart-progress-item.posting {
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
            animation: pulse 2s ease-in-out infinite;
        }
        
        .multipart-progress-item.pending {
            background: #f9fafb;
        }
        
        .multipart-progress-item.failed {
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
        }
        
        .multipart-progress-icon {
            font-size: var(--text-xl);
            flex-shrink: 0;
        }
        
        .multipart-progress-text {
            flex: 1;
            font-size: var(--text-sm);
            font-weight: 500;
            color: var(--text-primary);
        }
        
        .multipart-cancel-btn {
            background: var(--danger-gradient);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 12px;
            font-size: var(--text-base);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: var(--spacing-md);
            width: 100%;
        }
        
        .multipart-cancel-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(239, 68, 68, 0.3);
        }
        
        .multipart-retry-btn {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 8px;
            font-size: var(--text-xs);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .multipart-retry-btn:hover {
            transform: scale(1.05);
        }
        
        /* Mobile Optimizations */
        @media (max-width: 768px) {
            .multipart-table-container {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            .multipart-table {
                min-width: 600px;
            }
            
            .multipart-summary-stats {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 style="display: flex; align-items: center; justify-content: center; gap: 12px;">
                <img src="static/images/archive-logo.svg" alt="ArcHive" style="height: 64px; width: auto; vertical-align: middle;">
                <span style="color: #E31337; text-shadow: 0 0 20px rgba(227, 19, 55, 0.5), 0 0 40px rgba(227, 19, 55, 0.3);">ArcHive</span>
                <a href="hash-explorer.html" title="URL Verification" style="text-decoration: none; font-size: 24px; transition: opacity 0.2s; filter: sepia(1) saturate(5) hue-rotate(10deg) brightness(1.1);" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.85'">🔗</a>
            </h1>
        </div>
        
        <div class="content">
            <!-- Phase 9: Resume Banner for Incomplete Multi-Part Postings -->
            <div id="resumeBanner" class="resume-banner" style="display: none;">
                <div class="resume-banner-content">
                    <h3>⚠️ Incomplete Threaded Posting Detected</h3>
                    <p id="resumeSummary"></p>
                    <div class="resume-banner-actions">
                        <button onclick="showResumeModal()" class="btn-primary">📤 Resume Posting Remaining Parts as Threaded Replies</button>
                        <button onclick="clearIncompletePipeline()" class="btn-secondary">❌ Cancel & Clear</button>
                    </div>
                </div>
            </div>
            
            <!-- Getting Started Guide (Onboarding Banner) -->
            <section id="gettingStarted" class="onboarding-banner" style="display: none;">
                <button class="close-btn" onclick="dismissGettingStarted()" aria-label="Close guide">×</button>
                <h3>🚀 Getting Started</h3>
                <ol>
                    <li><strong>Paste any URL</strong> in the search bar (Twitter, Reddit, Wikipedia, etc.)</li>
                    <li><strong>Click "ArcHive"</strong> - we extract & hash automatically</li>
                    <li><strong>Optional:</strong> Post to Hive blockchain for immutable proof</li>
                </ol>
            </section>
            
            <!-- Reset iOS Setup Button (iOS only) - Hidden -->
            <div id="resetIOSContainer" style="display: none;"></div>
            
            <!-- Toggle Button for Setup Instructions -->
            <div id="toggleSetupInstructions" style="text-align: center; margin-bottom: 16px;">
                <button id="toggleSetupText" onclick="toggleSetupVisibility()" style="background: white; border: 1px solid #e2e8f0; padding: 8px 20px; border-radius: 20px; font-size: 14px; color: #64748b; cursor: pointer; transition: all 0.2s;">
                    Hide Setup Instructions
                </button>
            </div>
            
            <!-- Setup Instructions Container (collapsible) -->
            <div id="setupInstructionsContainer" style="text-align: center; margin-bottom: 30px;">
                <h2 style="font-size: 28px; font-weight: 600; margin-bottom: 16px; color: #1a202c;">
                    Archive Any Web Content Forever
                </h2>
                <p style="font-size: 16px; color: #4a5568; margin-bottom: 24px; line-height: 1.6; max-width: 600px; margin-left: auto; margin-right: auto;">
                    One-time setup, lifetime access. Archive tweets, articles, posts from any website with cryptographic verification.
                </p>
                
                <!-- GET ARCHIVE Button -->
                <!-- Drag-and-Drop Bookmarklet Bar (Desktop) -->
                <div id="homepageBookmarkletBar" style="margin-bottom: 20px;">
                    <p style="font-size: 14px; color: #4a5568; margin-bottom: 12px;">
                        <strong>Desktop:</strong> Drag this button to your bookmarks bar:
                    </p>
                    <p id="bookmarksBarHint" style="font-size: 12px; color: #667eea; margin-bottom: 12px; display: none;">
                        💡 <strong>Don't see your bookmarks bar?</strong> Press <kbd style="background: #f1f5f9; padding: 2px 6px; border-radius: 4px; font-family: monospace;">Ctrl+Shift+B</kbd> (Windows/Linux) or <kbd style="background: #f1f5f9; padding: 2px 6px; border-radius: 4px; font-family: monospace;">Cmd+Shift+B</kbd> (Mac)
                    </p>
                    <div id="homepageBookmarkletContainer" style="display: inline-block;">
                        <!-- Bookmarklet link will be inserted here by JavaScript -->
                    </div>
                    <p style="font-size: 12px; color: #a0aec0; margin-top: 8px;">
                        Then visit any webpage and click the bookmark to archive it!
                    </p>
                </div>
                
                <!-- Mobile/iOS Instructions Button - Responsive sizing -->
                <button id="getArchiveButton" onclick="showBookmarkletInstructions()" style="
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    color: white;
                    border: none;
                    padding: 12px 24px;
                    font-size: 14px;
                    font-weight: 600;
                    border-radius: 50px;
                    cursor: pointer;
                    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
                    transition: all 0.3s;
                    display: inline-flex;
                    align-items: center;
                    gap: 8px;
                    max-width: 95vw;
                    white-space: nowrap;
                    overflow: hidden;
                    text-overflow: ellipsis;
                " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(102, 126, 234, 0.5)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(102, 126, 234, 0.4)';">
                    📱 Mobile/iOS Setup
                </button>
                <style>
                    @media (min-width: 768px) {
                        #getArchiveButton {
                            padding: 14px 36px !important;
                            font-size: 16px !important;
                            gap: 10px !important;
                        }
                    }
                </style>
                
                <!-- How it works -->
                <p style="font-size: 14px; color: #718096; margin-top: 16px;">
                    <strong>How it works:</strong> 1. Add to bookmarks → 2. Visit any website → 3. Click bookmark → Done!
                </p>
                
                <!-- OR divider -->
                <div style="margin: 30px 0 20px 0; color: #a0aec0; font-size: 14px;">
                    OR - Archive a URL directly:
                </div>
            </div>
            
            <!-- Google-Style Search Input -->
            <div id="searchBarContainer" style="background: white; border-radius: 50px; box-shadow: 0 2px 8px rgba(0,0,0,0.15); padding: 10px 16px; display: flex; align-items: center; gap: 8px; margin-bottom: 16px; max-width: 800px; margin-left: auto; margin-right: auto; position: relative; z-index: 100; flex-wrap: nowrap;" @media-mobile="position: fixed; bottom: 0; left: 0; right: 0; margin: 0; border-radius: 0; z-index: 998; padding: 8px 12px;">
                <a href="hash-explorer.html" class="search-icon-btn" aria-label="URL Verification" title="URL Verification">
                    🔗
                </a>
                <input 
                    type="url"
                    id="sourceUrlInput"
                    placeholder="ArcHive"
                    aria-label="URL to archive"
                    style="flex: 1; border: none; outline: none; font-size: 16px; padding: 8px 4px; background: transparent; min-width: 120px;">
                <button onclick="processContent()" class="search-icon-btn" aria-label="Archive URL" title="Archive">
                    🛡️
                </button>
            </div>
            
            <!-- Tip for login-required sites -->
            <p id="loginTip" style="text-align: center; font-size: 13px; color: #718096; margin-bottom: 20px;">
                Some sites require you to login to avoid a cutoff in data
            </p>
            
            <div id="advancedSection" style="display: none;">
                <div class="input-card">
                    <div class="input-title">📝 Manual HTML Paste (Optional)</div>
                    
                    <textarea 
                        id="contentInput" 
                        class="input-area" 
                        placeholder="Paste raw HTML code here (optional - only needed for complex sites that require manual extraction)

Examples:
• <html><body>your content here</body></html>
• Full webpage HTML source code"
                        aria-label="HTML content input"
                        style="min-height: 200px;"></textarea>
                    
                    <div class="char-counter" id="charCounter">Characters: 0</div>
                    
                    <div class="btn-group">
                        <button class="btn btn-full" onclick="processContent()" aria-label="Archive content">
                            🔒 ArcHive HTML Content
                        </button>
                    </div>
                </div>
            </div>
            
            <div id="status" class="mt-md"></div>
            
            <!-- Results - Redesigned Layout -->
            <div id="results" class="results">
                <!-- Compact Header with Title + Stats -->
                <div style="display: flex; flex-wrap: wrap; align-items: center; justify-content: space-between; gap: 12px; margin-bottom: 16px;">
                    <div class="result-title" id="resultTitle" style="margin: 0; flex: 1; min-width: 200px;">Archive Results</div>
                    <div style="display: flex; gap: 16px; flex-wrap: wrap;">
                        <span style="font-size: 13px; color: #64748b;"><strong id="wordCount">0</strong> words</span>
                        <span style="font-size: 13px; color: #64748b;"><strong id="imageCount">0</strong> images</span>
                        <span id="extractionMethodBadge" style="font-size: 11px; background: #e2e8f0; color: #475569; padding: 2px 8px; border-radius: 12px; font-weight: 500;"><span id="extractionMethod">-</span></span>
                    </div>
                </div>
                
                <!-- Dynamic Paywall Warning (shown when detected) -->
                <div id="paywallWarning" style="display: none;"></div>
                
                <!-- PRIMARY ACTION: Post to Blockchain (Most Important - At Top) -->
                <div id="primaryActionSection" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 16px; padding: 20px; margin-bottom: 16px; box-shadow: 0 4px 20px rgba(102, 126, 234, 0.3);">
                    <!-- HAS Authentication Status -->
                    <div id="hasStatus" style="text-align: center; margin-bottom: 12px;"></div>
                    
                    <!-- Keychain Detection Warning -->
                    <div id="keychainWarning" style="display: none; margin-bottom: 12px;"></div>
                    
                    <button id="blockchainBtn" onclick="postToHive()" aria-label="Publish to blockchain" style="
                        width: 100%;
                        background: white;
                        color: #667eea;
                        border: none;
                        padding: 16px 32px;
                        font-size: 18px;
                        font-weight: 700;
                        border-radius: 12px;
                        cursor: pointer;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        gap: 10px;
                        transition: all 0.3s;
                        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
                    " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(0,0,0,0.15)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(0,0,0,0.1)';">
                        ⛓️ Post to Blockchain
                    </button>
                    
                    <p style="text-align: center; color: rgba(255,255,255,0.8); font-size: 12px; margin: 12px 0 0 0;">
                        Timestamp your archive immutably on Hive blockchain
                    </p>
                </div>
                
                <!-- Content Preview Section (Important for Verification) -->
                <div class="content-preview" id="contentPreviewSection" style="display: none; margin-bottom: 16px;">
                    <div class="preview-header" onclick="togglePreview()" style="background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%); border: 1px solid #e2e8f0; border-radius: 12px 12px 0 0; padding: 14px 18px; cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
                        <span style="font-weight: 600; color: #334155;">👁️ Content Preview</span>
                        <span id="previewToggle" class="preview-toggle" style="color: #64748b; font-size: 12px;">▼ Show</span>
                    </div>
                    <div id="contentPreviewBody" class="preview-body" style="display: none; border: 1px solid #e2e8f0; border-top: none; border-radius: 0 0 12px 12px; max-height: 300px; overflow-y: auto;">
                        <!-- Content will be inserted here -->
                    </div>
                </div>
                
                <!-- Secondary Actions Row (touch-friendly on mobile) -->
                <div class="mobile-action-row" style="display: flex; gap: 10px; margin-bottom: 20px;">
                    <button class="btn btn-full" onclick="copyAllHashes()" aria-label="Copy all hashes" style="flex: 1; background: #f1f5f9; color: #475569; border: 1px solid #e2e8f0; padding: 12px; font-size: 14px; font-weight: 600; border-radius: 10px;">
                        📋 Copy Hashes
                    </button>
                    <button class="btn btn-full" onclick="downloadArchive()" aria-label="Download archive" style="flex: 1; background: #f1f5f9; color: #475569; border: 1px solid #e2e8f0; padding: 12px; font-size: 14px; font-weight: 600; border-radius: 10px;">
                        💾 Download
                    </button>
                </div>
                
                <!-- Collapsible Details Section -->
                <div id="detailsSection" style="border: 1px solid #e2e8f0; border-radius: 12px; overflow: hidden;">
                    <!-- Details Toggle Header -->
                    <div onclick="toggleDetailsSection()" style="background: #f8fafc; padding: 14px 18px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #e2e8f0;">
                        <span style="font-weight: 600; color: #334155; font-size: 14px;">📋 Archive Details</span>
                        <span id="detailsToggle" style="color: #64748b; font-size: 12px;">▼ Show</span>
                    </div>
                    
                    <!-- Collapsible Details Content -->
                    <div id="detailsContent" style="display: none; padding: 16px; background: white;">
                        <!-- Smart Tags Display + Custom Tags Input -->
                        <div id="tagsSection" style="display: none; margin-bottom: 16px; padding: 16px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px;">
                            <h3 style="color: white; margin: 0 0 12px 0; font-size: 15px; font-weight: 600;">🏷️ Hive Tags</h3>
                            
                            <!-- System Tags (5) -->
                            <div style="margin-bottom: 12px;">
                                <p style="color: rgba(255,255,255,0.8); margin: 0 0 8px 0; font-size: 12px; font-weight: 500;">System Tags:</p>
                                <div id="systemTags" style="display: flex; flex-wrap: wrap; gap: 6px;"></div>
                            </div>
                            
                            <!-- Custom Tags (up to 5) -->
                            <div>
                                <p style="color: rgba(255,255,255,0.8); margin: 0 0 8px 0; font-size: 12px; font-weight: 500;">Custom Tags (optional):</p>
                                <div style="display: flex; flex-wrap: wrap; gap: 6px; align-items: center;">
                                    <div id="customTags" style="display: flex; flex-wrap: wrap; gap: 6px;"></div>
                                    <button id="addTagBtn" onclick="addCustomTag()" style="background: white; color: #667eea; border: none; border-radius: 16px; padding: 4px 12px; font-size: 12px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 4px;">
                                        <span style="font-size: 14px;">+</span> Add
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Archive Information -->
                        <div id="archiveInfoCard" style="display: none; margin-bottom: 16px;">
                            <h4 style="font-size: 14px; font-weight: 600; color: #334155; margin: 0 0 12px 0;">📋 Archive Information</h4>
                            <div style="background: #f8fafc; border-radius: 10px; padding: 12px;">
                                <div style="display: grid; gap: 8px; font-size: 13px;">
                                    <div style="display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid #e2e8f0;">
                                        <span style="color: #64748b;">📅 Archived:</span>
                                        <span id="archivedTimestamp" style="font-weight: 500; color: #334155;"></span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid #e2e8f0;">
                                        <span style="color: #64748b;">⚙️ Method:</span>
                                        <span id="archivedMethod" style="font-weight: 500; color: #334155;"></span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid #e2e8f0;">
                                        <span style="color: #64748b;">📊 Words:</span>
                                        <span id="archivedWordCount" style="font-weight: 500; color: #334155;"></span>
                                    </div>
                                    <div style="padding: 6px 0;">
                                        <span style="color: #64748b;">🔗 Source:</span>
                                        <div id="archivedSource" style="font-weight: 500; color: #3b82f6; font-size: 12px; word-break: break-all; margin-top: 4px;"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Provenance Section (Wikipedia) -->
                        <div id="provenanceSection" style="display: none; margin-bottom: 16px;">
                            <h4 style="font-size: 14px; font-weight: 600; color: #334155; margin: 0 0 12px 0;">🔐 Source Provenance</h4>
                            <div style="background: linear-gradient(135deg, rgba(139, 92, 246, 0.08) 0%, rgba(109, 40, 217, 0.08) 100%); border: 1px solid rgba(139, 92, 246, 0.2); border-radius: 10px; padding: 12px;">
                                <div id="provenanceContent" style="display: grid; gap: 8px; font-size: 13px;"></div>
                                <p style="font-size: 11px; color: #7c3aed; margin: 10px 0 0 0; padding: 8px; background: rgba(139, 92, 246, 0.1); border-radius: 6px;">
                                    <strong>Proof:</strong> Cryptographically linked to exact source version.
                                </p>
                            </div>
                        </div>
                        
                        <!-- Cryptographic Hashes -->
                        <div>
                            <h4 style="font-size: 14px; font-weight: 600; color: #334155; margin: 0 0 12px 0;">🔐 Cryptographic Hashes</h4>
                            <div id="hashesDisplay"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Multi-Part Content Preview (Phase 7) - Kept at bottom -->
                <div id="multipartSummary" style="display: none; margin-top: 16px;"></div>
                <div id="multipartPreviewTable" style="display: none;"></div>
                
                <!-- Hidden legacy elements for JS compatibility -->
                <div class="result-meta" style="display: none;">
                    <div class="meta-item"><div class="meta-label">Words</div><div class="meta-value" id="wordCountLegacy">0</div></div>
                    <div class="meta-item"><div class="meta-label">Images</div><div class="meta-value" id="imageCountLegacy">0</div></div>
                    <div class="meta-item"><div class="meta-label">Method</div><div class="meta-value" id="extractionMethodLegacy">-</div></div>
                </div>
            </div>
            
            <!-- History -->
            <div class="history mt-lg">
                <div class="history-title">
                    <span>📚 Archive History</span>
                    <div style="display: flex; gap: 8px;">
                        <button onclick="downloadFullHistory()" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); border: none; color: white; padding: 8px 18px; border-radius: 10px; cursor: pointer; font-size: 13px; font-weight: 600; transition: all 0.2s; box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);" onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 12px rgba(59, 130, 246, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(59, 130, 246, 0.3)'">
                            📥 Download
                        </button>
                        <button onclick="clearHistory()" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); border: none; color: white; padding: 8px 18px; border-radius: 10px; cursor: pointer; font-size: 13px; font-weight: 600; transition: all 0.2s; box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);" onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 12px rgba(239, 68, 68, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(239, 68, 68, 0.3)'">
                            🗑️ Clear
                        </button>
                    </div>
                </div>
                <div id="historyList" class="history-cards">
                    <div class="empty-state" style="padding: 40px 20px; text-align: center; color: rgba(255,255,255,0.5); font-size: 14px;">
                        <div style="font-size: 32px; margin-bottom: 12px;">📦</div>
                        <div>No archives yet. Paste a URL above to get started!</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Download Modal -->
    <div id="downloadModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span>💾 Download Archive</span>
                <button class="modal-close" onclick="closeDownloadModal()" aria-label="Close modal">×</button>
            </div>
            <div id="downloadOptions"></div>
        </div>
    </div>

    <!-- Ready to Post Confirmation Modal -->
    <div id="postConfirmModal" class="modal">
        <div class="modal-content">
            <h3 style="font-size: var(--text-2xl); font-weight: 700; margin-bottom: var(--spacing-md); color: var(--text-primary);">✅ Ready to Post!</h3>
            <p id="confirmUsername" style="font-size: var(--text-lg); font-weight: 600; color: #10b981; margin-bottom: var(--spacing-sm);"></p>
            <p style="margin-bottom: var(--spacing-sm); color: var(--text-secondary);">You're authenticated and ready to publish to Hive blockchain.</p>
            <p style="margin-bottom: var(--spacing-md); color: var(--text-secondary);">Click the button below to post your archived content.</p>
            <button id="confirmPostBtn" class="btn btn-success btn-full" style="margin-bottom: var(--spacing-sm);">
                📤 Post to Hive Now
            </button>
            <button onclick="closePostConfirmModal()" class="btn btn-full" style="background: var(--danger-gradient);">
                Cancel
            </button>
        </div>
    </div>

    <!-- Multi-Part Posting Confirmation Modal -->
    <div id="multipartConfirmModal" class="modal">
        <div class="modal-content multipart-confirm-modal-content">
            <div class="multipart-confirm-header">
                <span>⚠️</span>
                <span>Multi-Part Posting Confirmation</span>
            </div>
            
            <div class="multipart-confirm-message">
                This will create 1 root post with <strong id="multipartConfirmPartCount">X</strong> parts as threaded replies.
            </div>
            
            <div class="multipart-confirm-info" style="background: #f0f9ff; padding: 12px; border-radius: 8px; margin: 12px 0; font-size: 14px; color: #0c4a6e; line-height: 1.6;">
                📝 <strong>How it works:</strong> Part 1 posts as the root, then Parts 2-<span id="multipartConfirmPartCountInfo">X</span> post as comment replies with 20-second delays between each part.
            </div>
            
            <div class="multipart-confirm-warning">
                ⚠️ All parts must be posted for full content verification
            </div>
            
            <div style="display: flex; gap: var(--spacing-sm); justify-content: center; margin-top: var(--spacing-md); flex-wrap: wrap;">
                <button onclick="closeMultipartConfirmModal()" class="btn" style="background: #9ca3af; padding: 12px 24px; min-width: 120px; min-height: 44px;">
                    ❌ Cancel
                </button>
                <button id="multipartConfirmPostBtn" class="btn btn-success" style="padding: 12px 24px; min-width: 160px; min-height: 44px;">
                    ✅ Post All Parts
                </button>
            </div>
        </div>
    </div>
    
    <!-- Multi-Part Progress Container (injected into results) -->
    <div id="multipartProgressContainer" style="display: none;"></div>
    
    <!-- Phase 9: Resume Modal -->
    <div id="resumeModal" class="modal">
        <div class="modal-content">
            <h3>🔄 Resume Posting Remaining Threaded Replies?</h3>
            <div id="resumeDetails"></div>
            <div id="verificationProgress" style="display: none;"></div>
            <div style="display: flex; gap: var(--spacing-sm); margin-top: var(--spacing-md); min-height: 44px;">
                <button id="resumeConfirmBtn" onclick="confirmResume()" class="btn btn-success btn-full" style="flex: 1; min-height: 44px;">
                    🔍 Verify & Resume
                </button>
                <button onclick="closeResumeModal()" class="btn btn-full" style="background: #9ca3af; flex: 1; min-height: 44px;">
                    ❌ Cancel
                </button>
            </div>
        </div>
    </div>
    
    <!-- Phase 9: Paused Posting Modal -->
    <div id="pausedModal" class="modal">
        <div class="modal-content">
            <h3>⚠️ Multi-Part Posting Paused</h3>
            <div id="pausedDetails"></div>
            <div style="display: flex; gap: var(--spacing-sm); margin-top: var(--spacing-md); min-height: 44px;">
                <button onclick="retryPausedPosting()" class="btn btn-success btn-full" style="flex: 1; min-height: 44px;">
                    🔄 Retry Now
                </button>
                <button onclick="closePausedModal()" class="btn btn-full" style="background: #9ca3af; flex: 1; min-height: 44px;">
                    📅 Resume Later
                </button>
            </div>
        </div>
    </div>

    <!-- ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
         INLINED JAVASCRIPT LIBRARIES
         All libraries are inlined for zero external dependencies
         ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ -->
    
    <script id="readability-library">
/*
 * Copyright (c) 2010 Arc90 Inc
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

/*
 * This code is heavily based on Arc90's readability.js (1.7.1) script
 * available at: http://code.google.com/p/arc90labs-readability
 */

/**
 * Public constructor.
 * @param {HTMLDocument} doc     The document to parse.
 * @param {Object}       options The options object.
 */
function Readability(doc, options) {
  // In some older versions, people passed a URI as the first argument. Cope:
  if (options && options.documentElement) {
    doc = options;
    options = arguments[2];
  } else if (!doc || !doc.documentElement) {
    throw new Error("First argument to Readability constructor should be a document object.");
  }
  options = options || {};

  this._doc = doc;
  this._docJSDOMParser = this._doc.firstChild.__JSDOMParser__;
  this._articleTitle = null;
  this._articleByline = null;
  this._articleDir = null;
  this._articleSiteName = null;
  this._attempts = [];

  // Configurable options
  this._debug = !!options.debug;
  this._maxElemsToParse = options.maxElemsToParse || this.DEFAULT_MAX_ELEMS_TO_PARSE;
  this._nbTopCandidates = options.nbTopCandidates || this.DEFAULT_N_TOP_CANDIDATES;
  this._charThreshold = options.charThreshold || this.DEFAULT_CHAR_THRESHOLD;
  this._classesToPreserve = this.CLASSES_TO_PRESERVE.concat(options.classesToPreserve || []);
  this._keepClasses = !!options.keepClasses;
  this._serializer = options.serializer || function(el) {
    return el.innerHTML;
  };
  this._disableJSONLD = !!options.disableJSONLD;
  this._allowedVideoRegex = options.allowedVideoRegex || this.REGEXPS.videos;

  // Start with all flags set
  this._flags = this.FLAG_STRIP_UNLIKELYS |
                this.FLAG_WEIGHT_CLASSES |
                this.FLAG_CLEAN_CONDITIONALLY;


  // Control whether log messages are sent to the console
  if (this._debug) {
    let logNode = function(node) {
      if (node.nodeType == node.TEXT_NODE) {
        return `${node.nodeName} ("${node.textContent}")`;
      }
      let attrPairs = Array.from(node.attributes || [], function(attr) {
        return `${attr.name}="${attr.value}"`;
      }).join(" ");
      return `<${node.localName} ${attrPairs}>`;
    };
    this.log = function () {
      if (typeof console !== "undefined") {
        let args = Array.from(arguments, arg => {
          if (arg && arg.nodeType == this.ELEMENT_NODE) {
            return logNode(arg);
          }
          return arg;
        });
        args.unshift("Reader: (Readability)");
        console.log.apply(console, args);
      } else if (typeof dump !== "undefined") {
        /* global dump */
        var msg = Array.prototype.map.call(arguments, function(x) {
          return (x && x.nodeName) ? logNode(x) : x;
        }).join(" ");
        dump("Reader: (Readability) " + msg + "\n");
      }
    };
  } else {
    this.log = function () {};
  }
}

Readability.prototype = {
  FLAG_STRIP_UNLIKELYS: 0x1,
  FLAG_WEIGHT_CLASSES: 0x2,
  FLAG_CLEAN_CONDITIONALLY: 0x4,

  // https://developer.mozilla.org/en-US/docs/Web/API/Node/nodeType
  ELEMENT_NODE: 1,
  TEXT_NODE: 3,

  // Max number of nodes supported by this parser. Default: 0 (no limit)
  DEFAULT_MAX_ELEMS_TO_PARSE: 0,

  // The number of top candidates to consider when analysing how
  // tight the competition is among candidates.
  DEFAULT_N_TOP_CANDIDATES: 5,

  // Element tags to score by default.
  DEFAULT_TAGS_TO_SCORE: "section,h2,h3,h4,h5,h6,p,td,pre".toUpperCase().split(","),

  // The default number of chars an article must have in order to return a result
  DEFAULT_CHAR_THRESHOLD: 500,

  // All of the regular expressions in use within readability.
  // Defined up here so we don't instantiate them repeatedly in loops.
  REGEXPS: {
    // NOTE: These two regular expressions are duplicated in
    // Readability-readerable.js. Please keep both copies in sync.
    unlikelyCandidates: /-ad-|ai2html|banner|breadcrumbs|combx|comment|community|cover-wrap|disqus|extra|footer|gdpr|header|legends|menu|related|remark|replies|rss|shoutbox|sidebar|skyscraper|social|sponsor|supplemental|ad-break|agegate|pagination|pager|popup|yom-remote/i,
    okMaybeItsACandidate: /and|article|body|column|content|main|shadow/i,

    positive: /article|body|content|entry|hentry|h-entry|main|page|pagination|post|text|blog|story/i,
    negative: /-ad-|hidden|^hid$| hid$| hid |^hid |banner|combx|comment|com-|contact|foot|footer|footnote|gdpr|masthead|media|meta|outbrain|promo|related|scroll|share|shoutbox|sidebar|skyscraper|sponsor|shopping|tags|tool|widget/i,
    extraneous: /print|archive|comment|discuss|e[\-]?mail|share|reply|all|login|sign|single|utility/i,
    byline: /byline|author|dateline|writtenby|p-author/i,
    replaceFonts: /<(\/?)font[^>]*>/gi,
    normalize: /\s{2,}/g,
    videos: /\/\/(www\.)?((dailymotion|youtube|youtube-nocookie|player\.vimeo|v\.qq)\.com|(archive|upload\.wikimedia)\.org|player\.twitch\.tv)/i,
    shareElements: /(\b|_)(share|sharedaddy)(\b|_)/i,
    nextLink: /(next|weiter|continue|>([^\|]|$)|»([^\|]|$))/i,
    prevLink: /(prev|earl|old|new|<|«)/i,
    tokenize: /\W+/g,
    whitespace: /^\s*$/,
    hasContent: /\S$/,
    hashUrl: /^#.+/,
    srcsetUrl: /(\S+)(\s+[\d.]+[xw])?(\s*(?:,|$))/g,
    b64DataUrl: /^data:\s*([^\s;,]+)\s*;\s*base64\s*,/i,
    // See: https://schema.org/Article
    jsonLdArticleTypes: /^Article|AdvertiserContentArticle|NewsArticle|AnalysisNewsArticle|AskPublicNewsArticle|BackgroundNewsArticle|OpinionNewsArticle|ReportageNewsArticle|ReviewNewsArticle|Report|SatiricalArticle|ScholarlyArticle|MedicalScholarlyArticle|SocialMediaPosting|BlogPosting|LiveBlogPosting|DiscussionForumPosting|TechArticle|APIReference$/
  },

  UNLIKELY_ROLES: [ "menu", "menubar", "complementary", "navigation", "alert", "alertdialog", "dialog" ],

  DIV_TO_P_ELEMS: new Set([ "BLOCKQUOTE", "DL", "DIV", "IMG", "OL", "P", "PRE", "TABLE", "UL" ]),

  ALTER_TO_DIV_EXCEPTIONS: ["DIV", "ARTICLE", "SECTION", "P"],

  PRESENTATIONAL_ATTRIBUTES: [ "align", "background", "bgcolor", "border", "cellpadding", "cellspacing", "frame", "hspace", "rules", "style", "valign", "vspace" ],

  DEPRECATED_SIZE_ATTRIBUTE_ELEMS: [ "TABLE", "TH", "TD", "HR", "PRE" ],

  // The commented out elements qualify as phrasing content but tend to be
  // removed by readability when put into paragraphs, so we ignore them here.
  PHRASING_ELEMS: [
    // "CANVAS", "IFRAME", "SVG", "VIDEO",
    "ABBR", "AUDIO", "B", "BDO", "BR", "BUTTON", "CITE", "CODE", "DATA",
    "DATALIST", "DFN", "EM", "EMBED", "I", "IMG", "INPUT", "KBD", "LABEL",
    "MARK", "MATH", "METER", "NOSCRIPT", "OBJECT", "OUTPUT", "PROGRESS", "Q",
    "RUBY", "SAMP", "SCRIPT", "SELECT", "SMALL", "SPAN", "STRONG", "SUB",
    "SUP", "TEXTAREA", "TIME", "VAR", "WBR"
  ],

  // These are the classes that readability sets itself.
  CLASSES_TO_PRESERVE: [ "page" ],

  // These are the list of HTML entities that need to be escaped.
  HTML_ESCAPE_MAP: {
    "lt": "<",
    "gt": ">",
    "amp": "&",
    "quot": '"',
    "apos": "'",
  },

  /**
   * Run any post-process modifications to article content as necessary.
   *
   * @param Element
   * @return void
  **/
  _postProcessContent: function(articleContent) {
    // Readability cannot open relative uris so we convert them to absolute uris.
    this._fixRelativeUris(articleContent);

    this._simplifyNestedElements(articleContent);

    if (!this._keepClasses) {
      // Remove classes.
      this._cleanClasses(articleContent);
    }
  },

  /**
   * Iterates over a NodeList, calls `filterFn` for each node and removes node
   * if function returned `true`.
   *
   * If function is not passed, removes all the nodes in node list.
   *
   * @param NodeList nodeList The nodes to operate on
   * @param Function filterFn the function to use as a filter
   * @return void
   */
  _removeNodes: function(nodeList, filterFn) {
    // Avoid ever operating on live node lists.
    if (this._docJSDOMParser && nodeList._isLiveNodeList) {
      throw new Error("Do not pass live node lists to _removeNodes");
    }
    for (var i = nodeList.length - 1; i >= 0; i--) {
      var node = nodeList[i];
      var parentNode = node.parentNode;
      if (parentNode) {
        if (!filterFn || filterFn.call(this, node, i, nodeList)) {
          parentNode.removeChild(node);
        }
      }
    }
  },

  /**
   * Iterates over a NodeList, and calls _setNodeTag for each node.
   *
   * @param NodeList nodeList The nodes to operate on
   * @param String newTagName the new tag name to use
   * @return void
   */
  _replaceNodeTags: function(nodeList, newTagName) {
    // Avoid ever operating on live node lists.
    if (this._docJSDOMParser && nodeList._isLiveNodeList) {
      throw new Error("Do not pass live node lists to _replaceNodeTags");
    }
    for (const node of nodeList) {
      this._setNodeTag(node, newTagName);
    }
  },

  /**
   * Iterate over a NodeList, which doesn't natively fully implement the Array
   * interface.
   *
   * For convenience, the current object context is applied to the provided
   * iterate function.
   *
   * @param  NodeList nodeList The NodeList.
   * @param  Function fn       The iterate function.
   * @return void
   */
  _forEachNode: function(nodeList, fn) {
    Array.prototype.forEach.call(nodeList, fn, this);
  },

  /**
   * Iterate over a NodeList, and return the first node that passes
   * the supplied test function
   *
   * For convenience, the current object context is applied to the provided
   * test function.
   *
   * @param  NodeList nodeList The NodeList.
   * @param  Function fn       The test function.
   * @return void
   */
  _findNode: function(nodeList, fn) {
    return Array.prototype.find.call(nodeList, fn, this);
  },

  /**
   * Iterate over a NodeList, return true if any of the provided iterate
   * function calls returns true, false otherwise.
   *
   * For convenience, the current object context is applied to the
   * provided iterate function.
   *
   * @param  NodeList nodeList The NodeList.
   * @param  Function fn       The iterate function.
   * @return Boolean
   */
  _someNode: function(nodeList, fn) {
    return Array.prototype.some.call(nodeList, fn, this);
  },

  /**
   * Iterate over a NodeList, return true if all of the provided iterate
   * function calls return true, false otherwise.
   *
   * For convenience, the current object context is applied to the
   * provided iterate function.
   *
   * @param  NodeList nodeList The NodeList.
   * @param  Function fn       The iterate function.
   * @return Boolean
   */
  _everyNode: function(nodeList, fn) {
    return Array.prototype.every.call(nodeList, fn, this);
  },

  /**
   * Concat all nodelists passed as arguments.
   *
   * @return ...NodeList
   * @return Array
   */
  _concatNodeLists: function() {
    var slice = Array.prototype.slice;
    var args = slice.call(arguments);
    var nodeLists = args.map(function(list) {
      return slice.call(list);
    });
    return Array.prototype.concat.apply([], nodeLists);
  },

  _getAllNodesWithTag: function(node, tagNames) {
    if (node.querySelectorAll) {
      return node.querySelectorAll(tagNames.join(","));
    }
    return [].concat.apply([], tagNames.map(function(tag) {
      var collection = node.getElementsByTagName(tag);
      return Array.isArray(collection) ? collection : Array.from(collection);
    }));
  },

  /**
   * Removes the class="" attribute from every element in the given
   * subtree, except those that match CLASSES_TO_PRESERVE and
   * the classesToPreserve array from the options object.
   *
   * @param Element
   * @return void
   */
  _cleanClasses: function(node) {
    var classesToPreserve = this._classesToPreserve;
    var className = (node.getAttribute("class") || "")
      .split(/\s+/)
      .filter(function(cls) {
        return classesToPreserve.indexOf(cls) != -1;
      })
      .join(" ");

    if (className) {
      node.setAttribute("class", className);
    } else {
      node.removeAttribute("class");
    }

    for (node = node.firstElementChild; node; node = node.nextElementSibling) {
      this._cleanClasses(node);
    }
  },

  /**
   * Converts each <a> and <img> uri in the given element to an absolute URI,
   * ignoring #ref URIs.
   *
   * @param Element
   * @return void
   */
  _fixRelativeUris: function(articleContent) {
    var baseURI = this._doc.baseURI;
    var documentURI = this._doc.documentURI;
    function toAbsoluteURI(uri) {
      // Leave hash links alone if the base URI matches the document URI:
      if (baseURI == documentURI && uri.charAt(0) == "#") {
        return uri;
      }

      // Otherwise, resolve against base URI:
      try {
        return new URL(uri, baseURI).href;
      } catch (ex) {
        // Something went wrong, just return the original:
      }
      return uri;
    }

    var links = this._getAllNodesWithTag(articleContent, ["a"]);
    this._forEachNode(links, function(link) {
      var href = link.getAttribute("href");
      if (href) {
        // Remove links with javascript: URIs, since
        // they won't work after scripts have been removed from the page.
        if (href.indexOf("javascript:") === 0) {
          // if the link only contains simple text content, it can be converted to a text node
          if (link.childNodes.length === 1 && link.childNodes[0].nodeType === this.TEXT_NODE) {
            var text = this._doc.createTextNode(link.textContent);
            link.parentNode.replaceChild(text, link);
          } else {
            // if the link has multiple children, they should all be preserved
            var container = this._doc.createElement("span");
            while (link.firstChild) {
              container.appendChild(link.firstChild);
            }
            link.parentNode.replaceChild(container, link);
          }
        } else {
          link.setAttribute("href", toAbsoluteURI(href));
        }
      }
    });

    var medias = this._getAllNodesWithTag(articleContent, [
      "img", "picture", "figure", "video", "audio", "source"
    ]);

    this._forEachNode(medias, function(media) {
      var src = media.getAttribute("src");
      var poster = media.getAttribute("poster");
      var srcset = media.getAttribute("srcset");

      if (src) {
        media.setAttribute("src", toAbsoluteURI(src));
      }

      if (poster) {
        media.setAttribute("poster", toAbsoluteURI(poster));
      }

      if (srcset) {
        var newSrcset = srcset.replace(this.REGEXPS.srcsetUrl, function(_, p1, p2, p3) {
          return toAbsoluteURI(p1) + (p2 || "") + p3;
        });

        media.setAttribute("srcset", newSrcset);
      }
    });
  },

  _simplifyNestedElements: function(articleContent) {
    var node = articleContent;

    while (node) {
      if (node.parentNode && ["DIV", "SECTION"].includes(node.tagName) && !(node.id && node.id.startsWith("readability"))) {
        if (this._isElementWithoutContent(node)) {
          node = this._removeAndGetNext(node);
          continue;
        } else if (this._hasSingleTagInsideElement(node, "DIV") || this._hasSingleTagInsideElement(node, "SECTION")) {
          var child = node.children[0];
          for (var i = 0; i < node.attributes.length; i++) {
            child.setAttribute(node.attributes[i].name, node.attributes[i].value);
          }
          node.parentNode.replaceChild(child, node);
          node = child;
          continue;
        }
      }

      node = this._getNextNode(node);
    }
  },

  /**
   * Get the article title as an H1.
   *
   * @return string
   **/
  _getArticleTitle: function() {
    var doc = this._doc;
    var curTitle = "";
    var origTitle = "";

    try {
      curTitle = origTitle = doc.title.trim();

      // If they had an element with id "title" in their HTML
      if (typeof curTitle !== "string")
        curTitle = origTitle = this._getInnerText(doc.getElementsByTagName("title")[0]);
    } catch (e) {/* ignore exceptions setting the title. */}

    var titleHadHierarchicalSeparators = false;
    function wordCount(str) {
      return str.split(/\s+/).length;
    }

    // If there's a separator in the title, first remove the final part
    if ((/ [\|\-\\\/>»] /).test(curTitle)) {
      titleHadHierarchicalSeparators = / [\\\/>»] /.test(curTitle);
      curTitle = origTitle.replace(/(.*)[\|\-\\\/>»] .*/gi, "$1");

      // If the resulting title is too short (3 words or fewer), remove
      // the first part instead:
      if (wordCount(curTitle) < 3)
        curTitle = origTitle.replace(/[^\|\-\\\/>»]*[\|\-\\\/>»](.*)/gi, "$1");
    } else if (curTitle.indexOf(": ") !== -1) {
      // Check if we have an heading containing this exact string, so we
      // could assume it's the full title.
      var headings = this._concatNodeLists(
        doc.getElementsByTagName("h1"),
        doc.getElementsByTagName("h2")
      );
      var trimmedTitle = curTitle.trim();
      var match = this._someNode(headings, function(heading) {
        return heading.textContent.trim() === trimmedTitle;
      });

      // If we don't, let's extract the title out of the original title string.
      if (!match) {
        curTitle = origTitle.substring(origTitle.lastIndexOf(":") + 1);

        // If the title is now too short, try the first colon instead:
        if (wordCount(curTitle) < 3) {
          curTitle = origTitle.substring(origTitle.indexOf(":") + 1);
          // But if we have too many words before the colon there's something weird
          // with the titles and the H tags so let's just use the original title instead
        } else if (wordCount(origTitle.substr(0, origTitle.indexOf(":"))) > 5) {
          curTitle = origTitle;
        }
      }
    } else if (curTitle.length > 150 || curTitle.length < 15) {
      var hOnes = doc.getElementsByTagName("h1");

      if (hOnes.length === 1)
        curTitle = this._getInnerText(hOnes[0]);
    }

    curTitle = curTitle.trim().replace(this.REGEXPS.normalize, " ");
    // If we now have 4 words or fewer as our title, and either no
    // 'hierarchical' separators (\, /, > or ») were found in the original
    // title or we decreased the number of words by more than 1 word, use
    // the original title.
    var curTitleWordCount = wordCount(curTitle);
    if (curTitleWordCount <= 4 &&
        (!titleHadHierarchicalSeparators ||
         curTitleWordCount != wordCount(origTitle.replace(/[\|\-\\\/>»]+/g, "")) - 1)) {
      curTitle = origTitle;
    }

    return curTitle;
  },

  /**
   * Prepare the HTML document for readability to scrape it.
   * This includes things like stripping javascript, CSS, and handling terrible markup.
   *
   * @return void
   **/
  _prepDocument: function() {
    var doc = this._doc;

    // Remove all style tags in head
    this._removeNodes(this._getAllNodesWithTag(doc, ["style"]));

    if (doc.body) {
      this._replaceBrs(doc.body);
    }

    this._replaceNodeTags(this._getAllNodesWithTag(doc, ["font"]), "SPAN");
  },

  /**
   * Finds the next node, starting from the given node, and ignoring
   * whitespace in between. If the given node is an element, the same node is
   * returned.
   */
  _nextNode: function (node) {
    var next = node;
    while (next
        && (next.nodeType != this.ELEMENT_NODE)
        && this.REGEXPS.whitespace.test(next.textContent)) {
      next = next.nextSibling;
    }
    return next;
  },

  /**
   * Replaces 2 or more successive <br> elements with a single <p>.
   * Whitespace between <br> elements are ignored. For example:
   *   <div>foo<br>bar<br> <br><br>abc</div>
   * will become:
   *   <div>foo<br>bar<p>abc</p></div>
   */
  _replaceBrs: function (elem) {
    this._forEachNode(this._getAllNodesWithTag(elem, ["br"]), function(br) {
      var next = br.nextSibling;

      // Whether 2 or more <br> elements have been found and replaced with a
      // <p> block.
      var replaced = false;

      // If we find a <br> chain, remove the <br>s until we hit another node
      // or non-whitespace. This leaves behind the first <br> in the chain
      // (which will be replaced with a <p> later).
      while ((next = this._nextNode(next)) && (next.tagName == "BR")) {
        replaced = true;
        var brSibling = next.nextSibling;
        next.parentNode.removeChild(next);
        next = brSibling;
      }

      // If we removed a <br> chain, replace the remaining <br> with a <p>. Add
      // all sibling nodes as children of the <p> until we hit another <br>
      // chain.
      if (replaced) {
        var p = this._doc.createElement("p");
        br.parentNode.replaceChild(p, br);

        next = p.nextSibling;
        while (next) {
          // If we've hit another <br><br>, we're done adding children to this <p>.
          if (next.tagName == "BR") {
            var nextElem = this._nextNode(next.nextSibling);
            if (nextElem && nextElem.tagName == "BR")
              break;
          }

          if (!this._isPhrasingContent(next))
            break;

          // Otherwise, make this node a child of the new <p>.
          var sibling = next.nextSibling;
          p.appendChild(next);
          next = sibling;
        }

        while (p.lastChild && this._isWhitespace(p.lastChild)) {
          p.removeChild(p.lastChild);
        }

        if (p.parentNode.tagName === "P")
          this._setNodeTag(p.parentNode, "DIV");
      }
    });
  },

  _setNodeTag: function (node, tag) {
    this.log("_setNodeTag", node, tag);
    if (this._docJSDOMParser) {
      node.localName = tag.toLowerCase();
      node.tagName = tag.toUpperCase();
      return node;
    }

    var replacement = node.ownerDocument.createElement(tag);
    while (node.firstChild) {
      replacement.appendChild(node.firstChild);
    }
    node.parentNode.replaceChild(replacement, node);
    if (node.readability)
      replacement.readability = node.readability;

    for (var i = 0; i < node.attributes.length; i++) {
      try {
        replacement.setAttribute(node.attributes[i].name, node.attributes[i].value);
      } catch (ex) {
        /* it's possible for setAttribute() to throw if the attribute name
         * isn't a valid XML Name. Such attributes can however be parsed from
         * source in HTML docs, see https://github.com/whatwg/html/issues/4275,
         * so we can hit them here and then throw. We don't care about such
         * attributes so we ignore them.
         */
      }
    }
    return replacement;
  },

  /**
   * Prepare the article node for display. Clean out any inline styles,
   * iframes, forms, strip extraneous <p> tags, etc.
   *
   * @param Element
   * @return void
   **/
  _prepArticle: function(articleContent) {
    this._cleanStyles(articleContent);

    // Check for data tables before we continue, to avoid removing items in
    // those tables, which will often be isolated even though they're
    // visually linked to other content-ful elements (text, images, etc.).
    this._markDataTables(articleContent);

    this._fixLazyImages(articleContent);

    // Clean out junk from the article content
    this._cleanConditionally(articleContent, "form");
    this._cleanConditionally(articleContent, "fieldset");
    this._clean(articleContent, "object");
    this._clean(articleContent, "embed");
    this._clean(articleContent, "footer");
    this._clean(articleContent, "link");
    this._clean(articleContent, "aside");

    // Clean out elements with little content that have "share" in their id/class combinations from final top candidates,
    // which means we don't remove the top candidates even they have "share".

    var shareElementThreshold = this.DEFAULT_CHAR_THRESHOLD;

    this._forEachNode(articleContent.children, function (topCandidate) {
      this._cleanMatchedNodes(topCandidate, function (node, matchString) {
        return this.REGEXPS.shareElements.test(matchString) && node.textContent.length < shareElementThreshold;
      });
    });

    this._clean(articleContent, "iframe");
    this._clean(articleContent, "input");
    this._clean(articleContent, "textarea");
    this._clean(articleContent, "select");
    this._clean(articleContent, "button");
    this._cleanHeaders(articleContent);

    // Do these last as the previous stuff may have removed junk
    // that will affect these
    this._cleanConditionally(articleContent, "table");
    this._cleanConditionally(articleContent, "ul");
    this._cleanConditionally(articleContent, "div");

    // replace H1 with H2 as H1 should be only title that is displayed separately
    this._replaceNodeTags(this._getAllNodesWithTag(articleContent, ["h1"]), "h2");

    // Remove extra paragraphs
    this._removeNodes(this._getAllNodesWithTag(articleContent, ["p"]), function (paragraph) {
      var imgCount = paragraph.getElementsByTagName("img").length;
      var embedCount = paragraph.getElementsByTagName("embed").length;
      var objectCount = paragraph.getElementsByTagName("object").length;
      // At this point, nasty iframes have been removed, only remain embedded video ones.
      var iframeCount = paragraph.getElementsByTagName("iframe").length;
      var totalCount = imgCount + embedCount + objectCount + iframeCount;

      return totalCount === 0 && !this._getInnerText(paragraph, false);
    });

    this._forEachNode(this._getAllNodesWithTag(articleContent, ["br"]), function(br) {
      var next = this._nextNode(br.nextSibling);
      if (next && next.tagName == "P")
        br.parentNode.removeChild(br);
    });

    // Remove single-cell tables
    this._forEachNode(this._getAllNodesWithTag(articleContent, ["table"]), function(table) {
      var tbody = this._hasSingleTagInsideElement(table, "TBODY") ? table.firstElementChild : table;
      if (this._hasSingleTagInsideElement(tbody, "TR")) {
        var row = tbody.firstElementChild;
        if (this._hasSingleTagInsideElement(row, "TD")) {
          var cell = row.firstElementChild;
          cell = this._setNodeTag(cell, this._everyNode(cell.childNodes, this._isPhrasingContent) ? "P" : "DIV");
          table.parentNode.replaceChild(cell, table);
        }
      }
    });
  },

  /**
   * Initialize a node with the readability object. Also checks the
   * className/id for special names to add to its score.
   *
   * @param Element
   * @return void
  **/
  _initializeNode: function(node) {
    node.readability = {"contentScore": 0};

    switch (node.tagName) {
      case "DIV":
        node.readability.contentScore += 5;
        break;

      case "PRE":
      case "TD":
      case "BLOCKQUOTE":
        node.readability.contentScore += 3;
        break;

      case "ADDRESS":
      case "OL":
      case "UL":
      case "DL":
      case "DD":
      case "DT":
      case "LI":
      case "FORM":
        node.readability.contentScore -= 3;
        break;

      case "H1":
      case "H2":
      case "H3":
      case "H4":
      case "H5":
      case "H6":
      case "TH":
        node.readability.contentScore -= 5;
        break;
    }

    node.readability.contentScore += this._getClassWeight(node);
  },

  _removeAndGetNext: function(node) {
    var nextNode = this._getNextNode(node, true);
    node.parentNode.removeChild(node);
    return nextNode;
  },

  /**
   * Traverse the DOM from node to node, starting at the node passed in.
   * Pass true for the second parameter to indicate this node itself
   * (and its kids) are going away, and we want the next node over.
   *
   * Calling this in a loop will traverse the DOM depth-first.
   */
  _getNextNode: function(node, ignoreSelfAndKids) {
    // First check for kids if those aren't being ignored
    if (!ignoreSelfAndKids && node.firstElementChild) {
      return node.firstElementChild;
    }
    // Then for siblings...
    if (node.nextElementSibling) {
      return node.nextElementSibling;
    }
    // And finally, move up the parent chain *and* find a sibling
    // (because this is depth-first traversal, we will have already
    // seen the parent nodes themselves).
    do {
      node = node.parentNode;
    } while (node && !node.nextElementSibling);
    return node && node.nextElementSibling;
  },

  // compares second text to first one
  // 1 = same text, 0 = completely different text
  // works the way that it splits both texts into words and then finds words that are unique in second text
  // the result is given by the lower length of unique parts
  _textSimilarity: function(textA, textB) {
    var tokensA = textA.toLowerCase().split(this.REGEXPS.tokenize).filter(Boolean);
    var tokensB = textB.toLowerCase().split(this.REGEXPS.tokenize).filter(Boolean);
    if (!tokensA.length || !tokensB.length) {
      return 0;
    }
    var uniqTokensB = tokensB.filter(token => !tokensA.includes(token));
    var distanceB = uniqTokensB.join(" ").length / tokensB.join(" ").length;
    return 1 - distanceB;
  },

  _checkByline: function(node, matchString) {
    if (this._articleByline) {
      return false;
    }

    if (node.getAttribute !== undefined) {
      var rel = node.getAttribute("rel");
      var itemprop = node.getAttribute("itemprop");
    }

    if ((rel === "author" || (itemprop && itemprop.indexOf("author") !== -1) || this.REGEXPS.byline.test(matchString)) && this._isValidByline(node.textContent)) {
      this._articleByline = node.textContent.trim();
      return true;
    }

    return false;
  },

  _getNodeAncestors: function(node, maxDepth) {
    maxDepth = maxDepth || 0;
    var i = 0, ancestors = [];
    while (node.parentNode) {
      ancestors.push(node.parentNode);
      if (maxDepth && ++i === maxDepth)
        break;
      node = node.parentNode;
    }
    return ancestors;
  },

  /***
   * grabArticle - Using a variety of metrics (content score, classname, element types), find the content that is
   *         most likely to be the stuff a user wants to read. Then return it wrapped up in a div.
   *
   * @param page a document to run upon. Needs to be a full document, complete with body.
   * @return Element
  **/
  _grabArticle: function (page) {
    this.log("**** grabArticle ****");
    var doc = this._doc;
    var isPaging = page !== null;
    page = page ? page : this._doc.body;

    // We can't grab an article if we don't have a page!
    if (!page) {
      this.log("No body found in document. Abort.");
      return null;
    }

    var pageCacheHtml = page.innerHTML;

    while (true) {
      this.log("Starting grabArticle loop");
      var stripUnlikelyCandidates = this._flagIsActive(this.FLAG_STRIP_UNLIKELYS);

      // First, node prepping. Trash nodes that look cruddy (like ones with the
      // class name "comment", etc), and turn divs into P tags where they have been
      // used inappropriately (as in, where they contain no other block level elements.)
      var elementsToScore = [];
      var node = this._doc.documentElement;

      let shouldRemoveTitleHeader = true;

      while (node) {

        if (node.tagName === "HTML") {
          this._articleLang = node.getAttribute("lang");
        }

        var matchString = node.className + " " + node.id;

        if (!this._isProbablyVisible(node)) {
          this.log("Removing hidden node - " + matchString);
          node = this._removeAndGetNext(node);
          continue;
        }

        // User is not able to see elements applied with both "aria-modal = true" and "role = dialog"
        if (node.getAttribute("aria-modal") == "true" && node.getAttribute("role") == "dialog") {
          node = this._removeAndGetNext(node);
          continue;
        }

        // Check to see if this node is a byline, and remove it if it is.
        if (this._checkByline(node, matchString)) {
          node = this._removeAndGetNext(node);
          continue;
        }

        if (shouldRemoveTitleHeader && this._headerDuplicatesTitle(node)) {
          this.log("Removing header: ", node.textContent.trim(), this._articleTitle.trim());
          shouldRemoveTitleHeader = false;
          node = this._removeAndGetNext(node);
          continue;
        }

        // Remove unlikely candidates
        if (stripUnlikelyCandidates) {
          if (this.REGEXPS.unlikelyCandidates.test(matchString) &&
              !this.REGEXPS.okMaybeItsACandidate.test(matchString) &&
              !this._hasAncestorTag(node, "table") &&
              !this._hasAncestorTag(node, "code") &&
              node.tagName !== "BODY" &&
              node.tagName !== "A") {
            this.log("Removing unlikely candidate - " + matchString);
            node = this._removeAndGetNext(node);
            continue;
          }

          if (this.UNLIKELY_ROLES.includes(node.getAttribute("role"))) {
            this.log("Removing content with role " + node.getAttribute("role") + " - " + matchString);
            node = this._removeAndGetNext(node);
            continue;
          }
        }

        // Remove DIV, SECTION, and HEADER nodes without any content(e.g. text, image, video, or iframe).
        if ((node.tagName === "DIV" || node.tagName === "SECTION" || node.tagName === "HEADER" ||
             node.tagName === "H1" || node.tagName === "H2" || node.tagName === "H3" ||
             node.tagName === "H4" || node.tagName === "H5" || node.tagName === "H6") &&
            this._isElementWithoutContent(node)) {
          node = this._removeAndGetNext(node);
          continue;
        }

        if (this.DEFAULT_TAGS_TO_SCORE.indexOf(node.tagName) !== -1) {
          elementsToScore.push(node);
        }

        // Turn all divs that don't have children block level elements into p's
        if (node.tagName === "DIV") {
          // Put phrasing content into paragraphs.
          var p = null;
          var childNode = node.firstChild;
          while (childNode) {
            var nextSibling = childNode.nextSibling;
            if (this._isPhrasingContent(childNode)) {
              if (p !== null) {
                p.appendChild(childNode);
              } else if (!this._isWhitespace(childNode)) {
                p = doc.createElement("p");
                node.replaceChild(p, childNode);
                p.appendChild(childNode);
              }
            } else if (p !== null) {
              while (p.lastChild && this._isWhitespace(p.lastChild)) {
                p.removeChild(p.lastChild);
              }
              p = null;
            }
            childNode = nextSibling;
          }

          // Sites like http://mobile.slate.com encloses each paragraph with a DIV
          // element. DIVs with only a P element inside and no text content can be
          // safely converted into plain P elements to avoid confusing the scoring
          // algorithm with DIVs with are, in practice, paragraphs.
          if (this._hasSingleTagInsideElement(node, "P") && this._getLinkDensity(node) < 0.25) {
            var newNode = node.children[0];
            node.parentNode.replaceChild(newNode, node);
            node = newNode;
            elementsToScore.push(node);
          } else if (!this._hasChildBlockElement(node)) {
            node = this._setNodeTag(node, "P");
            elementsToScore.push(node);
          }
        }
        node = this._getNextNode(node);
      }

      /**
       * Loop through all paragraphs, and assign a score to them based on how content-y they look.
       * Then add their score to their parent node.
       *
       * A score is determined by things like number of commas, class names, etc. Maybe eventually link density.
      **/
      var candidates = [];
      this._forEachNode(elementsToScore, function(elementToScore) {
        if (!elementToScore.parentNode || typeof(elementToScore.parentNode.tagName) === "undefined")
          return;

        // If this paragraph is less than 25 characters, don't even count it.
        var innerText = this._getInnerText(elementToScore);
        if (innerText.length < 25)
          return;

        // Exclude nodes with no ancestor.
        var ancestors = this._getNodeAncestors(elementToScore, 5);
        if (ancestors.length === 0)
          return;

        var contentScore = 0;

        // Add a point for the paragraph itself as a base.
        contentScore += 1;

        // Add points for any commas within this paragraph.
        contentScore += innerText.split(",").length;

        // For every 100 characters in this paragraph, add another point. Up to 3 points.
        contentScore += Math.min(Math.floor(innerText.length / 100), 3);

        // Initialize and score ancestors.
        this._forEachNode(ancestors, function(ancestor, level) {
          if (!ancestor.tagName || !ancestor.parentNode || typeof(ancestor.parentNode.tagName) === "undefined")
            return;

          if (typeof(ancestor.readability) === "undefined") {
            this._initializeNode(ancestor);
            candidates.push(ancestor);
          }

          // Node score divider:
          // - parent:             1 (no division)
          // - grandparent:        2
          // - great grandparent+: ancestor level * 3
          if (level === 0)
            var scoreDivider = 1;
          else if (level === 1)
            scoreDivider = 2;
          else
            scoreDivider = level * 3;
          ancestor.readability.contentScore += contentScore / scoreDivider;
        });
      });

      // After we've calculated scores, loop through all of the possible
      // candidate nodes we found and find the one with the highest score.
      var topCandidates = [];
      for (var c = 0, cl = candidates.length; c < cl; c += 1) {
        var candidate = candidates[c];

        // Scale the final candidates score based on link density. Good content
        // should have a relatively small link density (5% or less) and be mostly
        // unaffected by this operation.
        var candidateScore = candidate.readability.contentScore * (1 - this._getLinkDensity(candidate));
        candidate.readability.contentScore = candidateScore;

        this.log("Candidate:", candidate, "with score " + candidateScore);

        for (var t = 0; t < this._nbTopCandidates; t++) {
          var aTopCandidate = topCandidates[t];

          if (!aTopCandidate || candidateScore > aTopCandidate.readability.contentScore) {
            topCandidates.splice(t, 0, candidate);
            if (topCandidates.length > this._nbTopCandidates)
              topCandidates.pop();
            break;
          }
        }
      }

      var topCandidate = topCandidates[0] || null;
      var neededToCreateTopCandidate = false;
      var parentOfTopCandidate;

      // If we still have no top candidate, just use the body as a last resort.
      // We also have to copy the body node so it is something we can modify.
      if (topCandidate === null || topCandidate.tagName === "BODY") {
        // Move all of the page's children into topCandidate
        topCandidate = doc.createElement("DIV");
        neededToCreateTopCandidate = true;
        // Move everything (not just elements, also text nodes etc.) into the container
        // so we even include text directly in the body:
        while (page.firstChild) {
          this.log("Moving child out:", page.firstChild);
          topCandidate.appendChild(page.firstChild);
        }

        page.appendChild(topCandidate);

        this._initializeNode(topCandidate);
      } else if (topCandidate) {
        // Find a better top candidate node if it contains (at least three) nodes which belong to `topCandidates` array
        // and whose scores are quite closed with current `topCandidate` node.
        var alternativeCandidateAncestors = [];
        for (var i = 1; i < topCandidates.length; i++) {
          if (topCandidates[i].readability.contentScore / topCandidate.readability.contentScore >= 0.75) {
            alternativeCandidateAncestors.push(this._getNodeAncestors(topCandidates[i]));
          }
        }
        var MINIMUM_TOPCANDIDATES = 3;
        if (alternativeCandidateAncestors.length >= MINIMUM_TOPCANDIDATES) {
          parentOfTopCandidate = topCandidate.parentNode;
          while (parentOfTopCandidate.tagName !== "BODY") {
            var listsContainingThisAncestor = 0;
            for (var ancestorIndex = 0; ancestorIndex < alternativeCandidateAncestors.length && listsContainingThisAncestor < MINIMUM_TOPCANDIDATES; ancestorIndex++) {
              listsContainingThisAncestor += Number(alternativeCandidateAncestors[ancestorIndex].includes(parentOfTopCandidate));
            }
            if (listsContainingThisAncestor >= MINIMUM_TOPCANDIDATES) {
              topCandidate = parentOfTopCandidate;
              break;
            }
            parentOfTopCandidate = parentOfTopCandidate.parentNode;
          }
        }
        if (!topCandidate.readability) {
          this._initializeNode(topCandidate);
        }

        // Because of our bonus system, parents of candidates might have scores
        // themselves. They get half of the node. There won't be nodes with higher
        // scores than our topCandidate, but if we see the score going *up* in the first
        // few steps up the tree, that's a decent sign that there might be more content
        // lurking in other places that we want to unify in. The sibling stuff
        // below does some of that - but only if we've looked high enough up the DOM
        // tree.
        parentOfTopCandidate = topCandidate.parentNode;
        var lastScore = topCandidate.readability.contentScore;
        // The scores shouldn't get too low.
        var scoreThreshold = lastScore / 3;
        while (parentOfTopCandidate.tagName !== "BODY") {
          if (!parentOfTopCandidate.readability) {
            parentOfTopCandidate = parentOfTopCandidate.parentNode;
            continue;
          }
          var parentScore = parentOfTopCandidate.readability.contentScore;
          if (parentScore < scoreThreshold)
            break;
          if (parentScore > lastScore) {
            // Alright! We found a better parent to use.
            topCandidate = parentOfTopCandidate;
            break;
          }
          lastScore = parentOfTopCandidate.readability.contentScore;
          parentOfTopCandidate = parentOfTopCandidate.parentNode;
        }

        // If the top candidate is the only child, use parent instead. This will help sibling
        // joining logic when adjacent content is actually located in parent's sibling node.
        parentOfTopCandidate = topCandidate.parentNode;
        while (parentOfTopCandidate.tagName != "BODY" && parentOfTopCandidate.children.length == 1) {
          topCandidate = parentOfTopCandidate;
          parentOfTopCandidate = topCandidate.parentNode;
        }
        if (!topCandidate.readability) {
          this._initializeNode(topCandidate);
        }
      }

      // Now that we have the top candidate, look through its siblings for content
      // that might also be related. Things like preambles, content split by ads
      // that we removed, etc.
      var articleContent = doc.createElement("DIV");
      if (isPaging)
        articleContent.id = "readability-content";

      var siblingScoreThreshold = Math.max(10, topCandidate.readability.contentScore * 0.2);
      // Keep potential top candidate's parent node to try to get text direction of it later.
      parentOfTopCandidate = topCandidate.parentNode;
      var siblings = parentOfTopCandidate.children;

      for (var s = 0, sl = siblings.length; s < sl; s++) {
        var sibling = siblings[s];
        var append = false;

        this.log("Looking at sibling node:", sibling, sibling.readability ? ("with score " + sibling.readability.contentScore) : "");
        this.log("Sibling has score", sibling.readability ? sibling.readability.contentScore : "Unknown");

        if (sibling === topCandidate) {
          append = true;
        } else {
          var contentBonus = 0;

          // Give a bonus if sibling nodes and top candidates have the example same classname
          if (sibling.className === topCandidate.className && topCandidate.className !== "")
            contentBonus += topCandidate.readability.contentScore * 0.2;

          if (sibling.readability &&
              ((sibling.readability.contentScore + contentBonus) >= siblingScoreThreshold)) {
            append = true;
          } else if (sibling.nodeName === "P") {
            var linkDensity = this._getLinkDensity(sibling);
            var nodeContent = this._getInnerText(sibling);
            var nodeLength = nodeContent.length;

            if (nodeLength > 80 && linkDensity < 0.25) {
              append = true;
            } else if (nodeLength < 80 && nodeLength > 0 && linkDensity === 0 &&
                       nodeContent.search(/\.( |$)/) !== -1) {
              append = true;
            }
          }
        }

        if (append) {
          this.log("Appending node:", sibling);

          if (this.ALTER_TO_DIV_EXCEPTIONS.indexOf(sibling.nodeName) === -1) {
            // We have a node that isn't a common block level element, like a form or td tag.
            // Turn it into a div so it doesn't get filtered out later by accident.
            this.log("Altering sibling:", sibling, "to div.");

            sibling = this._setNodeTag(sibling, "DIV");
          }

          articleContent.appendChild(sibling);
          // Fetch children again to make it compatible
          // with DOM parsers without live collection support.
          siblings = parentOfTopCandidate.children;
          // siblings is a reference to the children array, and
          // sibling is removed from the array when we call appendChild().
          // As a result, we must revisit this index since the nodes
          // have been shifted.
          s -= 1;
          sl -= 1;
        }
      }

      if (this._debug)
        this.log("Article content pre-prep: " + articleContent.innerHTML);
      // So we have all of the content that we need. Now we clean it up for presentation.
      this._prepArticle(articleContent);
      if (this._debug)
        this.log("Article content post-prep: " + articleContent.innerHTML);

      if (neededToCreateTopCandidate) {
        // We already created a fake div thing, and there wouldn't have been any siblings left
        // for the previous loop, so there's no point trying to create a new div, and then
        // move all the children over. Just assign IDs and class names here. No need to append
        // because that already happened anyway.
        topCandidate.id = "readability-page-1";
        topCandidate.className = "page";
      } else {
        var div = doc.createElement("DIV");
        div.id = "readability-page-1";
        div.className = "page";
        while (articleContent.firstChild) {
          div.appendChild(articleContent.firstChild);
        }
        articleContent.appendChild(div);
      }

      if (this._debug)
        this.log("Article content after paging: " + articleContent.innerHTML);

      var parseSuccessful = true;

      // Now that we've gone through the full algorithm, check to see if
      // we got any meaningful content. If we didn't, we may need to re-run
      // grabArticle with different flags set. This gives us a higher likelihood of
      // finding the content, and the sieve approach gives us a higher likelihood of
      // finding the -right- content.
      var textLength = this._getInnerText(articleContent, true).length;
      if (textLength < this._charThreshold) {
        parseSuccessful = false;
        page.innerHTML = pageCacheHtml;

        if (this._flagIsActive(this.FLAG_STRIP_UNLIKELYS)) {
          this._removeFlag(this.FLAG_STRIP_UNLIKELYS);
          this._attempts.push({articleContent: articleContent, textLength: textLength});
        } else if (this._flagIsActive(this.FLAG_WEIGHT_CLASSES)) {
          this._removeFlag(this.FLAG_WEIGHT_CLASSES);
          this._attempts.push({articleContent: articleContent, textLength: textLength});
        } else if (this._flagIsActive(this.FLAG_CLEAN_CONDITIONALLY)) {
          this._removeFlag(this.FLAG_CLEAN_CONDITIONALLY);
          this._attempts.push({articleContent: articleContent, textLength: textLength});
        } else {
          this._attempts.push({articleContent: articleContent, textLength: textLength});
          // No luck after removing flags, just return the longest text we found during the different loops
          this._attempts.sort(function (a, b) {
            return b.textLength - a.textLength;
          });

          // But first check if we actually have something
          if (!this._attempts[0].textLength) {
            return null;
          }

          articleContent = this._attempts[0].articleContent;
          parseSuccessful = true;
        }
      }

      if (parseSuccessful) {
        // Find out text direction from ancestors of final top candidate.
        var ancestors = [parentOfTopCandidate, topCandidate].concat(this._getNodeAncestors(parentOfTopCandidate));
        this._someNode(ancestors, function(ancestor) {
          if (!ancestor.tagName)
            return false;
          var articleDir = ancestor.getAttribute("dir");
          if (articleDir) {
            this._articleDir = articleDir;
            return true;
          }
          return false;
        });
        return articleContent;
      }
    }
  },

  /**
   * Check whether the input string could be a byline.
   * This verifies that the input is a string, and that the length
   * is less than 100 chars.
   *
   * @param possibleByline {string} - a string to check whether its a byline.
   * @return Boolean - whether the input string is a byline.
   */
  _isValidByline: function(byline) {
    if (typeof byline == "string" || byline instanceof String) {
      byline = byline.trim();
      return (byline.length > 0) && (byline.length < 100);
    }
    return false;
  },

  /**
   * Converts some of the common HTML entities in string to their corresponding characters.
   *
   * @param str {string} - a string to unescape.
   * @return string without HTML entity.
   */
  _unescapeHtmlEntities: function(str) {
    if (!str) {
      return str;
    }

    var htmlEscapeMap = this.HTML_ESCAPE_MAP;
    return str.replace(/&(quot|amp|apos|lt|gt);/g, function(_, tag) {
      return htmlEscapeMap[tag];
    }).replace(/&#(?:x([0-9a-z]{1,4})|([0-9]{1,4}));/gi, function(_, hex, numStr) {
      var num = parseInt(hex || numStr, hex ? 16 : 10);
      return String.fromCharCode(num);
    });
  },

  /**
   * Try to extract metadata from JSON-LD object.
   * For now, only Schema.org objects of type Article or its subtypes are supported.
   * @return Object with any metadata that could be extracted (possibly none)
   */
  _getJSONLD: function (doc) {
    var scripts = this._getAllNodesWithTag(doc, ["script"]);

    var metadata;

    this._forEachNode(scripts, function(jsonLdElement) {
      if (!metadata && jsonLdElement.getAttribute("type") === "application/ld+json") {
        try {
          // Strip CDATA markers if present
          var content = jsonLdElement.textContent.replace(/^\s*<!\[CDATA\[|\]\]>\s*$/g, "");
          var parsed = JSON.parse(content);
          if (
            !parsed["@context"] ||
            !parsed["@context"].match(/^https?\:\/\/schema\.org$/)
          ) {
            return;
          }

          if (!parsed["@type"] && Array.isArray(parsed["@graph"])) {
            parsed = parsed["@graph"].find(function(it) {
              return (it["@type"] || "").match(
                this.REGEXPS.jsonLdArticleTypes
              );
            });
          }

          if (
            !parsed ||
            !parsed["@type"] ||
            !parsed["@type"].match(this.REGEXPS.jsonLdArticleTypes)
          ) {
            return;
          }

          metadata = {};

          if (typeof parsed.name === "string" && typeof parsed.headline === "string" && parsed.name !== parsed.headline) {
            // we have both name and headline element in the JSON-LD. They should both be the same but some websites like aktualne.cz
            // put their own name into "name" and the article title to "headline" which confuses Readability. So we try to check if either
            // "name" or "headline" closely matches the html title, and if so, use that one. If not, then we use "name" by default.

            var title = this._getArticleTitle();
            var nameMatches = this._textSimilarity(parsed.name, title) > 0.75;
            var headlineMatches = this._textSimilarity(parsed.headline, title) > 0.75;

            if (headlineMatches && !nameMatches) {
              metadata.title = parsed.headline;
            } else {
              metadata.title = parsed.name;
            }
          } else if (typeof parsed.name === "string") {
            metadata.title = parsed.name.trim();
          } else if (typeof parsed.headline === "string") {
            metadata.title = parsed.headline.trim();
          }
          if (parsed.author) {
            if (typeof parsed.author.name === "string") {
              metadata.byline = parsed.author.name.trim();
            } else if (Array.isArray(parsed.author) && parsed.author[0] && typeof parsed.author[0].name === "string") {
              metadata.byline = parsed.author
                .filter(function(author) {
                  return author && typeof author.name === "string";
                })
                .map(function(author) {
                  return author.name.trim();
                })
                .join(", ");
            }
          }
          if (typeof parsed.description === "string") {
            metadata.excerpt = parsed.description.trim();
          }
          if (
            parsed.publisher &&
            typeof parsed.publisher.name === "string"
          ) {
            metadata.siteName = parsed.publisher.name.trim();
          }
          return;
        } catch (err) {
          this.log(err.message);
        }
      }
    });
    return metadata ? metadata : {};
  },

  /**
   * Attempts to get excerpt and byline metadata for the article.
   *
   * @param {Object} jsonld — object containing any metadata that
   * could be extracted from JSON-LD object.
   *
   * @return Object with optional "excerpt" and "byline" properties
   */
  _getArticleMetadata: function(jsonld) {
    var metadata = {};
    var values = {};
    var metaElements = this._doc.getElementsByTagName("meta");

    // property is a space-separated list of values
    var propertyPattern = /\s*(dc|dcterm|og|twitter)\s*:\s*(author|creator|description|title|site_name)\s*/gi;

    // name is a single value
    var namePattern = /^\s*(?:(dc|dcterm|og|twitter|weibo:(article|webpage))\s*[\.:]\s*)?(author|creator|description|title|site_name)\s*$/i;

    // Find description tags.
    this._forEachNode(metaElements, function(element) {
      var elementName = element.getAttribute("name");
      var elementProperty = element.getAttribute("property");
      var content = element.getAttribute("content");
      if (!content) {
        return;
      }
      var matches = null;
      var name = null;

      if (elementProperty) {
        matches = elementProperty.match(propertyPattern);
        if (matches) {
          // Convert to lowercase, and remove any whitespace
          // so we can match below.
          name = matches[0].toLowerCase().replace(/\s/g, "");
          // multiple authors
          values[name] = content.trim();
        }
      }
      if (!matches && elementName && namePattern.test(elementName)) {
        name = elementName;
        if (content) {
          // Convert to lowercase, remove any whitespace, and convert dots
          // to colons so we can match below.
          name = name.toLowerCase().replace(/\s/g, "").replace(/\./g, ":");
          values[name] = content.trim();
        }
      }
    });

    // get title
    metadata.title = jsonld.title ||
                     values["dc:title"] ||
                     values["dcterm:title"] ||
                     values["og:title"] ||
                     values["weibo:article:title"] ||
                     values["weibo:webpage:title"] ||
                     values["title"] ||
                     values["twitter:title"];

    if (!metadata.title) {
      metadata.title = this._getArticleTitle();
    }

    // get author
    metadata.byline = jsonld.byline ||
                      values["dc:creator"] ||
                      values["dcterm:creator"] ||
                      values["author"];

    // get description
    metadata.excerpt = jsonld.excerpt ||
                       values["dc:description"] ||
                       values["dcterm:description"] ||
                       values["og:description"] ||
                       values["weibo:article:description"] ||
                       values["weibo:webpage:description"] ||
                       values["description"] ||
                       values["twitter:description"];

    // get site name
    metadata.siteName = jsonld.siteName ||
                        values["og:site_name"];

    // in many sites the meta value is escaped with HTML entities,
    // so here we need to unescape it
    metadata.title = this._unescapeHtmlEntities(metadata.title);
    metadata.byline = this._unescapeHtmlEntities(metadata.byline);
    metadata.excerpt = this._unescapeHtmlEntities(metadata.excerpt);
    metadata.siteName = this._unescapeHtmlEntities(metadata.siteName);

    return metadata;
  },

  /**
   * Check if node is image, or if node contains exactly only one image
   * whether as a direct child or as its descendants.
   *
   * @param Element
  **/
  _isSingleImage: function(node) {
    if (node.tagName === "IMG") {
      return true;
    }

    if (node.children.length !== 1 || node.textContent.trim() !== "") {
      return false;
    }

    return this._isSingleImage(node.children[0]);
  },

  /**
   * Find all <noscript> that are located after <img> nodes, and which contain only one
   * <img> element. Replace the first image with the image from inside the <noscript> tag,
   * and remove the <noscript> tag. This improves the quality of the images we use on
   * some sites (e.g. Medium).
   *
   * @param Element
  **/
  _unwrapNoscriptImages: function(doc) {
    // Find img without source or attributes that might contains image, and remove it.
    // This is done to prevent a placeholder img is replaced by img from noscript in next step.
    var imgs = Array.from(doc.getElementsByTagName("img"));
    this._forEachNode(imgs, function(img) {
      for (var i = 0; i < img.attributes.length; i++) {
        var attr = img.attributes[i];
        switch (attr.name) {
          case "src":
          case "srcset":
          case "data-src":
          case "data-srcset":
            return;
        }

        if (/\.(jpg|jpeg|png|webp)/i.test(attr.value)) {
          return;
        }
      }

      img.parentNode.removeChild(img);
    });

    // Next find noscript and try to extract its image
    var noscripts = Array.from(doc.getElementsByTagName("noscript"));
    this._forEachNode(noscripts, function(noscript) {
      // Parse content of noscript and make sure it only contains image
      var tmp = doc.createElement("div");
      tmp.innerHTML = noscript.innerHTML;
      if (!this._isSingleImage(tmp)) {
        return;
      }

      // If noscript has previous sibling and it only contains image,
      // replace it with noscript content. However we also keep old
      // attributes that might contains image.
      var prevElement = noscript.previousElementSibling;
      if (prevElement && this._isSingleImage(prevElement)) {
        var prevImg = prevElement;
        if (prevImg.tagName !== "IMG") {
          prevImg = prevElement.getElementsByTagName("img")[0];
        }

        var newImg = tmp.getElementsByTagName("img")[0];
        for (var i = 0; i < prevImg.attributes.length; i++) {
          var attr = prevImg.attributes[i];
          if (attr.value === "") {
            continue;
          }

          if (attr.name === "src" || attr.name === "srcset" || /\.(jpg|jpeg|png|webp)/i.test(attr.value)) {
            if (newImg.getAttribute(attr.name) === attr.value) {
              continue;
            }

            var attrName = attr.name;
            if (newImg.hasAttribute(attrName)) {
              attrName = "data-old-" + attrName;
            }

            newImg.setAttribute(attrName, attr.value);
          }
        }

        noscript.parentNode.replaceChild(tmp.firstElementChild, prevElement);
      }
    });
  },

  /**
   * Removes script tags from the document.
   *
   * @param Element
  **/
  _removeScripts: function(doc) {
    this._removeNodes(this._getAllNodesWithTag(doc, ["script", "noscript"]));
  },

  /**
   * Check if this node has only whitespace and a single element with given tag
   * Returns false if the DIV node contains non-empty text nodes
   * or if it contains no element with given tag or more than 1 element.
   *
   * @param Element
   * @param string tag of child element
  **/
  _hasSingleTagInsideElement: function(element, tag) {
    // There should be exactly 1 element child with given tag
    if (element.children.length != 1 || element.children[0].tagName !== tag) {
      return false;
    }

    // And there should be no text nodes with real content
    return !this._someNode(element.childNodes, function(node) {
      return node.nodeType === this.TEXT_NODE &&
             this.REGEXPS.hasContent.test(node.textContent);
    });
  },

  _isElementWithoutContent: function(node) {
    return node.nodeType === this.ELEMENT_NODE &&
      node.textContent.trim().length == 0 &&
      (node.children.length == 0 ||
       node.children.length == node.getElementsByTagName("br").length + node.getElementsByTagName("hr").length);
  },

  /**
   * Determine whether element has any children block level elements.
   *
   * @param Element
   */
  _hasChildBlockElement: function (element) {
    return this._someNode(element.childNodes, function(node) {
      return this.DIV_TO_P_ELEMS.has(node.tagName) ||
             this._hasChildBlockElement(node);
    });
  },

  /***
   * Determine if a node qualifies as phrasing content.
   * https://developer.mozilla.org/en-US/docs/Web/Guide/HTML/Content_categories#Phrasing_content
  **/
  _isPhrasingContent: function(node) {
    return node.nodeType === this.TEXT_NODE || this.PHRASING_ELEMS.indexOf(node.tagName) !== -1 ||
      ((node.tagName === "A" || node.tagName === "DEL" || node.tagName === "INS") &&
        this._everyNode(node.childNodes, this._isPhrasingContent));
  },

  _isWhitespace: function(node) {
    return (node.nodeType === this.TEXT_NODE && node.textContent.trim().length === 0) ||
           (node.nodeType === this.ELEMENT_NODE && node.tagName === "BR");
  },

  /**
   * Get the inner text of a node - cross browser compatibly.
   * This also strips out any excess whitespace to be found.
   *
   * @param Element
   * @param Boolean normalizeSpaces (default: true)
   * @return string
  **/
  _getInnerText: function(e, normalizeSpaces) {
    normalizeSpaces = (typeof normalizeSpaces === "undefined") ? true : normalizeSpaces;
    var textContent = e.textContent.trim();

    if (normalizeSpaces) {
      return textContent.replace(this.REGEXPS.normalize, " ");
    }
    return textContent;
  },

  /**
   * Get the number of times a string s appears in the node e.
   *
   * @param Element
   * @param string - what to split on. Default is ","
   * @return number (integer)
  **/
  _getCharCount: function(e, s) {
    s = s || ",";
    return this._getInnerText(e).split(s).length - 1;
  },

  /**
   * Remove the style attribute on every e and under.
   * TODO: Test if getElementsByTagName(*) is faster.
   *
   * @param Element
   * @return void
  **/
  _cleanStyles: function(e) {
    if (!e || e.tagName.toLowerCase() === "svg")
      return;

    // Remove `style` and deprecated presentational attributes
    for (var i = 0; i < this.PRESENTATIONAL_ATTRIBUTES.length; i++) {
      e.removeAttribute(this.PRESENTATIONAL_ATTRIBUTES[i]);
    }

    if (this.DEPRECATED_SIZE_ATTRIBUTE_ELEMS.indexOf(e.tagName) !== -1) {
      e.removeAttribute("width");
      e.removeAttribute("height");
    }

    var cur = e.firstElementChild;
    while (cur !== null) {
      this._cleanStyles(cur);
      cur = cur.nextElementSibling;
    }
  },

  /**
   * Get the density of links as a percentage of the content
   * This is the amount of text that is inside a link divided by the total text in the node.
   *
   * @param Element
   * @return number (float)
  **/
  _getLinkDensity: function(element) {
    var textLength = this._getInnerText(element).length;
    if (textLength === 0)
      return 0;

    var linkLength = 0;

    // XXX implement _reduceNodeList?
    this._forEachNode(element.getElementsByTagName("a"), function(linkNode) {
      var href = linkNode.getAttribute("href");
      var coefficient = href && this.REGEXPS.hashUrl.test(href) ? 0.3 : 1;
      linkLength += this._getInnerText(linkNode).length * coefficient;
    });

    return linkLength / textLength;
  },

  /**
   * Get an elements class/id weight. Uses regular expressions to tell if this
   * element looks good or bad.
   *
   * @param Element
   * @return number (Integer)
  **/
  _getClassWeight: function(e) {
    if (!this._flagIsActive(this.FLAG_WEIGHT_CLASSES))
      return 0;

    var weight = 0;

    // Look for a special classname
    if (typeof(e.className) === "string" && e.className !== "") {
      if (this.REGEXPS.negative.test(e.className))
        weight -= 25;

      if (this.REGEXPS.positive.test(e.className))
        weight += 25;
    }

    // Look for a special ID
    if (typeof(e.id) === "string" && e.id !== "") {
      if (this.REGEXPS.negative.test(e.id))
        weight -= 25;

      if (this.REGEXPS.positive.test(e.id))
        weight += 25;
    }

    return weight;
  },

  /**
   * Clean a node of all elements of type "tag".
   * (Unless it's a youtube/vimeo video. People love movies.)
   *
   * @param Element
   * @param string tag to clean
   * @return void
   **/
  _clean: function(e, tag) {
    var isEmbed = ["object", "embed", "iframe"].indexOf(tag) !== -1;

    this._removeNodes(this._getAllNodesWithTag(e, [tag]), function(element) {
      // Allow youtube and vimeo videos through as people usually want to see those.
      if (isEmbed) {
        // First, check the elements attributes to see if any of them contain youtube or vimeo
        for (var i = 0; i < element.attributes.length; i++) {
          if (this._allowedVideoRegex.test(element.attributes[i].value)) {
            return false;
          }
        }

        // For embed with <object> tag, check inner HTML as well.
        if (element.tagName === "object" && this._allowedVideoRegex.test(element.innerHTML)) {
          return false;
        }
      }

      return true;
    });
  },

  /**
   * Check if a given node has one of its ancestor tag name matching the
   * provided one.
   * @param  HTMLElement node
   * @param  String      tagName
   * @param  Number      maxDepth
   * @param  Function    filterFn a filter to invoke to determine whether this node 'counts'
   * @return Boolean
   */
  _hasAncestorTag: function(node, tagName, maxDepth, filterFn) {
    maxDepth = maxDepth || 3;
    tagName = tagName.toUpperCase();
    var depth = 0;
    while (node.parentNode) {
      if (maxDepth > 0 && depth > maxDepth)
        return false;
      if (node.parentNode.tagName === tagName && (!filterFn || filterFn(node.parentNode)))
        return true;
      node = node.parentNode;
      depth++;
    }
    return false;
  },

  /**
   * Return an object indicating how many rows and columns this table has.
   */
  _getRowAndColumnCount: function(table) {
    var rows = 0;
    var columns = 0;
    var trs = table.getElementsByTagName("tr");
    for (var i = 0; i < trs.length; i++) {
      var rowspan = trs[i].getAttribute("rowspan") || 0;
      if (rowspan) {
        rowspan = parseInt(rowspan, 10);
      }
      rows += (rowspan || 1);

      // Now look for column-related info
      var columnsInThisRow = 0;
      var cells = trs[i].getElementsByTagName("td");
      for (var j = 0; j < cells.length; j++) {
        var colspan = cells[j].getAttribute("colspan") || 0;
        if (colspan) {
          colspan = parseInt(colspan, 10);
        }
        columnsInThisRow += (colspan || 1);
      }
      columns = Math.max(columns, columnsInThisRow);
    }
    return {rows: rows, columns: columns};
  },

  /**
   * Look for 'data' (as opposed to 'layout') tables, for which we use
   * similar checks as
   * https://searchfox.org/mozilla-central/rev/f82d5c549f046cb64ce5602bfd894b7ae807c8f8/accessible/generic/TableAccessible.cpp#19
   */
  _markDataTables: function(root) {
    var tables = root.getElementsByTagName("table");
    for (var i = 0; i < tables.length; i++) {
      var table = tables[i];
      var role = table.getAttribute("role");
      if (role == "presentation") {
        table._readabilityDataTable = false;
        continue;
      }
      var datatable = table.getAttribute("datatable");
      if (datatable == "0") {
        table._readabilityDataTable = false;
        continue;
      }
      var summary = table.getAttribute("summary");
      if (summary) {
        table._readabilityDataTable = true;
        continue;
      }

      var caption = table.getElementsByTagName("caption")[0];
      if (caption && caption.childNodes.length > 0) {
        table._readabilityDataTable = true;
        continue;
      }

      // If the table has a descendant with any of these tags, consider a data table:
      var dataTableDescendants = ["col", "colgroup", "tfoot", "thead", "th"];
      var descendantExists = function(tag) {
        return !!table.getElementsByTagName(tag)[0];
      };
      if (dataTableDescendants.some(descendantExists)) {
        this.log("Data table because found data-y descendant");
        table._readabilityDataTable = true;
        continue;
      }

      // Nested tables indicate a layout table:
      if (table.getElementsByTagName("table")[0]) {
        table._readabilityDataTable = false;
        continue;
      }

      var sizeInfo = this._getRowAndColumnCount(table);
      if (sizeInfo.rows >= 10 || sizeInfo.columns > 4) {
        table._readabilityDataTable = true;
        continue;
      }
      // Now just go by size entirely:
      table._readabilityDataTable = sizeInfo.rows * sizeInfo.columns > 10;
    }
  },

  /* convert images and figures that have properties like data-src into images that can be loaded without JS */
  _fixLazyImages: function (root) {
    this._forEachNode(this._getAllNodesWithTag(root, ["img", "picture", "figure"]), function (elem) {
      // In some sites (e.g. Kotaku), they put 1px square image as base64 data uri in the src attribute.
      // So, here we check if the data uri is too short, just might as well remove it.
      if (elem.src && this.REGEXPS.b64DataUrl.test(elem.src)) {
        // Make sure it's not SVG, because SVG can have a meaningful image in under 133 bytes.
        var parts = this.REGEXPS.b64DataUrl.exec(elem.src);
        if (parts[1] === "image/svg+xml") {
          return;
        }

        // Make sure this element has other attributes which contains image.
        // If it doesn't, then this src is important and shouldn't be removed.
        var srcCouldBeRemoved = false;
        for (var i = 0; i < elem.attributes.length; i++) {
          var attr = elem.attributes[i];
          if (attr.name === "src") {
            continue;
          }

          if (/\.(jpg|jpeg|png|webp)/i.test(attr.value)) {
            srcCouldBeRemoved = true;
            break;
          }
        }

        // Here we assume if image is less than 100 bytes (or 133B after encoded to base64)
        // it will be too small, therefore it might be placeholder image.
        if (srcCouldBeRemoved) {
          var b64starts = elem.src.search(/base64\s*/i) + 7;
          var b64length = elem.src.length - b64starts;
          if (b64length < 133) {
            elem.removeAttribute("src");
          }
        }
      }

      // also check for "null" to work around https://github.com/jsdom/jsdom/issues/2580
      if ((elem.src || (elem.srcset && elem.srcset != "null")) && elem.className.toLowerCase().indexOf("lazy") === -1) {
        return;
      }

      for (var j = 0; j < elem.attributes.length; j++) {
        attr = elem.attributes[j];
        if (attr.name === "src" || attr.name === "srcset" || attr.name === "alt") {
          continue;
        }
        var copyTo = null;
        if (/\.(jpg|jpeg|png|webp)\s+\d/.test(attr.value)) {
          copyTo = "srcset";
        } else if (/^\s*\S+\.(jpg|jpeg|png|webp)\S*\s*$/.test(attr.value)) {
          copyTo = "src";
        }
        if (copyTo) {
          //if this is an img or picture, set the attribute directly
          if (elem.tagName === "IMG" || elem.tagName === "PICTURE") {
            elem.setAttribute(copyTo, attr.value);
          } else if (elem.tagName === "FIGURE" && !this._getAllNodesWithTag(elem, ["img", "picture"]).length) {
            //if the item is a <figure> that does not contain an image or picture, create one and place it inside the figure
            //see the nytimes-3 testcase for an example
            var img = this._doc.createElement("img");
            img.setAttribute(copyTo, attr.value);
            elem.appendChild(img);
          }
        }
      }
    });
  },

  _getTextDensity: function(e, tags) {
    var textLength = this._getInnerText(e, true).length;
    if (textLength === 0) {
      return 0;
    }
    var childrenLength = 0;
    var children = this._getAllNodesWithTag(e, tags);
    this._forEachNode(children, (child) => childrenLength += this._getInnerText(child, true).length);
    return childrenLength / textLength;
  },

  /**
   * Clean an element of all tags of type "tag" if they look fishy.
   * "Fishy" is an algorithm based on content length, classnames, link density, number of images & embeds, etc.
   *
   * @return void
   **/
  _cleanConditionally: function(e, tag) {
    if (!this._flagIsActive(this.FLAG_CLEAN_CONDITIONALLY))
      return;

    // Gather counts for other typical elements embedded within.
    // Traverse backwards so we can remove nodes at the same time
    // without effecting the traversal.
    //
    // TODO: Consider taking into account original contentScore here.
    this._removeNodes(this._getAllNodesWithTag(e, [tag]), function(node) {
      // First check if this node IS data table, in which case don't remove it.
      var isDataTable = function(t) {
        return t._readabilityDataTable;
      };

      var isList = tag === "ul" || tag === "ol";
      if (!isList) {
        var listLength = 0;
        var listNodes = this._getAllNodesWithTag(node, ["ul", "ol"]);
        this._forEachNode(listNodes, (list) => listLength += this._getInnerText(list).length);
        isList = listLength / this._getInnerText(node).length > 0.9;
      }

      if (tag === "table" && isDataTable(node)) {
        return false;
      }

      // Next check if we're inside a data table, in which case don't remove it as well.
      if (this._hasAncestorTag(node, "table", -1, isDataTable)) {
        return false;
      }

      if (this._hasAncestorTag(node, "code")) {
        return false;
      }

      var weight = this._getClassWeight(node);

      this.log("Cleaning Conditionally", node);

      var contentScore = 0;

      if (weight + contentScore < 0) {
        return true;
      }

      if (this._getCharCount(node, ",") < 10) {
        // If there are not very many commas, and the number of
        // non-paragraph elements is more than paragraphs or other
        // ominous signs, remove the element.
        var p = node.getElementsByTagName("p").length;
        var img = node.getElementsByTagName("img").length;
        var li = node.getElementsByTagName("li").length - 100;
        var input = node.getElementsByTagName("input").length;
        var headingDensity = this._getTextDensity(node, ["h1", "h2", "h3", "h4", "h5", "h6"]);

        var embedCount = 0;
        var embeds = this._getAllNodesWithTag(node, ["object", "embed", "iframe"]);

        for (var i = 0; i < embeds.length; i++) {
          // If this embed has attribute that matches video regex, don't delete it.
          for (var j = 0; j < embeds[i].attributes.length; j++) {
            if (this._allowedVideoRegex.test(embeds[i].attributes[j].value)) {
              return false;
            }
          }

          // For embed with <object> tag, check inner HTML as well.
          if (embeds[i].tagName === "object" && this._allowedVideoRegex.test(embeds[i].innerHTML)) {
            return false;
          }

          embedCount++;
        }

        var linkDensity = this._getLinkDensity(node);
        var contentLength = this._getInnerText(node).length;

        var haveToRemove =
          (img > 1 && p / img < 0.5 && !this._hasAncestorTag(node, "figure")) ||
          (!isList && li > p) ||
          (input > Math.floor(p/3)) ||
          (!isList && headingDensity < 0.9 && contentLength < 25 && (img === 0 || img > 2) && !this._hasAncestorTag(node, "figure")) ||
          (!isList && weight < 25 && linkDensity > 0.2) ||
          (weight >= 25 && linkDensity > 0.5) ||
          ((embedCount === 1 && contentLength < 75) || embedCount > 1);
        // Allow simple lists of images to remain in pages
        if (isList && haveToRemove) {
          for (var x = 0; x < node.children.length; x++) {
            let child = node.children[x];
            // Don't filter in lists with li's that contain more than one child
            if (child.children.length > 1) {
              return haveToRemove;
            }
          }
          let li_count = node.getElementsByTagName("li").length;
          // Only allow the list to remain if every li contains an image
          if (img == li_count) {
            return false;
          }
        }
        return haveToRemove;
      }
      return false;
    });
  },

  /**
   * Clean out elements that match the specified conditions
   *
   * @param Element
   * @param Function determines whether a node should be removed
   * @return void
   **/
  _cleanMatchedNodes: function(e, filter) {
    var endOfSearchMarkerNode = this._getNextNode(e, true);
    var next = this._getNextNode(e);
    while (next && next != endOfSearchMarkerNode) {
      if (filter.call(this, next, next.className + " " + next.id)) {
        next = this._removeAndGetNext(next);
      } else {
        next = this._getNextNode(next);
      }
    }
  },

  /**
   * Clean out spurious headers from an Element.
   *
   * @param Element
   * @return void
  **/
  _cleanHeaders: function(e) {
    let headingNodes = this._getAllNodesWithTag(e, ["h1", "h2"]);
    this._removeNodes(headingNodes, function(node) {
      let shouldRemove = this._getClassWeight(node) < 0;
      if (shouldRemove) {
        this.log("Removing header with low class weight:", node);
      }
      return shouldRemove;
    });
  },

  /**
   * Check if this node is an H1 or H2 element whose content is mostly
   * the same as the article title.
   *
   * @param Element  the node to check.
   * @return boolean indicating whether this is a title-like header.
   */
  _headerDuplicatesTitle: function(node) {
    if (node.tagName != "H1" && node.tagName != "H2") {
      return false;
    }
    var heading = this._getInnerText(node, false);
    this.log("Evaluating similarity of header:", heading, this._articleTitle);
    return this._textSimilarity(this._articleTitle, heading) > 0.75;
  },

  _flagIsActive: function(flag) {
    return (this._flags & flag) > 0;
  },

  _removeFlag: function(flag) {
    this._flags = this._flags & ~flag;
  },

  _isProbablyVisible: function(node) {
    // Have to null-check node.style and node.className.indexOf to deal with SVG and MathML nodes.
    return (!node.style || node.style.display != "none")
      && !node.hasAttribute("hidden")
      //check for "fallback-image" so that wikimedia math images are displayed
      && (!node.hasAttribute("aria-hidden") || node.getAttribute("aria-hidden") != "true" || (node.className && node.className.indexOf && node.className.indexOf("fallback-image") !== -1));
  },

  /**
   * Runs readability.
   *
   * Workflow:
   *  1. Prep the document by removing script tags, css, etc.
   *  2. Build readability's DOM tree.
   *  3. Grab the article content from the current dom tree.
   *  4. Replace the current DOM tree with the new one.
   *  5. Read peacefully.
   *
   * @return void
   **/
  parse: function () {
    // Avoid parsing too large documents, as per configuration option
    if (this._maxElemsToParse > 0) {
      var numTags = this._doc.getElementsByTagName("*").length;
      if (numTags > this._maxElemsToParse) {
        throw new Error("Aborting parsing document; " + numTags + " elements found");
      }
    }

    // Unwrap image from noscript
    this._unwrapNoscriptImages(this._doc);

    // Extract JSON-LD metadata before removing scripts
    var jsonLd = this._disableJSONLD ? {} : this._getJSONLD(this._doc);

    // Remove script tags from the document.
    this._removeScripts(this._doc);

    this._prepDocument();

    var metadata = this._getArticleMetadata(jsonLd);
    this._articleTitle = metadata.title;

    var articleContent = this._grabArticle();
    if (!articleContent)
      return null;

    this.log("Grabbed: " + articleContent.innerHTML);

    this._postProcessContent(articleContent);

    // If we haven't found an excerpt in the article's metadata, use the article's
    // first paragraph as the excerpt. This is used for displaying a preview of
    // the article's content.
    if (!metadata.excerpt) {
      var paragraphs = articleContent.getElementsByTagName("p");
      if (paragraphs.length > 0) {
        metadata.excerpt = paragraphs[0].textContent.trim();
      }
    }

    var textContent = articleContent.textContent;
    return {
      title: this._articleTitle,
      byline: metadata.byline || this._articleByline,
      dir: this._articleDir,
      lang: this._articleLang,
      content: this._serializer(articleContent),
      textContent: textContent,
      length: textContent.length,
      excerpt: metadata.excerpt,
      siteName: metadata.siteName || this._articleSiteName
    };
  }
};

if (typeof module === "object") {
  /* global module */
  module.exports = Readability;
}
    </script>
    
    
    <!-- DOMPurify Library - ES5-compatible version from CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/2.4.7/purify.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    
    <script src="static/js/blakejs-browser.js?v=1763761129"></script>

    
    <script id="md5-library">
!function(n){"use strict";function d(n,t){var r=(65535&n)+(65535&t);return(n>>16)+(t>>16)+(r>>16)<<16|65535&r}function f(n,t,r,e,o,u){return d((u=d(d(t,n),d(e,u)))<<o|u>>>32-o,r)}function l(n,t,r,e,o,u,c){return f(t&r|~t&e,n,t,o,u,c)}function g(n,t,r,e,o,u,c){return f(t&e|r&~e,n,t,o,u,c)}function v(n,t,r,e,o,u,c){return f(t^r^e,n,t,o,u,c)}function m(n,t,r,e,o,u,c){return f(r^(t|~e),n,t,o,u,c)}function c(n,t){var r,e,o,u;n[t>>5]|=128<<t%32,n[14+(t+64>>>9<<4)]=t;for(var c=1732584193,f=-271733879,i=-1732584194,a=271733878,h=0;h<n.length;h+=16)c=l(r=c,e=f,o=i,u=a,n[h],7,-680876936),a=l(a,c,f,i,n[h+1],12,-389564586),i=l(i,a,c,f,n[h+2],17,606105819),f=l(f,i,a,c,n[h+3],22,-1044525330),c=l(c,f,i,a,n[h+4],7,-176418897),a=l(a,c,f,i,n[h+5],12,1200080426),i=l(i,a,c,f,n[h+6],17,-1473231341),f=l(f,i,a,c,n[h+7],22,-45705983),c=l(c,f,i,a,n[h+8],7,1770035416),a=l(a,c,f,i,n[h+9],12,-1958414417),i=l(i,a,c,f,n[h+10],17,-42063),f=l(f,i,a,c,n[h+11],22,-1990404162),c=l(c,f,i,a,n[h+12],7,1804603682),a=l(a,c,f,i,n[h+13],12,-40341101),i=l(i,a,c,f,n[h+14],17,-1502002290),c=g(c,f=l(f,i,a,c,n[h+15],22,1236535329),i,a,n[h+1],5,-165796510),a=g(a,c,f,i,n[h+6],9,-1069501632),i=g(i,a,c,f,n[h+11],14,643717713),f=g(f,i,a,c,n[h],20,-373897302),c=g(c,f,i,a,n[h+5],5,-701558691),a=g(a,c,f,i,n[h+10],9,38016083),i=g(i,a,c,f,n[h+15],14,-660478335),f=g(f,i,a,c,n[h+4],20,-405537848),c=g(c,f,i,a,n[h+9],5,568446438),a=g(a,c,f,i,n[h+14],9,-1019803690),i=g(i,a,c,f,n[h+3],14,-187363961),f=g(f,i,a,c,n[h+8],20,1163531501),c=g(c,f,i,a,n[h+13],5,-1444681467),a=g(a,c,f,i,n[h+2],9,-51403784),i=g(i,a,c,f,n[h+7],14,1735328473),c=v(c,f=g(f,i,a,c,n[h+12],20,-1926607734),i,a,n[h+5],4,-378558),a=v(a,c,f,i,n[h+8],11,-2022574463),i=v(i,a,c,f,n[h+11],16,1839030562),f=v(f,i,a,c,n[h+14],23,-35309556),c=v(c,f,i,a,n[h+1],4,-1530992060),a=v(a,c,f,i,n[h+4],11,1272893353),i=v(i,a,c,f,n[h+7],16,-155497632),f=v(f,i,a,c,n[h+10],23,-1094730640),c=v(c,f,i,a,n[h+13],4,681279174),a=v(a,c,f,i,n[h],11,-358537222),i=v(i,a,c,f,n[h+3],16,-722521979),f=v(f,i,a,c,n[h+6],23,76029189),c=v(c,f,i,a,n[h+9],4,-640364487),a=v(a,c,f,i,n[h+12],11,-421815835),i=v(i,a,c,f,n[h+15],16,530742520),c=m(c,f=v(f,i,a,c,n[h+2],23,-995338651),i,a,n[h],6,-198630844),a=m(a,c,f,i,n[h+7],10,1126891415),i=m(i,a,c,f,n[h+14],15,-1416354905),f=m(f,i,a,c,n[h+5],21,-57434055),c=m(c,f,i,a,n[h+12],6,1700485571),a=m(a,c,f,i,n[h+3],10,-1894986606),i=m(i,a,c,f,n[h+10],15,-1051523),f=m(f,i,a,c,n[h+1],21,-2054922799),c=m(c,f,i,a,n[h+8],6,1873313359),a=m(a,c,f,i,n[h+15],10,-30611744),i=m(i,a,c,f,n[h+6],15,-1560198380),f=m(f,i,a,c,n[h+13],21,1309151649),c=m(c,f,i,a,n[h+4],6,-145523070),a=m(a,c,f,i,n[h+11],10,-1120210379),i=m(i,a,c,f,n[h+2],15,718787259),f=m(f,i,a,c,n[h+9],21,-343485551),c=d(c,r),f=d(f,e),i=d(i,o),a=d(a,u);return[c,f,i,a]}function i(n){for(var t="",r=32*n.length,e=0;e<r;e+=8)t+=String.fromCharCode(n[e>>5]>>>e%32&255);return t}function a(n){var t=[];for(t[(n.length>>2)-1]=void 0,e=0;e<t.length;e+=1)t[e]=0;for(var r=8*n.length,e=0;e<r;e+=8)t[e>>5]|=(255&n.charCodeAt(e/8))<<e%32;return t}function e(n){for(var t,r="0123456789abcdef",e="",o=0;o<n.length;o+=1)t=n.charCodeAt(o),e+=r.charAt(t>>>4&15)+r.charAt(15&t);return e}function r(n){return unescape(encodeURIComponent(n))}function o(n){return i(c(a(n=r(n)),8*n.length))}function u(n,t){return function(n,t){var r,e=a(n),o=[],u=[];for(o[15]=u[15]=void 0,16<e.length&&(e=c(e,8*n.length)),r=0;r<16;r+=1)o[r]=909522486^e[r],u[r]=1549556828^e[r];return t=c(o.concat(a(t)),512+8*t.length),i(c(u.concat(t),640))}(r(n),r(t))}function t(n,t,r){return t?r?u(t,n):e(u(t,n)):r?o(n):e(o(n))}"function"==typeof define&&define.amd?define(function(){return t}):"object"==typeof module&&module.exports?module.exports=t:n.md5=t}(this);
//# sourceMappingURL=md5.min.js.map    </script>
    
    <!-- CryptoJS Library - Loaded from CDN for mobile compatibility -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js" integrity="sha512-E8QSvWZ0eCLGk4km3hxSsNmGWbLtSCSUcewDQPQWZF6pEU8GlT8a5fF32wOl1i8ftdMhssTrF/OhyGWwonTcXA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    
    <!-- QRCodeJS2-Fixes Library - Fixes Android mobile rendering bugs -->
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs2-fixes@0.0.2/qrcode.min.js" crossorigin="anonymous"></script>
    
    <!-- ArcHive Shared Modules -->
    <script src="static/js/url-normalizer.js?v=1763761129"></script>
    <script src="static/js/hive-lookup.js?v=1763761129"></script>
    <script src="static/js/indexeddb-storage.js?v=1763761129"></script>
    <script src="static/js/multipart-content.js?v=1763761129"></script>
    
    <script id="uuid-generator">
        // BUG #6 FIX: Corrected UUID v4 generation
        function generateUUID() {
            // Modern browsers support crypto.randomUUID() - use native implementation
            if (typeof crypto !== 'undefined' && crypto.randomUUID) {
                return crypto.randomUUID();
            }
            
            // Fallback for older browsers using secure random
            const randomWords = CryptoJS.lib.WordArray.random(16); // 128 bits
            const hex = randomWords.toString(CryptoJS.enc.Hex);
            
            // Format as UUID v4: xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx
            // Indices adjusted to correct positions
            return [
                hex.substr(0, 8),
                hex.substr(8, 4),
                '4' + hex.substr(13, 3),  // Version 4 (set nibble 12 to '4')
                ((parseInt(hex.substr(16, 1), 16) & 0x3) | 0x8).toString(16) + hex.substr(17, 3),  // Variant (nibble 16)
                hex.substr(20, 12)
            ].join('-');
        }
    </script>
    
    <script id="has-client">
        /* ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
         * HAS (HIVE AUTHENTICATION SERVICE) CLIENT
         * Mobile-friendly authentication via QR code
         * UPDATED: Using primary server with automatic fallback
         * ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ */
        
        // HAS servers with automatic fallback
        const HAS_SERVERS = [
            'wss://hive-auth.arcange.eu',      // Primary server
            'wss://has.hiveauth.com'           // Fallback server
        ];
        let currentServerIndex = 0;
        
        const HAS_APP_META = {
            name: 'Archive Paste',
            description: 'Content archiving with cryptographic verification for Hive blockchain',
            icon: undefined
        };
        
        let hasWS = null;
        // Load HAS session from localStorage (survives page refresh)
        let hasAuth = (() => {
            try {
                const stored = localStorage.getItem('hasAuth');
                console.log('🔍 Checking localStorage for HAS session...');
                
                if (stored) {
                    const session = JSON.parse(stored);
                    console.log('📦 Found stored session:', {
                        username: session.username,
                        hasKey: !!session.key,
                        expire: session.expire ? new Date(session.expire).toLocaleString() : 'null'
                    });
                    
                    // Validate required fields
                    if (!session.username || !session.key) {
                        console.log('⚠️ Session missing username or key, clearing...');
                        localStorage.removeItem('hasAuth');
                        return { username: null, key: null, token: null, expire: null };
                    }
                    
                    if (session.expire && session.expire > Date.now()) {
                        console.log('✅ Restored HAS session for @' + session.username + ' (expires:', new Date(session.expire).toLocaleString() + ')');
                        return session;
                    } else {
                        console.log('⏱️ Stored HAS session expired, clearing...');
                        localStorage.removeItem('hasAuth');
                    }
                } else {
                    console.log('ℹ️ No HAS session in localStorage');
                }
            } catch (e) {
                console.error('❌ Failed to restore HAS session:', e);
            }
            return { username: null, key: null, token: null, expire: null };
        })();
        
        /**
         * SESSION MANAGEMENT HELPERS
         * Centralize HAS session lifecycle for 1-30 day sessions
         */
        
        // Get stored HAS session with validation
        function getStoredHASSession() {
            try {
                const stored = localStorage.getItem('hasAuth');
                if (!stored) return null;
                
                const session = JSON.parse(stored);
                
                // Validate required fields (Protocol V1: token is deprecated)
                if (!session.username || !session.key || !session.expire) {
                    console.log('⚠️ Invalid session format (missing required field), clearing...');
                    clearHASSession();
                    return null;
                }
                
                // Check expiry
                if (session.expire <= Date.now()) {
                    console.log('⏱️ Session expired, clearing...');
                    clearHASSession();
                    return null;
                }
                
                console.log('✅ Valid HAS session found (expires:', new Date(session.expire).toLocaleString() + ')');
                
                // CRITICAL: Sync global hasAuth with localStorage session
                hasAuth = session;
                console.log('🔄 Global hasAuth synced with stored session');
                
                return session;
            } catch (e) {
                console.error('❌ Failed to read HAS session:', e);
                clearHASSession();
                return null;
            }
        }
        
        // Store HAS session with auto-clear on expiry
        function storeHASSession(session) {
            try {
                localStorage.setItem('hasAuth', JSON.stringify(session));
                console.log('💾 HAS session saved (expires:', new Date(session.expire).toLocaleString() + ')');
                
                // Update global hasAuth (keep in sync)
                hasAuth = session;
                
                // NOTE: Not using setTimeout for auto-clear because browser timer limit is 24.8 days
                // Instead, rely on on-demand expiry checks via getStoredHASSession()
                
                // Update UI
                updateHASStatus();
                updateBlockchainButtonState(); // Update button to show "Post to Hive"
            } catch (e) {
                console.error('❌ Failed to store HAS session:', e);
                alert('⚠️ Cannot save session (localStorage unavailable). Session will not persist after page refresh.');
            }
        }
        
        // Clear HAS session
        function clearHASSession() {
            try {
                localStorage.removeItem('hasAuth');
                // Update global hasAuth (keep in sync) - include all required fields
                hasAuth = { username: null, key: null, token: null, expire: null };
                console.log('🗑️ HAS session cleared');
                // Update UI (safe - reads from hasAuth, no recursion)
                updateHASStatus();
                updateBlockchainButtonState(); // Update button to show "Connect Hive Account"
            } catch (e) {
                console.error('❌ Failed to clear HAS session:', e);
            }
        }
        
        // User-initiated disconnect (clears stale session)
        function disconnectHAS() {
            if (confirm('Disconnect from Hive? You will need to re-authenticate to post.')) {
                clearHASSession();
                showToast('info', 'Disconnected. Tap "Post to Blockchain" to reconnect.');
            }
        }
        
        // Update UI to show HAS auth status
        // FIXED: Read from global hasAuth to avoid recursion (not getStoredHASSession)
        // UX IMPROVEMENT: Use status chip CSS classes
        function updateHASStatus(connecting = false) {
            const statusElement = document.getElementById('hasStatus');
            
            if (!statusElement) return; // UI not ready yet
            
            // Guard for older browsers: Check if hasAuth is defined
            if (typeof hasAuth === 'undefined') return;
            
            // UX IMPROVEMENT: Show connecting state
            if (connecting) {
                statusElement.innerHTML = `
                    <div class="status-chip status-chip--connecting">
                        ⏳ Connecting...
                    </div>
                `;
                return;
            }
            
            // Read from in-memory hasAuth (kept in sync by store/clear helpers)
            if (hasAuth && hasAuth.username && hasAuth.key && hasAuth.expire && hasAuth.expire > Date.now()) {
                const daysUntil = Math.ceil((hasAuth.expire - Date.now()) / (1000 * 60 * 60 * 24));
                statusElement.innerHTML = `
                    <div class="status-chip status-chip--connected" style="cursor: pointer;" onclick="disconnectHAS()" title="Tap to disconnect">
                        ✅ @${hasAuth.username} (${daysUntil} day${daysUntil !== 1 ? 's' : ''}) ✕
                    </div>
                `;
                showToast('success', `Connected as @${hasAuth.username}`);
            } else {
                statusElement.innerHTML = `
                    <div class="status-chip status-chip--disconnected">
                        🔐 Not Connected
                    </div>
                `;
            }
        }
        
        /**
         * UX IMPROVEMENT: Smart button states
         * Updates blockchain button text based on connection state
         */
        function updateBlockchainButtonState(state = 'auto') {
            const btn = document.getElementById('blockchainBtn');
            if (!btn) return; // UI not ready yet
            
            // If manual state provided (posting, success, error), use it
            if (state === 'posting') {
                btn.innerHTML = '⏳ Posting...';
                btn.disabled = true;
                btn.style.opacity = '0.6';
                btn.style.cursor = 'wait';
                return;
            }
            
            if (state === 'success') {
                btn.innerHTML = '✅ Posted!';
                btn.disabled = false;
                btn.style.opacity = '1';
                btn.style.cursor = 'pointer';
                // Reset to normal after 3 seconds
                setTimeout(() => updateBlockchainButtonState('auto'), 3000);
                return;
            }
            
            if (state === 'error') {
                btn.innerHTML = '❌ Post Failed';
                btn.disabled = false;
                btn.style.opacity = '1';
                btn.style.cursor = 'pointer';
                // Reset to normal after 3 seconds
                setTimeout(() => updateBlockchainButtonState('auto'), 3000);
                return;
            }
            
            // AUTO mode: Detect connection state
            btn.disabled = false;
            btn.style.opacity = '1';
            btn.style.cursor = 'pointer';
            
            // Desktop: Check for Hive Keychain extension
            if (typeof window.hive_keychain !== 'undefined') {
                btn.innerHTML = '⛓️ Post to Blockchain';
                return;
            }
            
            // Mobile: Check for active HAS session
            if (hasAuth && hasAuth.username && hasAuth.key && hasAuth.expire && hasAuth.expire > Date.now()) {
                btn.innerHTML = '⛓️ Post to Blockchain';
                return;
            }
            
            // No connection: Show "Connect" message
            btn.innerHTML = '🔗 Connect Hive Account';
        }
        
        // BUG #1 FIX: Add variables for connection promise reuse and timeout cleanup
        let connectionPromise = null;
        let timeoutHandle = null;
        
        // MOBILE FIX: Track pending operations to resume after app switch
        let pendingAuth = null;  // { username, auth_key, resolve, reject, messageHandler, timeout }
        let pendingSign = null;  // { resolve, reject, messageHandler, timeout }
        
        /**
         * Force WebSocket reconnection (for mobile app switching)
         */
        async function forceReconnect() {
            console.log('🔄 Force reconnecting WebSocket...');
            
            // Clear existing WebSocket
            if (hasWS) {
                hasWS.close();
                hasWS = null;
            }
            
            // Clear connection promise
            connectionPromise = null;
            
            // Clear timeout
            if (timeoutHandle) {
                clearTimeout(timeoutHandle);
                timeoutHandle = null;
            }
            
            // Reconnect
            try {
                const ws = await connectHAS();
                console.log('✅ WebSocket reconnected successfully');
                return ws;
            } catch (error) {
                console.error('❌ Failed to reconnect:', error);
                throw error;
            }
        }
        
        // MOBILE FIX: Handle page visibility changes (app switching on mobile)
        document.addEventListener('visibilitychange', async () => {
            if (document.visibilityState === 'visible') {
                console.log('📱 App resumed - checking WebSocket connection...');
                
                // Check WebSocket connection status
                if (!hasWS || hasWS.readyState !== WebSocket.OPEN) {
                    console.log('⚠️ WebSocket not connected - reconnecting now...');
                    
                    try {
                        await forceReconnect();
                        console.log('✅ Reconnected - ready for operations');
                        
                        // RESUMABLE AUTH: Re-send auth request if authentication was in progress
                        if (pendingAuth && pendingAuth.payload) {
                            console.log('🔄 Resuming authentication - re-sending auth_req');
                            updateHASModalStatus('🔄 Reconnecting... waiting for approval');
                            
                            // Reattach message handler
                            hasWS.addEventListener('message', pendingAuth.messageHandler);
                            
                            // Re-send the auth request
                            hasWS.send(JSON.stringify(pendingAuth.payload));
                            console.log('📤 Auth request re-sent - waiting for server response');
                        }
                        // Reattach pending operation handlers if needed
                        else if (pendingAuth && pendingAuth.messageHandler) {
                            console.log('🔄 Reattaching authentication message handler');
                            hasWS.addEventListener('message', pendingAuth.messageHandler);
                        }
                        
                        // RESUMABLE SIGN: Re-send sign request if posting was in progress
                        if (pendingSign && pendingSign.payload) {
                            console.log('🔄 Resuming transaction - re-sending sign_req');
                            
                            // Reattach message handler
                            hasWS.addEventListener('message', pendingSign.messageHandler);
                            
                            // Re-send the sign request
                            hasWS.send(JSON.stringify(pendingSign.payload));
                            console.log('📤 Sign request re-sent - waiting for approval');
                        }
                        // Reattach pending operation handlers if needed
                        else if (pendingSign && pendingSign.messageHandler) {
                            console.log('🔄 Reattaching transaction message handler');
                            hasWS.addEventListener('message', pendingSign.messageHandler);
                        }
                    } catch (error) {
                        console.error('❌ Reconnection failed:', error);
                        showNotification('⚠️ Connection lost. Please try again.');
                        updateHASModalStatus('❌ Reconnection failed - please try again', true);
                    }
                } else {
                    console.log('✅ WebSocket still connected');
                    
                    // Still reattach handlers if needed (just in case)
                    if (pendingAuth && pendingAuth.messageHandler) {
                        console.log('🔄 Reattaching authentication message handler');
                        hasWS.removeEventListener('message', pendingAuth.messageHandler);
                        hasWS.addEventListener('message', pendingAuth.messageHandler);
                    }
                    
                    // RESUMABLE SIGN: Re-send sign request if WebSocket stayed connected but handler lost
                    if (pendingSign && pendingSign.payload) {
                        console.log('🔄 Resuming transaction on connected socket');
                        hasWS.removeEventListener('message', pendingSign.messageHandler);
                        hasWS.addEventListener('message', pendingSign.messageHandler);
                        hasWS.send(JSON.stringify(pendingSign.payload));
                        console.log('📤 Sign request re-sent');
                    }
                    else if (pendingSign && pendingSign.messageHandler) {
                        console.log('🔄 Reattaching transaction message handler');
                        hasWS.removeEventListener('message', pendingSign.messageHandler);
                        hasWS.addEventListener('message', pendingSign.messageHandler);
                    }
                }
            } else {
                console.log('📱 App backgrounded - WebSocket will likely disconnect');
            }
        });
        
        function connectHAS(retryWithFallback = true) {
            // Reuse existing connection attempt
            if (connectionPromise) {
                return connectionPromise;
            }
            
            connectionPromise = new Promise(async (resolve, reject) => {
                if (hasWS && hasWS.readyState === WebSocket.OPEN) {
                    resolve(hasWS);
                    connectionPromise = null;
                    return;
                }
                
                // Clear any existing connection attempt  
                if (hasWS) {
                    hasWS.close();
                    hasWS = null;
                }
                
                // Clear any existing timeout
                if (timeoutHandle) {
                    clearTimeout(timeoutHandle);
                }
                
                const currentServer = HAS_SERVERS[currentServerIndex];
                console.log(`🔌 Connecting to HAS server: ${currentServer}`);
                
                timeoutHandle = setTimeout(() => {
                    if (hasWS) {
                        hasWS.close();
                        hasWS = null;
                    }
                    connectionPromise = null;
                    
                    // Try fallback server if primary failed and fallback is available
                    if (retryWithFallback && currentServerIndex < HAS_SERVERS.length - 1) {
                        console.warn(`⚠️ ${currentServer} timed out. Trying fallback server...`);
                        currentServerIndex++;
                        resolve(connectHAS(false)); // Try next server, but don't retry again
                    } else {
                        reject(new Error('Connection timeout - HAS server not responding'));
                    }
                }, 10000);
                
                hasWS = new WebSocket(currentServer);
                
                hasWS.onopen = () => {
                    clearTimeout(timeoutHandle);
                    timeoutHandle = null;
                    connectionPromise = null;
                    console.log(`✅ HAS Connected to ${currentServer}`);
                    resolve(hasWS);
                };
                
                hasWS.onerror = (error) => {
                    clearTimeout(timeoutHandle);
                    timeoutHandle = null;
                    hasWS = null;  // BUG #3 FIX: Set to null on error
                    connectionPromise = null;
                    console.error('❌ HAS Connection Error:', error);
                    console.error('   Server:', currentServer);
                    console.error('   Browser:', navigator.userAgent);
                    
                    // Try fallback server if primary failed and fallback is available
                    if (retryWithFallback && currentServerIndex < HAS_SERVERS.length - 1) {
                        console.warn(`⚠️ ${currentServer} connection failed. Trying fallback server...`);
                        currentServerIndex++;
                        resolve(connectHAS(false)); // Try next server, but don't retry again
                    } else {
                        reject(new Error('Failed to connect to HAS server. Check network connection.'));
                    }
                };
                
                hasWS.onclose = () => {
                    console.log('📡 HAS Disconnected');
                    hasWS = null;
                    connectionPromise = null;
                    
                    // Don't auto-reconnect here - wait for next operation or visibility change
                    // This prevents infinite reconnection loops
                    console.log('ℹ️ Will reconnect when needed');
                };
            });
            
            return connectionPromise;
        }
        
        // BUG #4 & #5 FIX: Prevent multiple modals, fix cancel button, remove unused onClose parameter
        // CLIENT-SIDE QR GENERATION: Generate QR code locally instead of using external API
        function showHASModal(deepLink) {
            // Check if modal already exists
            let modal = document.getElementById('hasAuthModal');
            if (modal) {
                console.log('📝 Updating existing HAS modal');
                // Update existing modal - regenerate QR code
                const qrContainer = modal.querySelector('#hasQrCode');
                const link = modal.querySelector('a');
                if (qrContainer) {
                    qrContainer.innerHTML = ''; // Clear old QR code
                    try {
                        if (typeof QRCode === 'undefined') {
                            throw new Error('QRCode library not loaded');
                        }
                        new QRCode(qrContainer, {
                            text: deepLink,
                            width: 280,
                            height: 280,
                            colorDark: "#000000",
                            colorLight: "#ffffff",
                            correctLevel: QRCode.CorrectLevel.H
                        });
                        console.log('✅ QR code regenerated in existing modal');
                    } catch (error) {
                        console.error('❌ QR Code regeneration failed:', error);
                        qrContainer.innerHTML = '<p style="color: #ef4444; font-size: 14px;">QR generation failed: ' + error.message + '</p>';
                    }
                }
                if (link) link.href = deepLink;
                return modal;
            }
            
            // Create new modal only if doesn't exist
            modal = document.createElement('div');
            modal.id = 'hasAuthModal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.85);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 999999;
                animation: fadeIn 0.3s;
            `;
            
            modal.innerHTML = `
                <div style="
                    background: white;
                    border-radius: 20px;
                    padding: 30px;
                    max-width: 400px;
                    width: 90%;
                    box-shadow: 0 20px 60px rgba(0,0,0,0.5);
                    text-align: center;
                ">
                    <div style="font-size: 48px; margin-bottom: 15px;">🔐</div>
                    <h2 style="margin: 0 0 10px 0; font-size: 24px; color: #1e293b;">Authenticate with Keychain</h2>
                    <p style="color: #64748b; font-size: 14px; margin-bottom: 20px;">
                        Scan or tap to open Keychain Mobile, approve, then return here
                    </p>
                    <a href="${deepLink}" style="display: block; text-decoration: none;">
                        <div id="hasQrCode" style="
                            width: 280px; 
                            height: 280px; 
                            margin: 0 auto; 
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            background: #f8fafc;
                            border-radius: 12px;
                            cursor: pointer;
                        "></div>
                    </a>
                    <p style="color: #10b981; font-size: 13px; margin-top: 15px; font-weight: 600;">
                        ✅ After approving, return to this app
                    </p>
                    <p id="hasModalStatus" style="color: #f59e0b; font-size: 13px; margin-top: 10px; font-weight: 600; display: none;">
                        <!-- Status messages appear here -->
                    </p>
                    <a href="${deepLink}" style="
                        display: inline-block;
                        margin-top: 15px;
                        padding: 12px 24px;
                        background: #8b5cf6;
                        color: white;
                        text-decoration: none;
                        border-radius: 8px;
                        font-size: 14px;
                        font-weight: 600;
                    ">
                        📱 Open in Keychain Mobile
                    </a>
                    <button id="hasFallbackBtn" onclick="closeHASModal(); showNotification('Please click the Post button again to retry.');" 
                            style="
                                display: none;
                                margin-top: 15px;
                                padding: 12px 24px;
                                background: #10b981;
                                border: none;
                                border-radius: 8px;
                                font-size: 14px;
                                color: white;
                                cursor: pointer;
                                font-weight: 600;
                                min-height: 44px;
                            ">
                        ✅ I Already Approved - Close QR
                    </button>
                    <button onclick="closeHASModal();" 
                            style="
                                margin-top: 20px;
                                padding: 12px 24px;
                                background: #e2e8f0;
                                border: none;
                                border-radius: 8px;
                                font-size: 14px;
                                color: #475569;
                                cursor: pointer;
                                font-weight: 600;
                                min-height: 44px;
                            ">
                        Cancel
                    </button>
                    <details style="margin-top: 20px; text-align: left; font-size: 12px; color: #64748b;">
                        <summary style="cursor: pointer; font-weight: 600;">⚠️ Having trouble connecting?</summary>
                        <div style="margin-top: 10px; padding: 12px; background: #fff7ed; border-radius: 8px; color: #9a3412;">
                            <p style="margin: 0 0 8px 0;"><strong>Tip:</strong> Make sure Keychain Mobile is updated to the latest version.</p>
                            <p style="margin: 0;">If issues persist, try clearing old connections in Keychain → Settings → Browser</p>
                        </div>
                    </details>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Generate QR code client-side after modal is in DOM
            const qrContainer = document.getElementById('hasQrCode');
            
            // Show loading indicator
            qrContainer.innerHTML = '<div style="display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 280px; gap: 16px;"><div style="border: 3px solid #e2e8f0; border-top: 3px solid #3b82f6; border-radius: 50%; width: 48px; height: 48px; animation: spin 0.8s linear infinite;"></div><div style="font-size: 14px; color: #64748b;">Generating QR code...</div></div>';
            
            // Add spin animation if not already defined
            if (!document.getElementById('spinAnimStyle')) {
                const style = document.createElement('style');
                style.id = 'spinAnimStyle';
                style.textContent = '@keyframes spin { to { transform: rotate(360deg); } }';
                document.head.appendChild(style);
            }
            
            try {
                // Check if QRCode library loaded
                if (typeof QRCode === 'undefined') {
                    throw new Error('QRCode library not loaded from CDN');
                }
                
                // Clear loading and generate QR code with high error correction for mobile
                qrContainer.innerHTML = '';
                new QRCode(qrContainer, {
                    text: deepLink,
                    width: 280,
                    height: 280,
                    colorDark: "#000000",
                    colorLight: "#ffffff",
                    correctLevel: QRCode.CorrectLevel.H  // High error correction (30%)
                });
                console.log('✅ QR code generated successfully with Android fix library');
                showNotification('✅ QR code ready! Tap to open Keychain');
            } catch (error) {
                console.error('❌ QR Code generation failed:', error);
                console.error('❌ Error details:', error.message, error.stack);
                qrContainer.innerHTML = '<p style="color: #ef4444; font-size: 14px; padding: 20px;">QR generation failed: ' + error.message + '<br><br>Tap the link below instead.</p>';
                showNotification('⚠️ QR failed. Use manual link below.', 'error');
            }
            
            return modal;
        }
        
        function updateHASModalStatus(message, showFallback = false) {
            const modal = document.getElementById('hasAuthModal');
            if (!modal) return;
            
            const statusEl = modal.querySelector('#hasModalStatus');
            if (statusEl) {
                statusEl.textContent = message;
                statusEl.style.display = 'block';
            }
            
            // Show manual fallback button if needed
            const fallbackBtn = modal.querySelector('#hasFallbackBtn');
            if (fallbackBtn) {
                fallbackBtn.style.display = showFallback ? 'inline-block' : 'none';
            }
        }
        
        function closeHASModal() {
            const modal = document.getElementById('hasAuthModal');
            if (modal) {
                modal.style.animation = 'fadeOut 0.3s';
                setTimeout(() => modal.remove(), 300);
            }
        }
        
        /**
         * FLOW 1: AUTHENTICATE ONLY (No automatic posting)
         * User clicks "Authenticate with Hive" → Shows QR → Approves → Session saved → QR closes → STOPS
         * Returns: true on success, false on failure
         */
        async function authenticateWithHAS(username) {
            return new Promise(async (resolve, reject) => {
                try {
                    const ws = await connectHAS();
                    
                    const auth_key = generateUUID();
                    const auth_data = {
                        app: HAS_APP_META,
                        token: undefined,
                        challenge: undefined
                    };
                    
                    const encrypted_data = CryptoJS.AES.encrypt(
                        JSON.stringify(auth_data),
                        auth_key
                    ).toString();
                    
                    const payload = {
                        cmd: 'auth_req',
                        account: username,
                        data: encrypted_data
                    };
                    
                    let authModal = null;
                    let messageHandler = null;
                    let completed = false;  // MOBILE FIX: Prevent double-resolution
                    
                    // WARNING #7 FIX: Add 60-second approval timeout
                    let approvalTimeout = setTimeout(() => {
                        if (completed) return;
                        completed = true;
                        pendingAuth = null;  // Clear pending state
                        closeHASModal();
                        if (messageHandler) ws.removeEventListener('message', messageHandler);
                        reject(new Error('⏱️ Authentication timeout - Please try again'));
                    }, 60000); // 60 seconds
                    
                    messageHandler = (event) => {
                        let message;
                        try {
                            message = JSON.parse(event.data);
                        } catch (e) {
                            console.error('❌ Invalid WebSocket message:', e);
                            return;
                        }
                        console.log('📨 HAS Message:', message);
                        
                        if (message.cmd === 'auth_wait') {
                            // CRITICAL: UUID from server identifies this auth request for Keychain Mobile
                            const auth_payload = {
                                account: username,
                                uuid: message.uuid,  // REQUIRED - server provides this
                                key: auth_key,
                                host: HAS_SERVERS[currentServerIndex]  // Server hostname for mobile to connect
                            };
                            
                            // Use btoa() encoding (base64) - matches working HAS implementations
                            const deepLink = `has://auth_req/${btoa(JSON.stringify(auth_payload))}`;
                            console.log('🔗 HAS Deep Link:', {
                                account: username,
                                uuid: message.uuid,
                                host: HAS_SERVERS[currentServerIndex],
                                encoding: 'btoa (base64)',
                                length: deepLink.length
                            });
                            
                            authModal = showHASModal(deepLink);
                            
                            // MOBILE FIX: Store pending auth so we can resume after app switch
                            pendingAuth = {
                                username,
                                auth_key,
                                payload,  // Store payload to re-send on reconnect
                                resolve,
                                reject,
                                messageHandler,
                                timeout: approvalTimeout
                            };
                            console.log('📱 Authentication pending - stored state for resume');
                            
                            // Show fallback button after 20 seconds if still waiting
                            setTimeout(() => {
                                if (pendingAuth && !completed) {
                                    console.log('⏱️ 20 seconds elapsed - showing fallback button');
                                    updateHASModalStatus('Taking longer than expected...', true);
                                }
                            }, 20000);
                        }
                        else if (message.cmd === 'auth_ack') {
                            if (completed) return;  // MOBILE FIX: Already handled
                            completed = true;
                            pendingAuth = null;  // Clear pending state
                            
                            try {
                                const decrypted = CryptoJS.AES.decrypt(message.data, auth_key)
                                    .toString(CryptoJS.enc.Utf8);
                                const auth_ack_data = JSON.parse(decrypted);
                                
                                const session = {
                                    username: username,
                                    key: auth_key,
                                    token: auth_ack_data.token,
                                    expire: auth_ack_data.expire
                                };
                                
                                // Store session using helper (updates global hasAuth and UI)
                                storeHASSession(session);
                                
                                // Close QR modal
                                closeHASModal();
                                clearTimeout(approvalTimeout);
                                ws.removeEventListener('message', messageHandler);
                                
                                console.log('✅ Authentication completed successfully');
                                console.log('📝 Session saved - expires:', new Date(session.expire).toLocaleString());
                                console.log('🔐 Ready to post! Click "Post to Hive Now" button');
                                
                                // Show success notification
                                showNotification(`✅ Authenticated as @${username}!\n\nClick "📤 Post to Hive Now" to publish your content.`);
                                
                                resolve(true);  // Return success flag (NOT the session object)
                            } catch (e) {
                                console.error('❌ Decryption failed:', e);
                                clearTimeout(approvalTimeout);
                                ws.removeEventListener('message', messageHandler);
                                reject(new Error('Failed to decrypt auth response'));
                            }
                        }
                        else if (message.cmd === 'auth_nack') {
                            if (completed) return;  // MOBILE FIX: Already handled
                            completed = true;
                            pendingAuth = null;  // Clear pending state
                            
                            localStorage.removeItem('hasAuth');
                            closeHASModal();
                            clearTimeout(approvalTimeout);
                            ws.removeEventListener('message', messageHandler);
                            reject(new Error('Authentication declined'));
                        }
                        else if (message.cmd === 'auth_err') {
                            if (completed) return;  // MOBILE FIX: Already handled
                            completed = true;
                            pendingAuth = null;  // Clear pending state
                            
                            localStorage.removeItem('hasAuth');
                            closeHASModal();
                            clearTimeout(approvalTimeout);
                            ws.removeEventListener('message', messageHandler);
                            reject(new Error('Authentication error'));
                        }
                    };
                    
                    ws.addEventListener('message', messageHandler);
                    ws.send(JSON.stringify(payload));
                    
                } catch (error) {
                    console.error('❌ HAS Auth Error:', error);
                    reject(error);
                }
            });
        }
        
        async function postToHiveWithHAS(username, operations) {
            return new Promise(async (resolve, reject) => {
                try {
                    // Ensure we have a valid session (should already be authenticated)
                    // Protocol V1: token is deprecated, only need username, key, and expire
                    if (!hasAuth || !hasAuth.username || !hasAuth.key || !hasAuth.expire) {
                        console.error('❌ Missing session field:', {
                            hasAuth: !!hasAuth,
                            username: hasAuth?.username,
                            key: !!hasAuth?.key,
                            expire: hasAuth?.expire
                        });
                        throw new Error('No valid authentication session found. Please authenticate first.');
                    }

                    if (hasAuth.expire < Date.now()) {
                        throw new Error('Authentication session expired. Please authenticate again.');
                    }

                    console.log('✅ Using authenticated session for @' + hasAuth.username);
                    
                    const ws = await connectHAS();
                    
                    const sign_data = {
                        key_type: 'posting',
                        ops: operations,
                        broadcast: true,
                        nonce: Date.now()
                    };
                    
                    const encrypted = CryptoJS.AES.encrypt(
                        JSON.stringify(sign_data),
                        hasAuth.key
                    ).toString();
                    
                    // Include token for Keychain Mobile compatibility
                    const payload = {
                        cmd: 'sign_req',
                        account: hasAuth.username,
                        token: hasAuth.token,
                        data: encrypted
                    };
                    
                    let signModal = null;
                    let messageHandler = null;
                    let completed = false;  // MOBILE FIX: Prevent double-resolution
                    
                    // Add 60-second approval timeout
                    let approvalTimeout = setTimeout(() => {
                        if (completed) return;
                        completed = true;
                        pendingSign = null;  // Clear pending state
                        if (messageHandler) ws.removeEventListener('message', messageHandler);
                        reject(new Error('⏱️ Transaction approval timeout - Please try again'));
                    }, 60000); // 60 seconds
                    
                    messageHandler = (event) => {
                        let message;
                        try {
                            message = JSON.parse(event.data);
                        } catch (e) {
                            console.error('❌ Invalid WebSocket message:', e);
                            return;
                        }
                        console.log('📨 HAS Sign Message:', message);
                        
                        // CRITICAL FIX: Handle ERROR command from HAS server
                        if (message.cmd === 'error') {
                            if (completed) return;
                            completed = true;
                            
                            // Close the sign modal if it exists
                            if (pendingSign && pendingSign.modal) {
                                closeHASModal();
                            }
                            
                            pendingSign = null;
                            
                            console.error('❌ HAS Server Error:', message);
                            clearTimeout(approvalTimeout);
                            ws.removeEventListener('message', messageHandler);
                            reject(new Error(`HAS Error: ${message.error || message.msg || 'Unknown server error'}`));
                            return;
                        }
                        
                        if (message.cmd === 'sign_wait') {
                            console.log('📝 Transaction ready - waiting for auto-approve or manual approval');
                            
                            // Generate deep link for transaction signing (in case manual approval needed)
                            const sign_payload = {
                                account: hasAuth.username,
                                uuid: message.uuid,  // From sign_wait response
                                key: hasAuth.key,    // Encryption key from auth session
                                host: HAS_SERVERS[currentServerIndex]  // HAS server
                            };
                            
                            const deepLink = `has://sign_req/${btoa(JSON.stringify(sign_payload))}`;
                            console.log('🔗 Sign Request Deep Link generated');
                            
                            // SMART AUTO-APPROVE DETECTION:
                            // Wait 2 seconds to see if sign_ack comes automatically
                            // If it does, user has auto-approve enabled - no popup needed!
                            // If not, show the approval UI
                            
                            const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
                            let signModal = null;
                            let autoApproveTimeout = null;
                            
                            // Show "processing" notification while waiting
                            showNotification('📡 Publishing to Hive...');
                            
                            // Wait 2 seconds before showing approval UI
                            autoApproveTimeout = setTimeout(() => {
                                if (completed) return; // Already got sign_ack
                                
                                console.log('⏱️ No auto-approve - showing manual approval UI');
                                
                                if (isMobile) {
                                    // Auto-open Keychain Mobile
                                    console.log('📱 Mobile detected - auto-opening Keychain');
                                    showNotification('📱 Opening Keychain for approval...');
                                    setTimeout(() => {
                                        window.location.href = deepLink;
                                    }, 300);
                                } else {
                                    // Desktop: Show modal with QR code
                                    signModal = showHASModal(deepLink);
                                    updateHASModalStatus('📱 Scan QR with Keychain Mobile to approve', false);
                                    showNotification('⏳ Approve transaction in Keychain...');
                                }
                            }, 2000); // Wait 2 seconds for auto-approve
                            
                            // Store pending sign so we can resume after app switch
                            pendingSign = {
                                payload,  // Store payload to re-send on reconnect
                                resolve,
                                reject,
                                messageHandler,
                                timeout: approvalTimeout,
                                autoApproveTimeout: autoApproveTimeout, // Store so we can cancel
                                modal: signModal,  // null initially, set later if needed
                                deepLink: deepLink // Store for later use
                            };
                            console.log('📱 Transaction pending - waiting for response');
                        }
                        else if (message.cmd === 'sign_ack') {
                            if (completed) return;  // MOBILE FIX: Already handled
                            completed = true;
                            
                            console.log('✅ Transaction approved and broadcast!');
                            
                            // Cancel auto-approve timeout (no popup needed!)
                            if (pendingSign && pendingSign.autoApproveTimeout) {
                                clearTimeout(pendingSign.autoApproveTimeout);
                            }
                            
                            // Close the sign modal if it exists
                            if (pendingSign && pendingSign.modal) {
                                closeHASModal();
                            }
                            
                            pendingSign = null;  // Clear pending state
                            clearTimeout(approvalTimeout);
                            ws.removeEventListener('message', messageHandler);
                            resolve(message);
                        }
                        else if (message.cmd === 'sign_nack') {
                            if (completed) return;  // MOBILE FIX: Already handled
                            completed = true;
                            
                            // Cancel auto-approve timeout
                            if (pendingSign && pendingSign.autoApproveTimeout) {
                                clearTimeout(pendingSign.autoApproveTimeout);
                            }
                            
                            // Close the sign modal if it exists
                            if (pendingSign && pendingSign.modal) {
                                closeHASModal();
                            }
                            
                            pendingSign = null;  // Clear pending state
                            clearTimeout(approvalTimeout);
                            ws.removeEventListener('message', messageHandler);
                            reject(new Error('Transaction declined'));
                        }
                        else if (message.cmd === 'sign_err') {
                            if (completed) return;  // MOBILE FIX: Already handled
                            completed = true;
                            
                            // Cancel auto-approve timeout
                            if (pendingSign && pendingSign.autoApproveTimeout) {
                                clearTimeout(pendingSign.autoApproveTimeout);
                            }
                            
                            // Close the sign modal if it exists
                            if (pendingSign && pendingSign.modal) {
                                closeHASModal();
                            }
                            
                            pendingSign = null;  // Clear pending state
                            clearTimeout(approvalTimeout);
                            ws.removeEventListener('message', messageHandler);
                            try {
                                const error = CryptoJS.AES.decrypt(message.error, hasAuth.key)
                                    .toString(CryptoJS.enc.Utf8);
                                reject(new Error(error));
                            } catch (e) {
                                reject(new Error('Transaction error'));
                            }
                        }
                    };
                    
                    ws.addEventListener('message', messageHandler);
                    ws.send(JSON.stringify(payload));
                    
                } catch (error) {
                    console.error('❌ HAS Sign Error:', error);
                    reject(error);
                }
            });
        }
    </script>

    
    <script>
        /* ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
         * WINDOW NAMING - Allow Console Snippet to find and focus THIS window
         * ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ */
        
        // Set window name so snippet can REUSE this window (no new popups!)
        if (!window.name) {
            window.name = 'ArcHiveExtractor';
            console.log('🪟 Window named "ArcHiveExtractor" - snippet will focus THIS window (no popups!)');
        }
        
        /* ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
         * POST MESSAGE RECEIVER - Accept content from bookmarklet
         * ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ */
        
        /**
         * Filter Twitter/X UI chrome and navigation elements from HTML
         */
        function filterTwitterUI(html) {
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = html;
            
            // Remove common Twitter UI junk
            const junkSelectors = [
                '[aria-label*="keyboard shortcuts"]',
                '[data-testid="primaryColumn"] > div > div > div:first-child',
                'nav[aria-label*="Timeline"]',
                '[role="navigation"]',
                '[data-testid="sidebarColumn"]',
                '[data-testid="DMDrawer"]'
            ];
            
            junkSelectors.forEach(selector => {
                const elements = tempDiv.querySelectorAll(selector);
                elements.forEach(el => el.remove());
            });
            
            return tempDiv.innerHTML;
        }
        
        /**
         * Format Twitter/X replies with @username
         */
        function formatTwitterReplies(repliesHTML) {
            if (!repliesHTML || repliesHTML.length === 0) {
                return '';
            }
            
            let formattedReplies = '\n\n--- REPLIES ---\n\n';
            
            // ROBUST EXTRACTION (Nov 25, 2025): Multiple selectors for X.com compatibility
            const textSelectors = ['[data-testid="tweetText"]', '[class*="tweetText"]', '[lang]', '[dir="auto"]'];
            const userSelectors = ['[data-testid="User-Name"] a[href^="/"]', 'a[href^="/"][role="link"]'];
            
            repliesHTML.forEach((replyHTML, index) => {
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = replyHTML;
                
                // Extract username with fallbacks
                let usernameElement = null;
                for (const sel of userSelectors) {
                    usernameElement = tempDiv.querySelector(sel);
                    if (usernameElement) break;
                }
                const username = usernameElement ? usernameElement.getAttribute('href').substring(1) : 'unknown';
                
                // Extract tweet text with fallbacks
                let tweetTextElement = null;
                for (const sel of textSelectors) {
                    tweetTextElement = tempDiv.querySelector(sel);
                    if (tweetTextElement && tweetTextElement.textContent.trim().length > 5) break;
                    tweetTextElement = null;
                }
                const tweetText = tweetTextElement ? tweetTextElement.innerText : '';
                
                if (tweetText) {
                    formattedReplies += `@${username}: ${tweetText}\n\n`;
                }
            });
            
            return formattedReplies;
        }
        
        /**
         * Format extracted Twitter/X plain text for clean display
         * FIXED: Now returns ONLY the tweet text without duplication
         * 
         * @param {string} textContent - Plain text extracted by Readability (ignored, we extract fresh)
         * @param {string} htmlContent - Original HTML content
         * @returns {Object} - { content: formatted text, username: extracted username }
         */
        function formatTwitterText(textContent, htmlContent) {
            // Extract components from the original HTML
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = htmlContent;
            
            // ROBUST EXTRACTION: Try multiple selectors for X.com compatibility
            // X.com changes their DOM frequently, so we try several known selectors
            const tweetTextSelectors = [
                '[data-testid="tweetText"]',
                '[class*="tweetText"]',
                'article [lang]',
                '[data-testid="tweet"] span[dir]',
                '[role="article"] [dir="auto"]'
            ];
            
            let tweetTextEl = null;
            for (const selector of tweetTextSelectors) {
                tweetTextEl = tempDiv.querySelector(selector);
                if (tweetTextEl && tweetTextEl.textContent.trim().length > 10) {
                    console.log(`✅ Twitter text found via: ${selector}`);
                    break;
                }
                tweetTextEl = null;
            }
            
            // Username extraction - multiple fallback selectors
            const usernameSelectors = [
                '[data-testid="User-Name"] a[href^="/"]',
                '[data-testid="User-Names"] a[href^="/"]',
                'a[href^="/"][role="link"][class*="css"]',
                '[data-testid="tweet"] a[href^="/"][tabindex="-1"]'
            ];
            
            let userNameEl = null;
            for (const selector of usernameSelectors) {
                userNameEl = tempDiv.querySelector(selector);
                if (userNameEl && userNameEl.getAttribute('href')?.length > 1) {
                    break;
                }
                userNameEl = null;
            }
            
            const timeEl = tempDiv.querySelector('time');
            
            // If extraction fails, fall back to original
            if (!tweetTextEl) {
                console.warn('⚠️ Twitter extraction failed - falling back to original text');
                console.log('   HTML length:', htmlContent.length, 'chars');
                return { content: textContent, username: null };
            }
            
            const username = userNameEl ? userNameEl.getAttribute('href').substring(1) : null;
            const tweetText = tweetTextEl.innerText || tweetTextEl.textContent || '';
            const timestamp = timeEl ? timeEl.getAttribute('datetime') : '';
            const formattedTime = timestamp ? new Date(timestamp).toLocaleString('en-US', {
                hour: 'numeric',
                minute: '2-digit',
                hour12: true,
                month: 'short',
                day: 'numeric',
                year: 'numeric'
            }) : '';
            
            // Format: Just the tweet text + timestamp
            // NO @username prefix (that goes in the title)
            // NO duplication
            let formattedText = tweetText;
            
            if (formattedTime) {
                formattedText += `\n\n_${formattedTime}_`;
            }
            
            return { content: formattedText, username: username };
        }
        
        // RACE CONDITION FIX (Nov 25, 2025): Prevent duplicate message handling
        // Both message handlers (this one and checkPendingExtract's messageHandler) receive
        // the same ARCHIVE_EXTRACT message, causing duplicate smartArchive() calls
        // Using window-level scope so both handlers can access this flag
        window._extractionInProgress = false;
        
        window.addEventListener('message', async (event) => {
            // Security: Validate message structure and content
            // NOTE: We cannot validate event.origin since bookmarklet runs on ANY site (Twitter, Facebook, etc.)
            // Instead, we rely on strict data validation and the fact that only our bookmarklet knows the message format
            
            try {
                const data = event.data;
                
                // Check if this is a snippet/bookmarklet extraction
                if (data && data.type === 'ARCHIVE_EXTRACT') {
                    // RACE CONDITION FIX: Skip if another handler is already processing this extraction
                    if (window._extractionInProgress) {
                        console.log('🔄 Extraction already in progress - skipping duplicate handler');
                        return;
                    }
                    window._extractionInProgress = true;
                    
                    // Strict validation: ensure required fields exist and are reasonable
                    if (!data.html || typeof data.html !== 'string' || data.html.length === 0) {
                        console.log('⚠️ Ignored invalid message: missing or invalid HTML');
                        window._extractionInProgress = false;
                        return;
                    }
                    if (!data.url || typeof data.url !== 'string' || !data.url.startsWith('http')) {
                        console.log('⚠️ Ignored invalid message: missing or invalid URL');
                        window._extractionInProgress = false;
                        return;
                    }
                    
                    // Size sanity check - reject suspiciously large payloads (>50MB)
                    if (data.html.length > 50 * 1024 * 1024) {
                        console.error('⚠️ Rejected: HTML payload too large (>50MB)');
                        showNotification('❌ Content too large to process');
                        window._extractionInProgress = false;
                        return;
                    }
                    
                    console.log('📨 Received content from Console Snippet!');
                    console.log('   Source:', data.url);
                    console.log('   HTML length:', (data.html && data.html.length) || 0);
                    
                    // Handle Twitter/X smart extraction
                    let processedHTML = data.html;
                    const mode = data.mode || 'normal';
                    
                    if (mode === 'tweet-only' || mode === 'with-replies') {
                        console.log('🐦 Twitter/X smart extraction mode:', mode);
                        
                        if (data.tweetOnlyHTML) {
                            // Use cleaned main tweet HTML
                            processedHTML = filterTwitterUI(data.tweetOnlyHTML);
                            console.log('   Using tweet-only HTML:', processedHTML.length, 'chars');
                            
                            // Append formatted replies if included
                            if (mode === 'with-replies' && data.repliesHTML) {
                                const formattedReplies = formatTwitterReplies(data.repliesHTML);
                                processedHTML += formattedReplies;
                                console.log('   Added', data.repliesHTML.length, 'replies');
                            }
                        } else {
                            console.warn('   Smart extraction failed, using full HTML');
                        }
                    }
                    
                    // IMPORTANT: Close the bookmarklet modal if it's still open
                    const modal = document.getElementById('bookmarkletModal');
                    if (modal) {
                        modal.style.opacity = '0';
                        setTimeout(() => modal.remove(), 300);
                    }
                    
                    // BUG FIX #1: Check if we're in verification mode BEFORE filling textarea
                    // If in verification mode, we need to trigger smart archive flow to compare hashes
                    const isVerificationMode = window._archiveVerificationData && 
                                              window._archiveVerificationData.mode === 'verification';
                    
                    // Fill the textarea with extracted HTML
                    const textarea = document.getElementById('contentInput');
                    if (textarea) {
                        textarea.value = processedHTML;
                        const siteName = data.url.split('/')[2] || 'external site';
                        const modeInfo = mode !== 'normal' ? ` (${mode})` : '';
                        showNotification('✅ Content received from ' + siteName + modeInfo);
                        
                        // REGRESSION FIX: ALWAYS populate Source URL field for all bookmarklet extractions
                        // Bug: Was only filling sourceUrlInput in verification mode, causing "Source: manual-paste" in preview
                        // Fix: Always populate URL so buildHivePostBody() can show correct source
                        if (data.url) {
                            const sourceUrlField = document.getElementById('sourceUrlInput');
                            if (sourceUrlField) {
                                sourceUrlField.value = data.url;
                                console.log(isVerificationMode ? '🔍 Verification mode: Set source URL to' : '📝 Bookmarklet: Set source URL to', data.url);
                            }
                        }
                        
                        // 🔍 BUG FIX: Check for duplicates using source URL BEFORE processing
                        // UNLESS we're in verification mode (already know URL is archived, just comparing hashes)
                        if (!isVerificationMode && data.url && processor.isURL(data.url)) {
                            console.log('🔍 F12 Snippet: Checking for duplicates before archiving...');
                            // smartArchive will check for duplicates and show modal if found
                            // If no duplicates, it will call processContent(true) via modal button
                            window._bookmarkletExtractedHtml = processedHTML;
                            await smartArchive(data.url);
                            console.log('✅ Duplicate check completed');
                        } else {
                            // Verification mode or no URL - process directly
                            console.log(isVerificationMode ? '🔍 Verification mode: Processing directly...' : '🚀 No source URL: Processing directly...');
                            await processContent(true); // Skip smart archive
                            
                            // Mark extraction ready if in verification mode
                            if (isVerificationMode) {
                                window._archiveVerificationData.extractionReady = true;
                                updatePrimaryActionButton();
                            }
                        }
                    }
                    
                    // RACE CONDITION FIX: Reset flag after extraction completes
                    window._extractionInProgress = false;
                }
            } catch (error) {
                console.error('❌ Error processing postMessage:', error);
                // RACE CONDITION FIX: Reset flag on error too
                window._extractionInProgress = false;
                // Silently ignore malformed messages - don't expose internals to potential attackers
            }
        });
        
        /* ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
         * ARCHIVE PROCESSOR - Core Functionality
         * ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ */
        
        class ArchiveProcessor {
            constructor() {
                this.currentData = null;
                this.history = this.loadHistory();
                this.wikipediaApiCache = new Map();
                this.lastModifiedHeader = null;
            }
            
            /**
             * Check if input is a URL
             */
            isURL(input) {
                return input.trim().startsWith('http://') || input.trim().startsWith('https://');
            }
            
            /**
             * Main processing function - detects input type and routes accordingly
             */
            async processContent(input, progressCallback = null, abortSignal = null) {
                input = input.trim();
                
                if (!input) {
                    throw new Error('Please paste content or enter a URL');
                }
                
                // Reset metadata for fresh extraction
                this.lastModifiedHeader = null;
                
                // Store progress callback for use in sub-methods
                this.progressCallback = progressCallback;
                this.abortSignal = abortSignal;
                
                // Detect Wikipedia URL (supports 300+ languages)
                const wikiRegex = /^https?:\/\/([a-z]{2,3})\.wikipedia\.org\/wiki\/(.+)$/i;
                const wikiMatch = input.match(wikiRegex);
                
                if (wikiMatch) {
                    console.log('📚 Detected Wikipedia URL:', wikiMatch[0]);
                    if (progressCallback) progressCallback('Fetching from Wikipedia API...');
                    return await this.processWikipediaUrl(wikiMatch[1], wikiMatch[2]);
                }
                
                // Detect URL
                if (input.startsWith('http://') || input.startsWith('https://')) {
                    console.log('🌐 Detected general URL:', input);
                    return await this.processGeneralUrl(input);
                }
                
                // Process as HTML
                console.log('📄 Processing as HTML content');
                return await this.processHTML(input);
            }
            
            /**
             * Wikipedia extraction via API
             * 🔐 PROVENANCE: Captures revision ID as cryptographic proof of exact version
             */
            async processWikipediaUrl(lang, title) {
                console.log(`📚 Fetching Wikipedia content: ${lang}.wikipedia.org/wiki/${title}`);
                
                const apiUrl = `https://${lang}.wikipedia.org/w/api.php`;
                // Request revision info for provenance proof
                const params = new URLSearchParams({
                    action: 'parse',
                    page: decodeURIComponent(title),
                    prop: 'text|displaytitle|revid',  // Added revid for provenance
                    format: 'json',
                    origin: '*'
                });
                
                try {
                    const response = await fetch(`${apiUrl}?${params}`);
                    const data = await response.json();
                    
                    if (data.error) {
                        throw new Error(`Wikipedia API error: ${data.error.info}`);
                    }
                    
                    const html = data.parse.text['*'];
                    const articleTitle = data.parse.displaytitle;
                    const revisionId = data.parse.revid;
                    const pageId = data.parse.pageid;
                    
                    console.log(`✅ Wikipedia content fetched: ${html.length} characters`);
                    console.log(`🔐 Wikipedia Revision ID: ${revisionId} (provenance proof)`);
                    
                    // Build provenance metadata for Wikipedia
                    const provenance = {
                        source_type: 'wikipedia',
                        revision_id: revisionId,
                        page_id: pageId,
                        language: lang,
                        permanent_url: `https://${lang}.wikipedia.org/w/index.php?oldid=${revisionId}`,
                        api_timestamp: new Date().toISOString(),
                        extraction_method: 'wikipedia-api'
                    };
                    
                    return await this.extractWithReadability(html, articleTitle, `https://${lang}.wikipedia.org/wiki/${title}`, 'wikipedia-api', null, provenance);
                } catch (error) {
                    console.error('❌ Wikipedia extraction failed:', error);
                    throw new Error(`Wikipedia extraction failed: ${error.message}`);
                }
            }
            
            /**
             * 🎓 TEACHING: Multi-Tier URL Extraction (Server-Side Quality, Client-Side!)
             * Inspired by real-extraction-server.py multi-stage extraction pipeline
             * 
             * EXTRACTION TIERS:
             * 1. Direct fetch (works for CORS-enabled sites)
             * 2. CORS proxy cascade (3 public proxies for maximum coverage)
             * 3. Server-side extraction (if Real Extraction Server running)
             * 4. Manual paste fallback (with clear instructions)
             * 
             * This achieves server-like extraction using USER'S browser resources!
             */
            async processGeneralUrl(url) {
                console.log(`🌐 Multi-tier extraction starting: ${url}`);
                const progress = this.progressCallback;
                
                // 🎓 TIER 1: Direct Fetch (fastest, works for simple sites)
                try {
                    console.log('  📡 TIER 1: Attempting direct fetch...');
                    if (progress) progress('Attempting direct connection to website...');
                    
                    const response = await fetch(url, { signal: this.abortSignal });
                    this.lastModifiedHeader = response.headers.get('Last-Modified');
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }
                    
                    const html = await response.text();
                    console.log(`  ✅ TIER 1 SUCCESS: Fetched ${html.length} characters`);
                    if (progress) progress('Extracting content with Readability.js...');
                    
                    return await this.extractWithReadability(html, '', url, 'direct-fetch', this.lastModifiedHeader);
                    
                } catch (directError) {
                    if (directError.name === 'AbortError') throw directError;
                    console.warn(`  ⚠️ TIER 1 FAILED: ${directError.message}`);
                    console.log('  🔄 Falling back to CORS proxy cascade...');
                }
                
                // 🎓 TIER 2: CORS Proxy Cascade (uses user's browser, bypasses restrictions)
                for (let i = 0; i < CORS_PROXIES.length; i++) {
                    const proxy = CORS_PROXIES[i];
                    const proxyUrl = proxy + encodeURIComponent(url);
                    
                    try {
                        console.log(`  📡 TIER 2-${i+1}: Trying proxy ${i+1}/${CORS_PROXIES.length}...`);
                        console.log(`     Proxy: ${proxy.substring(0, 30)}...`);
                        if (progress) progress(`Trying CORS proxy ${i+1} of ${CORS_PROXIES.length}...`);
                        
                        const response = await fetch(proxyUrl, {
                            headers: {
                                'User-Agent': 'Mozilla/5.0 (compatible; ArcHive/1.0)'
                            },
                            signal: this.abortSignal || (function() {
                                var controller = new AbortController();
                                setTimeout(function() { controller.abort(); }, 10000);
                                return controller.signal;
                            })()
                        });
                        this.lastModifiedHeader = response.headers.get('Last-Modified');
                        
                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}`);
                        }
                        
                        const html = await response.text();
                        console.log(`  ✅ TIER 2-${i+1} SUCCESS: Fetched ${html.length} characters via proxy`);
                        if (progress) progress(`Extracting content (via proxy ${i+1})...`);
                        
                        return await this.extractWithReadability(html, '', url, `cors-proxy-${i+1}`, this.lastModifiedHeader);
                        
                    } catch (proxyError) {
                        if (proxyError.name === 'AbortError') throw proxyError;
                        console.warn(`  ⚠️ TIER 2-${i+1} FAILED: ${proxyError.message}`);
                        
                        if (i === CORS_PROXIES.length - 1) {
                            console.log('  ❌ All CORS proxies exhausted');
                        }
                    }
                }
                
                // 🎓 TIER 3: Offer Auto-Bookmarklet for Complex Sites
                // Note: Server extraction was removed - ArcHive is 100% client-side
                console.log('  ℹ️ TIER 4: Offering smart extraction options');
                const siteName = this.getSiteName(url);
                const isComplexSite = this.detectComplexSite(url);
                
                if (isComplexSite) {
                    // For complex sites (X.com, Reddit, etc.), offer bookmarklet
                    showBookmarkletModal(url, siteName);
                    throw new Error('BOOKMARKLET_OFFERED'); // Special code to prevent error display
                } else {
                    // For other sites, show manual paste instructions
                    throw new Error(
                        `Automated extraction failed for ${sanitizeForHTML(siteName)}\n\n` +
                        `🔧 EASY WORKAROUND:\n` +
                        `1. Visit: ${url}\n` +
                        `2. Right-click anywhere → "View Page Source" (or Ctrl+U)\n` +
                        `3. Select all (Ctrl+A) → Copy (Ctrl+C)\n` +
                        `4. Paste the HTML into the textarea above\n` +
                        `5. Click "Extract & Hash"\n\n` +
                        `This works for 100% of websites! Uses your browser, fully decentralized. ✅`
                    );
                }
            }
            
            /**
             * 🎓 TEACHING: Complex Site Detection
             * Identifies sites that require server-side extraction
             */
            detectComplexSite(url) {
                const complexDomains = [
                    'twitter.com', 'x.com',          // X/Twitter
                    'reddit.com',                     // Reddit
                    'instagram.com',                  // Instagram
                    'facebook.com', 'fb.com',        // Facebook
                    'linkedin.com',                   // LinkedIn
                    'tiktok.com',                     // TikTok
                    'youtube.com', 'youtu.be'        // YouTube
                ];
                
                try {
                    const urlObj = new URL(url);
                    const hostname = urlObj.hostname.replace('www.', '');
                    
                    return complexDomains.some(domain => hostname.includes(domain));
                } catch (e) {
                    return false;
                }
            }
            
            /**
             * Get friendly site name for error messages
             */
            getSiteName(url) {
                try {
                    const urlObj = new URL(url);
                    const hostname = urlObj.hostname.replace('www.', '');
                    
                    if (hostname.includes('twitter.com') || hostname.includes('x.com')) return 'X.com/Twitter';
                    if (hostname.includes('reddit.com')) return 'Reddit';
                    if (hostname.includes('instagram.com')) return 'Instagram';
                    if (hostname.includes('facebook.com')) return 'Facebook';
                    if (hostname.includes('linkedin.com')) return 'LinkedIn';
                    
                    return hostname;
                } catch (e) {
                    return 'this site';
                }
            }
            
            /**
             * HTML content processing
             */
            async processHTML(html) {
                // Check if user provided a source URL in the optional field
                const sourceUrlField = document.getElementById('sourceUrlInput');
                const sourceUrl = sourceUrlField ? sourceUrlField.value.trim() : '';
                return await this.extractWithReadability(html, '', sourceUrl || null, 'html-paste', null);
            }
            
            /**
             * 🎓 TEACHING: Publication Date Metadata Harvester
             * Extracts publication date from meta tags, JSON-LD, and time elements
             * Used for deterministic time-based tagging on Hive blockchain
             */
            harvestMetadata(doc, sourceUrl) {
                // Priority 1: Schema.org JSON-LD
                const ldJsonScripts = doc.querySelectorAll('script[type="application/ld+json"]');
                for (let script of ldJsonScripts) {
                    try {
                        const data = JSON.parse(script.textContent);
                        if (data.datePublished) return data.datePublished;
                        if (data.publishedDate) return data.publishedDate;
                    } catch(e) {}
                }
                
                // Priority 2: Standard meta tags
                const metaSelectors = [
                    'meta[property="article:published_time"]',
                    'meta[name="date"]',
                    'meta[name="publishdate"]',
                    'meta[name="publication_date"]',
                    'meta[property="og:published_time"]'
                ];
                
                for (let selector of metaSelectors) {
                    const meta = doc.querySelector(selector);
                    if (meta && meta.content) return meta.content;
                }
                
                // Priority 3: time[datetime] element
                const timeEl = doc.querySelector('time[datetime]');
                if (timeEl) return timeEl.getAttribute('datetime');
                
                return null; // No publication date found
            }
            
            /**
             * Extract content using Readability.js
             */
            async extractWithReadability(html, providedTitle, source, method, lastModified = null, provenance = null) {
                try {
                    // Parse HTML
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    
                    // Extract publication date metadata for smart tagging
                    const publicationDate = this.harvestMetadata(doc, source);
                    
                    // Build provenance if not provided (for non-Wikipedia sources)
                    if (!provenance) {
                        provenance = {
                            source_type: 'general',
                            extraction_method: method,
                            api_timestamp: new Date().toISOString()
                        };
                        if (lastModified) {
                            provenance.last_modified = lastModified;
                        }
                    }
                    
                    // Use Readability to extract content
                    const reader = new Readability(doc);
                    const article = reader.parse();
                    
                    if (!article) {
                        throw new Error('Readability.js could not extract content');
                    }
                    
                    // 🎓 TEACHING: Title Sanitization
                    // Wikipedia returns HTML in titles: "<span class='mw-page-title-main'>Thor</span>"
                    // We need plain text for Hive posts: "Thor"
                    let rawTitle = providedTitle || article.title || 'Untitled Archive';
                    let title = this.stripHtmlTags(rawTitle);
                    let textContent = article.textContent || '';
                    
                    // Clean Wikipedia-specific artifacts (geological timeline, infobox junk)
                    if (source && source.includes('wikipedia.org')) {
                        console.log('📚 Wikipedia detected - cleaning infobox artifacts');
                        textContent = this.cleanWikipediaArtifacts(textContent);
                        console.log('✅ Wikipedia artifacts removed');
                    }
                    
                    // Format Twitter/X content after extraction
                    // FIXED: Tweets don't have titles - use "X by @username" format
                    if (source && (source.includes('twitter.com') || source.includes('x.com'))) {
                        console.log('🐦 Twitter/X detected - applying clean formatting');
                        const twitterData = formatTwitterText(textContent, html);
                        textContent = twitterData.content;
                        
                        // Set title to "X by @username" (tweets don't have real titles)
                        if (twitterData.username) {
                            title = `X by @${twitterData.username}`;
                            console.log(`✅ Twitter title: "${title}"`);
                        } else {
                            title = 'X Post';
                            console.log('⚠️ Twitter username not found, using "X Post"');
                        }
                        console.log('✅ Twitter text formatted');
                    }
                    
                    console.log(`✅ Extracted: ${title} (${textContent.length} chars)`);
                    
                    // 🎓 TEACHING: Smart Image Detection
                    // Extract image URLs from HTML content (handles lazy-loading, relative URLs)
                    // This enables: Hive feed thumbnails, image preservation, visual archiving
                    // For Twitter/X: Use original HTML because Readability strips <img> tags from tweets
                    // For other sites: Use Readability's article.content which preserves images
                    const imageSource = (source && (source.includes('twitter.com') || source.includes('x.com'))) 
                        ? html 
                        : article.content;
                    const images = this.extractImages(imageSource, source);
                    
                    // 🎓 TEACHING: Image Integration - The Missing Step!
                    // Embed images directly into markdown content for display
                    // Without this, images only exist in metadata (invisible to readers!)
                    const enhancedContent = this.integrateImages(textContent, images);
                    
                    // Generate hashes (IMPORTANT: Hash BEFORE image integration to preserve original content)
                    const hashes = await this.generateHashes(textContent, title);
                    
                    // Count metrics
                    const wordCount = this.countWords(textContent);
                    
                    // Log metadata findings
                    if (publicationDate) {
                        console.log(`📅 Publication date: ${publicationDate}`);
                    }
                    if (lastModified) {
                        console.log(`📅 Last-Modified: ${lastModified}`);
                    }
                    
                    const archiveData = {
                        title: title,
                        content: enhancedContent, // Use enhanced content with embedded images
                        contentHtml: article.content,
                        source: source,
                        method: method,
                        wordCount: wordCount,
                        imageCount: images.length, // Use actual extracted count
                        images: images, // Store actual image URLs
                        publicationDate: publicationDate,
                        lastModified: lastModified,
                        url: source, // Add URL for tag generation
                        timestamp: new Date().toISOString(),
                        hashes: hashes,
                        provenance: provenance // 🔐 Provenance proof (Wikipedia revision ID, etc.)
                    };
                    
                    // Log provenance for debugging
                    if (provenance && provenance.revision_id) {
                        console.log(`🔐 Provenance captured: Wikipedia Revision ${provenance.revision_id}`);
                        console.log(`   Permanent URL: ${provenance.permanent_url}`);
                    }
                    
                    // Save to history
                    this.saveToHistory(archiveData);
                    
                    return archiveData;
                } catch (error) {
                    console.error('❌ Extraction failed:', error);
                    throw new Error(`Content extraction failed: ${error.message}`);
                }
            }
            
            /**
             * Generate cryptographic hashes using 3 algorithms
             */
            async generateHashes(content, title) {
                console.log('🔐 Generating multi-algorithm hashes...');
                
                const contentHashes = await this.hashString(content);
                const titleHashes = await this.hashString(title);
                const integrityString = `${content}|||${title}`;
                const integrityHashes = await this.hashString(integrityString);
                
                return {
                    content: contentHashes,
                    title: titleHashes,
                    integrity: integrityHashes
                };
            }
            
            /**
             * 🎓 TEACHING: Smart Tag Generation for 1900x Faster Hash Lookups
             * Generates 5-6 deterministic categories for Hive blockchain posts
             * 
             * OPTIMIZATION MATH:
             * - Without smart tags: Search 100,000 posts with 'archive' tag
             * - With 5 tags: 10 domains × 3 lengths × 4 quarters × 16 hash prefixes = ~52 posts
             * - Result: 1,900x faster search! 🚀
             * 
             * TAG CATEGORIES (Single-Part Content - 5 tags):
             * 1. DOMAIN: Source website (ARCHIVEX, ARCHIVEWIKI, etc.)
             * 2. LENGTH: Content size (ARCHIVESHORT/MEDIUM/LONG)
             * 3. DATE: Publication quarter (ARCHIVE2025Q1, etc.)
             * 4. HASH PREFIX: First hex char of SHA-256 (ARCHIVEHASH0-F)
             * 5. PRIMARY: archivedcontenthaf (unique identifier)
             * 
             * TAG CATEGORIES (Multi-Part Content - 6 tags):
             * All above tags PLUS:
             * 6. SERIES: Multi-part series bucket (SERIES0-SERIESF) - Phase 5
             *    - Creates 16 discovery buckets for multi-part content
             *    - Enables efficient search for all parts of a series
             * 
             * @param {Object} data - Archive data object
             * @param {string} seriesId - Optional series_id for multi-part content (Phase 5)
             * @returns {Array<string>} - Array of 5-6 system tags
             */
            generateArchiveTags(data, seriesId = null) {
                // Base 5 tags for all content (archivedcontenthaf is ALWAYS first - unique primary tag)
                const tags = [
                    'archivedcontenthaf',  // 1. Primary unique tag
                    this.computeDomainTag(data.url),  // 2. Domain (ARCHIVEX, ARCHIVEWIKI, etc.)
                    this.computeLengthTag(data.wordCount),  // 3. Length (SHORT/MEDIUM/LONG)
                    this.computeDateTag(data.publicationDate, data.lastModified),  // 4. Date (quarterly)
                    this.computeHashPrefixTag(data.hashes.content.sha256)  // 5. Hash prefix (0-F)
                ];
                
                // Phase 5: Add SERIES tag for multi-part content (6th system tag)
                if (seriesId) {
                    try {
                        // Use ArcHiveMultiPart.generateSeriesTag() to create SERIES tag
                        const seriesTag = window.ArcHiveMultiPart.generateSeriesTag(seriesId);
                        tags.push(seriesTag);  // 6. Series bucket (SERIES0-SERIESF)
                        console.log(`🏷️ Smart tags generated (6 total - multi-part with ${seriesTag}):`, tags);
                    } catch (error) {
                        console.error('❌ Failed to generate series tag:', error);
                        console.log('🏷️ Smart tags generated (5 total - series tag failed):', tags);
                    }
                } else {
                    console.log('🏷️ Smart tags generated (5 total - single-part):', tags);
                }
                
                return tags;
            }
            
            /**
             * Compute domain tag from source URL
             */
            computeDomainTag(sourceUrl) {
                try {
                    const url = new URL(sourceUrl);
                    const host = url.hostname.replace('www.', '').toLowerCase();
                    
                    // Social media platforms
                    if (host.includes('x.com') || host.includes('twitter.com')) return 'ARCHIVEX';
                    if (host.includes('reddit.com')) return 'ARCHIVEREDDIT';
                    if (host.includes('facebook.com')) return 'ARCHIVEFACEBOOK';
                    if (host.includes('instagram.com')) return 'ARCHIVEINSTAGRAM';
                    if (host.includes('linkedin.com')) return 'ARCHIVELINKEDIN';
                    
                    // Knowledge bases
                    if (host.includes('wikipedia.org')) return 'ARCHIVEWIKI';
                    if (host.includes('github.com')) return 'ARCHIVEGITHUB';
                    if (host.includes('stackoverflow.com')) return 'ARCHIVESTACK';
                    
                    // News sites
                    if (host.includes('nytimes.com') || host.includes('bbc.com') || 
                        host.includes('cnn.com') || host.includes('reuters.com')) return 'ARCHIVENEWS';
                    
                    // Blogs & Medium
                    if (host.includes('medium.com') || host.includes('substack.com')) return 'ARCHIVEBLOG';
                    
                    return 'ARCHIVEOTHER';
                } catch(e) {
                    // If no valid URL provided, default to OTHER (user should provide URL in Source URL field)
                    console.warn('⚠️ No valid URL for domain tag - using ARCHIVEOTHER. Please provide Source URL.');
                    return 'ARCHIVEOTHER';
                }
            }
            
            /**
             * Compute length tag from word count
             */
            computeLengthTag(wordCount) {
                if (wordCount < 100) return 'ARCHIVESHORT';
                if (wordCount < 1000) return 'ARCHIVEMEDIUM';
                return 'ARCHIVELONG';
            }
            
            /**
             * Compute date tag from publication date or Last-Modified header
             * Uses UTC to ensure deterministic tagging across timezones
             */
            computeDateTag(publicationDate, lastModified) {
                let date = null;
                let source = 'unknown';
                
                // Priority 1: Publication date from meta tags
                if (publicationDate) {
                    date = new Date(publicationDate);
                    source = 'pub';
                }
                // Priority 2: Last-Modified HTTP header
                else if (lastModified) {
                    date = new Date(lastModified);
                    source = 'mod';
                }
                // Priority 3: Current date (fallback with special marker)
                else {
                    date = new Date();
                    source = 'now';
                }
                
                // Validate date
                if (isNaN(date.getTime())) {
                    console.warn('⚠️ Invalid date, using ARCHIVEUNKNOWN tag');
                    return 'ARCHIVEUNKNOWN';
                }
                
                // Calculate quarter using UTC to avoid timezone issues
                const year = date.getUTCFullYear();
                const quarter = Math.floor(date.getUTCMonth() / 3) + 1;
                
                // Add 'now' marker for current-date fallbacks
                const prefix = source === 'now' ? 'ARCHIVEnow' : 'ARCHIVE';
                const tag = `${prefix}${year}Q${quarter}`;
                
                console.log(`📅 Date tag: ${tag} (source: ${source === 'pub' ? 'publication date' : source === 'mod' ? 'Last-Modified header' : 'current date'})`);
                
                return tag;
            }
            
            /**
             * Compute hash prefix tag from SHA-256 hash
             * First hex character creates 16 evenly-distributed buckets
             */
            computeHashPrefixTag(sha256Hash) {
                if (!sha256Hash || sha256Hash.length === 0) {
                    console.error('❌ Missing SHA-256 hash for prefix tag');
                    return 'ARCHIVEHASH0'; // Safe fallback
                }
                
                const firstChar = sha256Hash.charAt(0).toUpperCase();
                return `ARCHIVEHASH${firstChar}`;
            }
            
            /**
             * Hash a string with SHA-256, BLAKE2b, and MD5
             */
            async hashString(input) {
                const encoder = new TextEncoder();
                const data = encoder.encode(input);
                
                // SHA-256 (Native Web Crypto API)
                const sha256Buffer = await crypto.subtle.digest('SHA-256', data);
                const sha256 = Array.from(new Uint8Array(sha256Buffer))
                    .map(b => b.toString(16).padStart(2, '0'))
                    .join('');
                
                // BLAKE2b
                const blake2b = blakejs.blake2bHex(input, null, 32);
                
                // MD5
                const md5Hash = md5(input);
                
                return {
                    sha256: sha256,
                    blake2b: blake2b,
                    md5: md5Hash
                };
            }
            
            /**
             * 🎓 TEACHING: Smart Image Extraction
             * Extract image URLs from HTML content with intelligent fallbacks
             * Features:
             * - Handles lazy-loaded images (data-src, data-lazy-src)
             * - Converts relative URLs to absolute URLs
             * - Filters out base64 data URIs
             * - Limits to 10 images for Hive feed optimization
             */
            extractImages(htmlContent, baseUrl) {
                console.log('🖼️ Extracting images from content...');
                console.log(`  📍 Base URL for images: ${baseUrl}`);
                
                const doc = new DOMParser().parseFromString(htmlContent, 'text/html');
                const images = Array.from(doc.querySelectorAll('img'))
                    .map(img => {
                        // FIXED: Use getAttribute to get RAW src value (not browser-resolved)
                        // img.src auto-resolves relative URLs to current page (wrong domain!)
                        // img.getAttribute('src') returns the original attribute value
                        let src = img.getAttribute('src') || img.getAttribute('data-src') || img.getAttribute('data-lazy-src');
                        
                        // Skip base64 embedded images and empty sources
                        if (src && !src.startsWith('data:')) {
                            // Convert relative URLs to absolute using source page's URL
                            try {
                                const absoluteUrl = new URL(src, baseUrl).href;
                                console.log(`  🔗 ${src} → ${absoluteUrl}`);
                                return absoluteUrl;
                            } catch (e) {
                                console.warn(`  ⚠️ Failed to resolve: ${src}`);
                                return src;
                            }
                        }
                        return null;
                    })
                    .filter(src => src) // Remove nulls
                    .slice(0, 10); // Limit to 10 images for Hive feed
                
                console.log(`  ✅ Found ${images.length} images`);
                return images;
            }
            
            /**
             * Count words in text
             */
            countWords(text) {
                return text.trim().split(/\s+/).filter(word => word.length > 0).length;
            }
            
            /**
             * 🎓 TEACHING: HTML Tag Removal
             * Removes HTML tags from text (e.g., Wikipedia title formatting)
             * Example: "<span class='title'>Thor</span>" → "Thor"
             */
            stripHtmlTags(text) {
                const doc = new DOMParser().parseFromString(text, 'text/html');
                return doc.body.textContent || text;
            }
            
            /**
             * Clean Wikipedia-specific artifacts that Readability.js extracts incorrectly
             * - Geological timeline tables (PreC€OSDC PT J K Pg N ↓)
             * - Infobox metadata (Conservation status, Scientific classification, etc.)
             * - Navigation breadcrumbs
             */
            cleanWikipediaArtifacts(text) {
                const lines = text.split('\n');
                const cleaned = [];
                let foundArticleStart = false;
                
                // Wikipedia infobox keywords to skip
                const infoboxKeywords = [
                    'Temporal range:', 'Conservation status', 'Scientific classification',
                    'Kingdom:', 'Phylum:', 'Class:', 'Order:', 'Family:', 'Genus:', 'Species:',
                    'Domesticated', 'Various types of', 'Binomial name', 'Trinomial name',
                    'Subspecies', 'Breeds', 'Domain:', 'Clade:', 'Subclass:', 'Infraclass:',
                    'Superorder:', 'Suborder:', 'Infraorder:', 'Superfamily:', 'Subfamily:',
                    'Type species', 'Diversity', 'Synonyms', 'Range map'
                ];
                
                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i].trim();
                    
                    // Skip empty lines at the start
                    if (!foundArticleStart && !line) continue;
                    
                    // Skip infobox metadata lines
                    if (infoboxKeywords.some(keyword => line.includes(keyword))) {
                        continue;
                    }
                    
                    // Skip single-letter or symbol lines (geological timeline junk)
                    if (line.length <= 2 && /^[A-Z€↓Є∞]$/i.test(line)) {
                        continue;
                    }
                    
                    // Skip lines that are just taxonomy names (single words ending with "a")
                    if (/^[A-Z][a-z]+a$/.test(line) && line.length < 15) {
                        // Skip likely taxonomy terms like "Animalia", "Chordata", "Mammalia"
                        continue;
                    }
                    
                    // Skip "Holocene to present" timeline text
                    if (/^(Holocene|Pleistocene|Pliocene|Miocene).*(?:present|ago)/i.test(line)) {
                        continue;
                    }
                    
                    // ARTICLE START DETECTION: Look for proper sentences (starts with capital, has words, ends with punctuation)
                    // Wikipedia articles typically start like "The cat (Felis catus)..."
                    if (!foundArticleStart && line.length > 30 && /^[A-Z].*[.!?]$/.test(line)) {
                        foundArticleStart = true;
                        cleaned.push(line);
                        continue;
                    }
                    
                    // Once we've found article start, keep everything
                    if (foundArticleStart) {
                        cleaned.push(lines[i]); // Keep original formatting
                    }
                }
                
                return cleaned.join('\n').trim();
            }
            
            /**
             * 🎓 TEACHING: Intelligent Image Integration into Content
             * Embeds images throughout the text at strategic intervals
             * This makes images visible when post is rendered on Hive frontends
             * 
             * Strategy:
             * - Splits content into paragraphs
             * - Calculates even distribution intervals
             * - Inserts images between paragraphs using Markdown syntax
             * - Prevents image clustering at top or bottom
             */
            integrateImages(content, images) {
                if (!images || images.length === 0) {
                    console.log('  ℹ️ No images to integrate');
                    return content;
                }
                
                console.log(`  🖼️ Integrating ${images.length} images into content...`);
                
                // BUG FIX #5: Robust paragraph splitting with regex (handles \n\n\n or varied spacing)
                const paragraphs = content.split(/\n{2,}/).filter(p => p.trim().length > 0);
                
                // BUG FIX #3: Lower threshold from 3 to 2 for short Twitter posts
                if (paragraphs.length >= 2 && images.length > 0) {
                    // BUG FIX #2: Build new array instead of mutating with splice
                    const result = [];
                    let imageIndex = 0;
                    const imageInterval = Math.max(1, Math.floor(paragraphs.length / (images.length + 1)));
                    
                    for (let i = 0; i < paragraphs.length; i++) {
                        result.push(paragraphs[i]);
                        
                        // Insert image after this paragraph if it's time
                        const nextImagePosition = (imageIndex + 1) * imageInterval;
                        if (i === nextImagePosition - 1 && imageIndex < images.length) {
                            result.push(`![Image ${imageIndex + 1}](${images[imageIndex]})`);
                            imageIndex++;
                        }
                    }
                    
                    console.log(`  ✅ Images integrated at ${imageIndex} positions`);
                    return result.join('\n\n');
                } else if (paragraphs.length === 1 && images.length > 0) {
                    // For single paragraph, add image after it
                    console.log('  ℹ️ Single paragraph detected, appending images after content');
                    return content + '\n\n' + images.map((img, i) => `![Image ${i + 1}](${img})`).join('\n\n');
                } else {
                    // Fallback for edge cases
                    console.log('  ℹ️ Content too short for integration, appending images');
                    return content + '\n\n' + images.map((img, i) => `![Image ${i + 1}](${img})`).join('\n\n');
                }
            }
            
            /**
             * Save archive to localStorage history
             * Stores only essential metadata to prevent quota errors
             */
            saveToHistory(data) {
                // Create lightweight history entry (no full content/HTML to save space)
                const historyEntry = {
                    title: data.title,
                    source: data.source,
                    timestamp: data.timestamp,
                    wordCount: data.wordCount,
                    imageCount: data.imageCount,
                    method: data.method,
                    // Store all three hashes for verification
                    hashes: {
                        content: {
                            sha256: data.hashes?.content?.sha256 || null,
                            blake2b: data.hashes?.content?.blake2b || null,
                            md5: data.hashes?.content?.md5 || null
                        },
                        title: {
                            sha256: data.hashes?.title?.sha256 || null,
                            blake2b: data.hashes?.title?.blake2b || null,
                            md5: data.hashes?.title?.md5 || null
                        },
                        integrity: {
                            sha256: data.hashes?.integrity?.sha256 || null,
                            blake2b: data.hashes?.integrity?.blake2b || null,
                            md5: data.hashes?.integrity?.md5 || null
                        }
                    },
                    // Legacy fields for backward compatibility
                    fullHash: data.hashes?.content?.sha256 || null,
                    contentHash: data.hashes?.content?.sha256?.substring(0, 16) || null,
                    // Blockchain data (populated after successful Hive post)
                    txid: null,
                    author: null,
                    permlink: null,
                    ecencyUrl: null,
                    hivescanTxUrl: null
                };
                
                this.history.unshift(historyEntry);
                
                // Keep last 20 archives (auto-delete older ones)
                if (this.history.length > 20) {
                    this.history = this.history.slice(0, 20);
                    console.log(`🗑️ Trimmed history to last 20 archives`);
                }
                
                try {
                    localStorage.setItem('archiveHistory', JSON.stringify(this.history));
                    console.log(`💾 Saved to history (${this.history.length}/20 archives)`);
                } catch (error) {
                    console.warn('⚠️ Could not save to localStorage:', error);
                    // If still failing, try clearing old history and retry with just this one
                    try {
                        this.history = [historyEntry];
                        localStorage.setItem('archiveHistory', JSON.stringify(this.history));
                        console.log('💾 Cleared old history and saved current archive');
                    } catch (retryError) {
                        console.error('❌ localStorage completely full, cannot save history');
                    }
                }
            }
            
            /**
             * Load history from localStorage
             */
            loadHistory() {
                try {
                    const stored = localStorage.getItem('archiveHistory');
                    return stored ? JSON.parse(stored) : [];
                } catch (error) {
                    console.warn('⚠️ Could not load history:', error);
                    return [];
                }
            }
            
            /**
             * Clear all history
             */
            clearHistory() {
                this.history = [];
                try {
                    localStorage.removeItem('archiveHistory');
                    console.log('🗑️ History cleared');
                } catch (error) {
                    console.warn('⚠️ Could not clear history:', error);
                }
            }
            
            /**
             * Update existing history entry with blockchain data after successful Hive post
             * Matches by source URL or timestamp to find the correct entry
             */
            updateHistoryWithBlockchainData(source, txid, author, permlink) {
                // Find the most recent history entry matching this source
                const entryIndex = this.history.findIndex(entry => 
                    entry.source === source || 
                    (Date.now() - new Date(entry.timestamp).getTime() < 60000) // Within last minute
                );
                
                if (entryIndex !== -1) {
                    const ecencyUrl = `https://ecency.com/@${author}/${permlink}`;
                    const hivescanTxUrl = txid ? `https://hivescan.info/tx/${txid}` : null;
                    
                    this.history[entryIndex] = {
                        ...this.history[entryIndex],
                        txid: txid,
                        author: author,
                        permlink: permlink,
                        ecencyUrl: ecencyUrl,
                        hivescanTxUrl: hivescanTxUrl
                    };
                    
                    try {
                        localStorage.setItem('archiveHistory', JSON.stringify(this.history));
                        console.log(`📝 Updated history entry with blockchain data: @${author}/${permlink}`);
                    } catch (error) {
                        console.warn('⚠️ Could not update history with blockchain data:', error);
                    }
                } else {
                    console.warn('⚠️ Could not find matching history entry to update');
                }
            }
        }
        
        /* ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
         * UI FUNCTIONS
         * ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ */
        
        const processor = new ArchiveProcessor();
        
        /**
         * 🎓 TEACHING: Multi-Tier CORS Proxy System
         * Tries multiple public CORS proxies to bypass restrictions
         * Uses user's browser resources, not our server!
         */
        const CORS_PROXIES = [
            'https://api.allorigins.win/raw?url=',
            'https://corsproxy.io/?',
            'https://api.codetabs.com/v1/proxy?quest='
        ];
        
        /**
         * 🎓 TEACHING: Progress Callback System for User Feedback
         * Provides real-time status updates during multi-tier extraction
         */
        let currentAbortController = null;
        
        function updateExtractionProgress(message, isError = false) {
            const statusDiv = document.getElementById('status');
            const statusClass = isError ? 'status-error' : 'status-loading';
            const icon = isError ? '⚠️' : '⏳';
            
            statusDiv.innerHTML = `
                <div class="status ${statusClass}">
                    <span class="spinner"></span> 
                    <strong>${icon} ${message}</strong>
                    ${!isError ? '<button onclick="cancelExtraction()" style="margin-left: 10px; padding: 4px 12px; border: none; background: #ef4444; color: white; border-radius: 4px; cursor: pointer; font-size: 12px;">❌ Cancel</button>' : ''}
                </div>
            `;
        }
        
        function cancelExtraction() {
            if (currentAbortController) {
                currentAbortController.abort();
                updateExtractionProgress('Extraction cancelled by user', true);
            }
        }
        
        /**
         * Focus textarea and add visual hint for manual paste
         */
        function focusTextarea() {
            const textarea = document.getElementById('contentInput');
            textarea.focus();
            textarea.placeholder = '👈 Paste HTML source code from the website here, then click "Extract & Hash"...';
            textarea.style.border = '2px solid #3b82f6';
            textarea.style.boxShadow = '0 0 0 3px rgba(59, 130, 246, 0.2)';
            
            // Scroll to textarea
            textarea.scrollIntoView({ behavior: 'smooth', block: 'center' });
            
            // Reset styling after 3 seconds
            setTimeout(() => {
                textarea.style.border = '';
                textarea.style.boxShadow = '';
            }, 3000);
        }
        
        // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
        // SMART PRE-ARCHIVE LOOKUP FLOW
        // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
        
        /**
         * Show a modal overlay with custom content
         */
        function showModal(content) {
            // Remove existing modal if any
            const existing = document.getElementById('smartArchiveModal');
            if (existing) existing.remove();
            
            const modal = document.createElement('div');
            modal.id = 'smartArchiveModal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.7);
                backdrop-filter: blur(5px);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                padding: var(--spacing-md);
            `;
            
            const modalContent = document.createElement('div');
            modalContent.style.cssText = `
                background: var(--surface-bg);
                border-radius: 16px;
                max-width: 600px;
                width: 100%;
                max-height: 90vh;
                overflow-y: auto;
                box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            `;
            modalContent.innerHTML = content;
            
            modal.appendChild(modalContent);
            document.body.appendChild(modal);
            
            // Close on outside click
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
            
            return modal;
        }
        
        /**
         * Close the smart archive modal
         */
        function closeModal() {
            const modal = document.getElementById('smartArchiveModal');
            if (modal) modal.remove();
        }
        
        /**
         * Scenario A: URL not found on Hive - Offer to archive now
         */
        function showNotFoundModal(url, contentExtracted = false, extractionError = null) {
            // Check if we have server-extracted data
            const serverData = window._serverExtractedData;
            const hasExtractedContent = contentExtracted || (serverData && serverData.content);
            
            let statusMessage = '';
            let buttonAction = '';
            
            if (hasExtractedContent) {
                // Content already extracted - ready to archive
                statusMessage = `
                    <div style="background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.3); padding: var(--spacing-sm) var(--spacing-md); border-radius: 8px; margin-bottom: var(--spacing-md);">
                        <div style="color: #059669; font-weight: 600; display: flex; align-items: center; gap: 8px;">
                            <span>✅</span>
                            <span>Content extracted and ready to archive!</span>
                        </div>
                        ${serverData?.title ? `<div style="color: var(--text-secondary); font-size: 0.85rem; margin-top: 4px;">Title: ${escapeHtml(serverData.title.substring(0, 60))}${serverData.title.length > 60 ? '...' : ''}</div>` : ''}
                    </div>
                `;
                buttonAction = 'processContent(true)';
            } else if (extractionError) {
                // Extraction failed - offer bookmarklet
                statusMessage = `
                    <div style="background: rgba(245, 158, 11, 0.1); border: 1px solid rgba(245, 158, 11, 0.3); padding: var(--spacing-sm) var(--spacing-md); border-radius: 8px; margin-bottom: var(--spacing-md);">
                        <div style="color: #d97706; font-weight: 600; display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                            <span>⚠️</span>
                            <span>This site requires special handling</span>
                        </div>
                        <div style="color: var(--text-tertiary); font-size: 0.85rem;">
                            ${escapeHtml(extractionError)}
                        </div>
                    </div>
                `;
                buttonAction = 'showBookmarkletInstructions()';
            } else {
                buttonAction = 'processContent(true)';
            }
            
            const content = `
                <div style="padding: var(--spacing-md) var(--spacing-lg);">
                    <div style="text-align: center; font-size: 2.2rem; margin-bottom: var(--spacing-sm);">📭</div>
                    <h2 style="font-size: var(--text-2xl); font-weight: 700; text-align: center; margin-bottom: var(--spacing-sm); color: var(--text-primary);">
                        Not Yet Archived
                    </h2>
                    <p style="color: var(--text-secondary); text-align: center; margin-bottom: var(--spacing-md); font-size: var(--text-base); line-height: 1.5;">
                        This link hasn't been archived yet. Be the first to preserve it on the blockchain!
                    </p>
                    ${statusMessage}
                    <div style="background: rgba(241, 245, 249, 0.6); padding: var(--spacing-sm) var(--spacing-md); border-radius: 8px; margin-bottom: var(--spacing-md); word-break: break-all; font-family: monospace; font-size: var(--text-xs); color: var(--text-tertiary); border: 1px solid var(--border-color);">
                        ${escapeHtml(url)}
                    </div>
                    <div class="btn-group">
                        ${hasExtractedContent ? `
                            <button class="btn btn-success btn-full" onclick="closeModal(); ${buttonAction};" style="min-height: var(--touch-target);">
                                ✅ Archive Now
                            </button>
                        ` : extractionError ? `
                            <button class="btn btn-primary btn-full" onclick="closeModal(); ${buttonAction};" style="min-height: var(--touch-target);">
                                📥 Get Bookmarklet
                            </button>
                        ` : `
                            <button class="btn btn-success btn-full" onclick="closeModal(); ${buttonAction};" style="min-height: var(--touch-target);">
                                ✅ Archive Now
                            </button>
                        `}
                        <button class="btn" onclick="closeModal();" style="background: rgba(100, 116, 139, 0.1); color: var(--text-secondary); min-height: var(--touch-target);">
                            Cancel
                        </button>
                    </div>
                </div>
            `;
            showModal(content);
        }
        
        /**
         * Show "Verify or View" modal when URL found on Hive
         * ✅ CRITICAL FIX: Re-validate all manifests before showing modal
         * ✅ AUTO-VERIFY: If content already extracted, compare hashes immediately
         */
        async function showVerifyOrViewModal(url, matchingPosts, extractedData = null) {
            // CHECK: If content already extracted (from bookmarklet or server), auto-verify
            const extractedHtml = window._bookmarkletExtractedHtml;
            const textareaContent = document.getElementById('contentInput')?.value?.trim();
            const serverExtracted = extractedData || window._serverExtractedData;
            
            if (extractedHtml || textareaContent || serverExtracted) {
                console.log('🔍 Auto-verification: Content available, comparing hashes automatically...');
                const contentToVerify = extractedHtml || textareaContent || (serverExtracted?.content);
                await performAutoVerification(url, matchingPosts, contentToVerify);
                return;
            }
            
            // RE-VALIDATE manifests before proceeding (with legacy single-part support)
            const multipartModule = window.ArcHiveMultiPart;
            
            for (const post of matchingPosts) {
                const manifest = multipartModule?.extractManifestFromPost(post);
                if (!manifest) {
                    // Check for legacy single-part archive (has hashes but no manifest)
                    let metadata = post.json_metadata;
                    if (typeof metadata === 'string') {
                        try {
                            metadata = JSON.parse(metadata);
                        } catch (e) {
                            metadata = {};
                        }
                    }
                    
                    if (metadata && metadata.hashes) {
                        // Legacy single-part archive - skip manifest validation
                        console.log(`✅ Legacy single-part archive: @${post.author}/${post.permlink} (has hashes, no manifest)`);
                        continue;
                    }
                    
                    console.error(`❌ No manifest found for @${post.author}/${post.permlink} - rejecting`);
                    showToast('error', 'Archive validation failed: No valid manifest');
                    return;
                }
                
                try {
                    await multipartModule.validateManifest(manifest);
                    console.log(`✅ Re-validated manifest for @${post.author}/${post.permlink}`);
                } catch (error) {
                    // Validation failed - abort and show error
                    console.error(`❌ Re-validation failed for @${post.author}/${post.permlink}:`, error);
                    showToast('error', 'Archive validation failed: ' + error.message);
                    return;
                }
            }
            
            const hivePostUrl = 'https://ecency.com/@' + matchingPosts[0].author + '/' + matchingPosts[0].permlink;
            const versionCount = matchingPosts.length;
            const post = matchingPosts[0];
            
            // Detect if this is a multi-part series
            const manifest = detectManifest(post);
            const isSeries = manifest && manifest.total_parts > 1;
            
            let content;
            
            if (isSeries) {
                // Multi-part series modal
                const date = new Date(post.created).toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                const multipartModule = window.ArcHiveMultiPart;
                const seriesTag = multipartModule ? multipartModule.generateSeriesTag(manifest.series_id) : 'SERIES';
                
                content = `
                    <div style="padding: var(--spacing-xl);">
                        <!-- Icon -->
                        <div style="text-align: center; margin-bottom: var(--spacing-lg);">
                            <div style="display: inline-flex; align-items: center; justify-content: center; width: 72px; height: 72px; background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); border-radius: 50%; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);">
                                <svg width="40" height="40" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M20 7L12 3L4 7M20 7L12 11M20 7V17L12 21M12 11L4 7M12 11V21M4 7V17L12 21" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                            </div>
                        </div>
                        
                        <!-- Title -->
                        <h2 style="font-size: 1.5rem; font-weight: 700; text-align: center; margin-bottom: var(--spacing-sm); color: var(--text-primary); line-height: 1.3;">
                            Already Archived
                        </h2>
                        <p style="text-align: center; margin-bottom: var(--spacing-xs); color: #3b82f6; font-weight: 600; font-size: 0.95rem;">
                            Multi-Part Series (${manifest.total_parts} parts)
                        </p>
                        <p style="color: var(--text-secondary); text-align: center; margin-bottom: var(--spacing-xl); font-size: var(--text-sm); line-height: 1.6;">
                            This URL was archived on <strong>${date}</strong>.<br>Verify if content changed or view the archive.
                        </p>
                        
                        <!-- Series Info Card -->
                        <div style="background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); border: 1px solid #bae6fd; border-radius: 12px; padding: var(--spacing-md); margin-bottom: var(--spacing-xl); box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);">
                            <div style="display: grid; gap: var(--spacing-md);">
                                <div>
                                    <div style="color: #0369a1; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">Series ID</div>
                                    <div style="color: #0c4a6e; font-size: 0.85rem; font-family: 'Monaco', 'Courier New', monospace; word-break: break-all;">${manifest.series_id}</div>
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-md);">
                                    <div>
                                        <div style="color: #0369a1; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">Parts</div>
                                        <div style="color: #0c4a6e; font-size: 0.9rem; font-weight: 600;">${manifest.total_parts}</div>
                                    </div>
                                    <div>
                                        <div style="color: #0369a1; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">Tag</div>
                                        <div style="color: #0c4a6e; font-size: 0.9rem; font-weight: 600;">${seriesTag}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Action Buttons -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-sm); margin-bottom: var(--spacing-sm);">
                            <button onclick="closeModal(); startVerification();" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none; border-radius: 10px; padding: 14px 20px; font-weight: 600; font-size: 0.95rem; cursor: pointer; transition: all 0.2s; box-shadow: 0 2px 8px rgba(16, 185, 129, 0.25); min-height: var(--touch-target); display: flex; align-items: center; justify-content: center; gap: 8px;">
                                <span>🔍</span> Verify
                            </button>
                            <button onclick="closeModal(); viewArchivedContent();" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; border: none; border-radius: 10px; padding: 14px 20px; font-weight: 600; font-size: 0.95rem; cursor: pointer; transition: all 0.2s; box-shadow: 0 2px 8px rgba(59, 130, 246, 0.25); min-height: var(--touch-target); display: flex; align-items: center; justify-content: center; gap: 8px;">
                                <span>📖</span> View Now
                            </button>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-sm);">
                            <a href="${hivePostUrl}" target="_blank" style="background: white; color: #3b82f6; border: 2px solid #3b82f6; border-radius: 10px; padding: 14px 20px; font-weight: 600; font-size: 0.95rem; cursor: pointer; transition: all 0.2s; min-height: var(--touch-target); display: flex; align-items: center; justify-content: center; gap: 8px; text-decoration: none;">
                                <span>🔗</span> View on Hive
                            </a>
                            <button onclick="closeModal();" style="background: #f1f5f9; color: #64748b; border: none; border-radius: 10px; padding: 14px 20px; font-weight: 600; font-size: 0.95rem; cursor: pointer; transition: all 0.2s; min-height: var(--touch-target);">
                                Cancel
                            </button>
                        </div>
                    </div>
                `;
            } else {
                // Single-part modal with modern design
                const date = new Date(post.created).toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                
                content = `
                    <div style="padding: var(--spacing-xl);">
                        <!-- Icon -->
                        <div style="text-align: center; margin-bottom: var(--spacing-lg);">
                            <div style="display: inline-flex; align-items: center; justify-content: center; width: 72px; height: 72px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); border-radius: 50%; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);">
                                <svg width="40" height="40" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M9 12L11 14L15 10M21 12C21 16.9706 16.9706 21 12 21C7.02944 21 3 16.9706 3 12C3 7.02944 7.02944 3 12 3C16.9706 3 21 7.02944 21 12Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                            </div>
                        </div>
                        
                        <!-- Title -->
                        <h2 style="font-size: 1.5rem; font-weight: 700; text-align: center; margin-bottom: var(--spacing-sm); color: var(--text-primary); line-height: 1.3;">
                            Already Archived
                        </h2>
                        <p style="text-align: center; margin-bottom: var(--spacing-xs); color: #10b981; font-weight: 600; font-size: 0.95rem;">
                            Single Post
                        </p>
                        <p style="color: var(--text-secondary); text-align: center; margin-bottom: var(--spacing-xl); font-size: var(--text-sm); line-height: 1.6;">
                            This URL was archived on <strong>${date}</strong>.<br>Verify if content changed or view the archive.
                        </p>
                        
                        <!-- Action Buttons -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-sm); margin-bottom: var(--spacing-sm);">
                            <button onclick="closeModal(); startVerification();" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none; border-radius: 10px; padding: 14px 20px; font-weight: 600; font-size: 0.95rem; cursor: pointer; transition: all 0.2s; box-shadow: 0 2px 8px rgba(16, 185, 129, 0.25); min-height: var(--touch-target); display: flex; align-items: center; justify-content: center; gap: 8px;">
                                <span>🔍</span> Verify
                            </button>
                            <button onclick="closeModal(); viewArchivedContent();" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; border: none; border-radius: 10px; padding: 14px 20px; font-weight: 600; font-size: 0.95rem; cursor: pointer; transition: all 0.2s; box-shadow: 0 2px 8px rgba(59, 130, 246, 0.25); min-height: var(--touch-target); display: flex; align-items: center; justify-content: center; gap: 8px;">
                                <span>📖</span> View Now
                            </button>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-sm);">
                            <a href="${hivePostUrl}" target="_blank" style="background: white; color: #3b82f6; border: 2px solid #3b82f6; border-radius: 10px; padding: 14px 20px; font-weight: 600; font-size: 0.95rem; cursor: pointer; transition: all 0.2s; min-height: var(--touch-target); display: flex; align-items: center; justify-content: center; gap: 8px; text-decoration: none;">
                                <span>🔗</span> View on Hive
                            </a>
                            <button onclick="closeModal();" style="background: #f1f5f9; color: #64748b; border: none; border-radius: 10px; padding: 14px 20px; font-weight: 600; font-size: 0.95rem; cursor: pointer; transition: all 0.2s; min-height: var(--touch-target);">
                                Cancel
                            </button>
                        </div>
                    </div>
                `;
            }
            
            showModal(content);
            
            // Initialize verification state with all required fields
            let expectedHashes = null;
            try {
                const metadata = typeof matchingPosts[0].json_metadata === 'string' 
                    ? JSON.parse(matchingPosts[0].json_metadata) 
                    : matchingPosts[0].json_metadata;
                expectedHashes = metadata.hashes || null;
            } catch (e) {
                console.warn('⚠️ Could not parse archived hashes:', e);
            }
            
            window._archiveVerificationData = {
                mode: null,
                url: url,
                matchingPosts: matchingPosts,
                expectedHashes: expectedHashes,
                extractionReady: false,
                isSeries: isSeries,
                manifest: manifest,
                archivedParts: []
            };
            
            console.log('📋 Verification data initialized:', window._archiveVerificationData);
        }
        
        /**
         * Auto-verify when content is already extracted (from bookmarklet or client-side)
         * Compares hashes immediately without showing F12 instructions
         * 
         * Handles two content types:
         * 1. Client-side extracted: Plain text from ContentExtractor - hash directly
         * 2. Bookmarklet-extracted: HTML that needs Readability parsing
         */
        async function performAutoVerification(url, matchingPosts, contentOrHtml) {
            try {
                showLoadingModal('Verifying content hashes...');
                
                // Get archived hashes from the post
                const post = matchingPosts[0];
                let archivedMetadata = post.json_metadata;
                if (typeof archivedMetadata === 'string') {
                    archivedMetadata = JSON.parse(archivedMetadata);
                }
                
                // Check if multi-part
                const manifest = window.ArcHiveMultiPart?.extractManifestFromPost(post);
                const isSeries = manifest && manifest.total_parts > 1;
                
                // Determine content source and process accordingly
                console.log('🔍 Processing content for hash comparison...');
                let currentData;
                
                // Check if we have client-side extracted data (plain text, not HTML)
                const serverData = window._serverExtractedData;
                if (serverData && serverData.content) {
                    console.log('📡 Using client-side extracted plain text content');
                    // Server returns plain text - compute hashes directly using processor's method
                    const content = serverData.content;
                    const title = serverData.title || 'Untitled';
                    
                    // Use processor.generateHashes which handles all 3 hash types
                    const hashes = await processor.generateHashes(content, title);
                    
                    currentData = {
                        title: title,
                        content: content,
                        url: url,
                        provenance: serverData.provenance || null,
                        hashes: hashes,
                        extractionMethod: 'server-api'
                    };
                    console.log(`✅ Server content processed: ${content.length} chars`);
                } else {
                    // Bookmarklet HTML or textarea content - process with Readability
                    console.log('📄 Processing as HTML with Readability');
                    currentData = await processor.processContent(contentOrHtml, null, null);
                }
                
                processor.currentData = currentData;
                
                // Store content in textarea for later use (showContentDiff needs this)
                document.getElementById('contentInput').value = currentData.content || contentOrHtml;
                
                // Initialize verification state for showContentDiff to use
                let expectedHashes = archivedMetadata.hashes || null;
                window._archiveVerificationData = {
                    mode: 'verification',
                    url: url,
                    matchingPosts: matchingPosts,
                    expectedHashes: expectedHashes,
                    extractionReady: true,
                    isSeries: isSeries,
                    manifest: manifest,
                    archivedParts: [],
                    currentContent: currentData.content  // Store for comparison
                };
                console.log('📋 Verification data initialized for auto-verify:', window._archiveVerificationData);
                
                closeModal();
                
                if (isSeries) {
                    // Multi-part series - compare full content hash
                    const archivedFullHash = manifest.content_hash_full;
                    if (!archivedFullHash) {
                        console.warn('⚠️ No archived full content hash found for multi-part series');
                        showAutoVerificationResult(url, matchingPosts, false, 'No archived hash data available - treating as new version');
                        return;
                    }
                    
                    // For multi-part, we need to compare the full content hash
                    // The current content hash is in currentData.hashes.content.sha256
                    const currentHash = currentData.hashes.content.sha256;
                    const archivedHash = archivedFullHash.sha256 || archivedFullHash;
                    
                    const isMatch = currentHash === archivedHash;
                    console.log(`🔍 Multi-part hash comparison: ${isMatch ? '✅ MATCH' : '❌ MISMATCH'}`);
                    console.log(`   Current:  ${currentHash}`);
                    console.log(`   Archived: ${archivedHash}`);
                    
                    // Debug: Log content length for analysis
                    const contentLength = currentData.content?.length || 0;
                    console.log(`   Content length: ${contentLength} chars`);
                    console.log(`   Title: "${currentData.title}"`);
                    
                    // If mismatch, check for common causes
                    if (!isMatch) {
                        const isWikipedia = url.includes('wikipedia.org');
                        if (isWikipedia) {
                            console.log('   📚 Wikipedia detected - articles can change frequently (edits, view counts, timestamps)');
                        }
                    }
                    
                    showAutoVerificationResult(url, matchingPosts, isMatch, null, manifest);
                } else {
                    // Single-part - compare all 9 hashes
                    const archivedHashes = archivedMetadata.hashes;
                    if (!archivedHashes) {
                        console.warn('⚠️ No archived hashes found');
                        showAutoVerificationResult(url, matchingPosts, false, 'No archived hash data available - treating as new version');
                        return;
                    }
                    
                    const currentHashes = currentData.hashes;
                    
                    // Compare content hashes (primary verification)
                    const contentMatch = currentHashes.content.sha256 === archivedHashes.content?.sha256;
                    const titleMatch = currentHashes.title.sha256 === archivedHashes.title?.sha256;
                    
                    const isMatch = contentMatch && titleMatch;
                    console.log(`🔍 Single-part hash comparison: ${isMatch ? '✅ MATCH' : '❌ MISMATCH'}`);
                    console.log(`   Content SHA-256: ${contentMatch ? '✅' : '❌'}`);
                    console.log(`   Title SHA-256: ${titleMatch ? '✅' : '❌'}`);
                    
                    showAutoVerificationResult(url, matchingPosts, isMatch);
                }
                
                // Clear the extracted HTML since we've processed it
                window._bookmarkletExtractedHtml = null;
                
            } catch (error) {
                console.error('❌ Auto-verification failed:', error);
                closeModal();
                showToast('error', 'Verification failed: ' + error.message);
            }
        }
        
        /**
         * Show auto-verification result modal
         */
        function showAutoVerificationResult(url, matchingPosts, isMatch, errorMessage = null, manifest = null) {
            const post = matchingPosts[0];
            const hiveUrl = `https://ecency.com/@${post.author}/${post.permlink}`;
            const date = new Date(post.created).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            
            // Check if this is a Wikipedia article for contextual messaging
            const isWikipedia = url.includes('wikipedia.org');
            
            let content;
            
            if (isMatch) {
                // Content unchanged - show verified modal
                content = `
                    <div style="padding: var(--spacing-xl);">
                        <div style="text-align: center; margin-bottom: var(--spacing-lg);">
                            <div style="display: inline-flex; align-items: center; justify-content: center; width: 80px; height: 80px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); border-radius: 50%; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);">
                                <span style="font-size: 40px;">✅</span>
                            </div>
                        </div>
                        
                        <h2 style="font-size: 1.5rem; font-weight: 700; text-align: center; margin-bottom: var(--spacing-sm); color: var(--text-primary);">
                            Content Verified
                        </h2>
                        <p style="color: #10b981; text-align: center; font-weight: 600; margin-bottom: var(--spacing-md);">
                            Hashes Match - Content Unchanged
                        </p>
                        <p style="color: var(--text-secondary); text-align: center; margin-bottom: var(--spacing-lg); font-size: var(--text-sm);">
                            This content is identical to the version archived on <strong>${date}</strong>. No new archive needed.
                        </p>
                        
                        <div style="background: rgba(16, 185, 129, 0.1); border: 2px solid rgba(16, 185, 129, 0.3); border-radius: 12px; padding: var(--spacing-md); margin-bottom: var(--spacing-lg); text-align: center;">
                            <span style="font-size: 1.5rem;">🔒</span>
                            <p style="color: #065f46; font-weight: 600; margin: var(--spacing-sm) 0 0 0;">Cryptographic integrity confirmed</p>
                        </div>
                        
                        <div class="btn-group">
                            <a href="${hiveUrl}" target="_blank" class="btn btn-success btn-full" style="min-height: var(--touch-target); text-decoration: none;">
                                🔗 View Archive on Hive
                            </a>
                            <button class="btn" onclick="closeModal();" style="background: rgba(100, 116, 139, 0.1); color: var(--text-secondary); min-height: var(--touch-target);">
                                Close
                            </button>
                        </div>
                    </div>
                `;
            } else {
                // Content changed - show update option
                let changeReason = errorMessage || 'Content has been edited since the last archive';
                
                // Add Wikipedia-specific context
                if (isWikipedia && !errorMessage) {
                    changeReason = 'Wikipedia articles are edited frequently by contributors worldwide';
                }
                
                content = `
                    <div style="padding: var(--spacing-xl);">
                        <div style="text-align: center; margin-bottom: var(--spacing-lg);">
                            <div style="display: inline-flex; align-items: center; justify-content: center; width: 80px; height: 80px; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); border-radius: 50%; box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);">
                                <span style="font-size: 40px;">📝</span>
                            </div>
                        </div>
                        
                        <h2 style="font-size: 1.5rem; font-weight: 700; text-align: center; margin-bottom: var(--spacing-sm); color: var(--text-primary);">
                            Content Changed
                        </h2>
                        <p style="color: #d97706; text-align: center; font-weight: 600; margin-bottom: var(--spacing-md);">
                            Hash Mismatch Detected
                        </p>
                        <p style="color: var(--text-secondary); text-align: center; margin-bottom: var(--spacing-lg); font-size: var(--text-sm);">
                            ${changeReason}. Last archived on <strong>${date}</strong>.
                        </p>
                        
                        ${isWikipedia ? `
                        <div style="background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 8px; padding: var(--spacing-sm); margin-bottom: var(--spacing-md); text-align: left; font-size: 0.8rem; color: #1e40af;">
                            <strong>📚 Note:</strong> Wikipedia pages can change even minutes after archiving due to community edits, image URL updates, or template changes. This is expected behavior - your archived version is preserved.
                        </div>
                        ` : ''}
                        
                        <div style="background: rgba(245, 158, 11, 0.1); border: 2px solid rgba(245, 158, 11, 0.3); border-radius: 12px; padding: var(--spacing-md); margin-bottom: var(--spacing-lg); text-align: center;">
                            <span style="font-size: 1.5rem;">⚠️</span>
                            <p style="color: #92400e; font-weight: 600; margin: var(--spacing-sm) 0 0 0;">Archive a new version to preserve the current content</p>
                        </div>
                        
                        <div class="btn-group">
                            <button class="btn btn-success btn-full" onclick="closeModal(); processContent(true);" style="min-height: var(--touch-target);">
                                📤 Archive Updated Version Now
                            </button>
                            <button class="btn btn-full" onclick="showContentDiff('${url.replace(/'/g, "\\'")}');" style="background: rgba(139, 92, 246, 0.1); color: #7c3aed; border: 2px solid #7c3aed; min-height: var(--touch-target);">
                                🔍 See What Changed
                            </button>
                            <a href="${hiveUrl}" target="_blank" class="btn btn-full" style="background: rgba(59, 130, 246, 0.1); color: #3b82f6; border: 2px solid #3b82f6; min-height: var(--touch-target); text-decoration: none; display: flex; align-items: center; justify-content: center;">
                                🔗 View Old Archive
                            </a>
                            <button class="btn" onclick="closeModal();" style="background: rgba(100, 116, 139, 0.1); color: var(--text-secondary); min-height: var(--touch-target);">
                                Cancel
                            </button>
                        </div>
                    </div>
                `;
            }
            
            showModal(content);
        }
        
        /**
         * Extract just the article content from a Hive post body
         * Strips out headers, hash tables, and other formatting
         */
        function extractArticleContent(postBody) {
            let content = postBody;
            
            // Try to extract content between "## 📝 Archived Content" and the next major section
            const contentMatch = content.match(/##\s*📝\s*Archived Content\s*\n([\s\S]*?)(?=\n---|\n##\s*🔐|\n##\s*📊|\n\|.*\|.*\||\n<!--)/i);
            if (contentMatch && contentMatch[1]) {
                content = contentMatch[1];
            } else {
                // Fallback: Remove known formatting patterns
                // Remove title line
                content = content.replace(/^#\s+.+\n*/m, '');
                // Remove archive info headers
                content = content.replace(/##\s*📝\s*Archived Content\s*\n*/gi, '');
                content = content.replace(/##\s*🔐\s*Cryptographic.*\n*/gi, '');
                content = content.replace(/##\s*📊\s*Archive.*\n*/gi, '');
                content = content.replace(/##\s*🔗\s*Source.*\n*/gi, '');
                // Remove hash tables
                content = content.replace(/\|[^\n]*\|[^\n]*\|\n/g, '');
                content = content.replace(/\|[-:\s|]+\|\n/g, '');
                // Remove horizontal rules
                content = content.replace(/^---+$/gm, '');
                // Remove manifest comments
                content = content.replace(/<!--ARCHIVE-MANIFEST:[\s\S]*?-->/g, '');
                // Remove other HTML comments
                content = content.replace(/<!--[\s\S]*?-->/g, '');
                // Remove badge/link lines at the end
                content = content.replace(/\[!\[.*?\]\(.*?\)\]\(.*?\)/g, '');
                content = content.replace(/\*Archived.*archivedcontenthaf.*\*/gi, '');
            }
            
            // Clean up extra whitespace
            content = content.replace(/\n{3,}/g, '\n\n').trim();
            
            return content;
        }
        
        /**
         * Show content diff between archived and current content
         * Fetches archived content from Hive and compares with current extraction
         */
        async function showContentDiff(url) {
            closeModal();
            showLoadingModal('Fetching archived content for comparison...');
            
            try {
                // Get current content from multiple sources (in priority order)
                let currentContent = null;
                
                // Source 1: processor.currentData (from bookmarklet processing)
                if (processor.currentData && processor.currentData.content) {
                    currentContent = processor.currentData.content;
                    console.log('📄 Using content from processor.currentData');
                }
                // Source 2: window._archiveVerificationData (from auto-verification)
                else if (window._archiveVerificationData && window._archiveVerificationData.currentContent) {
                    currentContent = window._archiveVerificationData.currentContent;
                    console.log('📄 Using content from _archiveVerificationData.currentContent');
                }
                // Source 3: window._serverExtractedData (from server extraction)
                else if (window._serverExtractedData && window._serverExtractedData.content) {
                    currentContent = window._serverExtractedData.content;
                    console.log('📄 Using content from _serverExtractedData');
                }
                // Source 4: Textarea (fallback)
                else {
                    const textareaContent = document.getElementById('contentInput')?.value?.trim();
                    if (textareaContent && textareaContent.length > 100) {
                        currentContent = textareaContent;
                        console.log('📄 Using content from textarea');
                    }
                }
                
                if (!currentContent) {
                    throw new Error('No current content available for comparison');
                }
                
                // Wrap in object for compatibility with existing code
                const currentData = { content: currentContent };
                
                // Get the archived post data
                const verificationData = window._archiveVerificationData;
                if (!verificationData || !verificationData.matchingPosts || verificationData.matchingPosts.length === 0) {
                    throw new Error('No archived post data available');
                }
                
                const post = verificationData.matchingPosts[0];
                const manifest = verificationData.manifest;
                
                let archivedContent = '';
                
                if (manifest && manifest.total_parts > 1) {
                    // Multi-part: Fetch and reassemble all parts
                    console.log('🔍 Fetching multi-part archived content...');
                    const multipartModule = window.ArcHiveMultiPart;
                    
                    // Find all series parts
                    const seriesTag = multipartModule.generateSeriesTag(manifest.series_id);
                    const lookupModule = window.ArcHiveHiveLookup;
                    
                    // Note: searchHiveByTags(tags, progressCallback) - no limit parameter
                    const seriesPosts = await lookupModule.searchHiveByTags([seriesTag]);
                    
                    // Sort by part number and reassemble
                    const sortedParts = seriesPosts
                        .map(p => {
                            const m = multipartModule.extractManifestFromPost(p);
                            return { post: p, manifest: m };
                        })
                        .filter(x => x.manifest && x.manifest.series_id === manifest.series_id)
                        .sort((a, b) => (a.manifest.current_part || 1) - (b.manifest.current_part || 1));
                    
                    // Extract content from each part
                    for (const part of sortedParts) {
                        let body = part.post.body || '';
                        // Strip manifest comment
                        body = body.replace(/\n*<!--ARCHIVE-MANIFEST:[\s\S]*?-->/g, '');
                        archivedContent += body;
                    }
                } else {
                    // Single part: Extract from post body
                    archivedContent = post.body || '';
                }
                
                // Extract just the article content from the archived post (strip Hive formatting)
                archivedContent = extractArticleContent(archivedContent);
                
                closeModal();
                
                // Calculate similarity and differences
                const comparison = compareContent(currentData.content, archivedContent);
                
                // Show diff modal
                showDiffModal(comparison, currentData.content, archivedContent, url);
                
            } catch (error) {
                console.error('❌ Content comparison failed:', error);
                closeModal();
                showToast('error', 'Failed to fetch archived content: ' + error.message);
            }
        }
        
        /**
         * Compare two content strings and calculate similarity with detailed text diff
         */
        function compareContent(currentContent, archivedContent) {
            // Normalize content for comparison (remove extra whitespace)
            const normalizeText = (text) => text.replace(/\s+/g, ' ').trim();
            
            const current = normalizeText(currentContent);
            const archived = normalizeText(archivedContent);
            
            // Calculate character-level similarity using Levenshtein-like approach
            // For performance, use word-based comparison for long texts
            const currentWords = current.split(' ');
            const archivedWords = archived.split(' ');
            
            // Find common words (simple approach)
            const currentSet = new Set(currentWords);
            const archivedSet = new Set(archivedWords);
            
            let commonWords = 0;
            for (const word of currentSet) {
                if (archivedSet.has(word)) commonWords++;
            }
            
            const totalUniqueWords = new Set([...currentWords, ...archivedWords]).size;
            const wordSimilarity = totalUniqueWords > 0 ? (commonWords / totalUniqueWords) * 100 : 0;
            
            // Character length comparison
            const lengthDiff = Math.abs(current.length - archived.length);
            const avgLength = (current.length + archived.length) / 2;
            const lengthSimilarity = avgLength > 0 ? Math.max(0, 100 - (lengthDiff / avgLength) * 100) : 0;
            
            // Combined similarity score
            const similarity = Math.round((wordSimilarity * 0.7 + lengthSimilarity * 0.3));
            
            // Find specific differences (first few)
            const addedWords = currentWords.filter(w => !archivedSet.has(w) && w.length > 3).slice(0, 10);
            const removedWords = archivedWords.filter(w => !currentSet.has(w) && w.length > 3).slice(0, 10);
            
            // ═══════════════════════════════════════════════════════════════
            // ENHANCED: Sentence-level diff for actual text changes
            // ═══════════════════════════════════════════════════════════════
            const sentenceDiff = computeSentenceDiff(current, archived);
            
            return {
                similarity: similarity,
                currentLength: currentContent.length,
                archivedLength: archivedContent.length,
                currentWordCount: currentWords.length,
                archivedWordCount: archivedWords.length,
                addedWords: addedWords,
                removedWords: removedWords,
                // NEW: Detailed sentence-level changes
                addedSentences: sentenceDiff.added,
                removedSentences: sentenceDiff.removed,
                modifiedSentences: sentenceDiff.modified,
                unchangedCount: sentenceDiff.unchangedCount,
                totalSentences: sentenceDiff.totalSentences,
                changeType: sentenceDiff.changeType
            };
        }
        
        /**
         * Compute sentence-level diff between current and archived content
         * Returns added, removed, and modified sentences with context
         */
        function computeSentenceDiff(current, archived) {
            // Split into sentences/segments (handle common patterns)
            const splitSentences = (text) => {
                return text
                    .split(/(?<=[.!?:;])\s+|(?<=\n)|\s{2,}/)
                    .map(s => s.trim())
                    .filter(s => s.length > 3 && /[a-zA-Z]/.test(s)); // Keep anything with letters
            };
            
            const currentSentences = splitSentences(current);
            const archivedSentences = splitSentences(archived);
            
            // Track which archived sentences have been matched
            const matchedArchived = new Set();
            const matchedCurrent = new Set();
            
            // Find exact matches first
            currentSentences.forEach((cs, ci) => {
                archivedSentences.forEach((as, ai) => {
                    if (!matchedArchived.has(ai) && cs === as) {
                        matchedCurrent.add(ci);
                        matchedArchived.add(ai);
                    }
                });
            });
            
            // Find modified sentences (similar but not identical)
            const modified = [];
            currentSentences.forEach((cs, ci) => {
                if (matchedCurrent.has(ci)) return;
                
                let bestMatch = null;
                let bestSim = 0;
                let bestIdx = -1;
                
                archivedSentences.forEach((as, ai) => {
                    if (matchedArchived.has(ai)) return;
                    
                    const sim = sentenceSimilarity(cs, as);
                    if (sim > bestSim && sim >= 0.4 && sim < 0.95) {
                        bestSim = sim;
                        bestMatch = as;
                        bestIdx = ai;
                    }
                });
                
                if (bestMatch && bestIdx >= 0) {
                    matchedCurrent.add(ci);
                    matchedArchived.add(bestIdx);
                    modified.push({
                        before: truncateSentence(bestMatch, 120),
                        after: truncateSentence(cs, 120),
                        similarity: Math.round(bestSim * 100)
                    });
                }
            });
            
            // Find added sentences (in current but not matched)
            const added = [];
            currentSentences.forEach((cs, ci) => {
                if (!matchedCurrent.has(ci)) {
                    added.push(truncateSentence(cs, 150));
                }
            });
            
            // Find removed sentences (in archived but not matched)
            const removed = [];
            archivedSentences.forEach((as, ai) => {
                if (!matchedArchived.has(ai)) {
                    removed.push(truncateSentence(as, 150));
                }
            });
            
            // Calculate unchanged count
            const unchangedCount = currentSentences.length - added.length - modified.length;
            
            // Determine change type
            let changeType = 'mixed';
            if (added.length > 0 && removed.length === 0 && modified.length === 0) {
                changeType = 'additions_only';
            } else if (removed.length > 0 && added.length === 0 && modified.length === 0) {
                changeType = 'removals_only';
            } else if (modified.length > 0 && added.length === 0 && removed.length === 0) {
                changeType = 'edits_only';
            } else if (added.length === 0 && removed.length === 0 && modified.length === 0) {
                changeType = 'structural_only'; // Formatting/whitespace changes
            }
            
            return {
                added: added.slice(0, 5), // Limit for UI
                removed: removed.slice(0, 5),
                modified: modified.slice(0, 3),
                unchangedCount: Math.max(0, unchangedCount),
                totalSentences: Math.max(currentSentences.length, archivedSentences.length),
                changeType: changeType
            };
        }
        
        /**
         * Calculate similarity between two sentences (0-1) using word overlap
         * Improved to handle punctuation and provide granular scores
         */
        function sentenceSimilarity(s1, s2) {
            // Normalize: lowercase, keep alphanumeric and spaces
            const normalize = (s) => s.toLowerCase().replace(/[^a-z0-9\s]/g, ' ').replace(/\s+/g, ' ').trim();
            
            const words1 = normalize(s1).split(' ').filter(w => w.length > 2);
            const words2 = normalize(s2).split(' ').filter(w => w.length > 2);
            
            if (words1.length === 0 || words2.length === 0) return 0;
            
            // Count word frequency for better matching
            const freq1 = new Map();
            const freq2 = new Map();
            
            words1.forEach(w => freq1.set(w, (freq1.get(w) || 0) + 1));
            words2.forEach(w => freq2.set(w, (freq2.get(w) || 0) + 1));
            
            // Calculate overlap using min frequency (handles repeated words)
            let overlap = 0;
            for (const [word, count1] of freq1) {
                const count2 = freq2.get(word) || 0;
                overlap += Math.min(count1, count2);
            }
            
            // Similarity is overlap divided by average word count
            const avgLen = (words1.length + words2.length) / 2;
            return overlap / avgLen;
        }
        
        /**
         * Truncate sentence with ellipsis
         */
        function truncateSentence(s, maxLength) {
            if (s.length <= maxLength) return s;
            return s.slice(0, maxLength - 3) + '...';
        }
        
        /**
         * Show the diff comparison modal
         */
        function showDiffModal(comparison, currentContent, archivedContent, url) {
            const similarityColor = comparison.similarity >= 90 ? '#10b981' : 
                                   comparison.similarity >= 70 ? '#f59e0b' : '#ef4444';
            
            const lengthChange = comparison.currentLength - comparison.archivedLength;
            const lengthChangeText = lengthChange > 0 ? `+${lengthChange.toLocaleString()} chars` : 
                                    lengthChange < 0 ? `${lengthChange.toLocaleString()} chars` : 'No change';
            const lengthChangeColor = lengthChange > 0 ? '#10b981' : lengthChange < 0 ? '#ef4444' : '#64748b';
            
            const wordChange = comparison.currentWordCount - comparison.archivedWordCount;
            const wordChangeText = wordChange > 0 ? `+${wordChange.toLocaleString()} words` : 
                                  wordChange < 0 ? `${wordChange.toLocaleString()} words` : 'No change';
            
            const content = `
                <div style="padding: var(--spacing-xl); max-height: 80vh; overflow-y: auto;">
                    <div style="text-align: center; margin-bottom: var(--spacing-lg);">
                        <div style="display: inline-flex; align-items: center; justify-content: center; width: 80px; height: 80px; background: linear-gradient(135deg, #8b5cf6 0%, #6d28d9 100%); border-radius: 50%; box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);">
                            <span style="font-size: 40px;">🔍</span>
                        </div>
                    </div>
                    
                    <h2 style="font-size: 1.5rem; font-weight: 700; text-align: center; margin-bottom: var(--spacing-lg); color: var(--text-primary);">
                        Content Comparison
                    </h2>
                    
                    <!-- Similarity Score -->
                    <div style="background: linear-gradient(135deg, rgba(139, 92, 246, 0.1) 0%, rgba(109, 40, 217, 0.1) 100%); border: 2px solid rgba(139, 92, 246, 0.3); border-radius: 16px; padding: var(--spacing-lg); margin-bottom: var(--spacing-lg); text-align: center;">
                        <div style="font-size: 3rem; font-weight: 800; color: ${similarityColor}; margin-bottom: var(--spacing-xs);">
                            ${comparison.similarity}%
                        </div>
                        <div style="color: var(--text-secondary); font-weight: 600;">
                            Content Similarity
                        </div>
                        <div style="color: var(--text-tertiary); font-size: 0.85rem; margin-top: var(--spacing-xs);">
                            ${comparison.similarity >= 90 ? 'Minor edits detected' : 
                              comparison.similarity >= 70 ? 'Moderate changes' : 'Significant changes'}
                        </div>
                    </div>
                    
                    <!-- Stats Grid -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-md); margin-bottom: var(--spacing-lg);">
                        <div style="background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: var(--spacing-md); text-align: center;">
                            <div style="color: var(--text-tertiary); font-size: 0.75rem; text-transform: uppercase; margin-bottom: 4px;">Length Change</div>
                            <div style="color: ${lengthChangeColor}; font-weight: 700; font-size: 1.1rem;">${lengthChangeText}</div>
                        </div>
                        <div style="background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: var(--spacing-md); text-align: center;">
                            <div style="color: var(--text-tertiary); font-size: 0.75rem; text-transform: uppercase; margin-bottom: 4px;">Word Count</div>
                            <div style="color: ${lengthChangeColor}; font-weight: 700; font-size: 1.1rem;">${wordChangeText}</div>
                        </div>
                    </div>
                    
                    <!-- Content Stats -->
                    <div style="background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: var(--spacing-md); margin-bottom: var(--spacing-lg);">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-md);">
                            <div>
                                <div style="color: var(--text-tertiary); font-size: 0.75rem; margin-bottom: 4px;">📦 Archived Version</div>
                                <div style="color: var(--text-secondary); font-size: 0.9rem;">${comparison.archivedLength.toLocaleString()} chars</div>
                                <div style="color: var(--text-tertiary); font-size: 0.8rem;">${comparison.archivedWordCount.toLocaleString()} words</div>
                            </div>
                            <div>
                                <div style="color: var(--text-tertiary); font-size: 0.75rem; margin-bottom: 4px;">🌐 Current Version</div>
                                <div style="color: var(--text-secondary); font-size: 0.9rem;">${comparison.currentLength.toLocaleString()} chars</div>
                                <div style="color: var(--text-tertiary); font-size: 0.8rem;">${comparison.currentWordCount.toLocaleString()} words</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Change Type Summary -->
                    <div style="background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: var(--spacing-md); margin-bottom: var(--spacing-lg);">
                        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: var(--spacing-sm);">
                            <span style="font-size: 1.2rem;">${
                                comparison.changeType === 'additions_only' ? '➕' :
                                comparison.changeType === 'removals_only' ? '➖' :
                                comparison.changeType === 'edits_only' ? '✏️' :
                                comparison.changeType === 'structural_only' ? '🔄' : '📝'
                            }</span>
                            <span style="color: var(--text-primary); font-weight: 600;">${
                                comparison.changeType === 'additions_only' ? 'New Content Added' :
                                comparison.changeType === 'removals_only' ? 'Content Removed' :
                                comparison.changeType === 'edits_only' ? 'Text Edited' :
                                comparison.changeType === 'structural_only' ? 'Formatting Changes' : 'Multiple Changes'
                            }</span>
                        </div>
                        <div style="color: var(--text-tertiary); font-size: 0.85rem;">
                            ${comparison.unchangedCount} of ${comparison.totalSentences} sentences unchanged
                        </div>
                    </div>
                    
                    ${comparison.modifiedSentences && comparison.modifiedSentences.length > 0 ? `
                    <!-- Modified Text (Before/After) -->
                    <div style="background: linear-gradient(135deg, rgba(245, 158, 11, 0.1) 0%, rgba(217, 119, 6, 0.05) 100%); border: 2px solid rgba(245, 158, 11, 0.3); border-radius: 12px; padding: var(--spacing-md); margin-bottom: var(--spacing-lg);">
                        <div style="color: #d97706; font-weight: 600; margin-bottom: var(--spacing-md); display: flex; align-items: center; gap: 0.5rem;">
                            <span>✏️</span>
                            <span>Edited Text (${comparison.modifiedSentences.length} change${comparison.modifiedSentences.length > 1 ? 's' : ''})</span>
                        </div>
                        ${comparison.modifiedSentences.map((mod, i) => `
                        <div style="margin-bottom: ${i < comparison.modifiedSentences.length - 1 ? 'var(--spacing-md)' : '0'}; ${i > 0 ? 'padding-top: var(--spacing-md); border-top: 1px solid rgba(245, 158, 11, 0.2);' : ''}">
                            <div style="margin-bottom: var(--spacing-xs);">
                                <span style="background: #fef3c7; color: #92400e; padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; font-weight: 600;">BEFORE</span>
                            </div>
                            <div style="color: #92400e; font-size: 0.85rem; line-height: 1.5; padding: 0.5rem; background: rgba(254, 243, 199, 0.5); border-radius: 6px; margin-bottom: var(--spacing-xs); text-decoration: line-through; opacity: 0.8;">
                                "${escapeHtml(mod.before)}"
                            </div>
                            <div style="margin-bottom: var(--spacing-xs);">
                                <span style="background: #d1fae5; color: #065f46; padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; font-weight: 600;">AFTER</span>
                            </div>
                            <div style="color: #065f46; font-size: 0.85rem; line-height: 1.5; padding: 0.5rem; background: rgba(209, 250, 229, 0.5); border-radius: 6px;">
                                "${escapeHtml(mod.after)}"
                            </div>
                        </div>
                        `).join('')}
                    </div>
                    ` : ''}
                    
                    ${comparison.addedSentences && comparison.addedSentences.length > 0 ? `
                    <!-- Added Content -->
                    <div style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(5, 150, 105, 0.05) 100%); border: 2px solid rgba(16, 185, 129, 0.3); border-radius: 12px; padding: var(--spacing-md); margin-bottom: var(--spacing-lg);">
                        <div style="color: #059669; font-weight: 600; margin-bottom: var(--spacing-sm); display: flex; align-items: center; gap: 0.5rem;">
                            <span>➕</span>
                            <span>New Content Added (${comparison.addedSentences.length} item${comparison.addedSentences.length > 1 ? 's' : ''})</span>
                        </div>
                        ${comparison.addedSentences.map(s => `
                        <div style="color: #065f46; font-size: 0.85rem; line-height: 1.5; padding: 0.5rem; background: rgba(209, 250, 229, 0.5); border-radius: 6px; margin-bottom: 0.5rem; border-left: 3px solid #10b981;">
                            + "${escapeHtml(s)}"
                        </div>
                        `).join('')}
                    </div>
                    ` : ''}
                    
                    ${comparison.removedSentences && comparison.removedSentences.length > 0 ? `
                    <!-- Removed Content -->
                    <div style="background: linear-gradient(135deg, rgba(239, 68, 68, 0.1) 0%, rgba(220, 38, 38, 0.05) 100%); border: 2px solid rgba(239, 68, 68, 0.3); border-radius: 12px; padding: var(--spacing-md); margin-bottom: var(--spacing-lg);">
                        <div style="color: #dc2626; font-weight: 600; margin-bottom: var(--spacing-sm); display: flex; align-items: center; gap: 0.5rem;">
                            <span>➖</span>
                            <span>Content Removed (${comparison.removedSentences.length} item${comparison.removedSentences.length > 1 ? 's' : ''})</span>
                        </div>
                        ${comparison.removedSentences.map(s => `
                        <div style="color: #991b1b; font-size: 0.85rem; line-height: 1.5; padding: 0.5rem; background: rgba(254, 226, 226, 0.5); border-radius: 6px; margin-bottom: 0.5rem; border-left: 3px solid #ef4444; text-decoration: line-through; opacity: 0.8;">
                            - "${escapeHtml(s)}"
                        </div>
                        `).join('')}
                    </div>
                    ` : ''}
                    
                    ${comparison.addedWords.length > 0 || comparison.removedWords.length > 0 ? `
                    <!-- Word-Level Changes (Collapsed by default) -->
                    <details style="background: var(--surface); border: 1px solid var(--border); border-radius: 12px; margin-bottom: var(--spacing-lg);">
                        <summary style="padding: var(--spacing-md); cursor: pointer; color: var(--text-secondary); font-weight: 600; font-size: 0.9rem;">
                            🔤 View Word-Level Changes
                        </summary>
                        <div style="padding: 0 var(--spacing-md) var(--spacing-md);">
                            ${comparison.addedWords.length > 0 ? `
                            <div style="margin-bottom: var(--spacing-sm);">
                                <span style="color: #10b981; font-size: 0.8rem; font-weight: 600;">+ Added words:</span>
                                <div style="color: #10b981; font-size: 0.85rem; word-wrap: break-word;">${comparison.addedWords.slice(0, 8).join(', ')}${comparison.addedWords.length > 8 ? '...' : ''}</div>
                            </div>
                            ` : ''}
                            ${comparison.removedWords.length > 0 ? `
                            <div>
                                <span style="color: #ef4444; font-size: 0.8rem; font-weight: 600;">- Removed words:</span>
                                <div style="color: #ef4444; font-size: 0.85rem; word-wrap: break-word;">${comparison.removedWords.slice(0, 8).join(', ')}${comparison.removedWords.length > 8 ? '...' : ''}</div>
                            </div>
                            ` : ''}
                        </div>
                    </details>
                    ` : ''}
                    
                    <div class="btn-group">
                        <button class="btn btn-full" onclick="closeModal(); postVersionUpdate('${url.replace(/'/g, "\\'")}', ${comparison.similarity});" style="background: linear-gradient(135deg, #8b5cf6 0%, #6d28d9 100%); color: white; min-height: var(--touch-target);">
                            📝 Post as Version Update
                        </button>
                        <button class="btn btn-success btn-full" onclick="closeModal(); processContent(true);" style="min-height: var(--touch-target);">
                            📤 Archive as New Post
                        </button>
                        <button class="btn" onclick="closeModal();" style="background: rgba(100, 116, 139, 0.1); color: var(--text-secondary); min-height: var(--touch-target);">
                            Close
                        </button>
                    </div>
                    
                    <div style="background: rgba(139, 92, 246, 0.1); border: 1px solid rgba(139, 92, 246, 0.3); border-radius: 12px; padding: var(--spacing-md); margin-top: var(--spacing-md);">
                        <p style="font-size: 0.85rem; color: var(--text-secondary); margin: 0;">
                            <strong>📝 Version Update:</strong> Posts as a reply to the original archive, creating a visible edit history on the blockchain.
                        </p>
                    </div>
                </div>
            `;
            
            showModal(content);
        }
        
        /**
         * Post current content as a version update (threaded reply) under the original archive
         * Creates a visible edit history chain on Hive blockchain
         */
        async function postVersionUpdate(url, similarity) {
            const state = window._archiveVerificationData;
            const currentData = window._preExtractedData;
            
            if (!state || !state.matchingPosts || state.matchingPosts.length === 0) {
                showToast('error', 'Cannot find original archive to update');
                return;
            }
            
            if (!currentData) {
                showToast('error', 'No current content extracted');
                return;
            }
            
            // Get the original post info
            const originalPost = state.matchingPosts[0];
            const originalAuthor = originalPost.author;
            const originalPermlink = originalPost.permlink;
            
            // Build version info
            const versionInfo = {
                version: (state.matchingPosts.length + 1), // Increment version number
                originalAuthor: originalAuthor,
                originalPermlink: originalPermlink,
                contentChanged: similarity < 100,
                similarity: similarity,
                previousVersion: `@${originalAuthor}/${originalPermlink}`
            };
            
            // Store version info for the posting flow
            window._versionUpdateInfo = versionInfo;
            
            console.log('📝 Preparing version update:', versionInfo);
            
            // Show confirmation
            const content = `
                <div style="padding: var(--spacing-xl); text-align: center;">
                    <div style="display: inline-flex; align-items: center; justify-content: center; width: 80px; height: 80px; background: linear-gradient(135deg, #8b5cf6 0%, #6d28d9 100%); border-radius: 50%; margin-bottom: var(--spacing-lg); box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);">
                        <span style="font-size: 40px;">📝</span>
                    </div>
                    
                    <h2 style="font-size: 1.5rem; font-weight: 700; margin-bottom: var(--spacing-md); color: var(--text-primary);">
                        Post Version Update
                    </h2>
                    
                    <p style="color: var(--text-secondary); margin-bottom: var(--spacing-lg); line-height: 1.6;">
                        This will post the current content as a <strong>threaded reply</strong> under the original archive, creating a visible version history on the blockchain.
                    </p>
                    
                    <div style="background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: var(--spacing-md); margin-bottom: var(--spacing-lg); text-align: left;">
                        <div style="display: grid; gap: var(--spacing-sm);">
                            <div style="display: flex; justify-content: space-between;">
                                <span style="color: var(--text-tertiary);">Original Author:</span>
                                <span style="color: var(--text-primary); font-weight: 600;">@${originalAuthor}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span style="color: var(--text-tertiary);">Version:</span>
                                <span style="color: #8b5cf6; font-weight: 600;">#${versionInfo.version}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span style="color: var(--text-tertiary);">Similarity:</span>
                                <span style="color: ${similarity >= 90 ? '#10b981' : similarity >= 70 ? '#f59e0b' : '#ef4444'}; font-weight: 600;">${similarity}%</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="btn-group">
                        <button class="btn btn-full" onclick="closeModal(); executeVersionUpdate();" style="background: linear-gradient(135deg, #8b5cf6 0%, #6d28d9 100%); color: white; min-height: var(--touch-target);">
                            📝 Confirm Version Update
                        </button>
                        <button class="btn" onclick="closeModal();" style="background: rgba(100, 116, 139, 0.1); color: var(--text-secondary); min-height: var(--touch-target);">
                            Cancel
                        </button>
                    </div>
                </div>
            `;
            
            showModal(content);
        }
        
        /**
         * Execute the version update (post as reply)
         */
        async function executeVersionUpdate() {
            const versionInfo = window._versionUpdateInfo;
            const currentData = window._preExtractedData;
            
            if (!versionInfo || !currentData) {
                showToast('error', 'Version update data not available');
                return;
            }
            
            // Build the post body with version info
            const postBody = buildHivePostBody(currentData, versionInfo);
            
            // Check if content exceeds Hive's single-post limit
            const contentSizeKB = new Blob([postBody]).size / 1024;
            if (contentSizeKB > 60) {
                // Content too large for version update - show warning
                const content = `
                    <div style="padding: var(--spacing-xl); text-align: center;">
                        <div style="display: inline-flex; align-items: center; justify-content: center; width: 80px; height: 80px; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); border-radius: 50%; margin-bottom: var(--spacing-lg);">
                            <span style="font-size: 40px;">⚠️</span>
                        </div>
                        
                        <h2 style="font-size: 1.5rem; font-weight: 700; margin-bottom: var(--spacing-md); color: var(--text-primary);">
                            Content Too Large for Version Update
                        </h2>
                        
                        <p style="color: var(--text-secondary); margin-bottom: var(--spacing-lg);">
                            This content is <strong>${contentSizeKB.toFixed(1)} KB</strong>, which exceeds Hive's single-post limit of 64 KB. Version updates are designed for tracking edits, not for archiving completely rewritten content.
                        </p>
                        
                        <div style="background: rgba(245, 158, 11, 0.1); border: 1px solid rgba(245, 158, 11, 0.3); border-radius: 12px; padding: var(--spacing-md); margin-bottom: var(--spacing-lg);">
                            <p style="color: #d97706; margin: 0;">
                                <strong>Recommendation:</strong> Use "Archive as New Post" for large content updates. This will create a fresh multi-part archive that preserves the complete content.
                            </p>
                        </div>
                        
                        <div class="btn-group">
                            <button class="btn btn-success btn-full" onclick="closeModal(); processContent(true);" style="min-height: var(--touch-target);">
                                📤 Archive as New Post
                            </button>
                            <button class="btn" onclick="closeModal();" style="background: rgba(100, 116, 139, 0.1); color: var(--text-secondary); min-height: var(--touch-target);">
                                Cancel
                            </button>
                        </div>
                    </div>
                `;
                showModal(content);
                return;
            }
            
            // Generate a unique permlink for the comment
            const timestamp = Date.now();
            const commentPermlink = `re-${versionInfo.originalPermlink}-v${versionInfo.version}-${timestamp}`;
            
            // Build complete metadata structure (matches regular post format)
            const metadata = {
                app: 'archivehaf/1.0',
                format: 'markdown',
                sourceUrl: currentData.url || currentData.source,
                timestamp: new Date().toISOString(),
                clientSide: true,
                readability: true,
                images: currentData.images || [],
                hashes: currentData.hashes,
                archived_at: currentData.timestamp,
                image_count: currentData.imageCount,
                word_count: currentData.wordCount,
                provenance: currentData.provenance || null,
                archiveVersion: {
                    version: versionInfo.version,
                    previousVersion: versionInfo.previousVersion,
                    similarity: versionInfo.similarity,
                    contentChanged: versionInfo.contentChanged,
                    originalAuthor: versionInfo.originalAuthor,
                    originalPermlink: versionInfo.originalPermlink
                }
            };
            
            // Store data for posting
            window._pendingVersionUpdate = {
                parentAuthor: versionInfo.originalAuthor,
                parentPermlink: versionInfo.originalPermlink,
                author: null, // Will be filled by Keychain
                permlink: commentPermlink,
                title: '', // Comments don't have titles
                body: postBody,
                jsonMetadata: JSON.stringify(metadata),
                versionInfo: versionInfo
            };
            
            console.log('📝 Version update ready to post:', window._pendingVersionUpdate);
            
            // Check for Keychain and post
            if (typeof window.hive_keychain !== 'undefined') {
                postVersionUpdateToHive();
            } else {
                // Try HAS for mobile
                showToast('info', 'Connecting to Hive Keychain...');
                setTimeout(() => {
                    if (typeof window.hive_keychain !== 'undefined') {
                        postVersionUpdateToHive();
                    } else {
                        showToast('error', 'Please install Hive Keychain to post version updates');
                    }
                }, 1000);
            }
        }
        
        /**
         * Post version update comment to Hive via Keychain
         */
        function postVersionUpdateToHive() {
            const pending = window._pendingVersionUpdate;
            
            if (!pending) {
                showToast('error', 'No pending version update');
                return;
            }
            
            // Get username from stored value or prompt
            const username = localStorage.getItem('hive_username');
            
            if (!username) {
                // Show username input modal
                const content = `
                    <div style="padding: var(--spacing-xl); text-align: center;">
                        <h2 style="font-size: 1.5rem; font-weight: 700; margin-bottom: var(--spacing-lg);">Enter Hive Username</h2>
                        <input type="text" id="versionUpdateUsername" placeholder="Your Hive username" style="width: 100%; padding: var(--spacing-md); border: 1px solid var(--border); border-radius: 8px; margin-bottom: var(--spacing-lg); font-size: 1rem;">
                        <div class="btn-group">
                            <button class="btn btn-success btn-full" onclick="submitVersionUpdateUsername();" style="min-height: var(--touch-target);">
                                Continue
                            </button>
                            <button class="btn" onclick="closeModal();" style="background: rgba(100, 116, 139, 0.1); color: var(--text-secondary); min-height: var(--touch-target);">
                                Cancel
                            </button>
                        </div>
                    </div>
                `;
                showModal(content);
                return;
            }
            
            executeKeychainVersionUpdate(username);
        }
        
        function submitVersionUpdateUsername() {
            // Normalize username: trim, lowercase, remove @ prefix
            const username = document.getElementById('versionUpdateUsername').value.trim().toLowerCase().replace(/^@/, '');
            if (!username) {
                showToast('error', 'Please enter your Hive username');
                return;
            }
            localStorage.setItem('hive_username', username);
            closeModal();
            executeKeychainVersionUpdate(username);
        }
        
        function executeKeychainVersionUpdate(username) {
            const pending = window._pendingVersionUpdate;
            
            showLoadingModal('Posting version update to Hive blockchain...');
            
            window.hive_keychain.requestPost(
                username,
                pending.title,
                pending.body,
                pending.parentPermlink,
                pending.parentAuthor,
                pending.jsonMetadata,
                pending.permlink,
                '',  // No comment options for replies
                function(response) {
                    closeModal();
                    
                    if (response.success) {
                        console.log('✅ Version update posted successfully!', response);
                        
                        const versionInfo = pending.versionInfo;
                        const content = `
                            <div style="padding: var(--spacing-xl); text-align: center;">
                                <div style="display: inline-flex; align-items: center; justify-content: center; width: 80px; height: 80px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); border-radius: 50%; margin-bottom: var(--spacing-lg); box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);">
                                    <span style="font-size: 40px;">✅</span>
                                </div>
                                
                                <h2 style="font-size: 1.5rem; font-weight: 700; margin-bottom: var(--spacing-md); color: var(--text-primary);">
                                    Version Update Posted!
                                </h2>
                                
                                <p style="color: var(--text-secondary); margin-bottom: var(--spacing-lg);">
                                    Version ${versionInfo.version} has been posted as a reply under the original archive.
                                </p>
                                
                                <div style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(5, 150, 105, 0.1) 100%); border: 2px solid rgba(16, 185, 129, 0.3); border-radius: 12px; padding: var(--spacing-md); margin-bottom: var(--spacing-lg);">
                                    <p style="color: #059669; font-weight: 600; margin: 0;">
                                        📜 Edit history is now visible on the blockchain
                                    </p>
                                </div>
                                
                                <div class="btn-group">
                                    <a href="https://peakd.com/@${versionInfo.originalAuthor}/${versionInfo.originalPermlink}" target="_blank" class="btn btn-success btn-full" style="text-decoration: none; display: flex; align-items: center; justify-content: center; min-height: var(--touch-target);">
                                        🔗 View on Hive
                                    </a>
                                    <button class="btn" onclick="closeModal();" style="background: rgba(100, 116, 139, 0.1); color: var(--text-secondary); min-height: var(--touch-target);">
                                        Close
                                    </button>
                                </div>
                            </div>
                        `;
                        showModal(content);
                        
                        // Clean up
                        window._pendingVersionUpdate = null;
                        window._versionUpdateInfo = null;
                        
                    } else {
                        console.error('❌ Version update failed:', response);
                        showToast('error', 'Failed to post version update: ' + (response.message || 'Unknown error'));
                    }
                }
            );
        }
        
        /**
         * View archived content in a full-screen modal
         */
        async function viewArchivedContent() {
            const state = window._archiveVerificationData;
            if (!state || !state.matchingPosts || state.matchingPosts.length === 0) {
                console.error('❌ No archived content available');
                showToast('error', 'No archived content available');
                return;
            }
            
            try {
                // Show loading modal
                showLoadingModal('Loading archived content...');
                
                let contentToDisplay = '';
                let titleToDisplay = '';
                let sourceUrl = '';
                
                if (state.isSeries && state.manifest) {
                    // Multi-part content - fetch and reassemble all parts
                    console.log('📦 Loading multi-part series:', state.manifest.series_id);
                    
                    const manifest = state.manifest;
                    titleToDisplay = manifest.title || 'Untitled';
                    sourceUrl = manifest.source_url || '';
                    
                    // Step 1: Find all parts using SERIES tag
                    showLoadingModal('Finding all parts...');
                    const seriesTag = window.ArcHiveMultiPart.generateSeriesTag(manifest.series_id);
                    console.log(`🏷️  Using discovery tag: ${seriesTag}`);
                    
                    const searchTags = ['archivedcontenthaf', seriesTag];
                    const allPosts = await window.ArcHiveHiveLookup.searchHiveByTags(searchTags);
                    console.log(`📊 Found ${allPosts.length} posts with ${seriesTag} tag`);
                    
                    // Filter posts that match this specific series_id
                    const seriesParts = [];
                    const extractManifestFromPost = window.ArcHiveMultiPart.extractManifestFromPost;
                    
                    for (const post of allPosts) {
                        const postManifest = extractManifestFromPost(post);
                        if (!postManifest || postManifest.series_id !== manifest.series_id) {
                            continue;
                        }
                        
                        const partNumber = postManifest.current_part || 1;
                        seriesParts.push({
                            part_number: partNumber,
                            post_data: post
                        });
                        console.log(`✅ Found part ${partNumber}/${manifest.total_parts}`);
                    }
                    
                    seriesParts.sort((a, b) => a.part_number - b.part_number);
                    console.log(`✅ Series discovery complete: Found ${seriesParts.length}/${manifest.total_parts} parts`);
                    
                    // Step 2: Extract content from all parts
                    showLoadingModal(`Reassembling ${seriesParts.length} parts...`);
                    const contentParts = [];
                    
                    for (const partInfo of seriesParts) {
                        const post = partInfo.post_data;
                        let content = post.body;
                        
                        // Remove manifest HTML comment if present
                        content = content.replace(/<!--ARCHIVE-MANIFEST:[\s\S]*?-->/g, '');
                        content = content.trim();
                        
                        contentParts.push(content);
                        console.log(`📄 Extracted part ${partInfo.part_number} (${content.length} chars)`);
                    }
                    
                    // Step 3: Reassemble full content
                    contentToDisplay = contentParts.join('');
                    console.log(`📏 Reassembled content: ${contentToDisplay.length} chars from ${contentParts.length} parts`);
                    
                } else {
                    // Single-part content
                    const post = state.matchingPosts[0];
                    console.log('📄 Loading single-part post:', post.permlink);
                    
                    contentToDisplay = post.body;
                    titleToDisplay = post.title;
                    
                    // Extract source URL from metadata
                    let metadata = post.json_metadata;
                    if (typeof metadata === 'string') {
                        metadata = JSON.parse(metadata);
                    }
                    sourceUrl = metadata?.sourceUrl || metadata?.source_url || metadata?.arcMultiPart?.source_url || '';
                }
                
                closeModal();
                
                // Show full-screen content modal (similar to Link Explorer)
                showFullContentModal(titleToDisplay, contentToDisplay, sourceUrl);
                
            } catch (error) {
                console.error('❌ Error loading archived content:', error);
                closeModal();
                showToast('error', 'Failed to load archived content: ' + error.message);
            }
        }
        
        /**
         * Show full-screen content modal (used by "View Now")
         */
        function showFullContentModal(title, content, sourceUrl) {
            const modalHtml = `
                <div id="fullContentModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 10000; overflow-y: auto;">
                    <div style="position: sticky; top: 0; background: white; border-bottom: 1px solid var(--border-color); padding: var(--spacing-md); display: flex; justify-content: space-between; align-items: center; z-index: 10001;">
                        <div style="flex: 1;">
                            <h2 style="margin: 0; font-size: var(--text-lg); font-weight: 600; color: var(--text-primary);">${title}</h2>
                            ${sourceUrl ? `<p style="margin: var(--spacing-xs) 0 0 0; font-size: var(--text-sm); color: var(--text-secondary);">Source: ${sourceUrl}</p>` : ''}
                        </div>
                        <button onclick="closeFullContentModal()" style="background: rgba(100, 116, 139, 0.1); border: none; border-radius: 8px; padding: var(--spacing-sm) var(--spacing-md); cursor: pointer; font-size: var(--text-base); color: var(--text-secondary); font-weight: 500;">
                            ✕ Close
                        </button>
                    </div>
                    <div style="max-width: 800px; margin: 0 auto; padding: var(--spacing-xl);">
                        <div style="white-space: pre-wrap; word-wrap: break-word; line-height: 1.6; color: var(--text-primary);">${content}</div>
                    </div>
                </div>
            `;
            
            // Insert modal into document
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // Prevent body scroll
            document.body.style.overflow = 'hidden';
        }
        
        /**
         * Close full-screen content modal
         */
        function closeFullContentModal() {
            const modal = document.getElementById('fullContentModal');
            if (modal) {
                modal.remove();
            }
            // Re-enable body scroll
            document.body.style.overflow = '';
        }
        
        /**
         * Start verification flow: Guide user to manually extract content
         */
        function startVerification() {
            const state = window._archiveVerificationData;
            if (!state) {
                console.error('❌ Verification state not found');
                return;
            }
            
            // Set mode to verification
            state.mode = 'verification';
            state.extractionReady = false;
            
            console.log('🔍 Starting verification flow for:', state.url);
            
            // Show manual extraction guide modal
            showManualExtractionGuide();
            
            // Focus the textarea so user is ready to extract
            setTimeout(() => focusTextarea(), 500);
            
            // Show a toast notification
            showToast('info', '📋 Use the extraction tool to get the current content, then verify if it matches the archived version.');
        }
        
        /**
         * Show Manual Extraction Guide Modal with Mobile/Desktop tabs
         */
        function showManualExtractionGuide() {
            const state = window._archiveVerificationData;
            if (!state) return;
            
            const content = `
                <div style="padding: var(--spacing-lg);">
                    <div style="text-align: center; font-size: 3rem; margin-bottom: var(--spacing-md);">🔧</div>
                    <h2 style="font-size: var(--text-2xl); font-weight: 700; text-align: center; margin-bottom: var(--spacing-md); color: var(--text-primary);">
                        Manual Content Extraction
                    </h2>
                    <p style="color: var(--text-secondary); text-align: center; margin-bottom: var(--spacing-lg); font-size: var(--text-base);">
                        To verify if this content has changed, you need to extract the current version from the website.
                    </p>
                    
                    <div style="background: linear-gradient(135deg, #e0f2fe 0%, #dbeafe 100%); border: 2px solid #3b82f6; border-radius: 12px; padding: var(--spacing-md); margin-bottom: var(--spacing-lg);">
                        <h3 style="font-size: var(--text-lg); font-weight: 700; color: #1e40af; margin-bottom: var(--spacing-sm);">📱 Mobile Users</h3>
                        <ol style="margin: 0; padding-left: var(--spacing-lg); color: #1e40af; font-size: var(--text-sm); line-height: 1.8;">
                            <li>Go to the website: <code style="background: rgba(255,255,255,0.8); padding: 2px 6px; border-radius: 4px; font-size: 0.9em;">${escapeHtml(state.url.substring(0, 50))}${state.url.length > 50 ? '...' : ''}</code></li>
                            <li>Use the bookmarklet button below to extract content</li>
                            <li>Come back here - extraction will auto-fill</li>
                        </ol>
                    </div>
                    
                    <div style="background: linear-gradient(135deg, #f3e8ff 0%, #e9d5ff 100%); border: 2px solid #a855f7; border-radius: 12px; padding: var(--spacing-md); margin-bottom: var(--spacing-lg);">
                        <h3 style="font-size: var(--text-lg); font-weight: 700; color: #7e22ce; margin-bottom: var(--spacing-sm);">💻 Desktop Users</h3>
                        <ol style="margin: 0; padding-left: var(--spacing-lg); color: #7e22ce; font-size: var(--text-sm); line-height: 1.8;">
                            <li>Open the website in a new tab</li>
                            <li>Press <strong>F12</strong> to open Developer Tools</li>
                            <li>Go to <strong>Console</strong> tab</li>
                            <li>Paste the extraction snippet and press Enter</li>
                        </ol>
                    </div>
                    
                    <div class="info-tip" style="margin-bottom: var(--spacing-md);">
                        <strong>ℹ️ What Happens Next:</strong>
                        Once you extract the content, we'll compare it with the archived version's hashes to see if anything changed.
                    </div>
                    
                    <div class="btn-group">
                        <button class="btn btn-success btn-full" onclick="closeModal(); showBookmarkletModal('${escapeHtml(state.url).replace(/'/g, "\\'")}', 'verification');" style="min-height: var(--touch-target);">
                            🔧 Open Extraction Tools
                        </button>
                        <button class="btn" onclick="closeModal();" style="background: rgba(100, 116, 139, 0.1); color: var(--text-secondary); min-height: var(--touch-target);">
                            Cancel
                        </button>
                    </div>
                </div>
            `;
            
            showModal(content);
        }
        
        /**
         * Verify hashes: Compare current extraction with archived version
         */
        async function verifyHashes() {
            const state = window._archiveVerificationData;
            
            if (!state || state.mode !== 'verification') {
                console.error('❌ Not in verification mode');
                showToast('error', 'Verification state error - please try again');
                return;
            }
            
            // Check if this is a multi-part series
            if (state.isSeries) {
                console.log('📦 Multi-part verification detected - switching to series verification');
                await verifySeriesAgainstExtractedContent();
                return;
            }
            
            // Single-part verification (original logic)
            if (!processor.currentData || !processor.currentData.hashes) {
                console.error('❌ No current extraction data found');
                showToast('error', 'Please extract content first');
                return;
            }
            
            if (!state.expectedHashes) {
                console.error('❌ No archived hashes found');
                showToast('error', 'Archived hashes not available');
                clearVerificationState();
                return;
            }
            
            console.log('🔍 Comparing hashes...');
            console.log('Current hashes:', processor.currentData.hashes);
            console.log('Archived hashes:', state.expectedHashes);
            
            // Get current and archived hashes
            const currentHashes = processor.currentData.hashes;
            const archivedHashes = state.expectedHashes;
            
            // Compare all 9 hashes (content/title/integrity × SHA-256/BLAKE2b/MD5)
            const contentMatch = compareHashes(currentHashes.content, archivedHashes.content);
            const titleMatch = compareHashes(currentHashes.title, archivedHashes.title);
            const integrityMatch = compareHashes(currentHashes.integrity, archivedHashes.integrity);
            
            console.log('Hash comparison results:', {
                content: contentMatch,
                title: titleMatch,
                integrity: integrityMatch
            });
            
            // All must match for verification success
            if (contentMatch && titleMatch && integrityMatch) {
                console.log('✅ Verification SUCCESS - Content unchanged');
                showVerificationSuccessModal(state.matchingPosts[0]);
            } else {
                console.log('📝 Verification CHANGED - Content has been edited');
                showEditedVersionDetectedModal(state.url, state.matchingPosts);
            }
            
            // Cleanup verification state
            clearVerificationState();
        }
        
        /**
         * Compare hash objects for all three algorithms
         */
        function compareHashes(current, archived) {
            if (!current || !archived) return false;
            
            return current.sha256 === archived.sha256 &&
                   current.blake2b === archived.blake2b &&
                   current.md5 === archived.md5;
        }
        
        /**
         * Show verification success modal (content unchanged)
         */
        function showVerificationSuccessModal(archivedPost) {
            let metadata = archivedPost.json_metadata;
            if (typeof metadata === 'string') {
                try {
                    metadata = JSON.parse(metadata);
                } catch (e) {
                    metadata = {};
                }
            }
            metadata = metadata || {};
            
            const hiveUrl = `https://ecency.com/@${archivedPost.author}/${archivedPost.permlink}`;
            const date = new Date(archivedPost.created).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            const sourceUrl = metadata.sourceUrl || 'Unknown';
            
            const content = `
                <div style="padding: var(--spacing-lg);">
                    <div style="text-align: center; font-size: 3rem; margin-bottom: var(--spacing-md);">✅</div>
                    <h2 style="font-size: var(--text-2xl); font-weight: 700; text-align: center; margin-bottom: var(--spacing-md); color: var(--text-primary);">
                        Content Fully Archived
                    </h2>
                    <p style="color: var(--text-secondary); text-align: center; margin-bottom: var(--spacing-lg); font-size: var(--text-base);">
                        This content is already archived and <strong>unchanged</strong>. Duplicate posting prevented.
                    </p>
                    
                    <div style="background: rgba(16, 185, 129, 0.1); border: 2px solid rgba(16, 185, 129, 0.3); border-radius: 12px; padding: var(--spacing-md); margin-bottom: var(--spacing-lg);">
                        <div style="text-align: center; margin-bottom: var(--spacing-sm);">
                            <span style="font-size: 2rem;">🔒</span>
                        </div>
                        <p style="color: #065f46; text-align: center; font-weight: 600; font-size: var(--text-base); margin-bottom: var(--spacing-sm);">
                            All cryptographic hashes match perfectly
                        </p>
                        <p style="color: #059669; text-align: center; font-size: var(--text-sm);">
                            Content, title, and integrity verified across SHA-256, BLAKE2b, and MD5
                        </p>
                    </div>
                    
                    <div style="background: #f1f5f9; border-radius: 12px; padding: var(--spacing-md); margin-bottom: var(--spacing-lg);">
                        <div style="margin-bottom: var(--spacing-sm);">
                            <strong style="color: var(--text-primary); font-size: var(--text-sm);">📅 Archived on:</strong>
                            <div style="color: var(--text-secondary); font-size: var(--text-base);">${date}</div>
                        </div>
                        <div style="margin-bottom: var(--spacing-sm);">
                            <strong style="color: var(--text-primary); font-size: var(--text-sm);">👤 Author:</strong>
                            <div style="color: var(--text-secondary); font-size: var(--text-base);">@${escapeHtml(archivedPost.author)}</div>
                        </div>
                        <div>
                            <strong style="color: var(--text-primary); font-size: var(--text-sm);">🔗 Source:</strong>
                            <div style="color: var(--text-secondary); font-size: var(--text-sm); word-break: break-all; font-family: monospace;">${escapeHtml(sourceUrl)}</div>
                        </div>
                    </div>
                    
                    <div class="btn-group">
                        <a href="${hiveUrl}" target="_blank" class="btn btn-success btn-full" style="min-height: var(--touch-target); text-decoration: none;">
                            🔗 View on Hive
                        </a>
                        <button class="btn" onclick="closeModal();" style="background: rgba(100, 116, 139, 0.1); color: var(--text-secondary); min-height: var(--touch-target);">
                            Close
                        </button>
                    </div>
                </div>
            `;
            
            showModal(content);
            showToast('success', '✅ Verification complete - content unchanged!');
        }
        
        /**
         * Show edited version detected modal (content has changed)
         */
        function showEditedVersionDetectedModal(url, existingVersions) {
            const versionCount = existingVersions.length;
            const latestPost = existingVersions[existingVersions.length - 1];
            const latestDate = new Date(latestPost.created).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            const hiveUrl = `https://ecency.com/@${latestPost.author}/${latestPost.permlink}`;
            
            const content = `
                <div style="padding: var(--spacing-lg);">
                    <div style="text-align: center; font-size: 3rem; margin-bottom: var(--spacing-md);">📝</div>
                    <h2 style="font-size: var(--text-2xl); font-weight: 700; text-align: center; margin-bottom: var(--spacing-md); color: var(--text-primary);">
                        Edited Version Detected
                    </h2>
                    <p style="color: var(--text-secondary); text-align: center; margin-bottom: var(--spacing-lg); font-size: var(--text-base);">
                        The content has been <strong>modified</strong> since archiving. Would you like to archive the new version?
                    </p>
                    
                    <div style="background: rgba(245, 158, 11, 0.1); border: 2px solid rgba(245, 158, 11, 0.3); border-radius: 12px; padding: var(--spacing-md); margin-bottom: var(--spacing-lg);">
                        <div style="text-align: center; margin-bottom: var(--spacing-sm);">
                            <span style="font-size: 2rem;">⚠️</span>
                        </div>
                        <p style="color: #92400e; text-align: center; font-weight: 600; font-size: var(--text-base); margin-bottom: var(--spacing-sm);">
                            Hash mismatch detected
                        </p>
                        <p style="color: #b45309; text-align: center; font-size: var(--text-sm);">
                            One or more cryptographic hashes don't match the archived version
                        </p>
                    </div>
                    
                    <div style="background: #f1f5f9; border-radius: 12px; padding: var(--spacing-md); margin-bottom: var(--spacing-lg);">
                        <div style="margin-bottom: var(--spacing-sm);">
                            <strong style="color: var(--text-primary); font-size: var(--text-sm);">📦 Existing versions:</strong>
                            <div style="color: var(--text-secondary); font-size: var(--text-lg); font-weight: 700;">${versionCount}</div>
                        </div>
                        <div>
                            <strong style="color: var(--text-primary); font-size: var(--text-sm);">📅 Last archived:</strong>
                            <div style="color: var(--text-secondary); font-size: var(--text-base);">${latestDate}</div>
                        </div>
                    </div>
                    
                    <div style="background: #e0f2fe; padding: var(--spacing-md); border-radius: 8px; margin-bottom: var(--spacing-lg); font-size: var(--text-sm);">
                        <p style="color: #0369a1; margin: 0;">
                            <strong>💡 Tip:</strong> You can view the existing archived version on Hive to compare what changed.
                        </p>
                    </div>
                    
                    <div class="btn-group">
                        <button class="btn btn-success btn-full" onclick="closeModal(); switchToArchiveMode();" style="min-height: var(--touch-target);">
                            ✅ Archive New Version
                        </button>
                        <a href="${hiveUrl}" target="_blank" class="btn" style="min-height: var(--touch-target); text-decoration: none; display: inline-block;">
                            🔗 View Old Version
                        </a>
                        <button class="btn" onclick="closeModal(); clearVerificationState();" style="background: rgba(100, 116, 139, 0.1); color: var(--text-secondary); min-height: var(--touch-target);">
                            Cancel
                        </button>
                    </div>
                </div>
            `;
            
            showModal(content);
            showToast('warning', '📝 Content has changed - you can archive the new version');
        }
        
        /**
         * Switch from verification mode to archive mode
         */
        function switchToArchiveMode() {
            clearVerificationState();
            updatePrimaryActionButton();
            showToast('info', 'Ready to archive the new version - proceed with posting to Hive');
        }
        
        /**
         * Clear verification state
         */
        function clearVerificationState() {
            if (window._archiveVerificationData) {
                console.log('🧹 Clearing verification state');
                window._archiveVerificationData = null;
            }
            updatePrimaryActionButton();
        }
        
        /**
         * Update primary action button based on verification mode
         */
        function updatePrimaryActionButton() {
            const postButton = document.getElementById('blockchainBtn');
            
            if (!postButton) {
                console.log('⚠️ Post button not found (results not shown yet)');
                return;
            }
            
            // Check if in verification mode
            if (window._archiveVerificationData && window._archiveVerificationData.mode === 'verification') {
                const state = window._archiveVerificationData;
                
                // Multi-part verification mode
                if (state.isSeries) {
                    // Check if verification is complete
                    if (state.verificationComplete) {
                        if (state.fullArticleMatch) {
                            // All parts match - disable posting
                            postButton.innerHTML = '✅ Fully Archived';
                            postButton.disabled = true;
                            postButton.title = 'Content already archived - duplicate posting prevented';
                            postButton.setAttribute('aria-label', 'Content fully archived');
                            console.log('✅ Multi-part content fully archived - posting disabled');
                        } else {
                            // Content changed - allow archiving new version
                            postButton.innerHTML = '🌐 Archive New Version';
                            postButton.onclick = () => {
                                clearVerificationState();
                                updatePrimaryActionButton();
                                showToast('info', 'Ready to archive new version - proceed with posting');
                            };
                            postButton.disabled = false;
                            postButton.title = 'Archive the updated content as a new series';
                            postButton.setAttribute('aria-label', 'Archive new version');
                            console.log('📝 Multi-part content changed - archiving new version enabled');
                        }
                    } else {
                        // Verification in progress or not started
                        postButton.innerHTML = '🔍 Verify Multi-Part Content';
                        postButton.onclick = verifyHashes;
                        
                        if (!state.extractionReady) {
                            postButton.disabled = true;
                            postButton.title = 'Complete extraction first';
                            postButton.setAttribute('aria-label', 'Verify multi-part content (disabled until extraction completes)');
                            console.log('🔒 Multi-part verify button disabled - waiting for extraction');
                        } else {
                            postButton.disabled = false;
                            postButton.title = 'Compare with archived multi-part series';
                            postButton.setAttribute('aria-label', 'Verify multi-part content with archived version');
                            console.log('✅ Multi-part verify button enabled - ready to compare');
                        }
                    }
                } else {
                    // Single-part verification mode (original logic)
                    postButton.innerHTML = '🔍 Verify Hashes';
                    postButton.onclick = verifyHashes;
                    
                    if (!state.extractionReady) {
                        postButton.disabled = true;
                        postButton.title = 'Complete extraction first';
                        postButton.setAttribute('aria-label', 'Verify hashes (disabled until extraction completes)');
                        console.log('🔒 Verify button disabled - waiting for extraction');
                    } else {
                        postButton.disabled = false;
                        postButton.title = 'Compare with archived version';
                        postButton.setAttribute('aria-label', 'Verify hashes with archived version');
                        console.log('✅ Verify button enabled - ready to compare hashes');
                    }
                }
            } else {
                // Normal mode - Post to Hive
                postButton.innerHTML = '🌐 Publish to Blockchain';
                postButton.onclick = postToHive;
                postButton.disabled = false;
                postButton.title = '';
                postButton.setAttribute('aria-label', 'Publish to blockchain');
                console.log('🌐 Button reset to normal Post to Hive mode');
            }
        }
        
        /**
         * Focus the textarea
         */
        function focusTextarea() {
            const textarea = document.getElementById('contentInput');
            if (textarea) {
                textarea.focus();
                textarea.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }
        
        /* ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
         * PHASE 8: MULTI-PART VERIFICATION MODES
         * ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ */
        
        /**
         * Detect multi-part manifest in a Hive post
         * Checks json_metadata.arcMultiPart and falls back to compact HTML comment
         * Reused from hash-explorer.html
         */
        function detectManifest(post) {
            const multipartModule = window.ArcHiveMultiPart;
            if (!multipartModule || !multipartModule.extractManifestFromPost) {
                console.warn('⚠️  Multi-part module not loaded - skipping manifest detection');
                return null;
            }
            
            try {
                const manifest = multipartModule.extractManifestFromPost(post);
                if (!manifest) {
                    return null;
                }
                
                // Normalize manifest structure (handle both compact and full formats)
                const normalized = {
                    series_id: manifest.series_id || manifest.s,
                    total_parts: manifest.total_parts || manifest.t,
                    current_part: manifest.current_part || manifest.p,
                    content_hash_full: manifest.content_hash_full || manifest.h,
                    source_url: manifest.source_url || manifest.u,
                    parts: manifest.parts || [],
                    part_hashes: manifest.part_hashes || []
                };
                
                // Validate critical fields
                if (!normalized.series_id || !normalized.total_parts) {
                    console.warn('⚠️  Incomplete manifest - missing series_id or total_parts');
                    return null;
                }
                
                console.log(`📦 Multi-part manifest detected: ${normalized.total_parts} parts, series ${normalized.series_id.substring(0, 8)}...`);
                return normalized;
                
            } catch (error) {
                console.warn('⚠️  Manifest detection failed:', error.message);
                return null;
            }
        }
        
        /**
         * Find all parts of a multi-part series using SERIES tag
         * Uses client-side filtering to prevent cross-series contamination
         */
        async function findSeriesParts(manifest, progressCallback = null) {
            console.log(`🔍 Searching for ${manifest.total_parts} parts of series ${manifest.series_id.substring(0, 8)}...`);
            
            try {
                const multipartModule = window.ArcHiveMultiPart;
                if (!multipartModule || !multipartModule.generateSeriesTag) {
                    throw new Error('Multi-part module not loaded');
                }
                
                // Generate SERIES tag for this series
                const seriesTag = multipartModule.generateSeriesTag(manifest.series_id);
                console.log(`🏷️  Using discovery tag: ${seriesTag}`);
                
                // Search for all posts with this SERIES tag
                const searchTags = ['archivedcontenthaf', seriesTag];
                const allPosts = await window.ArcHiveHiveLookup.searchHiveByTags(searchTags, progressCallback);
                
                console.log(`📊 Found ${allPosts.length} posts with ${seriesTag} tag`);
                
                // Filter posts that match this specific series_id
                const seriesPosts = [];
                const postCache = new Map();
                
                for (const post of allPosts) {
                    const postManifest = detectManifest(post);
                    
                    if (!postManifest) {
                        continue;
                    }
                    
                    // Only accept posts from the SAME series
                    if (postManifest.series_id !== manifest.series_id) {
                        continue;
                    }
                    
                    // Store this part
                    const partNumber = postManifest.current_part;
                    if (!postCache.has(partNumber)) {
                        seriesPosts.push({
                            part_number: partNumber,
                            author: post.author,
                            permlink: post.permlink,
                            post_data: post,
                            manifest: postManifest
                        });
                        postCache.set(partNumber, true);
                    }
                }
                
                // Sort by part number
                seriesPosts.sort((a, b) => a.part_number - b.part_number);
                
                console.log(`✅ Found ${seriesPosts.length}/${manifest.total_parts} parts of series ${manifest.series_id.substring(0, 8)}...`);
                
                return seriesPosts;
                
            } catch (error) {
                console.error('❌ Failed to find series parts:', error);
                throw error;
            }
        }
        
        /**
         * Fetch and extract content from series parts
         */
        async function fetchSeriesParts(seriesParts, totalParts, progressCallback = null) {
            console.log(`📥 Fetching ${totalParts} parts in parallel...`);
            
            const parts = new Array(totalParts).fill(null);
            const missing = [];
            const errors = [];
            
            // Create fetch promises for all parts
            const fetchPromises = seriesParts.map(async (partInfo) => {
                const partNumber = partInfo.part_number;
                
                try {
                    if (progressCallback) {
                        progressCallback(partNumber, totalParts, 'fetching');
                    }
                    
                    const post = partInfo.post_data;
                    
                    // Extract content from post body
                    let content = post.body;
                    
                    // FIX BUG #3: Use [\s\S]*? to match multi-line manifests (. doesn't match newlines)
                    const beforeLength = content.length;
                    content = content.replace(/<!--ARCHIVE-MANIFEST:[\s\S]*?-->/g, '');
                    const afterLength = content.length;
                    
                    if (beforeLength === afterLength) {
                        console.warn(`⚠️  Part ${partNumber}: No manifest found in post body`);
                    }
                    
                    content = content.trim();
                    
                    // Store in correct position
                    parts[partNumber - 1] = {
                        part_number: partNumber,
                        content: content,
                        author: partInfo.author,
                        permlink: partInfo.permlink,
                        post_data: post
                    };
                    
                    console.log(`✅ Part ${partNumber} fetched (${content.length} chars)`);
                    
                    if (progressCallback) {
                        progressCallback(partNumber, totalParts, 'success');
                    }
                    
                } catch (error) {
                    console.error(`❌ Failed to fetch part ${partNumber}:`, error);
                    errors.push({
                        part_number: partNumber,
                        error: error.message
                    });
                    
                    if (progressCallback) {
                        progressCallback(partNumber, totalParts, 'error');
                    }
                }
            });
            
            await Promise.all(fetchPromises);
            
            // Identify missing parts
            for (let i = 0; i < totalParts; i++) {
                if (parts[i] === null) {
                    missing.push(i + 1);
                }
            }
            
            const success = missing.length === 0 && errors.length === 0;
            
            console.log(`📊 Fetch complete: ${parts.filter(p => p !== null).length}/${totalParts} parts retrieved`);
            if (missing.length > 0) {
                console.warn(`⚠️  Missing parts: ${missing.join(', ')}`);
            }
            
            return {
                success: success,
                parts: parts,
                missing: missing,
                errors: errors
            };
        }
        
        /**
         * Reassemble and verify multi-part content
         */
        async function reassembleContent(parts, manifest) {
            console.log(`🔗 Reassembling ${parts.length} parts...`);
            
            try {
                const multipartModule = window.ArcHiveMultiPart;
                
                // Filter out null parts
                const validParts = parts.filter(p => p !== null);
                
                if (validParts.length === 0) {
                    throw new Error('No valid parts to reassemble');
                }
                
                // Sort by part_number
                validParts.sort((a, b) => a.part_number - b.part_number);
                
                // Extract content strings in order
                const contentParts = validParts.map(p => p.content);
                
                // Concatenate to create full content
                const reassembled = contentParts.join('');
                
                console.log(`📏 Reassembled content: ${reassembled.length} chars from ${validParts.length} parts`);
                
                // Verify content integrity using dual hash system
                if (!multipartModule || !multipartModule.verifyMultiPartContent) {
                    console.warn('⚠️  Multi-part verification module not loaded - skipping hash verification');
                    return {
                        reassembled: reassembled,
                        verified: false,
                        errors: ['Verification module not available'],
                        partVerifications: []
                    };
                }
                
                // Prepare expected hashes
                const expectedHashes = {
                    partHashes: manifest.part_hashes || [],
                    fullContentHash: manifest.content_hash_full
                };
                
                // Verify all hashes
                const verification = await multipartModule.verifyMultiPartContent(contentParts, expectedHashes);
                
                const errors = [];
                if (!verification.valid) {
                    if (!verification.allPartsValid) {
                        errors.push('One or more part hashes failed verification');
                    }
                    if (!verification.fullHashValid) {
                        errors.push('Full content hash failed verification');
                    }
                }
                
                return {
                    reassembled: reassembled,
                    verified: verification.valid,
                    errors: errors,
                    partVerifications: verification.partVerifications || [],
                    fullHashVerification: verification.fullHashVerification || {}
                };
                
            } catch (error) {
                console.error('❌ Reassembly failed:', error);
                throw error;
            }
        }
        
        /**
         * Verify multi-part series against extracted content
         */
        async function verifySeriesAgainstExtractedContent() {
            const state = window._archiveVerificationData;
            
            if (!state || !state.isSeries) {
                console.error('❌ Not in multi-part verification mode');
                showToast('error', 'Verification state error');
                return;
            }
            
            try {
                // Step 1: Check if content has been extracted
                if (!processor.currentData || !processor.currentData.content) {
                    console.error('❌ No extracted content found');
                    showToast('error', 'Please extract content first');
                    return;
                }
                
                const extractedContent = processor.currentData.content;
                console.log(`📄 Extracted content: ${extractedContent.length} chars`);
                
                // Show progress modal
                showMultiPartVerificationProgressModal();
                
                // Step 2: Fetch all archived parts from blockchain
                updateMultiPartVerificationProgress('Fetching archived parts from blockchain...');
                const seriesParts = await findSeriesParts(state.manifest, (partNum, total, status) => {
                    updateMultiPartVerificationProgress(`Fetching part ${partNum}/${total}...`);
                });
                
                const fetchResult = await fetchSeriesParts(seriesParts, state.manifest.total_parts, (partNum, total, status) => {
                    updateMultiPartVerificationProgress(`Fetching part ${partNum}/${total}: ${status}...`);
                });
                
                state.archivedParts = fetchResult.parts;
                state.missingParts = fetchResult.missing;
                
                // Step 3: Reassemble archived content
                updateMultiPartVerificationProgress('Reassembling archived content...');
                const reassemblyResult = await reassembleContent(fetchResult.parts, state.manifest);
                const archivedContent = reassemblyResult.reassembled;
                
                console.log(`📄 Archived content: ${archivedContent.length} chars`);
                
                // Step 4: Compare extracted vs archived
                updateMultiPartVerificationProgress('Comparing content hashes...');
                
                // Simple comparison: Full content hash
                const extractedHashObj = await hashString(extractedContent);
                const extractedHash = extractedHashObj.sha256;  // Use SHA-256 for comparison
                
                // FIX BUG #2: Normalize archived hash (handle both string and object formats)
                // Legacy manifests: content_hash_full is a string (SHA-256)
                // New manifests: content_hash_full is {sha256: '...', blake2b: '...', md5: '...'}
                const archivedHash = typeof state.manifest.content_hash_full === 'string' 
                    ? state.manifest.content_hash_full 
                    : state.manifest.content_hash_full.sha256;
                
                console.log(`🔍 Hash comparison: extracted=${extractedHash.substring(0,16)}... vs archived=${archivedHash.substring(0,16)}...`);
                
                const fullArticleMatch = extractedHash === archivedHash;
                
                // Per-part comparison (if possible)
                const perPartResults = [];
                
                if (fullArticleMatch && reassemblyResult.verified) {
                    // All parts match - create success results
                    for (let i = 0; i < state.manifest.total_parts; i++) {
                        const partNum = i + 1;
                        const part = fetchResult.parts[i];
                        
                        if (part) {
                            perPartResults.push({
                                partNum: partNum,
                                match: true,
                                size: part.content.length,
                                status: 'matches'
                            });
                        } else {
                            perPartResults.push({
                                partNum: partNum,
                                match: false,
                                size: 0,
                                status: 'missing'
                            });
                        }
                    }
                } else {
                    // Content changed or missing parts
                    for (let i = 0; i < state.manifest.total_parts; i++) {
                        const partNum = i + 1;
                        const part = fetchResult.parts[i];
                        
                        if (part) {
                            const partVerification = reassemblyResult.partVerifications[i];
                            perPartResults.push({
                                partNum: partNum,
                                match: partVerification ? partVerification.valid : false,
                                size: part.content.length,
                                status: partVerification && partVerification.valid ? 'matches' : 'changed'
                            });
                        } else {
                            perPartResults.push({
                                partNum: partNum,
                                match: false,
                                size: 0,
                                status: 'missing'
                            });
                        }
                    }
                }
                
                // Step 5: Store verification results
                state.fullArticleMatch = fullArticleMatch;
                state.perPartResults = perPartResults;
                state.verificationComplete = true;
                state.reassemblyResult = reassemblyResult;
                
                // Close progress modal and show results
                closeModal();
                
                if (fullArticleMatch && fetchResult.missing.length === 0) {
                    showMultiPartVerificationSuccessModal();
                } else {
                    showMultiPartVerificationChangedModal();
                }
                
            } catch (error) {
                console.error('❌ Multi-part verification failed:', error);
                closeModal();
                showToast('error', 'Verification failed: ' + error.message);
            }
        }
        
        /**
         * Show multi-part verification progress modal
         */
        function showMultiPartVerificationProgressModal() {
            const content = `
                <div style="padding: var(--spacing-xl); text-align: center;">
                    <div style="width: 50px; height: 50px; border: 3px solid rgba(59, 130, 246, 0.2); border-top-color: #3b82f6; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto var(--spacing-md);"></div>
                    <p style="color: var(--text-primary); font-size: var(--text-lg); font-weight: 600; margin-bottom: var(--spacing-sm);">Verifying Multi-Part Content</p>
                    <p id="multipart-verification-progress" style="color: var(--text-secondary); font-size: var(--text-sm); margin-bottom: var(--spacing-md); min-height: 20px;">Starting verification...</p>
                </div>
                <style>
                    @keyframes spin { to { transform: rotate(360deg); } }
                </style>
            `;
            showModal(content);
        }
        
        /**
         * Update multi-part verification progress
         */
        function updateMultiPartVerificationProgress(message) {
            const progressElement = document.getElementById('multipart-verification-progress');
            if (progressElement) {
                progressElement.textContent = message;
            }
        }
        
        /**
         * Show multi-part verification success modal
         */
        function showMultiPartVerificationSuccessModal() {
            const state = window._archiveVerificationData;
            const manifest = state.manifest;
            const post = state.matchingPosts[0];
            
            const hiveUrl = `https://ecency.com/@${post.author}/${post.permlink}`;
            const date = new Date(post.created).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            
            const multipartModule = window.ArcHiveMultiPart;
            const seriesTag = multipartModule ? multipartModule.generateSeriesTag(manifest.series_id) : 'SERIES';
            
            const content = `
                <div style="padding: var(--spacing-lg);">
                    <div style="text-align: center; font-size: 3rem; margin-bottom: var(--spacing-md);">✅</div>
                    <h2 style="font-size: var(--text-2xl); font-weight: 700; text-align: center; margin-bottom: var(--spacing-md); color: var(--text-primary);">
                        Content Fully Archived
                    </h2>
                    <p style="color: var(--text-secondary); text-align: center; margin-bottom: var(--spacing-lg); font-size: var(--text-base);">
                        This multi-part content is already archived and <strong>unchanged</strong>. Duplicate posting prevented.
                    </p>
                    
                    <div style="background: rgba(16, 185, 129, 0.1); border: 2px solid rgba(16, 185, 129, 0.3); border-radius: 12px; padding: var(--spacing-md); margin-bottom: var(--spacing-lg);">
                        <div style="text-align: center; margin-bottom: var(--spacing-sm);">
                            <span style="font-size: 2rem;">🔒</span>
                        </div>
                        <p style="color: #065f46; text-align: center; font-weight: 600; font-size: var(--text-base); margin-bottom: var(--spacing-sm);">
                            All ${manifest.total_parts} parts verified successfully
                        </p>
                        <p style="color: #059669; text-align: center; font-size: var(--text-sm);">
                            Content hashes match across all parts
                        </p>
                    </div>
                    
                    <div style="background: #f1f5f9; border-radius: 12px; padding: var(--spacing-md); margin-bottom: var(--spacing-lg);">
                        <div style="margin-bottom: var(--spacing-sm);">
                            <strong style="color: var(--text-primary); font-size: var(--text-sm);">📦 Series:</strong>
                            <div style="color: var(--text-secondary); font-size: var(--text-sm); font-family: monospace;">${manifest.series_id.substring(0, 16)}...</div>
                        </div>
                        <div style="margin-bottom: var(--spacing-sm);">
                            <strong style="color: var(--text-primary); font-size: var(--text-sm);">📄 Parts:</strong>
                            <div style="color: var(--text-secondary); font-size: var(--text-base);">${manifest.total_parts} parts</div>
                        </div>
                        <div style="margin-bottom: var(--spacing-sm);">
                            <strong style="color: var(--text-primary); font-size: var(--text-sm);">🏷️ Tag:</strong>
                            <div style="color: var(--text-secondary); font-size: var(--text-base);">${seriesTag}</div>
                        </div>
                        <div style="margin-bottom: var(--spacing-sm);">
                            <strong style="color: var(--text-primary); font-size: var(--text-sm);">📅 Archived on:</strong>
                            <div style="color: var(--text-secondary); font-size: var(--text-base);">${date}</div>
                        </div>
                        <div>
                            <strong style="color: var(--text-primary); font-size: var(--text-sm);">👤 Author:</strong>
                            <div style="color: var(--text-secondary); font-size: var(--text-base);">@${escapeHtml(post.author)}</div>
                        </div>
                    </div>
                    
                    <div class="btn-group">
                        <a href="${hiveUrl}" target="_blank" class="btn btn-success btn-full" style="min-height: var(--touch-target); text-decoration: none;">
                            🔗 View on Hive
                        </a>
                        <button class="btn" onclick="closeModal(); clearVerificationState();" style="background: rgba(100, 116, 139, 0.1); color: var(--text-secondary); min-height: var(--touch-target);">
                            Close
                        </button>
                    </div>
                </div>
            `;
            
            showModal(content);
            showToast('success', '✅ Multi-part verification complete - all parts match!');
        }
        
        /**
         * Show multi-part verification changed modal
         */
        function showMultiPartVerificationChangedModal() {
            const state = window._archiveVerificationData;
            const manifest = state.manifest;
            const post = state.matchingPosts[0];
            
            const hiveUrl = `https://ecency.com/@${post.author}/${post.permlink}`;
            const date = new Date(post.created).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            
            const matchingParts = state.perPartResults.filter(p => p.match).length;
            const changedParts = state.perPartResults.filter(p => p.status === 'changed').length;
            const missingParts = state.perPartResults.filter(p => p.status === 'missing').length;
            
            let statusMessage = '';
            if (missingParts > 0) {
                statusMessage = `⚠️ ${missingParts} part(s) missing from blockchain`;
            } else if (changedParts > 0) {
                statusMessage = `📝 ${changedParts} part(s) have changed`;
            }
            
            const content = `
                <div style="padding: var(--spacing-lg);">
                    <div style="text-align: center; font-size: 3rem; margin-bottom: var(--spacing-md);">📝</div>
                    <h2 style="font-size: var(--text-2xl); font-weight: 700; text-align: center; margin-bottom: var(--spacing-md); color: var(--text-primary);">
                        Content Has Changed
                    </h2>
                    <p style="color: var(--text-secondary); text-align: center; margin-bottom: var(--spacing-lg); font-size: var(--text-base);">
                        The multi-part content has been <strong>modified</strong> since archiving. Would you like to archive the new version?
                    </p>
                    
                    <div style="background: rgba(245, 158, 11, 0.1); border: 2px solid rgba(245, 158, 11, 0.3); border-radius: 12px; padding: var(--spacing-md); margin-bottom: var(--spacing-lg);">
                        <div style="text-align: center; margin-bottom: var(--spacing-sm);">
                            <span style="font-size: 2rem;">⚠️</span>
                        </div>
                        <p style="color: #92400e; text-align: center; font-weight: 600; font-size: var(--text-base); margin-bottom: var(--spacing-sm);">
                            ${statusMessage}
                        </p>
                        <p style="color: #b45309; text-align: center; font-size: var(--text-sm);">
                            ${matchingParts}/${manifest.total_parts} parts match the archived version
                        </p>
                    </div>
                    
                    <div style="background: #f1f5f9; border-radius: 12px; padding: var(--spacing-md); margin-bottom: var(--spacing-lg);">
                        <div style="margin-bottom: var(--spacing-sm);">
                            <strong style="color: var(--text-primary); font-size: var(--text-sm);">📦 Original series:</strong>
                            <div style="color: var(--text-secondary); font-size: var(--text-sm); font-family: monospace;">${manifest.series_id.substring(0, 16)}...</div>
                        </div>
                        <div style="margin-bottom: var(--spacing-sm);">
                            <strong style="color: var(--text-primary); font-size: var(--text-sm);">📄 Total parts:</strong>
                            <div style="color: var(--text-secondary); font-size: var(--text-base);">${manifest.total_parts} parts</div>
                        </div>
                        <div>
                            <strong style="color: var(--text-primary); font-size: var(--text-sm);">📅 Last archived:</strong>
                            <div style="color: var(--text-secondary); font-size: var(--text-base);">${date}</div>
                        </div>
                    </div>
                    
                    <div style="background: #e0f2fe; padding: var(--spacing-md); border-radius: 8px; margin-bottom: var(--spacing-lg); font-size: var(--text-sm);">
                        <p style="color: #0369a1; margin: 0;">
                            <strong>💡 Tip:</strong> A new version will be created as a separate series with a new series ID.
                        </p>
                    </div>
                    
                    <div class="btn-group">
                        <button class="btn btn-success btn-full" onclick="closeModal(); switchToArchiveMode();" style="min-height: var(--touch-target);">
                            ✅ Archive New Version
                        </button>
                        <a href="${hiveUrl}" target="_blank" class="btn" style="min-height: var(--touch-target); text-decoration: none; display: inline-block;">
                            🔗 View Old Version
                        </a>
                        <button class="btn" onclick="closeModal(); clearVerificationState();" style="background: rgba(100, 116, 139, 0.1); color: var(--text-secondary); min-height: var(--touch-target);">
                            Cancel
                        </button>
                    </div>
                </div>
            `;
            
            showModal(content);
            showToast('warning', '📝 Content has changed - you can archive the new version');
        }
        
        /**
         * Hash a string using SHA-256 (fallback to simple hash if crypto not available)
         */
        async function hashString(str) {
            try {
                if (window.ArcHiveMultiPart && window.ArcHiveMultiPart.hashString) {
                    const hashes = await window.ArcHiveMultiPart.hashString(str);
                    return hashes;  // ✅ Return full hash object {sha256, blake2b, md5}
                }
                
                // Fallback to simple hash (should never be used in production)
                let hash = 0;
                for (let i = 0; i < str.length; i++) {
                    const char = str.charCodeAt(i);
                    hash = ((hash << 5) - hash) + char;
                    hash = hash & hash;
                }
                const simpleHash = hash.toString(16);
                return {
                    sha256: simpleHash,
                    blake2b: simpleHash,
                    md5: simpleHash
                };
            } catch (error) {
                console.error('❌ Hash generation failed:', error);
                return null;
            }
        }
        
        /**
         * Scenario B: Already archived and content unchanged
         */
        function showAlreadyArchivedModal(post) {
            let metadata = post.json_metadata;
            if (typeof metadata === 'string') {
                try {
                    metadata = JSON.parse(metadata);
                } catch (e) {
                    metadata = {};
                }
            }
            metadata = metadata || {};
            
            const hiveUrl = `https://ecency.com/@${post.author}/${post.permlink}`;
            const date = new Date(post.created).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            const sourceUrl = metadata.sourceUrl || 'Unknown';
            
            const content = `
                <div style="padding: var(--spacing-lg);">
                    <div style="text-align: center; font-size: 3rem; margin-bottom: var(--spacing-md);">✅</div>
                    <h2 style="font-size: var(--text-2xl); font-weight: 700; text-align: center; margin-bottom: var(--spacing-md); color: var(--text-primary);">
                        Already Archived
                    </h2>
                    <p style="color: var(--text-secondary); text-align: center; margin-bottom: var(--spacing-lg); font-size: var(--text-base);">
                        This link has already been archived to the Hive blockchain and the content hasn't changed.
                    </p>
                    <div style="background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.2); padding: var(--spacing-md); border-radius: 12px; margin-bottom: var(--spacing-lg);">
                        <div style="margin-bottom: var(--spacing-sm);">
                            <strong style="color: var(--text-primary); font-size: var(--text-sm);">Archived on:</strong>
                            <div style="color: var(--text-secondary); font-size: var(--text-base);">${date}</div>
                        </div>
                        <div style="margin-bottom: var(--spacing-sm);">
                            <strong style="color: var(--text-primary); font-size: var(--text-sm);">Source URL:</strong>
                            <div style="color: var(--text-secondary); font-size: var(--text-sm); word-break: break-all; font-family: monospace;">${escapeHtml(sourceUrl)}</div>
                        </div>
                        <div>
                            <strong style="color: var(--text-primary); font-size: var(--text-sm);">Author:</strong>
                            <div style="color: var(--text-secondary); font-size: var(--text-base);">@${escapeHtml(post.author)}</div>
                        </div>
                    </div>
                    <div class="btn-group">
                        <a href="${hiveUrl}" target="_blank" class="btn btn-success btn-full" style="min-height: var(--touch-target); text-decoration: none;">
                            🔗 View on Hive
                        </a>
                        <button class="btn" onclick="closeModal();" style="background: rgba(100, 116, 139, 0.1); color: var(--text-secondary); min-height: var(--touch-target);">
                            Close
                        </button>
                    </div>
                </div>
            `;
            showModal(content);
        }
        
        /**
         * Scenario C: Already archived but content has been edited
         */
        function showEditedVersionModal(url, existingVersions) {
            const versionCount = existingVersions.length;
            const latestPost = existingVersions[existingVersions.length - 1];
            const latestDate = new Date(latestPost.created).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            
            const content = `
                <div style="padding: var(--spacing-lg);">
                    <div style="text-align: center; font-size: 3rem; margin-bottom: var(--spacing-md);">📝</div>
                    <h2 style="font-size: var(--text-2xl); font-weight: 700; text-align: center; margin-bottom: var(--spacing-md); color: var(--text-primary);">
                        Content Has Changed
                    </h2>
                    <p style="color: var(--text-secondary); text-align: center; margin-bottom: var(--spacing-lg); font-size: var(--text-base);">
                        This link was previously archived, but the content has been edited since then. Would you like to archive the new version?
                    </p>
                    <div style="background: rgba(245, 158, 11, 0.1); border: 1px solid rgba(245, 158, 11, 0.2); padding: var(--spacing-md); border-radius: 12px; margin-bottom: var(--spacing-lg);">
                        <div style="margin-bottom: var(--spacing-sm);">
                            <strong style="color: var(--text-primary); font-size: var(--text-sm);">Existing versions:</strong>
                            <div style="color: var(--text-secondary); font-size: var(--text-lg); font-weight: 700;">${versionCount}</div>
                        </div>
                        <div>
                            <strong style="color: var(--text-primary); font-size: var(--text-sm);">Last archived:</strong>
                            <div style="color: var(--text-secondary); font-size: var(--text-base);">${latestDate}</div>
                        </div>
                    </div>
                    <div style="background: #f1f5f9; padding: var(--spacing-md); border-radius: 12px; margin-bottom: var(--spacing-lg); word-break: break-all; font-family: monospace; font-size: var(--text-sm);">
                        ${escapeHtml(url)}
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-success btn-full" onclick="closeModal(); processContent(true);" style="min-height: var(--touch-target);">
                            ✅ Archive New Version
                        </button>
                        <button class="btn" onclick="closeModal();" style="background: rgba(100, 116, 139, 0.1); color: var(--text-secondary); min-height: var(--touch-target);">
                            Cancel
                        </button>
                    </div>
                </div>
            `;
            showModal(content);
        }
        
        /**
         * Show loading modal during Hive lookup with progress and cancel button
         */
        function showLoadingModal(message) {
            const content = `
                <div style="padding: var(--spacing-xl); text-align: center;">
                    <div style="width: 50px; height: 50px; border: 3px solid rgba(59, 130, 246, 0.2); border-top-color: #3b82f6; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto var(--spacing-md);"></div>
                    <p style="color: var(--text-primary); font-size: var(--text-lg); font-weight: 600; margin-bottom: var(--spacing-sm);">${escapeHtml(message)}</p>
                    <p id="hive-search-progress" style="color: var(--text-secondary); font-size: var(--text-sm); margin-bottom: var(--spacing-md); min-height: 20px;">Connecting to Hive network...</p>
                    <button class="btn" onclick="window.ArcHiveHiveLookup.cancelCurrentSearch(); closeModal();" style="background: rgba(239, 68, 68, 0.1); color: #dc2626; min-height: var(--touch-target); margin-top: var(--spacing-md);">
                        🛑 Cancel
                    </button>
                </div>
                <style>
                    @keyframes spin { to { transform: rotate(360deg); } }
                </style>
            `;
            showModal(content);
        }
        
        /**
         * Update progress during Hive search
         */
        function updateSearchProgress(nodeIndex, totalNodes, nodeName, retry) {
            const progressElement = document.getElementById('hive-search-progress');
            if (progressElement) {
                const retryText = retry > 0 ? ` (retry ${retry})` : '';
                progressElement.textContent = `Trying node ${nodeIndex}/${totalNodes}: ${nodeName}${retryText}`;
            }
        }
        
        /**
         * HTML escape helper to prevent XSS
         */
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        /**
         * Smart Archive: Check if URL is already archived before extraction
         */
        async function smartArchive(url) {
            try {
                // Clear any existing verification state before starting new lookup
                if (window._archiveVerificationData) {
                    console.log('🧹 Clearing old verification state before new lookup');
                    window._archiveVerificationData = null;
                }
                
                // Show loading modal
                showLoadingModal('Checking Hive blockchain...');
                
                // Normalize URL for consistent comparison
                const normalizedUrl = window.ArcHiveUrlNormalizer.normalizeUrl(url);
                console.log('🔍 Smart Archive: Checking for URL:', normalizedUrl);
                
                // Search with universal tag first (fast but may get many results)
                const tags = ['archivedcontenthaf'];
                const allPosts = await window.ArcHiveHiveLookup.searchHiveByTags(tags, updateSearchProgress);
                console.log(`📊 Found ${allPosts.length} total archives, filtering by URL...`);
                
                // SECURITY LAYER 1: Filter posts that match this URL
                const urlMatchingPosts = allPosts.filter(post => {
                    let metadata = post.json_metadata;
                    if (typeof metadata === 'string') {
                        try {
                            metadata = JSON.parse(metadata);
                        } catch (e) {
                            return false;
                        }
                    }
                    metadata = metadata || {};
                    
                    // Check all possible URL locations in metadata:
                    // 1. metadata.sourceUrl (older format)
                    // 2. metadata.source_url (root level)
                    // 3. metadata.arcMultiPart.source_url (current format)
                    const metadataSourceUrl = metadata.sourceUrl || 
                                             metadata.source_url || 
                                             metadata.arcMultiPart?.source_url;
                    if (!metadataSourceUrl) return false;
                    
                    const normalizedMetadata = window.ArcHiveUrlNormalizer.normalizeUrl(metadataSourceUrl);
                    return normalizedMetadata === normalizedUrl;
                });
                
                console.log(`📊 Found ${urlMatchingPosts.length} posts matching URL, validating manifests...`);
                
                // SECURITY LAYER 2: Validate arcMultiPart manifest structure
                // This prevents spoofed posts (tags + URL but no actual archive data) from being treated as legitimate
                const multipartModule = window.ArcHiveMultiPart;
                
                // CRITICAL SECURITY FIX #1: Module Availability Guard
                // If validation module is missing, abort with fatal error instead of silently skipping validation
                if (!multipartModule) {
                    throw new Error('Archive validation module not loaded - please refresh the page');
                }
                
                const matchingPosts = [];  // Validated archives
                const spoofedPosts = [];    // Invalid posts
                
                for (const post of urlMatchingPosts) {
                    try {
                        // Extract manifest (checks json_metadata.arcMultiPart or HTML comment)
                        const manifest = multipartModule.extractManifestFromPost(post);
                        
                        if (!manifest) {
                            // CRITICAL SECURITY FIX #2: Single-Part vs Spoofed Distinction
                            // No arcMultiPart manifest found - check if it's a legacy single-part archive
                            let metadata = post.json_metadata;
                            if (typeof metadata === 'string') {
                                try {
                                    metadata = JSON.parse(metadata);
                                } catch (e) {
                                    metadata = {};
                                }
                            }
                            
                            // Legacy single-part archives have hashes in metadata (no arcMultiPart)
                            // These are legitimate archives created before manifest requirement
                            if (metadata && metadata.hashes) {
                                console.log(`✅ Legacy single-part archive: @${post.author}/${post.permlink} (has hashes, no manifest)`);
                                matchingPosts.push(post);
                                continue;
                            }
                            
                            // Post has matching URL but NO valid manifest structure AND no hashes
                            console.warn(`⚠️  Post @${post.author}/${post.permlink} has NO arcMultiPart manifest or legacy hashes - not a legitimate archive`);
                            spoofedPosts.push(post);
                            continue;
                        }
                        
                        // Validate manifest structure
                        await multipartModule.validateManifest(manifest);
                        
                        // Passed validation - legitimate archive
                        console.log(`✅ Validated archive: @${post.author}/${post.permlink} (${manifest.total_parts} parts)`);
                        matchingPosts.push(post);
                        
                    } catch (error) {
                        console.warn(`⚠️  Post @${post.author}/${post.permlink} failed validation: ${error.message}`);
                        spoofedPosts.push(post);
                    }
                }
                
                console.log(`🔒 Security check: ${matchingPosts.length} legitimate archives, ${spoofedPosts.length} spoofed/invalid posts filtered out`);
                
                // Scenario A: No legitimate archives found
                if (matchingPosts.length === 0) {
                    if (spoofedPosts.length > 0) {
                        // Found posts with matching URL but no valid manifest - show warning
                        console.warn('⚠️  Found posts with matching URL but no valid ArcHive manifest structure');
                        closeModal();
                        const content = `
                            <div style="padding: var(--spacing-lg);">
                                <div style="text-align: center; font-size: 3rem; margin-bottom: var(--spacing-md);">⚠️</div>
                                <h2 style="font-size: var(--text-2xl); font-weight: 700; text-align: center; margin-bottom: var(--spacing-md); color: var(--text-primary);">
                                    Not a Legitimate Archive
                                </h2>
                                <p style="color: var(--text-secondary); text-align: center; margin-bottom: var(--spacing-lg); font-size: var(--text-base);">
                                    Found ${spoofedPosts.length} post${spoofedPosts.length > 1 ? 's' : ''} with this URL, but ${spoofedPosts.length > 1 ? 'they lack' : 'it lacks'} the required ArcHive manifest structure.
                                </p>
                                <div style="background: rgba(251, 191, 36, 0.1); border: 1px solid rgba(251, 191, 36, 0.3); padding: var(--spacing-md); border-radius: 12px; margin-bottom: var(--spacing-lg); font-size: var(--text-sm);">
                                    <strong>Security Note:</strong> ArcHive requires posts to contain valid arcMultiPart manifest structures in <code>json_metadata.arcMultiPart</code>. These posts appear to be random link posts with ArcHive tags but no actual archived content.
                                </div>
                                <div class="btn-group">
                                    <button class="btn btn-success btn-full" onclick="closeModal(); processContent(true);" style="min-height: var(--touch-target);">
                                        ✅ ArcHive Now
                                    </button>
                                    <button class="btn" onclick="closeModal();" style="background: rgba(100, 116, 139, 0.1); color: var(--text-secondary); min-height: var(--touch-target);">
                                        Cancel
                                    </button>
                                </div>
                            </div>
                        `;
                        showModal(content);
                    } else {
                        // No posts found at all - extract content first, then show archive modal
                        console.log('📭 URL not found on Hive - checking for pre-extracted content...');
                        
                        // BUG FIX: Check if bookmarklet already extracted content
                        // The bookmarklet stores HTML in window._bookmarkletExtractedHtml
                        // Server extraction would OVERWRITE this with error messages for JS-heavy sites like X.com
                        const hasBookmarkletContent = window._bookmarkletExtractedHtml && 
                                                      window._bookmarkletExtractedHtml.length > 200;
                        const textareaContent = document.getElementById('contentInput')?.value?.trim();
                        const hasTextareaContent = textareaContent && textareaContent.length > 200;
                        
                        if (hasBookmarkletContent || hasTextareaContent) {
                            // Content already extracted by bookmarklet - skip server extraction
                            console.log('✅ Using bookmarklet-extracted content (skipping server extraction)');
                            console.log('   Bookmarklet HTML:', hasBookmarkletContent ? window._bookmarkletExtractedHtml.length + ' chars' : 'none');
                            console.log('   Textarea content:', hasTextareaContent ? textareaContent.length + ' chars' : 'none');
                            closeModal();
                            showNotFoundModal(url, true); // true = content already extracted
                        } else {
                            // No pre-extracted content - use client-side extraction
                            // 🚀 AUTO-EXTRACTION: Extract content before showing not-found modal
                            // NOTE: 100% client-side - no server dependency (GitHub Pages compatible)
                            try {
                                showLoadingModal('Extracting content for archiving...');
                                
                                const extractor = new ContentExtractor();
                                const extractResult = await extractor.extract(url, (status) => {
                                    showLoadingModal(status);
                                });
                                
                                if (extractResult && extractResult.content) {
                                    console.log('✅ Content extracted successfully via client-side extraction');
                                    
                                    // Store extracted data
                                    window._serverExtractedData = {
                                        title: extractResult.title || '',
                                        content: extractResult.content,
                                        url: extractResult.url || url,
                                        provenance: extractResult.provenance || null,
                                        method: 'client-side'
                                    };
                                    
                                    // Put content in textarea
                                    document.getElementById('contentInput').value = extractResult.content;
                                    
                                    closeModal();
                                    showNotFoundModal(url, true); // true = content already extracted
                                } else {
                                    // Extraction failed - still show modal but without content
                                    closeModal();
                                    showNotFoundModal(url, false);
                                }
                            } catch (e) {
                                // Handle bookmarklet offer gracefully
                                if (e.message === 'BOOKMARKLET_OFFERED') {
                                    return; // Modal already shown by ContentExtractor
                                }
                                console.warn('⚠️ Could not extract content:', e);
                                closeModal();
                                showNotFoundModal(url, false);
                            }
                        }
                    }
                    return;
                }
                
                // Scenario B: Found legitimate archive(s) with validated manifests
                console.log('✅ Found legitimate archive(s) on Hive - preparing for auto-verification...');
                
                // BUG FIX: Check if bookmarklet already extracted content before server extraction
                // Server extraction would OVERWRITE bookmarklet content for JS-heavy sites like X.com
                const hasBookmarkletContent = window._bookmarkletExtractedHtml && 
                                              window._bookmarkletExtractedHtml.length > 200;
                const textareaContent = document.getElementById('contentInput')?.value?.trim();
                const hasTextareaContent = textareaContent && textareaContent.length > 200;
                
                let extractedData = null;
                
                if (hasBookmarkletContent || hasTextareaContent) {
                    // Use bookmarklet-extracted content for verification
                    console.log('✅ Using bookmarklet-extracted content for verification (skipping server extraction)');
                    console.log('   Bookmarklet HTML:', hasBookmarkletContent ? window._bookmarkletExtractedHtml.length + ' chars' : 'none');
                    console.log('   Textarea content:', hasTextareaContent ? textareaContent.length + ' chars' : 'none');
                } else {
                    // No pre-extracted content - use client-side extraction
                    // 🚀 AUTO-EXTRACTION: Extract current content before showing modal
                    // NOTE: 100% client-side - no server dependency (GitHub Pages compatible)
                    try {
                        showLoadingModal('Extracting current content for verification...');
                        
                        const extractor = new ContentExtractor();
                        const extractResult = await extractor.extract(url, (status) => {
                            showLoadingModal(status);
                        });
                        
                        if (extractResult && extractResult.content) {
                            console.log('✅ Content extracted for verification via client-side');
                            extractedData = extractResult;
                            
                            // Store for later use
                            window._serverExtractedData = {
                                title: extractResult.title || '',
                                content: extractResult.content,
                                url: extractResult.url || url,
                                provenance: extractResult.provenance || null,
                                method: 'client-side'
                            };
                            
                            // Put content in textarea for processing
                            document.getElementById('contentInput').value = extractResult.content;
                        }
                    } catch (e) {
                        // Handle bookmarklet offer gracefully - don't log as error
                        if (e.message !== 'BOOKMARKLET_OFFERED') {
                            console.warn('⚠️ Could not extract content for auto-verification:', e);
                        }
                    }
                }
                
                closeModal();
                showVerifyOrViewModal(url, matchingPosts, extractedData);
                
            } catch (error) {
                console.error('❌ Smart archive lookup failed:', error);
                closeModal();
                
                // Check if user cancelled the search
                if (error.message.includes('cancelled by user')) {
                    console.log('🛑 User cancelled the search');
                    return; // Just close modal, don't show error
                }
                
                // RACE CONDITION FIX (Nov 25, 2025): When both message handlers trigger 
                // smartArchive() simultaneously, the second call fails with "already in progress".
                // This is expected behavior - silently skip since the first search is handling it.
                if (error.message.includes('already in progress')) {
                    console.log('🔄 Another search is handling this request - skipping duplicate');
                    return; // Let the first search complete normally
                }
                
                // Show error modal with retry option
                const content = `
                    <div style="padding: var(--spacing-lg);">
                        <div style="text-align: center; font-size: 3rem; margin-bottom: var(--spacing-md);">⚠️</div>
                        <h2 style="font-size: var(--text-2xl); font-weight: 700; text-align: center; margin-bottom: var(--spacing-md); color: var(--text-primary);">
                            Lookup Failed
                        </h2>
                        <p style="color: var(--text-secondary); text-align: center; margin-bottom: var(--spacing-lg); font-size: var(--text-base);">
                            We couldn't check if this URL is already archived. This might be due to network issues or Hive API being temporarily unavailable.
                        </p>
                        <div style="background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.2); padding: var(--spacing-md); border-radius: 12px; margin-bottom: var(--spacing-lg); font-size: var(--text-sm); word-break: break-word;">
                            <strong>Error:</strong> ${escapeHtml(error.message)}
                        </div>
                        <div class="btn-group">
                            <button class="btn btn-primary btn-full" onclick="closeModal(); smartArchive('${escapeHtml(url)}');" style="min-height: var(--touch-target);">
                                🔄 Retry
                            </button>
                            <button class="btn btn-success" onclick="closeModal(); processContent(true);" style="min-height: var(--touch-target);">
                                Proceed Anyway
                            </button>
                            <button class="btn" onclick="closeModal();" style="background: rgba(100, 116, 139, 0.1); color: var(--text-secondary); min-height: var(--touch-target);">
                                Cancel
                            </button>
                        </div>
                    </div>
                `;
                showModal(content);
            }
        }
        
        /**
         * Process content from textarea
         */
        async function processContent(skipSmartArchive = false) {
            let input = document.getElementById('contentInput').value.trim();
            const statusDiv = document.getElementById('status');
            const resultsDiv = document.getElementById('results');
            
            // 🎯 SMART PRIORITY: Use Source URL field only if textarea is empty
            // This supports both URL-only extraction AND manual HTML + source URL reference
            const sourceUrlField = document.getElementById('sourceUrlInput');
            const sourceUrl = sourceUrlField ? sourceUrlField.value.trim() : '';
            
            if (!input && sourceUrl) {
                // Textarea empty but Source URL provided - use URL extraction mode
                input = sourceUrl;
                console.log('🎯 Using Source URL field for extraction (textarea empty):', sourceUrl);
            } else if (input && sourceUrl) {
                // Both provided - textarea takes priority, source URL used for metadata
                console.log('📝 Using textarea content (manual mode), Source URL will be used for metadata:', sourceUrl);
            }
            
            // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
            // 🚀 SMART PRE-ARCHIVE LOOKUP: Check if URL is already archived
            // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
            // BUG FIX #1: Skip smart archive if we're in verification mode
            // In verification mode, we already know the URL is archived - just compare hashes
            // Only perform smart archive lookup if:
            // 1. Input is a URL (not manual HTML paste)
            // 2. Textarea is empty (URL-only mode)
            // 3. Not skipping smart archive (e.g., after modal click)
            // 4. NOT in verification mode (already archived, just comparing)
            const isVerificationMode = window._archiveVerificationData && 
                                       window._archiveVerificationData.mode === 'verification';
            
            if (!skipSmartArchive && 
                !isVerificationMode && 
                !document.getElementById('contentInput').value.trim() && 
                processor.isURL(input)) {
                console.log('🔍 Smart Archive: URL detected, performing pre-archive lookup...');
                await smartArchive(input);
                return; // Exit - modal will call processContent(true) if user wants to proceed
            }
            
            // 🔒 CLIENT-SIDE ONLY: ArcHive uses bookmarklets for extraction
            // No server-side extraction - this enables hosting on GitHub Pages, IPFS, etc.
            // 🤖 ANDROID FIX: Skip bookmarklet modal for Android - proceed directly to URL extraction
            const isAndroid = /Android/.test(navigator.userAgent);
            
            if (processor.isURL(input) && !document.getElementById('contentInput').value.trim() && !isAndroid) {
                // Non-Android + URL detected - show bookmarklet instructions
                console.log('📱 URL detected - bookmarklet required for extraction (non-Android)');
                statusDiv.innerHTML = '';
                resultsDiv.classList.remove('show');
                
                const siteName = processor.getSiteName(input);
                showModal(`
                    <div style="padding: var(--spacing-xl); text-align: center;">
                        <div style="font-size: 48px; margin-bottom: var(--spacing-md);">📱</div>
                        <h2 style="margin-bottom: var(--spacing-md); color: var(--text-primary);">Use the Bookmarklet</h2>
                        <p style="color: var(--text-secondary); margin-bottom: var(--spacing-md);">
                            To archive <strong>${siteName || 'this website'}</strong>, use the ArcHive bookmarklet directly on the page.
                        </p>
                        <p style="color: var(--text-tertiary); font-size: 0.9rem; margin-bottom: var(--spacing-lg);">
                            The bookmarklet extracts content client-side for true decentralization - no servers involved!
                        </p>
                        <div class="btn-group">
                            <button class="btn btn-primary btn-full" onclick="closeModal(); showBookmarkletInstructions();" style="min-height: var(--touch-target);">
                                📥 Get Bookmarklet
                            </button>
                            <button class="btn" onclick="closeModal();" style="background: rgba(100, 116, 139, 0.1); color: var(--text-secondary); min-height: var(--touch-target);">
                                Cancel
                            </button>
                        </div>
                    </div>
                `);
                return;
            }
            
            // 🤖 ANDROID FIX: Android users detected with URL - proceed to fetch/extract
            if (isAndroid && processor.isURL(input) && !document.getElementById('contentInput').value.trim()) {
                console.log('🤖 Android detected with URL - proceeding to extract directly');
            }
            
            // Create abort controller for cancellation
            currentAbortController = new AbortController();
            
            updateExtractionProgress('Starting extraction...');
            resultsDiv.classList.remove('show');
            
            try {
                const result = await processor.processContent(input, updateExtractionProgress, currentAbortController.signal);
                processor.currentData = result;
                
                statusDiv.innerHTML = '<div class="status status-success">✅ Content successfully extracted and hashed!</div>';
                displayResults(result);
                updateHistory();
                currentAbortController = null;
                
                // Mark extraction ready if in verification mode
                if (window._archiveVerificationData && window._archiveVerificationData.mode === 'verification') {
                    window._archiveVerificationData.extractionReady = true;
                    console.log('✅ Extraction complete in verification mode - enabling verify button');
                }
                
                // Update button state (will enable Verify button if in verification mode)
                updatePrimaryActionButton();
                
            } catch (error) {
                console.error('Processing error:', error?.message || error, error);
                
                // Check if it was user cancellation
                if (error.name === 'AbortError') {
                    statusDiv.innerHTML = '<div class="status status-error">⚠️ Extraction cancelled</div>';
                } else if (error.message === 'BOOKMARKLET_OFFERED') {
                    // Bookmarklet modal is already shown, no error display needed
                    statusDiv.innerHTML = '';
                    console.log('✅ Bookmarklet modal displayed to user');
                } else {
                    // Enhanced error message with manual paste hint
                    const errorHtml = `
                        <div class="status status-error">
                            <div style="margin-bottom: 12px;"><strong>❌ ${error.message.split('\n')[0]}</strong></div>
                            ${error.message.includes('WORKAROUND') ? `
                                <div style="background: rgba(0,0,0,0.1); padding: 12px; border-radius: 6px; font-size: 14px; line-height: 1.6; text-align: left;">
                                    ${error.message.split('\n').slice(1).join('<br>')}
                                </div>
                                <div style="margin-top: 12px;">
                                    <button onclick="focusTextarea()" style="padding: 8px 16px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                                        📝 Ready to Paste HTML
                                    </button>
                                </div>
                            ` : ''}
                        </div>
                    `;
                    statusDiv.innerHTML = errorHtml;
                }
                currentAbortController = null;
            }
        }
        
        /**
         * Detect paywall or login-required content
         * Returns { detected: boolean, siteName: string, indicators: [] }
         */
        function detectPaywall(data) {
            const content = (data.content || '').toLowerCase();
            const title = (data.title || '').toLowerCase();
            const source = (data.source || '').toLowerCase();
            const wordCount = data.wordCount || 0;
            
            const indicators = [];
            let siteName = '';
            
            // Common paywall text patterns
            const paywallPatterns = [
                /sign in to (read|continue|view)/i,
                /create (a|an) (free )?account/i,
                /subscribe to (read|continue|access)/i,
                /become a (member|subscriber)/i,
                /this article is for (members|subscribers)/i,
                /read the full (story|article)/i,
                /unlock this article/i,
                /premium content/i,
                /paywall/i,
                /member[- ]?only/i,
                /subscription required/i,
                /log in to view/i,
                /register to read/i
            ];
            
            // Check for paywall text patterns
            for (const pattern of paywallPatterns) {
                if (pattern.test(content) || pattern.test(title)) {
                    indicators.push(`Found paywall text: "${pattern.source.replace(/[\/\\]/g, '')}"`);
                }
            }
            
            // Check for known paywall sites in source URL
            const paywallSites = {
                'medium.com': 'Medium',
                'substack.com': 'Substack',
                'nytimes.com': 'New York Times',
                'wsj.com': 'Wall Street Journal',
                'washingtonpost.com': 'Washington Post',
                'bloomberg.com': 'Bloomberg',
                'ft.com': 'Financial Times',
                'economist.com': 'The Economist',
                'newyorker.com': 'The New Yorker',
                'wired.com': 'Wired',
                'theatlantic.com': 'The Atlantic'
            };
            
            for (const [domain, name] of Object.entries(paywallSites)) {
                if (source.includes(domain)) {
                    siteName = name;
                    indicators.push(`Known paywall site: ${name}`);
                    break;
                }
            }
            
            // Check for suspiciously short content (might be truncated)
            // Articles under 300 words that mention "continue reading" or similar
            if (wordCount < 300 && wordCount > 0) {
                if (/continue|read more|full article|see more/i.test(content)) {
                    indicators.push(`Short content (${wordCount} words) with "continue reading" indicator`);
                }
            }
            
            return {
                detected: indicators.length > 0,
                siteName: siteName,
                indicators: indicators
            };
        }
        
        /**
         * Display extraction results
         */
        async function displayResults(data) {
            const resultsDiv = document.getElementById('results');
            const titleEl = document.getElementById('resultTitle');
            const wordCountEl = document.getElementById('wordCount');
            const imageCountEl = document.getElementById('imageCount');
            const methodEl = document.getElementById('extractionMethod');
            const hashesDisplay = document.getElementById('hashesDisplay');
            
            titleEl.textContent = data.title;
            wordCountEl.textContent = data.wordCount.toLocaleString();
            imageCountEl.textContent = data.imageCount;
            methodEl.textContent = data.method;
            
            // Populate Archive Information Card
            const archiveInfoCard = document.getElementById('archiveInfoCard');
            const archivedTimestamp = document.getElementById('archivedTimestamp');
            const archivedMethod = document.getElementById('archivedMethod');
            const archivedWordCount = document.getElementById('archivedWordCount');
            const archivedSource = document.getElementById('archivedSource');
            
            // Format timestamp for display
            const timestamp = new Date(data.timestamp);
            const formattedTimestamp = timestamp.toLocaleString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            
            archivedTimestamp.textContent = formattedTimestamp;
            archivedMethod.textContent = data.method;
            archivedWordCount.textContent = data.wordCount.toLocaleString();
            
            // Display actual source URL (not "manual-paste")
            const sourceUrl = data.url || data.source;
            if (sourceUrl && sourceUrl !== 'manual-paste') {
                archivedSource.textContent = sourceUrl;
            } else {
                archivedSource.textContent = 'Direct paste (no source URL)';
                archivedSource.style.color = 'var(--text-secondary)';
            }
            
            // Show the Archive Information card
            archiveInfoCard.style.display = 'block';
            
            // Display provenance if available (Wikipedia revision ID, etc.)
            const provenanceSection = document.getElementById('provenanceSection');
            const provenanceContent = document.getElementById('provenanceContent');
            
            // Always clear previous provenance first to prevent stale data
            provenanceSection.style.display = 'none';
            provenanceContent.innerHTML = '';
            
            if (data.provenance && data.provenance.source_type === 'wikipedia' && data.provenance.revision_id) {
                provenanceSection.style.display = 'block';
                provenanceContent.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid rgba(139, 92, 246, 0.2);">
                        <span style="font-weight: 600; color: #7c3aed; font-size: var(--text-sm);">📚 Source Type:</span>
                        <span style="font-weight: 500; color: var(--text-primary); font-size: var(--text-sm);">Wikipedia</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid rgba(139, 92, 246, 0.2);">
                        <span style="font-weight: 600; color: #7c3aed; font-size: var(--text-sm);">🔢 Revision ID:</span>
                        <a href="${data.provenance.permanent_url}" target="_blank" style="font-weight: 600; color: #3b82f6; font-size: var(--text-sm); text-decoration: none;">
                            ${data.provenance.revision_id} ↗
                        </a>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid rgba(139, 92, 246, 0.2);">
                        <span style="font-weight: 600; color: #7c3aed; font-size: var(--text-sm);">📄 Page ID:</span>
                        <span style="font-weight: 500; color: var(--text-primary); font-size: var(--text-sm);">${data.provenance.page_id}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0;">
                        <span style="font-weight: 600; color: #7c3aed; font-size: var(--text-sm);">⏱️ Captured:</span>
                        <span style="font-weight: 500; color: var(--text-primary); font-size: var(--text-sm);">${new Date(data.provenance.api_timestamp).toLocaleString()}</span>
                    </div>
                `;
                console.log('🔐 Provenance displayed:', data.provenance.revision_id);
            } else {
                provenanceSection.style.display = 'none';
            }
            
            // 🚨 Check for paywall/login-required content
            const paywallCheck = detectPaywall(data);
            const paywallWarningDiv = document.getElementById('paywallWarning');
            
            if (paywallCheck.detected) {
                const siteSpecific = paywallCheck.siteName ? ` for ${paywallCheck.siteName}` : '';
                paywallWarningDiv.innerHTML = `
                    <div class="paywall-warning">
                        <div class="paywall-warning-header">
                            <span>⚠️</span>
                            <span>PAYWALL DETECTED - Content May Be Incomplete</span>
                        </div>
                        <div class="paywall-warning-body">
                            <p><strong>This content appears to be behind a paywall or requires login${siteSpecific}.</strong></p>
                            <p>To archive the <strong>full article</strong>:</p>
                            <ul>
                                <li>Sign in to the website first</li>
                                <li>Return to this page and try archiving again</li>
                                <li>Or use the F12 snippet method while signed in</li>
                            </ul>
                            <p style="margin-top: 12px; font-weight: 600;">⚠️ The current archive may only contain a preview or truncated version.</p>
                        </div>
                    </div>
                `;
                paywallWarningDiv.style.display = 'block';
                console.log('🚨 Paywall detected:', paywallCheck.indicators);
            } else {
                paywallWarningDiv.style.display = 'none';
            }
            
            // Display system tags (5) and show custom tag section
            displaySystemTags(data);
            
            // Display hashes with color-coded badges and individual copy buttons
            hashesDisplay.innerHTML = `
                <div class="hash-section">
                    <div class="hash-type">📄 Content Hashes</div>
                    <div class="hash-group">
                        <div class="hash-item">
                            <span class="hash-badge hash-badge-sha256">🔵 SHA-256</span>
                            <div class="hash-value-container">
                                <div class="hash-value">${data.hashes.content.sha256}</div>
                                <button class="hash-copy-btn" onclick="copyHash('${data.hashes.content.sha256}', 'Content SHA-256')" title="Copy SHA-256">📋</button>
                            </div>
                        </div>
                        <div class="hash-item">
                            <span class="hash-badge hash-badge-blake2b">🟢 BLAKE2b</span>
                            <div class="hash-value-container">
                                <div class="hash-value">${data.hashes.content.blake2b}</div>
                                <button class="hash-copy-btn" onclick="copyHash('${data.hashes.content.blake2b}', 'Content BLAKE2b')" title="Copy BLAKE2b">📋</button>
                            </div>
                        </div>
                        <div class="hash-item">
                            <span class="hash-badge hash-badge-md5">🟡 MD5</span>
                            <div class="hash-value-container">
                                <div class="hash-value">${data.hashes.content.md5}</div>
                                <button class="hash-copy-btn" onclick="copyHash('${data.hashes.content.md5}', 'Content MD5')" title="Copy MD5">📋</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="hash-section">
                    <div class="hash-type">📝 Title Hashes</div>
                    <div class="hash-group">
                        <div class="hash-item">
                            <span class="hash-badge hash-badge-sha256">🔵 SHA-256</span>
                            <div class="hash-value-container">
                                <div class="hash-value">${data.hashes.title.sha256}</div>
                                <button class="hash-copy-btn" onclick="copyHash('${data.hashes.title.sha256}', 'Title SHA-256')" title="Copy SHA-256">📋</button>
                            </div>
                        </div>
                        <div class="hash-item">
                            <span class="hash-badge hash-badge-blake2b">🟢 BLAKE2b</span>
                            <div class="hash-value-container">
                                <div class="hash-value">${data.hashes.title.blake2b}</div>
                                <button class="hash-copy-btn" onclick="copyHash('${data.hashes.title.blake2b}', 'Title BLAKE2b')" title="Copy BLAKE2b">📋</button>
                            </div>
                        </div>
                        <div class="hash-item">
                            <span class="hash-badge hash-badge-md5">🟡 MD5</span>
                            <div class="hash-value-container">
                                <div class="hash-value">${data.hashes.title.md5}</div>
                                <button class="hash-copy-btn" onclick="copyHash('${data.hashes.title.md5}', 'Title MD5')" title="Copy MD5">📋</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="hash-section">
                    <div class="hash-type">🔐 Integrity Hashes</div>
                    <div class="hash-group">
                        <div class="hash-item">
                            <span class="hash-badge hash-badge-sha256">🔵 SHA-256</span>
                            <div class="hash-value-container">
                                <div class="hash-value">${data.hashes.integrity.sha256}</div>
                                <button class="hash-copy-btn" onclick="copyHash('${data.hashes.integrity.sha256}', 'Integrity SHA-256')" title="Copy SHA-256">📋</button>
                            </div>
                        </div>
                        <div class="hash-item">
                            <span class="hash-badge hash-badge-blake2b">🟢 BLAKE2b</span>
                            <div class="hash-value-container">
                                <div class="hash-value">${data.hashes.integrity.blake2b}</div>
                                <button class="hash-copy-btn" onclick="copyHash('${data.hashes.integrity.blake2b}', 'Integrity BLAKE2b')" title="Copy BLAKE2b">📋</button>
                            </div>
                        </div>
                        <div class="hash-item">
                            <span class="hash-badge hash-badge-md5">🟡 MD5</span>
                            <div class="hash-value-container">
                                <div class="hash-value">${data.hashes.integrity.md5}</div>
                                <button class="hash-copy-btn" onclick="copyHash('${data.hashes.integrity.md5}', 'Integrity MD5')" title="Copy MD5">📋</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // UX IMPROVEMENT: Trigger expand animation and show toast
            hashesDisplay.classList.add('expanded');
            showToast('success', 'Hashes generated successfully!');
            
            // 🎓 TEACHING: Display Content Preview
            // Show what the Hive post will look like with images embedded
            displayContentPreview(data);
            
            // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
            // 📦 MULTI-PART DETECTION (Phase 7)
            // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
            const fullPostBody = buildHivePostBody(data);
            const contentSizeKB = new Blob([fullPostBody]).size / 1024;
            console.log(`📊 Content size: ${contentSizeKB.toFixed(2)} KB`);
            
            if (window.ArcHiveMultiPart && window.ArcHiveMultiPart.needsSplitting(fullPostBody)) {
                console.log('📦 Multi-part content detected - initiating split...');
                
                // PHASE 2.1: Request notification permission on first multi-part posting
                if (Notification.permission === 'default') {
                    console.log('🔔 Requesting notification permission for multi-part posting...');
                    await requestNotificationPermission();
                }
                
                try {
                    const contentParts = window.ArcHiveMultiPart.splitContentIntoParts(fullPostBody, data.title);
                    
                    // FIX BUG #4: Extract content strings from part objects before hashing
                    // splitContentIntoParts returns objects with {content, partNumber, etc.}
                    // but hashMultiPartContent expects an array of strings
                    const contentStrings = contentParts.map(part => part.content);
                    const hashResult = await window.ArcHiveMultiPart.hashMultiPartContent(contentStrings);
                    
                    const sourceUrl = data.url || data.source;
                    const customTags = getCustomTags();
                    
                    // Create manifest FIRST to get the series_id
                    const manifest = window.ArcHiveMultiPart.createManifest({
                        sourceUrl: sourceUrl,
                        title: data.title,
                        totalParts: contentParts.length,
                        contentHashFull: hashResult.fullContentHash,
                        partHashes: hashResult.partHashes,
                        tags: []  // Will add tags below
                    });
                    
                    // FIX BUG #11: Generate system tags WITH the seriesId so SERIES tag is included
                    const systemTags = processor.generateArchiveTags(data, manifest.series_id);
                    const allTags = [...systemTags, ...customTags].slice(0, 10);
                    
                    // Update manifest with complete tags (including SERIES tag)
                    manifest.tags = allTags;
                    console.log(`📦 Multi-part manifest created with ${allTags.length} tags:`, allTags);
                    
                    window.multipartPreview = {
                        isMultiPart: true,
                        parts: contentParts,
                        manifest: manifest,
                        hashes: hashResult,
                        previewStats: {
                            totalParts: contentParts.length,
                            totalSizeKB: contentSizeKB,
                            estimatedTimeSeconds: contentParts.length * 5
                        },
                        originalData: data
                    };
                    
                    displayMultiPartPreview(window.multipartPreview);
                    console.log('✅ Multi-part preview displayed');
                } catch (error) {
                    console.error('❌ Multi-part split error:', error);
                    showNotification('⚠️ Multi-part split failed: ' + error.message);
                    window.multipartPreview = { isMultiPart: false };
                }
            } else {
                console.log('📄 Single-part content (no split needed)');
                window.multipartPreview = { isMultiPart: false };
            }
            
            resultsDiv.classList.add('show');
        }
        
        /**
         * 🎓 TEACHING: Build Complete Hive Post Body
         * Creates the full markdown post body including all cryptographic hashes and source URL
         * This ensures the blockchain post contains complete verification data
         */
        function buildHivePostBody(data, versionInfo = null) {
            const sourceUrl = data.url || data.source;
            
            // 🔧 DEBUG: Log content availability
            if (!data.content || data.content.trim() === '') {
                console.warn('⚠️ WARNING: buildHivePostBody called with empty content!');
                console.log('📊 Data structure:', {
                    hasContent: !!data.content,
                    contentLength: data.content ? data.content.length : 0,
                    title: data.title ? data.title.substring(0, 50) : 'none',
                    source: sourceUrl ? sourceUrl.substring(0, 100) : 'none'
                });
            } else {
                console.log('✅ buildHivePostBody: Content available (' + data.content.length + ' characters)');
            }
            
            // Build provenance section for Wikipedia
            let provenanceSection = '';
            if (data.provenance && data.provenance.source_type === 'wikipedia' && data.provenance.revision_id) {
                provenanceSection = `
## 🔐 Source Provenance

**This archive is cryptographically linked to the original source.**

| Field | Value |
|-------|-------|
| Wikipedia Revision | [${data.provenance.revision_id}](${data.provenance.permanent_url}) |
| Page ID | ${data.provenance.page_id} |
| Archived At | ${data.provenance.api_timestamp} |

> **Proof of Authenticity:** The revision ID above is Wikipedia's permanent, immutable identifier for the exact version of this article at the time of archiving. Click the link to verify the original source content.

`;
            }
            
            // Version info for update posts
            let versionSection = '';
            if (versionInfo) {
                versionSection = `
## 📝 Version Update

| Field | Value |
|-------|-------|
| Version | ${versionInfo.version} |
| Original Post | @${versionInfo.originalAuthor}/${versionInfo.originalPermlink} |
| Content Changed | ${versionInfo.contentChanged ? 'Yes' : 'No'} |
| Similarity | ${versionInfo.similarity}% |

`;
            }
            
            return `# ${data.title}

**Source:** ${sourceUrl}

${data.content}

---
${versionSection}${provenanceSection}
## 🔐 Cryptographic Verification

**Archived URL:** ${sourceUrl}

\`\`\`
📄 CONTENT HASHES:
  SHA-256:  ${data.hashes.content.sha256}
  BLAKE2b:  ${data.hashes.content.blake2b}
  MD5:      ${data.hashes.content.md5}

📝 TITLE HASHES:
  SHA-256:  ${data.hashes.title.sha256}
  BLAKE2b:  ${data.hashes.title.blake2b}
  MD5:      ${data.hashes.title.md5}

🔒 INTEGRITY HASHES:
  SHA-256:  ${data.hashes.integrity.sha256}
  BLAKE2b:  ${data.hashes.integrity.blake2b}
  MD5:      ${data.hashes.integrity.md5}
\`\`\`

*Archived with ArcHive - Client-side cryptographic archival system*`;
        }
        
        /**
         * 🎓 TEACHING: Content Preview Display
         * Shows users exactly what will be posted to Hive blockchain
         * Converts markdown to HTML for visual preview
         * 
         * MOBILE OPTIMIZATION:
         * - On mobile, shows teaser mode first (truncated with "Read More")
         * - Progressive disclosure for better UX on small screens
         */
        function displayContentPreview(data) {
            const previewSection = document.getElementById('contentPreviewSection');
            const previewBody = document.getElementById('contentPreviewBody');
            
            // Build the full Hive post body using shared helper
            const fullPostBody = buildHivePostBody(data);
            
            // Convert markdown to HTML for preview
            const htmlPreview = markdownToHtml(fullPostBody);
            
            previewBody.innerHTML = htmlPreview;
            previewSection.style.display = 'block';
            
            // Check if mobile
            const isMobile = window.innerWidth <= 600;
            
            if (isMobile) {
                // Mobile: Show teaser mode with "Read More" button
                previewSection.classList.add('preview-teaser');
                previewBody.style.display = 'block';
                
                // Add or update the expand button
                let expandBtn = document.getElementById('expandTeaserBtn');
                if (!expandBtn) {
                    expandBtn = document.createElement('button');
                    expandBtn.id = 'expandTeaserBtn';
                    expandBtn.className = 'expand-teaser-btn';
                    expandBtn.innerHTML = '📖 Read Full Preview';
                    expandBtn.onclick = expandMobilePreview;
                    previewSection.appendChild(expandBtn);
                }
                expandBtn.style.display = 'block';
                
                // Update header toggle text
                const toggleIcon = document.getElementById('previewToggle');
                if (toggleIcon) toggleIcon.textContent = '▲ Teaser';
            } else {
                // Desktop: Auto-expand on first extraction
                if (!previewBody.classList.contains('preview-shown')) {
                    togglePreview();
                    previewBody.classList.add('preview-shown');
                }
            }
        }
        
        /**
         * Open fullscreen modal for content preview on mobile
         * Similar to archive history details modal
         */
        function expandMobilePreview() {
            const previewBody = document.getElementById('contentPreviewBody');
            if (!previewBody) return;
            
            // Create fullscreen modal - use fixed positioning with inset for iOS compatibility
            const modal = document.createElement('div');
            modal.id = 'previewFullscreenModal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: white;
                z-index: 100000;
                display: flex;
                flex-direction: column;
                overflow: hidden;
            `;
            
            // Header with close button
            const header = document.createElement('div');
            header.style.cssText = `
                flex-shrink: 0;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                padding: 12px 16px;
                display: flex;
                justify-content: space-between;
                align-items: center;
                box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            `;
            header.innerHTML = `
                <span style="color: white; font-weight: 700; font-size: 16px;">👁️ Full Content Preview</span>
                <button onclick="closePreviewModal()" style="
                    background: rgba(255,255,255,0.2);
                    border: none;
                    color: white;
                    font-size: 24px;
                    cursor: pointer;
                    width: 44px;
                    height: 44px;
                    border-radius: 50%;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                ">✕</button>
            `;
            
            // Body with preview content - takes remaining space
            const body = document.createElement('div');
            body.style.cssText = `
                flex: 1;
                padding: 16px;
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
                font-size: 16px;
                line-height: 1.7;
                color: #1e293b;
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
            `;
            body.className = 'preview-body fullscreen-preview';
            body.innerHTML = previewBody.innerHTML;
            
            modal.appendChild(header);
            modal.appendChild(body);
            document.body.appendChild(modal);
            
            // Prevent background scrolling
            document.body.style.overflow = 'hidden';
        }
        
        /**
         * Close the fullscreen preview modal
         */
        function closePreviewModal() {
            const modal = document.getElementById('previewFullscreenModal');
            if (modal) {
                modal.remove();
                document.body.style.overflow = '';
            }
        }
        
        /**
         * 🎓 TEACHING: Simple Markdown to HTML Converter
         * Converts basic markdown syntax to HTML for visual preview
         * Styling handled by CSS classes in preview-body
         * 
         * REGRESSION FIXES:
         * 1. Added code block handling (triple backticks) - was causing hash section to disappear
         * 2. Added emoji class wrapping - was causing emojis to display too large
         */
        function markdownToHtml(markdown) {
            let html = markdown;
            
            // REGRESSION FIX #1: Code blocks (triple backticks) - must be processed BEFORE inline code
            // Bug: buildHivePostBody() creates hash section with ``` but converter didn't handle it
            // Fix: Convert code blocks to <pre><code> tags with surrounding newlines for proper paragraph separation
            // CRITICAL: Add \n\n before and after to ensure <pre> is treated as separate block in paragraph splitting
            html = html.replace(/```([\s\S]*?)```/g, function(match, code) {
                return '\n\n<pre><code>' + code.trim() + '</code></pre>\n\n';
            });
            
            // Headers (no inline styles - CSS handles it)
            html = html.replace(/^#### (.*$)/gim, '<h4>$1</h4>');
            html = html.replace(/^### (.*$)/gim, '<h3>$1</h3>');
            html = html.replace(/^## (.*$)/gim, '<h2>$1</h2>');
            html = html.replace(/^# (.*$)/gim, '<h1>$1</h1>');
            
            // Images - Convert markdown images to HTML img tags
            html = html.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, '<img src="$2" alt="$1" loading="lazy">');
            
            // Links
            html = html.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank">$1</a>');
            
            // Bold
            html = html.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
            
            // Inline code (single backticks) - processed AFTER code blocks
            html = html.replace(/`([^`]+)`/g, '<code>$1</code>');
            
            // Horizontal rules
            html = html.replace(/^---$/gim, '<hr>');
            
            // REGRESSION FIX #2: Wrap emojis in span with .emoji class for proper sizing
            // Bug: CSS targets .emoji class but converter never applied it, causing huge emojis
            // Fix: Detect emoji Unicode ranges and wrap in <span class="emoji">
            // Emoji ranges: Basic emoticons, symbols, flags, etc.
            html = html.replace(/([\u{1F300}-\u{1F9FF}\u{2600}-\u{26FF}\u{2700}-\u{27BF}\u{1F1E0}-\u{1F1FF}\u{1F900}-\u{1F9FF}\u{1FA70}-\u{1FAFF}])/gu, 
                '<span class="emoji">$1</span>');
            
            // Line breaks and paragraphs
            html = html.split('\n\n').map(para => {
                if (para.trim().startsWith('<h') || 
                    para.trim().startsWith('<hr') || 
                    para.trim().startsWith('<img') ||
                    para.trim().startsWith('<pre')) {  // Don't wrap code blocks in <p>
                    return para;
                }
                return para.trim() ? `<p>${para.replace(/\n/g, '<br>')}</p>` : '';
            }).join('\n');
            
            return html;
        }
        
        /**
         * Toggle preview visibility
         */
        function togglePreview() {
            const previewBody = document.getElementById('contentPreviewBody');
            const toggleIcon = document.getElementById('previewToggle');
            
            if (previewBody.style.display === 'none') {
                previewBody.style.display = 'block';
                toggleIcon.textContent = '▲ Hide';
            } else {
                previewBody.style.display = 'none';
                toggleIcon.textContent = '▼ Show';
            }
        }
        
        /**
         * Toggle details section visibility (tags, archive info, hashes)
         */
        function toggleDetailsSection() {
            const detailsContent = document.getElementById('detailsContent');
            const detailsToggle = document.getElementById('detailsToggle');
            
            if (detailsContent.style.display === 'none') {
                detailsContent.style.display = 'block';
                detailsToggle.textContent = '▲ Hide';
            } else {
                detailsContent.style.display = 'none';
                detailsToggle.textContent = '▼ Show';
            }
        }
        
        /**
         * Copy hash to clipboard
         */
        async function copyHash(hash, label) {
            try {
                await navigator.clipboard.writeText(hash);
                showToast('success', `${label} copied to clipboard!`);
            } catch (error) {
                // Fallback for older browsers
                const textarea = document.createElement('textarea');
                textarea.value = hash;
                textarea.style.position = 'fixed';
                textarea.style.opacity = '0';
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                showToast('success', `${label} copied to clipboard!`);
            }
        }
        
        /**
         * Copy all hashes
         */
        async function copyAllHashes() {
            if (!processor.currentData) return;
            
            const hashes = processor.currentData.hashes;
            const text = `ArcHive Multi-Algorithm Verification Hashes
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

📄 Content Hashes:
  SHA-256:  ${hashes.content.sha256}
  BLAKE2b:  ${hashes.content.blake2b}
  MD5:      ${hashes.content.md5}

📝 Title Hashes:
  SHA-256:  ${hashes.title.sha256}
  BLAKE2b:  ${hashes.title.blake2b}
  MD5:      ${hashes.title.md5}

🔐 Integrity Hashes:
  SHA-256:  ${hashes.integrity.sha256}
  BLAKE2b:  ${hashes.integrity.blake2b}
  MD5:      ${hashes.integrity.md5}

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
Generated: ${processor.currentData.timestamp}
Source: ${processor.currentData.source}
`;
            
            await copyHash(text, 'All hashes');
        }
        
        /**
         * Publish to Hive blockchain - Entry point with smart session detection
         * - If already authenticated via HAS: Post directly (no username prompt)
         * - If not authenticated: Ask for username and authenticate
         * UX IMPROVEMENT: Skip username prompt when session exists
         */
        async function postToHive() {
            // UX IMPROVEMENT: Pre-auth validation
            if (!processor.currentData) {
                showToast('error', 'No content to archive');
                return;
            }
            
            // Smart detection: Use Keychain extension if available (desktop fast path)
            if (typeof window.hive_keychain !== 'undefined') {
                console.log('🔑 Using Hive Keychain Extension');
                let username = prompt('Enter your Hive username:');
                if (!username) return;
                username = username.trim().toLowerCase().replace(/^@/, '');
                if (!username) {
                    showNotification('❌ Please enter a valid Hive username');
                    return;
                }
                await postWithKeychainExtension(username);
                return;
            }
            
            // Mobile or desktop without extension - use HAS
            console.log('📱 Using HAS (Hive Authentication Service)');
            
            // SMART SESSION CHECK: If already authenticated, post directly!
            const existingSession = getStoredHASSession();
            
            if (existingSession && existingSession.username && existingSession.key) {
                // ✅ Already authenticated - post directly without any extra prompts!
                console.log('✅ Valid HAS session found for @' + existingSession.username + ' - posting directly');
                await postWithHAS(existingSession.username);
                return;
            }
            
            // No session - need to authenticate first
            // Check HAS WebSocket connection
            if (hasWS && hasWS.readyState !== 1) {
                showToast('error', 'Not connected to HAS server. Please refresh the page.');
                return;
            }
            
            let username = prompt('Enter your Hive username:');
            if (!username) return;
            
            // CRITICAL: Normalize username for HAS/Keychain compatibility
            username = username.trim().toLowerCase().replace(/^@/, '');
            
            if (!username) {
                showNotification('❌ Please enter a valid Hive username');
                return;
            }
            
            console.log('👤 Normalized username:', username);
            console.log('🔐 No session found - starting authentication flow');
            
            try {
                await authenticateWithHAS(username);
                // Success notification already shown by authenticateWithHAS()
                // After successful auth, show post confirmation immediately
                showNotification('✅ Authenticated! Click "Post to Blockchain" again to publish.');
            } catch (error) {
                console.error('❌ Authentication failed:', error);
                showNotification('❌ Authentication failed: ' + (error.message || 'Unknown error'));
            }
        }
        
        /**
         * Post using Hive Keychain Extension (Desktop)
         */
        async function postWithKeychainExtension(username) {
            // GUARD: Prevent multiple simultaneous Keychain requests
            if (window._keychainPosting) {
                console.warn('⚠️ Keychain posting already in progress - ignoring duplicate request');
                return;
            }
            
            // Check if Keychain is available
            if (typeof window.hive_keychain === 'undefined') {
                showNotification('❌ Hive Keychain extension not installed. Install it for desktop posting.');
                return;
            }
            
            window._keychainPosting = true;
            
            // 📦 CHECK FOR MULTI-PART CONTENT FIRST
            if (window.multipartPreview && window.multipartPreview.isMultiPart) {
                console.log('📦 Multi-part content detected - showing confirmation modal');
                // FIX BUG #12: Pass transport mode and username to modal
                showMultipartConfirmModal(window.multipartPreview.parts.length, username, 'keychain');
                window._keychainPosting = false;
                return;
            }
            
            updateBlockchainButtonState('posting'); // UX: Show posting state
            
            const data = processor.currentData;
            
            // 🔧 CRITICAL VALIDATION: Ensure content exists before posting
            if (!data.content || data.content.trim() === '') {
                console.error('❌ CRITICAL: No content to post. data.content is empty or missing');
                console.log('📊 Data structure:', { 
                    hasContent: !!data.content,
                    contentLength: data.content ? data.content.length : 0,
                    hasTitle: !!data.title,
                    hasHashes: !!data.hashes
                });
                updateBlockchainButtonState('error');
                showNotification('❌ Archive incomplete: Content is empty. Please extract content again before posting.');
                window._keychainPosting = false;
                return;
            }
            
            const permlink = `archive-${Date.now()}-${Math.random().toString(36).substring(2, 8)}`;
            
            // 🔧 FIX: Truncate title to 90 characters for clean, readable posts
            let hiveTitle = data.title;
            if (hiveTitle.length > 90) {
                hiveTitle = hiveTitle.substring(0, 87) + '...';
                console.log(`⚠️ Title truncated from ${data.title.length} to 90 characters`);
            }
            
            // Build complete post body with all hashes and verification data
            const body = buildHivePostBody(data);
            console.log('📝 Post body length:', body.length, 'characters');
            console.log('📄 Content length:', data.content.length, 'characters');
            
            // 🎓 TEACHING: Hive json_metadata Best Practices
            // Including images in metadata enables:
            // - Hive feed thumbnails (improves discoverability)
            // - Visual content preservation
            // - Image verification and archival
            const metadata = {
                tags: getAllTags(data),  // 5 system tags + up to 5 custom tags
                app: 'archive-paste/1.0',
                sourceUrl: data.url || null,
                format: 'markdown',
                timestamp: new Date().toISOString(),
                clientSide: true,
                readability: true,
                images: data.images || [],
                hashes: data.hashes,
                archived_at: data.timestamp,
                image_count: data.imageCount,
                word_count: data.wordCount
            };
            
            console.log(`🖼️ Posting ${(data.images && data.images.length) || 0} images to Hive metadata`);
            console.log(`📝 Hive title (${hiveTitle.length} chars): ${hiveTitle.substring(0, 100)}...`);
            
            window.hive_keychain.requestPost(
                username,
                hiveTitle,
                body,
                'archivedcontenthaf',  // Use primary tag as parent_permlink (Hive requirement)
                '',
                JSON.stringify(metadata),
                permlink,
                '',
                (response) => {
                    window._keychainPosting = false;
                    console.log('🔍 Full Hive Keychain response:', JSON.stringify(response, null, 2));
                    
                    if (response.success) {
                        updateBlockchainButtonState('success'); // UX: Show success state
                        const ecencyUrl = `https://ecency.com/@${username}/${permlink}`;
                        console.log('✅ Hive post success:', response);
                        
                        // Extract txid from Keychain response
                        const txid = response.result?.id || response.result?.tx_id || null;
                        
                        // Update history with blockchain data
                        processor.updateHistoryWithBlockchainData(data.source, txid, username, permlink);
                        updateHistory();
                        
                        showHiveSuccessModal(username, permlink, ecencyUrl, data.hashes.content.sha256);
                    } else {
                        let errorMsg = response.message || response.error || response.msg || 'Unknown error';
                        const errorDetails = JSON.stringify(response, null, 2);
                        
                        if (errorMsg === 'assert_exception') {
                            errorMsg = `assert_exception - This usually means:\n• Title too long (was ${hiveTitle.length} chars, max 90)\n• Invalid characters in title or content\n• Check console for details`;
                        } else if (errorMsg.includes('insufficient')) {
                            errorMsg = 'Insufficient RC (Resource Credits). Wait a few minutes or power up more HIVE.';
                        } else if (errorMsg.includes('bandwidth')) {
                            errorMsg = 'Bandwidth limit exceeded. Wait a few minutes and try again.';
                        }
                        
                        console.error('❌ Hive post error details:', errorDetails);
                        updateBlockchainButtonState('error'); // UX: Show error state
                        showNotification(`❌ Hive post failed:\n\n${errorMsg}`);
                    }
                }
            );
        }
        
        /**
         * FLOW 2: POST TO HIVE (Assumes authentication already completed)
         * User clicks "Post to Hive Now" → Uses existing session → Posts to blockchain
         * If session missing/expired → shows error "Please authenticate first"
         */
        async function postWithHAS(username) {
            try {
                // 📦 CHECK FOR MULTI-PART CONTENT FIRST
                if (window.multipartPreview && window.multipartPreview.isMultiPart) {
                    console.log('📦 Multi-part content detected - showing confirmation modal');
                    // FIX BUG #12: Pass transport mode and username to modal
                    showMultipartConfirmModal(window.multipartPreview.parts.length, username, 'has');
                    return;
                }
                
                // Check for existing valid session UPFRONT - do NOT authenticate
                const session = getStoredHASSession();
                
                if (!session || session.username !== username) {
                    updateBlockchainButtonState('auto'); // UX: Reset button to "Connect Hive Account"
                    showNotification('❌ Not authenticated\n\nPlease click "🔐 Authenticate with Hive" first.');
                    console.error('❌ No valid HAS session found - user must authenticate first');
                    return;
                }
                
                console.log('✅ Using stored HAS session for @' + username);
                console.log('🔍 Session details:', { username: session.username, hasKey: !!session.key, expire: new Date(session.expire).toLocaleString() });
                console.log('🔍 Global hasAuth:', { username: hasAuth.username, hasKey: !!hasAuth.key, expire: hasAuth.expire ? new Date(hasAuth.expire).toLocaleString() : 'null' });
                console.log('📝 Proceeding to post to Hive blockchain...');
                
                const data = processor.currentData;
                
                // 🔧 CRITICAL VALIDATION: Ensure content exists before posting
                if (!data.content || data.content.trim() === '') {
                    console.error('❌ CRITICAL: No content to post. data.content is empty or missing');
                    console.log('📊 Data structure:', { 
                        hasContent: !!data.content,
                        contentLength: data.content ? data.content.length : 0,
                        hasTitle: !!data.title,
                        hasHashes: !!data.hashes
                    });
                    updateBlockchainButtonState('error');
                    showNotification('❌ Archive incomplete: Content is empty. Please extract content again before posting.');
                    return;
                }
                
                const permlink = `archive-${Date.now()}-${Math.random().toString(36).substring(2, 8)}`;
                
                let hiveTitle = data.title;
                if (hiveTitle.length > 90) {
                    hiveTitle = hiveTitle.substring(0, 87) + '...';
                }
                
                // Build complete post body with all hashes and verification data
                const body = buildHivePostBody(data);
                console.log('📝 Post body length:', body.length, 'characters');
                console.log('📄 Content length:', data.content.length, 'characters');
                
                const metadata = {
                    tags: getAllTags(data),  // 5 system tags + up to 5 custom tags
                    app: 'archive-paste/1.0',
                    sourceUrl: data.url || null,
                    format: 'markdown',
                    timestamp: new Date().toISOString(),
                    clientSide: true,
                    readability: true,
                    hasAuth: true,
                    images: data.images || [],
                    hashes: data.hashes,
                    archived_at: data.timestamp,
                    image_count: data.imageCount,
                    word_count: data.wordCount
                };
                
                const comment_op = [
                    'comment',
                    {
                        parent_author: '',
                        parent_permlink: 'archivedcontenthaf',  // Use primary tag as parent_permlink (Hive requirement)
                        author: username,
                        permlink: permlink,
                        title: hiveTitle,
                        body: body,
                        json_metadata: JSON.stringify(metadata)
                    }
                ];
                
                console.log('📡 Broadcasting with HAS (using existing session)...');
                console.log('📝 Operation:', comment_op);
                console.log('👤 Username:', username);
                console.log('🔗 Permlink:', permlink);
                updateBlockchainButtonState('posting'); // UX: Show posting state
                showNotification('📡 Publishing to Hive blockchain...');
                
                // Use the session we already have
                const result = await postToHiveWithHAS(session.username, [comment_op]);
                
                updateBlockchainButtonState('success'); // UX: Show success state
                const ecencyUrl = `https://ecency.com/@${username}/${permlink}`;
                console.log('✅ HAS post success!');
                console.log('📊 Result:', result);
                console.log('🌐 Ecency URL:', ecencyUrl);
                
                // Extract txid from HAS result
                const txid = result?.id || result?.tx_id || null;
                
                // Update history with blockchain data
                processor.updateHistoryWithBlockchainData(data.source, txid, username, permlink);
                updateHistory();
                
                showHiveSuccessModal(username, permlink, ecencyUrl, data.hashes.content.sha256);
                
            } catch (error) {
                console.error('❌ HAS post error:', error);
                
                let userMessage = error.message || 'Unknown error';
                
                if (error.message && error.message.includes('timeout')) {
                    userMessage = `⏱️ Connection timeout\n\nTroubleshooting:\n• Check your internet connection\n• Try again in a few seconds\n• Make sure you're on WiFi or have good cellular signal`;
                } else if (error.message && error.message.includes('Failed to connect')) {
                    userMessage = `🌐 Cannot connect to HAS server\n\nTroubleshooting:\n• Check your internet connection\n• Make sure you're on WiFi or cellular data\n• Firewall/VPN may be blocking WebSocket (wss://)\n• Try again in a few moments`;
                } else if (error.message && error.message.includes('declined')) {
                    userMessage = `❌ Transaction declined in Keychain Mobile app`;
                }
                
                updateBlockchainButtonState('error'); // UX: Show error state
                showNotification(`❌ Hive post failed:\n\n${userMessage}`);
            }
        }
        
        /**
         * Download archive
         */
        function downloadArchive() {
            if (!processor.currentData) {
                showNotification('❌ No content to download');
                return;
            }
            
            const modal = document.getElementById('downloadModal');
            const options = document.getElementById('downloadOptions');
            
            const data = processor.currentData;
            const timestamp = new Date(data.timestamp).toISOString().replace(/[:.]/g, '-').substring(0, 19);
            const baseFilename = `archive-${timestamp}`;
            
            options.innerHTML = `
                <button class="btn btn-full mb-sm" onclick="downloadFile('${baseFilename}.txt', getTextExport())">
                    📄 Download as Text (.txt)
                </button>
                <button class="btn btn-full mb-sm" onclick="downloadFile('${baseFilename}.md', getMarkdownExport())">
                    📝 Download as Markdown (.md)
                </button>
                <button class="btn btn-full mb-sm" onclick="downloadFile('${baseFilename}.html', getHtmlExport())">
                    🌐 Download as HTML (.html)
                </button>
                <button class="btn btn-full mb-sm" onclick="downloadFile('${baseFilename}.json', getJsonExport())">
                    📊 Download as JSON (.json)
                </button>
            `;
            
            modal.classList.add('show');
        }
        
        /**
         * Download file helper
         */
        function downloadFile(filename, content) {
            const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
            
            closeDownloadModal();
            showNotification(`✅ Downloaded: ${filename}`);
        }
        
        /**
         * Export formatters
         */
        function getTextExport() {
            const data = processor.currentData;
            return `${data.title}\n${'='.repeat(data.title.length)}\n\n${data.content}\n\n---\nArchived: ${data.timestamp}\nSource: ${data.source}\nContent Hash: ${data.hashes.content.sha256}`;
        }
        
        function getMarkdownExport() {
            const data = processor.currentData;
            return `# ${data.title}\n\n${data.content}\n\n---\n\n## Archive Metadata\n\n- **Archived:** ${data.timestamp}\n- **Source:** ${data.source}\n- **Method:** ${data.method}\n- **Words:** ${data.wordCount}\n- **SHA-256:** \`${data.hashes.content.sha256}\`\n- **BLAKE2b:** \`${data.hashes.content.blake2b}\`\n- **MD5:** \`${data.hashes.content.md5}\``;
        }
        
        function getHtmlExport() {
            const data = processor.currentData;
            return `<!DOCTYPE html>\n<html>\n<head>\n<meta charset="UTF-8">\n<title>${data.title}</title>\n<style>body{font-family:sans-serif;max-width:800px;margin:40px auto;padding:20px;line-height:1.6;}</style>\n</head>\n<body>\n<h1>${data.title}</h1>\n${data.contentHtml}\n<hr>\n<p><small>Archived: ${data.timestamp}<br>Hash: ${data.hashes.content.sha256}</small></p>\n</body>\n</html>`;
        }
        
        function getJsonExport() {
            return JSON.stringify(processor.currentData, null, 2);
        }
        
        /**
         * Update history display
         */
        function updateHistory() {
            const historyList = document.getElementById('historyList');
            
            if (processor.history.length === 0) {
                historyList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">📦</div>
                        <div>No archives yet. Start by pasting content above!</div>
                    </div>
                `;
                return;
            }
            
            historyList.innerHTML = processor.history.map((item, index) => `
                <div class="history-card" onclick="showHistoryDetails(${index})" title="Click for details">
                    <div class="history-card-title">${item.title || 'Untitled'}</div>
                    <div class="history-card-meta">
                        <span>📅 ${new Date(item.timestamp).toLocaleDateString()}</span>
                        <span>📊 ${item.wordCount || 0} words</span>
                        ${item.imageCount ? `<span>🖼️ ${item.imageCount} images</span>` : ''}
                        ${item.txid ? '<span style="color: #10b981;">⛓️ On-chain</span>' : ''}
                    </div>
                    ${item.source ? `<div style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 0.5rem; word-break: break-all;">🔗 ${item.source}</div>` : ''}
                    ${item.contentHash ? `<div class="history-card-hash">${item.contentHash}...</div>` : ''}
                </div>
            `).join('');
        }
        
        /**
         * Show history item details modal
         */
        function showHistoryDetails(index) {
            const item = processor.history[index];
            if (!item) {
                showNotification('❌ History item not found');
                return;
            }
            
            const modal = document.createElement('div');
            modal.id = 'historyDetailsModal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.8);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 100000;
                padding: 16px;
                animation: fadeIn 0.3s;
            `;
            
            const isOnChain = !!item.txid || !!item.author;
            
            const content = document.createElement('div');
            content.style.cssText = `
                background: white;
                border-radius: 20px;
                padding: 24px;
                max-width: 600px;
                width: 100%;
                max-height: 90vh;
                overflow-y: auto;
                box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
            `;
            
            content.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="margin: 0; font-size: 20px; font-weight: 700;">📋 Archive Details</h2>
                    <button onclick="document.getElementById('historyDetailsModal').remove()" style="
                        background: transparent;
                        border: none;
                        font-size: 28px;
                        cursor: pointer;
                        color: #64748b;
                        width: 44px;
                        height: 44px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                    ">×</button>
                </div>
                
                <div style="background: #f8fafc; border-radius: 12px; padding: 16px; margin-bottom: 16px;">
                    <h3 style="margin: 0 0 8px 0; font-size: 16px; color: #0f172a; word-break: break-word;">${item.title || 'Untitled'}</h3>
                    <div style="font-size: 14px; color: #64748b;">
                        <div style="margin: 4px 0;">📅 Archived: ${new Date(item.timestamp).toLocaleString()}</div>
                        <div style="margin: 4px 0;">📊 ${item.wordCount || 0} words${item.imageCount ? ` • 🖼️ ${item.imageCount} images` : ''}</div>
                        <div style="margin: 4px 0;">📂 Method: ${item.method || 'Unknown'}</div>
                    </div>
                </div>
                
                ${item.source ? `
                <div style="background: #f0f9ff; border-radius: 12px; padding: 16px; margin-bottom: 16px;">
                    <div style="font-size: 13px; color: #0369a1; font-weight: 600; margin-bottom: 6px;">🔗 SOURCE URL</div>
                    <div style="font-size: 14px; color: #0c4a6e; word-break: break-all;">
                        <a href="${item.source}" target="_blank" style="color: #0284c7; text-decoration: none;">${item.source}</a>
                    </div>
                </div>
                ` : ''}
                
                ${item.fullHash ? `
                <div style="background: #f0fdf4; border-radius: 12px; padding: 16px; margin-bottom: 16px;">
                    <div style="font-size: 13px; color: #15803d; font-weight: 600; margin-bottom: 6px;">🔐 SHA-256 CONTENT HASH</div>
                    <div style="font-family: monospace; font-size: 12px; color: #166534; word-break: break-all; background: #dcfce7; padding: 10px; border-radius: 8px;">
                        ${item.fullHash}
                    </div>
                    <button onclick="navigator.clipboard.writeText('${item.fullHash}').then(() => showNotification('✅ Hash copied!'))" style="
                        margin-top: 8px;
                        background: #10b981;
                        color: white;
                        border: none;
                        border-radius: 8px;
                        padding: 8px 16px;
                        font-size: 13px;
                        cursor: pointer;
                        font-weight: 600;
                    ">📋 Copy Hash</button>
                </div>
                ` : ''}
                
                ${isOnChain ? `
                <div style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border: 2px solid #f59e0b; border-radius: 12px; padding: 16px; margin-bottom: 16px;">
                    <div style="font-size: 13px; color: #92400e; font-weight: 600; margin-bottom: 10px;">⛓️ BLOCKCHAIN RECORD</div>
                    <div style="font-size: 14px; color: #78350f;">
                        <div style="margin: 6px 0;">👤 Author: <strong>@${item.author || 'Unknown'}</strong></div>
                        ${item.permlink ? `<div style="margin: 6px 0;">🔗 Permlink: <span style="font-family: monospace; font-size: 12px;">${item.permlink}</span></div>` : ''}
                        ${item.txid ? `<div style="margin: 6px 0;">📝 TX ID: <span style="font-family: monospace; font-size: 11px; word-break: break-all;">${item.txid}</span></div>` : ''}
                    </div>
                    <div style="display: flex; gap: 8px; flex-wrap: wrap; margin-top: 12px;">
                        ${item.ecencyUrl ? `<a href="${item.ecencyUrl}" target="_blank" style="
                            background: white;
                            color: #059669;
                            border: 2px solid #059669;
                            border-radius: 8px;
                            padding: 8px 16px;
                            font-size: 13px;
                            cursor: pointer;
                            font-weight: 600;
                            text-decoration: none;
                        ">🌐 View on Ecency</a>` : ''}
                        ${item.hivescanTxUrl ? `<a href="${item.hivescanTxUrl}" target="_blank" style="
                            background: white;
                            color: #0369a1;
                            border: 2px solid #0369a1;
                            border-radius: 8px;
                            padding: 8px 16px;
                            font-size: 13px;
                            cursor: pointer;
                            font-weight: 600;
                            text-decoration: none;
                        ">🔍 View Transaction</a>` : ''}
                    </div>
                </div>
                ` : `
                <div style="background: #f1f5f9; border-radius: 12px; padding: 16px; margin-bottom: 16px; text-align: center;">
                    <div style="font-size: 14px; color: #64748b;">
                        ℹ️ This archive has not been posted to Hive blockchain yet.
                    </div>
                </div>
                `}
                
                <div style="border-top: 1px solid #e2e8f0; padding-top: 16px; margin-top: 8px;">
                    <div style="font-size: 13px; color: #64748b; font-weight: 600; margin-bottom: 12px;">📥 ACTIONS</div>
                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                        ${!isOnChain ? `<button onclick="postHistoryItemToBlockchain(${index}); document.getElementById('historyDetailsModal').remove();" style="
                            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                            color: white;
                            border: none;
                            border-radius: 8px;
                            padding: 10px 20px;
                            font-size: 14px;
                            cursor: pointer;
                            font-weight: 600;
                            min-height: 44px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                        ">⛓️ Post to Chain</button>` : ''}
                        ${isOnChain ? `<button onclick="downloadHTS(${index})" style="
                            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
                            color: white;
                            border: none;
                            border-radius: 8px;
                            padding: 10px 20px;
                            font-size: 14px;
                            cursor: pointer;
                            font-weight: 600;
                            min-height: 44px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                        ">🏆 Download .hts Certificate</button>` : ''}
                        <button onclick="downloadHistoryItemAsJson(${index})" style="
                            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
                            color: white;
                            border: none;
                            border-radius: 8px;
                            padding: 10px 20px;
                            font-size: 14px;
                            cursor: pointer;
                            font-weight: 600;
                            min-height: 44px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                        ">📄 Download Metadata</button>
                    </div>
                </div>
            `;
            
            modal.appendChild(content);
            document.body.appendChild(modal);
            
            modal.addEventListener('click', (e) => {
                if (e.target === modal) modal.remove();
            });
        }
        
        /**
         * Download .hts (Hive Timestamp) certificate for a history item
         */
        function downloadHTS(index) {
            const item = processor.history[index];
            if (!item) {
                showNotification('❌ History item not found');
                return;
            }
            
            if (!item.txid && !item.author) {
                showNotification('❌ This archive is not on the blockchain yet');
                return;
            }
            
            const htsCertificate = {
                hash: item.fullHash || item.contentHash || null,
                filename: `${(item.title || 'archive').replace(/[^a-zA-Z0-9\s]/g, '').substring(0, 50).trim()}.archive`,
                user: item.author || null,
                txid: item.txid || null,
                network: "Hive",
                signed_at: item.timestamp,
                explorer: item.hivescanTxUrl || (item.txid ? `https://hivescan.info/tx/${item.txid}` : null),
                ecency_url: item.ecencyUrl || null,
                permlink: item.permlink || null,
                source_url: item.source || null,
                word_count: item.wordCount || 0,
                image_count: item.imageCount || 0
            };
            
            const filename = `${(item.title || 'archive').replace(/[^a-zA-Z0-9\s]/g, '').substring(0, 30).trim()}-${Date.now()}.hts`;
            const content = JSON.stringify(htsCertificate, null, 2);
            
            const blob = new Blob([content], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
            
            showNotification(`✅ Downloaded: ${filename}`);
            
            const modal = document.getElementById('historyDetailsModal');
            if (modal) modal.remove();
        }
        
        /**
         * Download a single history item as JSON metadata
         */
        function downloadHistoryItemAsJson(index) {
            const item = processor.history[index];
            if (!item) {
                showNotification('❌ History item not found');
                return;
            }
            
            const filename = `${(item.title || 'archive').replace(/[^a-zA-Z0-9\s]/g, '').substring(0, 30).trim()}-metadata.json`;
            const content = JSON.stringify(item, null, 2);
            
            const blob = new Blob([content], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
            
            showNotification(`✅ Downloaded: ${filename}`);
            
            const modal = document.getElementById('historyDetailsModal');
            if (modal) modal.remove();
        }
        
        /**
         * Post a history item to Hive blockchain
         * Reconstructs the content from history and initiates posting
         */
        async function postHistoryItemToBlockchain(index) {
            const item = processor.history[index];
            if (!item) {
                showToast('error', 'History item not found');
                return;
            }
            
            if (item.txid || item.author) {
                showToast('error', 'This archive has already been posted to blockchain');
                return;
            }
            
            // Reconstruct processor.currentData from history item with ALL required fields
            processor.currentData = {
                content: item.content || '',
                title: item.title || '',
                source: item.source || '',
                url: item.source || '',
                timestamp: item.timestamp,
                wordCount: item.wordCount || 0,
                imageCount: item.imageCount || 0,
                method: item.method || 'history',
                images: item.images || [],
                // CRITICAL: Include hashes for buildHivePostBody to work!
                hashes: {
                    content: {
                        sha256: item.fullHash || item.contentHash || '',
                        blake2b: item.blake2b || '',
                        md5: item.md5 || ''
                    },
                    title: {
                        sha256: item.titleSha256 || '',
                        blake2b: item.titleBlake2b || '',
                        md5: item.titleMd5 || ''
                    },
                    integrity: {
                        sha256: item.integritySha256 || '',
                        blake2b: item.integrityBlake2b || '',
                        md5: item.integrityMd5 || ''
                    }
                }
            };
            
            // Also set multipart if needed
            if (item.multipartInfo) {
                window.multipartPreview = item.multipartInfo;
            }
            
            console.log('📂 Loaded history item for posting:', item.title);
            console.log('🔐 Content hash:', item.fullHash || item.contentHash);
            console.log('✅ processor.currentData reconstructed with hashes');
            
            // Initiate the posting flow
            await postToHive();
        }
        
        /**
         * Download full history as JSON
         */
        function downloadFullHistory() {
            if (processor.history.length === 0) {
                showNotification('❌ No history to download');
                return;
            }
            
            const exportData = {
                exported_at: new Date().toISOString(),
                total_archives: processor.history.length,
                archives: processor.history
            };
            
            const filename = `archivehive-history-${new Date().toISOString().split('T')[0]}.json`;
            const content = JSON.stringify(exportData, null, 2);
            
            const blob = new Blob([content], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
            
            showNotification(`✅ Downloaded: ${filename} (${processor.history.length} archives)`);
        }
        
        /**
         * Load archive from history (disabled - history now only stores metadata)
         */
        function loadFromHistory(index) {
            // History now only stores lightweight metadata, not full content
            // This function is kept for compatibility but does nothing
            console.log('ℹ️ History only stores metadata - full content not available');
        }
        
        /**
         * Clear history
         */
        function clearHistory() {
            if (!confirm('Clear all archive history?')) return;
            
            processor.clearHistory();
            updateHistory();
            showNotification('🗑️ History cleared');
        }
        
        /**
         * Close download modal
         */
        function closeDownloadModal() {
            document.getElementById('downloadModal').classList.remove('show');
        }
        
        /**
         * Show post confirmation modal
         */
        function showPostConfirmModal(username) {
            document.getElementById('confirmUsername').textContent = `Posting as @${username}`;
            document.getElementById('postConfirmModal').classList.add('show');
        }
        
        /**
         * Close post confirmation modal
         */
        function closePostConfirmModal() {
            document.getElementById('postConfirmModal').classList.remove('show');
        }
        
        /**
         * Custom tags array
         * - Single-part content: up to 5 custom tags
         * - Multi-part content: up to 4 custom tags (makes room for SERIES tag)
         */
        let customTags = [];
        
        /**
         * Track current content type (for custom tag limit calculation)
         */
        let currentSeriesId = null;  // Phase 5: null for single-part, UUID for multi-part
        
        /**
         * Get all tags for Hive posting
         * - Single-part: 5 system tags + up to 5 custom tags = max 10 total
         * - Multi-part: 6 system tags (incl. SERIES) + up to 4 custom tags = max 10 total
         * 
         * @param {Object} data - Archive data object
         * @param {string} seriesId - Optional series_id for multi-part content (Phase 5)
         * @returns {Array<string>} - Array of tags (max 10)
         */
        function getAllTags(data, seriesId = null) {
            // Generate system tags (5 for single-part, 6 for multi-part with SERIES tag)
            const systemTags = processor.generateArchiveTags(data, seriesId);
            
            // Calculate max custom tags based on content type
            // Multi-part content (6 system tags) allows 4 custom tags
            // Single-part content (5 system tags) allows 5 custom tags
            const maxCustomTags = seriesId ? 4 : 5;
            
            // Combine system tags with custom tags
            // Ensure no duplicates and max 10 tags total (Hive limit)
            const allTags = [...systemTags];
            
            for (const customTag of customTags) {
                if (allTags.length >= 10) break; // Hive max
                if (!allTags.includes(customTag)) {
                    allTags.push(customTag);
                }
            }
            
            console.log(`🏷️ Final tags (${allTags.length}/10):`, allTags);
            console.log(`   └─ System: ${systemTags.length} tags - ${systemTags.join(', ')}`);
            console.log(`   └─ Custom: ${customTags.length}/${maxCustomTags} tags - ${customTags.join(', ') || 'none'}`);
            console.log(`   └─ Content type: ${seriesId ? 'Multi-part (6 system + 4 custom max)' : 'Single-part (5 system + 5 custom max)'}`);
            
            return allTags;
        }
        
        /**
         * Display system tags (5-6) in the tags section
         * - Single-part: 5 system tags
         * - Multi-part: 6 system tags (including SERIES tag)
         * 
         * @param {Object} data - Archive data object
         * @param {string} seriesId - Optional series_id for multi-part content (Phase 5)
         */
        function displaySystemTags(data, seriesId = null) {
            const tagsSection = document.getElementById('tagsSection');
            const systemTagsDiv = document.getElementById('systemTags');
            
            // Update current series ID (used by addCustomTag to enforce correct limit)
            currentSeriesId = seriesId;
            
            // Generate system tags (5 for single-part, 6 for multi-part)
            const tags = processor.generateArchiveTags(data, seriesId);
            
            // Display system tags
            systemTagsDiv.innerHTML = tags.map(tag => `
                <span style="background: rgba(255,255,255,0.2); color: white; padding: 6px 12px; border-radius: 20px; font-size: 13px; font-weight: 600; border: 2px solid rgba(255,255,255,0.3);">
                    ${tag}
                </span>
            `).join('');
            
            // Show the tags section
            tagsSection.style.display = 'block';
            
            // Reset custom tags for new archive
            customTags = [];
            renderCustomTags();
        }
        
        /**
         * Add a custom tag
         * Phase 5: Enforces correct limit based on content type
         * - Single-part: max 5 custom tags
         * - Multi-part: max 4 custom tags (makes room for SERIES tag)
         */
        function addCustomTag() {
            // Calculate max custom tags based on content type (Phase 5)
            const maxCustomTags = currentSeriesId ? 4 : 5;
            const contentType = currentSeriesId ? 'multi-part' : 'single-part';
            
            if (customTags.length >= maxCustomTags) {
                showToast('warning', `Maximum ${maxCustomTags} custom tags allowed for ${contentType} content`);
                return;
            }
            
            const tag = prompt(`Enter a custom tag (${customTags.length}/${maxCustomTags} used):\n\nLowercase, no spaces, use hyphens.\nExamples: bitcoin, tutorial, breaking-news, ai-research`);
            
            if (!tag) return;
            
            // Sanitize tag for Hive (lowercase, alphanumeric + hyphens only, 2-24 chars)
            const sanitized = tag.toLowerCase()
                .replace(/[^a-z0-9-]/g, '')
                .substring(0, 24);
            
            if (sanitized.length < 2) {
                showToast('error', 'Tag must be at least 2 characters');
                return;
            }
            
            // Check for duplicates
            if (customTags.includes(sanitized)) {
                showToast('warning', 'Tag already added');
                return;
            }
            
            customTags.push(sanitized);
            renderCustomTags();
            showToast('success', `Added tag: ${sanitized} (${customTags.length}/${maxCustomTags})`);
        }
        
        /**
         * Remove a custom tag
         */
        function removeCustomTag(index) {
            const removed = customTags.splice(index, 1)[0];
            renderCustomTags();
            showToast('info', `Removed tag: ${removed}`);
        }
        
        /**
         * Render custom tags display
         */
        function renderCustomTags() {
            const customTagsDiv = document.getElementById('customTags');
            const addBtn = document.getElementById('addTagBtn');
            
            customTagsDiv.innerHTML = customTags.map((tag, index) => `
                <span style="background: white; color: #667eea; padding: 6px 12px; border-radius: 20px; font-size: 13px; font-weight: 600; display: flex; align-items: center; gap: 6px;">
                    ${tag}
                    <button onclick="removeCustomTag(${index})" style="background: none; border: none; color: #667eea; cursor: pointer; font-size: 16px; padding: 0; margin: 0; line-height: 1; opacity: 0.7; transition: opacity 0.2s;" title="Remove tag">×</button>
                </span>
            `).join('');
            
            // Hide add button if at max tags
            addBtn.style.display = customTags.length >= 5 ? 'none' : 'flex';
        }
        
        /**
         * Show notification
         */
        function showNotification(message) {
            // Create toast notification
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                bottom: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: #1e293b;
                color: white;
                padding: 16px 24px;
                border-radius: 12px;
                box-shadow: 0 10px 40px rgba(0,0,0,0.3);
                z-index: 10000;
                font-size: 14px;
                max-width: 90vw;
                text-align: center;
            `;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transition = 'opacity 0.3s';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }
        
        /**
         * UX IMPROVEMENT: Show Toast Notification
         * Enhanced toast system with types and icons
         */
        function showToast(type, message) {
            const toastHost = document.getElementById('toastHost');
            if (!toastHost) return;
            
            const icons = {
                success: '✅',
                error: '❌',
                info: 'ℹ️',
                warning: '⚠️'
            };
            
            const toast = document.createElement('div');
            toast.className = `toast toast--${type}`;
            toast.innerHTML = `
                <div class="toast-icon">${icons[type] || icons.info}</div>
                <div class="toast-message">${message}</div>
            `;
            
            toastHost.appendChild(toast);
            
            setTimeout(() => {
                toast.classList.add('toast-exit');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }
        
        /* ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
         * MULTI-PART POSTING UI FUNCTIONS (Phase 7)
         * ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ */
        
        /**
         * Display Multi-Part Preview (Summary Card + Part Table)
         */
        function displayMultiPartPreview(previewData) {
            const summaryDiv = document.getElementById('multipartSummary');
            const tableDiv = document.getElementById('multipartPreviewTable');
            
            if (!previewData || !previewData.isMultiPart) {
                summaryDiv.style.display = 'none';
                tableDiv.style.display = 'none';
                return;
            }
            
            const { parts, manifest, hashes, previewStats } = previewData;
            
            // Extract ALL 6 mandatory tags (not just series tag)
            const allTags = manifest.tags || [];
            const seriesTag = allTags.find(t => t.startsWith('SERIES')) || '';
            const primaryTag = 'archivedcontenthaf';
            const otherTags = allTags.filter(t => t !== primaryTag && !t.startsWith('SERIES'));
            
            // Build tag badges HTML
            const tagBadgesHtml = `
                <div style="margin-top: var(--spacing-md);">
                    <div style="color: #0c4a6e; font-size: 13px; font-weight: 700; margin-bottom: 8px;">
                        🏷️ Smart Discovery Tags (6 mandatory):
                    </div>
                    <div style="display: flex; flex-wrap: wrap; gap: 6px;">
                        <span style="background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 700; border: 2px solid rgba(59,130,246,0.5);">
                            ${primaryTag}
                        </span>
                        ${otherTags.map(tag => `
                            <span style="background: rgba(59,130,246,0.1); color: #1e40af; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 600; border: 1px solid rgba(59,130,246,0.3);">
                                ${tag}
                            </span>
                        `).join('')}
                        ${seriesTag ? `
                            <span style="background: linear-gradient(135deg, #10b981, #059669); color: white; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 700; border: 2px solid rgba(16,185,129,0.5);">
                                ${seriesTag}
                            </span>
                        ` : ''}
                    </div>
                    <div style="color: #64748b; font-size: 11px; margin-top: 6px; font-style: italic;">
                        💡 Link Explorer uses these tags to find all parts of this series
                    </div>
                </div>
            `;
            
            summaryDiv.innerHTML = `
                <div class="multipart-summary-card">
                    <div class="multipart-summary-header">
                        <span>📊</span>
                        <span>Multi-Part Content Detected</span>
                    </div>
                    
                    <div class="multipart-summary-stats">
                        <div class="multipart-stat-item">
                            <div class="multipart-stat-label">Total Parts</div>
                            <div class="multipart-stat-value">${previewStats.totalParts}</div>
                        </div>
                        <div class="multipart-stat-item">
                            <div class="multipart-stat-label">Total Size</div>
                            <div class="multipart-stat-value">${previewStats.totalSizeKB.toFixed(1)} KB</div>
                        </div>
                        <div class="multipart-stat-item">
                            <div class="multipart-stat-label">Est. Time</div>
                            <div class="multipart-stat-value">~${previewStats.estimatedTimeSeconds}s</div>
                        </div>
                    </div>
                    
                    ${tagBadgesHtml}
                    
                    <div class="multipart-info-text">
                        📊 <strong>Posting Strategy:</strong> Part 1 (root post) + Parts 2-${previewStats.totalParts} (threaded replies)<br>
                        <span style="color: #059669; font-weight: 600;">✨ Benefit:</span> This bypasses Hive's 5-minute rate limit (~${previewStats.estimatedTimeSeconds} seconds total)
                    </div>
                </div>
            `;
            
            const tableRows = parts.map((part, index) => {
                const partNumber = index + 1;
                
                // FIX BUG #13: Extract content from part object (not string)
                const partContent = typeof part === 'string' ? part : (part.content || '');
                
                const sizeKB = (new Blob([partContent]).size / 1024).toFixed(1);
                const wordCount = partContent.split(/\s+/).length;
                const preview = partContent.length > 100 ? 
                    `${partContent.substring(0, 50)}...${partContent.substring(partContent.length - 50)}` :
                    partContent;
                
                // FIX BUG #13: Extract SHA-256 from hash object (not string)
                const partHashObj = hashes.partHashes[index];
                const hashPreview = typeof partHashObj === 'string' ? 
                    partHashObj.substring(0, 8) : 
                    (partHashObj.sha256 || '').substring(0, 8);
                
                return `
                    <tr>
                        <td><span class="multipart-part-number">${partNumber}</span></td>
                        <td>${sizeKB} KB</td>
                        <td>${wordCount.toLocaleString()}</td>
                        <td><div class="multipart-split-preview" title="${escapeHtml(preview)}">${escapeHtml(preview)}</div></td>
                        <td><code class="multipart-hash-preview">${hashPreview}...</code></td>
                        <td>
                            <button class="multipart-expand-btn" onclick="togglePartExcerpt(${index})">
                                <span id="expand-icon-${index}">▼</span> Expand
                            </button>
                        </td>
                    </tr>
                    <tr id="excerpt-row-${index}" style="display: none;">
                        <td colspan="6">
                            <div class="multipart-part-excerpt" id="excerpt-${index}">
${escapeHtml(partContent)}
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
            
            tableDiv.innerHTML = `
                <div class="multipart-table-container">
                    <table class="multipart-table">
                        <thead>
                            <tr>
                                <th>Part #</th>
                                <th>Size (KB)</th>
                                <th>Words</th>
                                <th>Split Preview</th>
                                <th>Hash Preview</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${tableRows}
                        </tbody>
                    </table>
                </div>
            `;
            
            summaryDiv.style.display = 'block';
            tableDiv.style.display = 'block';
        }
        
        /**
         * Toggle Part Excerpt Visibility
         */
        function togglePartExcerpt(index) {
            const excerptRow = document.getElementById(`excerpt-row-${index}`);
            const icon = document.getElementById(`expand-icon-${index}`);
            
            if (excerptRow.style.display === 'none') {
                excerptRow.style.display = 'table-row';
                icon.textContent = '▲';
            } else {
                excerptRow.style.display = 'none';
                icon.textContent = '▼';
            }
        }
        
        /**
         * Show Multi-Part Confirmation Modal
         * FIX BUG #10 & #12: Accept username and transport mode, wire button dynamically
         */
        function showMultipartConfirmModal(partCount, username, transportMode) {
            if (!window.multipartPreview || !window.multipartPreview.isMultiPart) {
                console.error('No multi-part preview data found');
                return;
            }
            
            const modal = document.getElementById('multipartConfirmModal');
            const partCountSpan = document.getElementById('multipartConfirmPartCount');
            const partCountInfoSpan = document.getElementById('multipartConfirmPartCountInfo');
            const postBtn = document.getElementById('multipartConfirmPostBtn');
            
            partCountSpan.textContent = partCount;
            if (partCountInfoSpan) partCountInfoSpan.textContent = partCount;
            postBtn.disabled = false; // Button enabled by default (no checkbox needed)
            
            // FIX BUG #10: Wire button onclick dynamically (no hardcoded HTML onclick)
            postBtn.onclick = async () => {
                closeMultipartConfirmModal();
                console.log(`🚀 Starting multi-part posting with ${transportMode} for @${username}`);
                await postMultiPartSeries(username, transportMode);
            };
            
            modal.style.display = 'flex';
            console.log(`📋 Multi-part confirmation modal shown (${partCount} parts, ${transportMode} transport)`);
        }
        
        /**
         * Close Multi-Part Confirmation Modal
         */
        function closeMultipartConfirmModal() {
            const modal = document.getElementById('multipartConfirmModal');
            modal.style.display = 'none';
        }
        
        /**
         * Toggle Multi-Part Confirmation Checkbox
         */
        function toggleMultipartConfirmCheckbox() {
            const checkbox = document.getElementById('multipartConfirmCheckbox');
            const postBtn = document.getElementById('multipartConfirmPostBtn');
            
            checkbox.checked = !checkbox.checked;
            postBtn.disabled = !checkbox.checked;
        }
        
        /**
         * Post Multi-Part Series - Main Orchestrator
         */
        async function postMultiPartSeries(username, authMethod) {
            if (!window.multipartPreview || !window.multipartPreview.isMultiPart) {
                showToast('error', 'No multi-part content to post');
                return;
            }
            
            const { parts, manifest } = window.multipartPreview;
            
            console.log(`📦 Starting multi-part posting (${parts.length} parts) via ${authMethod}`);
            
            const transportFunction = authMethod === 'keychain' ? 
                postToHiveKeychain : 
                postToHiveHAS;
            
            try {
                const pipeline = new window.ArcHiveMultiPart.HivePostingPipeline({
                    manifest: manifest,
                    contentParts: parts,
                    progressCallback: handleMultiPartProgress,
                    transportFunction: transportFunction,
                    author: username
                });
                
                window.currentMultipartPipeline = pipeline;
                
                // PHASE 2.2: Track active posting for beforeunload notification
                window.activeMultiPartPosting = {
                    series_id: manifest.series_id,
                    manifest: manifest,
                    startTime: Date.now()
                };
                
                showMultiPartProgress(manifest.total_parts);
                
                const result = await pipeline.start();
                
                // Clear active posting tracker
                window.activeMultiPartPosting = null;
                
                if (result.success) {
                    console.log('🎉 All parts posted successfully!');
                    showMultiPartSuccess(result.manifest);
                } else {
                    console.error('❌ Multi-part posting failed:', result.reason);
                    showMultiPartFailure(result);
                }
                
            } catch (error) {
                console.error('💥 Multi-part posting error:', error);
                showToast('error', 'Multi-part posting failed: ' + error.message);
                hideMultiPartProgress();
                
                // Clear active posting tracker on error
                window.activeMultiPartPosting = null;
            }
        }
        
        /**
         * Transport Function: Post to Hive via Keychain
         * Uses requestBroadcast for full control over operation parameters
         */
        async function postToHiveKeychain(payload) {
            return new Promise((resolve, reject) => {
                // Build the comment operation with all required fields
                const operations = [[
                    'comment',
                    {
                        parent_author: payload.parent_author || '',
                        parent_permlink: payload.parent_permlink,
                        author: payload.author,
                        permlink: payload.permlink,
                        title: payload.title,
                        body: payload.body,
                        json_metadata: JSON.stringify(payload.json_metadata)
                    }
                ]];
                
                window.hive_keychain.requestBroadcast(
                    payload.author,
                    operations,
                    'Posting',
                    (response) => {
                        if (response.success) {
                            console.log('✅ Keychain broadcast successful:', response.result);
                            resolve({
                                success: true,
                                permlink: payload.permlink,
                                author: payload.author
                            });
                        } else {
                            reject(new Error(response.message || 'Keychain posting failed'));
                        }
                    }
                );
            });
        }
        
        /**
         * Transport Function: Post to Hive via HAS
         */
        async function postToHiveHAS(payload) {
            const session = getStoredHASSession();
            if (!session) {
                throw new Error('No HAS session found');
            }
            
            const operations = [{
                type: 'comment',
                params: {
                    parent_author: payload.parent_author || '',
                    parent_permlink: payload.parent_permlink,
                    author: payload.author,
                    permlink: payload.permlink,
                    title: payload.title,
                    body: payload.body,
                    json_metadata: JSON.stringify(payload.json_metadata)
                }
            }];
            
            const result = await postToHiveWithHAS(payload.author, operations);
            
            return {
                success: true,
                permlink: payload.permlink,
                author: payload.author
            };
        }
        
        /**
         * Handle Multi-Part Progress Callbacks
         */
        function handleMultiPartProgress(progress) {
            console.log('📊 Progress:', progress);
            
            const { phase, partNumber, totalParts, status, message, remainingSeconds } = progress;
            
            // Pass extra data for cooldown countdown
            const extraData = {};
            if (status === 'cooldown') {
                extraData.remainingSeconds = progress.cooldownRemaining;
                extraData.totalSeconds = progress.cooldownTotal || 20;
            }
            
            updateMultiPartProgressUI(partNumber, totalParts, status, message, extraData);
            
            if (phase === 'SUCCESS') {
                hideMultiPartProgress();
            }
        }
        
        /**
         * Show Multi-Part Progress UI
         */
        function showMultiPartProgress(totalParts) {
            const container = document.getElementById('multipartProgressContainer');
            const resultsDiv = document.getElementById('results');
            
            const partItems = Array.from({ length: totalParts }, (_, i) => {
                const partNum = i + 1;
                return `
                    <li class="multipart-progress-item pending" id="progress-item-${partNum}">
                        <span class="multipart-progress-icon" id="progress-icon-${partNum}">⏳</span>
                        <span class="multipart-progress-text" id="progress-text-${partNum}">Part ${partNum}: Pending</span>
                    </li>
                `;
            }).join('');
            
            container.innerHTML = `
                <div class="multipart-progress-container">
                    <div class="multipart-progress-header">Posting Multi-Part Content</div>
                    
                    <div class="multipart-progress-bar-container">
                        <div class="multipart-progress-bar" id="multipartProgressBar" style="width: 0%;">
                            <span id="multipartProgressText">0%</span>
                        </div>
                    </div>
                    
                    <ul class="multipart-progress-list">
                        ${partItems}
                    </ul>
                    
                    <button class="multipart-cancel-btn" onclick="cancelMultipartPosting()">
                        🚫 Cancel Posting
                    </button>
                </div>
            `;
            
            container.style.display = 'block';
            resultsDiv.style.display = 'none';
            
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        
        /**
         * Update Multi-Part Progress UI
         */
        function updateMultiPartProgressUI(partNumber, totalParts, status, message, extraData = {}) {
            const progressBar = document.getElementById('multipartProgressBar');
            const progressText = document.getElementById('multipartProgressText');
            const item = document.getElementById(`progress-item-${partNumber}`);
            const icon = document.getElementById(`progress-icon-${partNumber}`);
            const text = document.getElementById(`progress-text-${partNumber}`);
            
            if (!progressBar || !item) return;
            
            const percentage = Math.round((partNumber / totalParts) * 100);
            progressBar.style.width = `${percentage}%`;
            progressText.textContent = `${percentage}%`;
            
            item.className = 'multipart-progress-item';
            
            switch (status) {
                case 'in_progress':
                case 'posting':
                    item.classList.add('posting');
                    icon.textContent = '🔄';
                    text.textContent = `Part ${partNumber}: Posting now...`;
                    break;
                case 'posted':
                    item.classList.add('posted');
                    icon.textContent = '✅';
                    text.textContent = `Part ${partNumber}: Posted successfully`;
                    break;
                case 'cooldown':
                    // Handle cooldown countdown timer with progress bar
                    item.classList.add('posted');
                    icon.textContent = '✅';
                    const remainingSeconds = extraData.remainingSeconds || 20;
                    const totalSeconds = extraData.totalSeconds || 20;
                    const nextPartNumber = partNumber + 1;
                    
                    if (nextPartNumber <= totalParts) {
                        // Calculate progress percentage (inverted - starts at 100%, goes to 0%)
                        const cooldownProgress = (remainingSeconds / totalSeconds) * 100;
                        
                        // Create countdown progress bar HTML
                        const countdownBarHTML = `
                            <div style="margin-top: 8px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                                    <span style="font-size: 0.9em; color: #6b7280;">Hive cooldown before Part ${nextPartNumber}:</span>
                                    <span style="font-size: 1.1em; font-weight: bold; color: #3b82f6;">${remainingSeconds}s</span>
                                </div>
                                <div style="width: 100%; height: 24px; background: #e5e7eb; border-radius: 12px; overflow: hidden; box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);">
                                    <div style="height: 100%; background: linear-gradient(90deg, #3b82f6 0%, #60a5fa 100%); width: ${cooldownProgress}%; transition: width 1s linear; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 0.85em;">
                                        ${remainingSeconds > 0 ? `${remainingSeconds}s remaining` : ''}
                                    </div>
                                </div>
                            </div>
                        `;
                        
                        text.innerHTML = `✅ Part ${partNumber} posted successfully${countdownBarHTML}`;
                    } else {
                        text.textContent = `Part ${partNumber}: Posted successfully`;
                    }
                    break;
                case 'failed':
                    item.classList.add('failed');
                    icon.textContent = '❌';
                    text.textContent = `Part ${partNumber}: Failed`;
                    break;
                default:
                    item.classList.add('pending');
                    icon.textContent = '⏳';
                    text.textContent = `Part ${partNumber}: Pending`;
            }
        }
        
        /**
         * Hide Multi-Part Progress UI
         */
        function hideMultiPartProgress() {
            const container = document.getElementById('multipartProgressContainer');
            const resultsDiv = document.getElementById('results');
            
            setTimeout(() => {
                container.style.display = 'none';
                resultsDiv.style.display = 'block';
            }, 2000);
        }
        
        /**
         * Reset Multi-Part Posting State
         * ARCHITECT FIX: Ensures UI buttons are never stuck disabled
         */
        function resetMultiPartPostingState() {
            console.log('🔄 Resetting multi-part posting state');
            
            // Clear pipeline reference
            if (window.currentMultipartPipeline) {
                window.currentMultipartPipeline = null;
            }
            
            // Hide progress UI
            const container = document.getElementById('multipartProgressContainer');
            if (container) {
                container.style.display = 'none';
            }
            
            // Show results div
            const resultsDiv = document.getElementById('results');
            if (resultsDiv) {
                resultsDiv.style.display = 'block';
            }
            
            // Reset blockchain button state
            updateBlockchainButtonState('auto');
            
            console.log('✅ Multi-part posting state reset complete');
        }
        
        /**
         * Cancel Multi-Part Posting
         */
        function cancelMultipartPosting() {
            if (!window.currentMultipartPipeline) return;
            
            const confirm = window.confirm('Are you sure you want to cancel multi-part posting?');
            if (!confirm) return;
            
            window.currentMultipartPipeline.cancel();
            showToast('info', 'Multi-part posting cancelled');
            
            setTimeout(() => {
                hideMultiPartProgress();
            }, 1000);
        }
        
        /**
         * Show Multi-Part Success Message
         */
        function showMultiPartSuccess(manifest) {
            console.log('📊 Multi-part posting complete:');
            console.log('   Series ID:', manifest?.series_id);
            console.log('   Total parts:', manifest?.total_parts);
            console.log('   All parts:', manifest?.parts);
            
            // ARCHITECT FIX: Handle missing manifest/parts gracefully
            // Reset posting state FIRST to prevent stuck UI
            resetMultiPartPostingState();
            
            // Validate manifest structure
            if (!manifest || !manifest.series_id || !manifest.total_parts) {
                console.warn('⚠️ Invalid manifest, showing generic success');
                showToast('success', '✅ Content posted successfully!');
                return;
            }
            
            // BUG FIX #3: Show success modal with link to view on Hive
            const firstPart = manifest.parts && manifest.parts[0];
            const hasValidPart = firstPart && firstPart.author && firstPart.permlink;
            const ecencyUrl = hasValidPart ? `https://ecency.com/@${firstPart.author}/${firstPart.permlink}` : null;
            const seriesTag = window.ArcHiveMultiPart ? window.ArcHiveMultiPart.generateSeriesTag(manifest.series_id) : manifest.series_id.substring(0, 16);
            
            // Store manifest globally for "View on Archive" functionality
            window.lastArchivedManifest = manifest;
            
            const modalContent = `
                <div style="padding: var(--spacing-xl);">
                    <div style="text-align: center; margin-bottom: var(--spacing-lg);">
                        <div style="display: inline-flex; align-items: center; justify-content: center; width: 80px; height: 80px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); border-radius: 50%; box-shadow: 0 10px 30px rgba(16, 185, 129, 0.3);">
                            <span style="font-size: 2.5rem;">🛡️</span>
                        </div>
                    </div>
                    
                    <h2 style="font-size: var(--text-2xl); font-weight: 700; text-align: center; margin-bottom: var(--spacing-sm); color: var(--text-primary);">
                        Successfully Archived!
                    </h2>
                    <p style="color: var(--text-secondary); text-align: center; margin-bottom: var(--spacing-xl); font-size: var(--text-base); line-height: 1.6;">
                        Your content has been cryptographically verified and permanently stored on the Hive blockchain as a ${manifest.total_parts}-part series.
                    </p>
                    
                    <div style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(5, 150, 105, 0.05) 100%); border: 1px solid rgba(16, 185, 129, 0.2); border-radius: 12px; padding: var(--spacing-lg); margin-bottom: var(--spacing-xl);">
                        <div style="display: flex; align-items: center; gap: var(--spacing-xs); margin-bottom: var(--spacing-sm);">
                            <span style="font-size: var(--text-sm); font-weight: 600; color: var(--text-primary);">🔐 Series ID</span>
                        </div>
                        <div style="font-family: 'SF Mono', 'Monaco', 'Consolas', monospace; font-size: 13px; word-break: break-all; color: var(--text-primary); line-height: 1.6; background: rgba(255, 255, 255, 0.5); padding: var(--spacing-sm); border-radius: 6px; margin-bottom: var(--spacing-md);">
                            ${manifest.series_id}
                        </div>
                        <div style="display: flex; gap: var(--spacing-lg); font-size: var(--text-sm); color: var(--text-secondary);">
                            <div>
                                <span style="opacity: 0.7;">🛡️ Parts:</span> <strong style="color: var(--text-primary);">${manifest.total_parts}</strong>
                            </div>
                            <div>
                                <span style="opacity: 0.7;">🏷️ Tag:</span> <strong style="color: var(--text-primary);">${seriesTag}</strong>
                            </div>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-sm); margin-bottom: var(--spacing-md);">
                        <button 
                            class="btn btn-success" 
                            onclick="showArchivedContentPreview();"
                            style="min-height: var(--touch-target); font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 8px;">
                            <span>📄</span> View on Archive
                        </button>
                        ${ecencyUrl ? `
                            <a href="${ecencyUrl}" target="_blank" class="btn" style="text-decoration: none; display: flex; align-items: center; justify-content: center; gap: 8px; background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; min-height: var(--touch-target); font-weight: 600;">
                                <span>🔗</span> View on Hive
                            </a>
                        ` : ''}
                    </div>
                    
                    <button class="btn" onclick="closeModal();" style="width: 100%; background: rgba(100, 116, 139, 0.08); color: var(--text-secondary); min-height: var(--touch-target); font-weight: 500;">
                        Done
                    </button>
                    
                    <div style="margin-top: var(--spacing-lg); padding: var(--spacing-md); background: rgba(59, 130, 246, 0.06); border-left: 3px solid rgba(59, 130, 246, 0.4); border-radius: 6px;">
                        <div style="font-size: var(--text-sm); color: var(--text-secondary); line-height: 1.7;">
                            💡 <strong style="color: var(--text-primary);">Tip:</strong> Your content is immutable and verifiable. Use the Link Explorer to verify it later or share the URL with others.
                        </div>
                    </div>
                </div>
            `;
            
            showModal(modalContent);
            showToast('success', `✅ All ${manifest.total_parts} parts posted successfully!`);
        }
        
        /**
         * Show Archived Content Preview
         * Opens a modal with the full archived content (similar to Link Explorer's "View Full Content")
         */
        function showArchivedContentPreview() {
            const manifest = window.lastArchivedManifest;
            if (!manifest) {
                showToast('error', 'Content data not available');
                return;
            }
            
            // Try to get content from multiple sources
            let fullContent = '';
            
            // 1. Try from multipartPreview (most reliable for just-posted content)
            if (window.multipartPreview && window.multipartPreview.originalData) {
                fullContent = window.multipartPreview.originalData.content || '';
            }
            
            // 2. Fallback to textarea
            if (!fullContent) {
                const contentTextarea = document.getElementById('content');
                fullContent = contentTextarea ? contentTextarea.value : '';
            }
            
            // 3. Fallback to reconstructing from parts
            if (!fullContent && window.multipartPreview && window.multipartPreview.parts) {
                fullContent = window.multipartPreview.parts.join('');
            }
            
            if (!fullContent) {
                showToast('error', 'Content not available - try viewing on Hive instead');
                return;
            }
            
            // Create modal content similar to Link Explorer's full content modal
            const modalContent = `
                <div style="padding: 0; height: 80vh; display: flex; flex-direction: column;">
                    <div style="padding: var(--spacing-lg); border-bottom: 1px solid rgba(100, 116, 139, 0.2); display: flex; justify-content: space-between; align-items: center; background: var(--bg-secondary);">
                        <h3 style="margin: 0; font-size: var(--text-xl); font-weight: 700; color: var(--text-primary);">
                            📄 Archived Content Preview
                        </h3>
                        <button onclick="closeModal();" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-secondary); padding: var(--spacing-xs);" aria-label="Close">
                            ✕
                        </button>
                    </div>
                    <div style="flex: 1; overflow-y: auto; padding: var(--spacing-xl); background: var(--bg-primary);">
                        <div style="max-width: 800px; margin: 0 auto;">
                            <div style="font-size: var(--text-base); line-height: 1.8; color: var(--text-primary); white-space: pre-wrap; word-wrap: break-word;">
                                ${escapeHtml(fullContent)}
                            </div>
                        </div>
                    </div>
                    <div style="padding: var(--spacing-md); border-top: 1px solid rgba(100, 116, 139, 0.2); background: var(--bg-secondary); text-align: center;">
                        <div style="font-size: var(--text-sm); color: var(--text-secondary);">
                            🛡️ ${manifest.total_parts} parts • ${fullContent.length.toLocaleString()} characters
                        </div>
                    </div>
                </div>
            `;
            
            showModal(modalContent);
        }
        
        /**
         * Show Multi-Part Failure Message
         */
        function showMultiPartFailure(result) {
            const message = `❌ Multi-part posting failed at part ${result.failedPart || 'unknown'}: ${result.error || 'Unknown error'}`;
            showToast('error', message);
            
            hideMultiPartProgress();
        }
        
        /**
         * Helper: Get Custom Tags
         */
        function getCustomTags() {
            return customTags || [];
        }
        
        /**
         * Helper: Escape HTML for XSS Prevention
         */
        function escapeHtml(unsafe) {
            if (typeof unsafe !== 'string') return '';
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }
        
        /* ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
         * END MULTI-PART POSTING UI FUNCTIONS
         * ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ */
        
        /**
         * UX IMPROVEMENT: Dismiss Getting Started Guide
         */
        function dismissGettingStarted() {
            const banner = document.getElementById('gettingStarted');
            if (banner) {
                banner.style.display = 'none';
                localStorage.setItem('archiveGettingStartedDismissed', 'true');
            }
        }
        
        /**
         * UX IMPROVEMENT: Dismiss Keychain Warning
         * Returning users don't need to see this every time
         */
        function dismissKeychainWarning() {
            const keychainWarning = document.getElementById('keychainWarning');
            if (keychainWarning) {
                keychainWarning.style.display = 'none';
                localStorage.setItem('archiveKeychainWarningDismissed', 'true');
            }
        }
        
        /**
         * Toggle Advanced HTML Paste Mode
         */
        function toggleAdvancedMode() {
            const section = document.getElementById('advancedSection');
            const button = document.getElementById('toggleAdvanced');
            
            if (section.style.display === 'none') {
                section.style.display = 'block';
                button.textContent = '▲ Hide Advanced Mode';
            } else {
                section.style.display = 'none';
                button.textContent = '⚙️ Advanced: Manual HTML Paste';
            }
        }
        
        /**
         * UX IMPROVEMENT: Error Recovery - Retry Post
         */
        function retryPost() {
            const lastUsername = localStorage.getItem('lastHiveUsername');
            if (lastUsername) {
                postToHive();
            } else {
                showToast('info', 'Please try posting again');
            }
        }
        
        /**
         * UX IMPROVEMENT: Error Recovery - Switch Account
         */
        function switchAccount() {
            clearHASSession();
            localStorage.removeItem('lastHiveUsername');
            showToast('info', 'Session cleared. Click "Post to Blockchain" to connect a new account.');
        }
        
        /**
         * Copy text to clipboard with fallback
         */
        function copyToClipboard(text) {
            // Modern clipboard API
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text)
                    .then(() => showNotification('✅ Link copied!'))
                    .catch(() => {
                        // Fallback to execCommand
                        fallbackCopy(text);
                    });
            } else {
                // Fallback for older browsers
                fallbackCopy(text);
            }
        }
        
        /**
         * Fallback copy method for older browsers
         */
        function fallbackCopy(text) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.left = '-999999px';
            document.body.appendChild(textArea);
            textArea.select();
            try {
                document.execCommand('copy');
                showNotification('✅ Link copied!');
            } catch (err) {
                showNotification('❌ Could not copy link');
            }
            document.body.removeChild(textArea);
        }
        
        /**
         * Show Hive success modal with Ecency link
         */
        function showHiveSuccessModal(username, permlink, ecencyUrl, hash) {
            // Create modal overlay
            const modal = document.createElement('div');
            modal.className = 'hive-success-modal-overlay';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.8);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 100000;
                animation: fadeIn 0.3s;
            `;
            
            // Create modal content
            const content = document.createElement('div');
            content.style.cssText = `
                background: linear-gradient(135deg, #10b981 0%, #059669 100%);
                border-radius: 24px;
                padding: 48px 40px;
                max-width: 500px;
                width: 90%;
                box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
                text-align: center;
                animation: slideUp 0.4s;
            `;
            
            content.innerHTML = `
                <div style="font-size: 72px; margin-bottom: 16px;">🎉</div>
                <h2 style="color: white; font-size: 32px; font-weight: 800; margin: 0 0 12px 0; text-shadow: 0 2px 4px rgba(0,0,0,0.2);">
                    SUCCESS!
                </h2>
                <p style="color: rgba(255,255,255,0.95); font-size: 18px; margin: 0 0 32px 0; line-height: 1.5;">
                    Your content has been permanently archived on the Hive blockchain!
                </p>
                
                <div style="background: rgba(255,255,255,0.15); border-radius: 12px; padding: 16px; margin-bottom: 24px;">
                    <div style="color: rgba(255,255,255,0.8); font-size: 13px; font-weight: 600; margin-bottom: 8px;">
                        VERIFICATION HASH
                    </div>
                    <div style="color: white; font-family: monospace; font-size: 14px; word-break: break-all; line-height: 1.6;">
                        ${hash.substring(0, 64)}...
                    </div>
                </div>
                
                <button onclick="window.open('${ecencyUrl}', '_blank')" style="
                    background: white;
                    color: #059669;
                    font-weight: 700;
                    font-size: 18px;
                    padding: 18px 40px;
                    border: none;
                    border-radius: 12px;
                    cursor: pointer;
                    width: 100%;
                    margin-bottom: 12px;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                    transition: all 0.2s;
                " onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
                    🌐 View Post on Ecency
                </button>
                
                <button onclick="document.querySelector('.hive-success-modal-overlay').remove(); showSuccessArchivePreview();" style="
                    background: rgba(255,255,255,0.2);
                    color: white;
                    font-weight: 600;
                    font-size: 16px;
                    padding: 14px 32px;
                    border: 2px solid rgba(255,255,255,0.4);
                    border-radius: 12px;
                    cursor: pointer;
                    width: 100%;
                    margin-bottom: 12px;
                    transition: all 0.2s;
                " onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                    📄 View on Archive
                </button>
                
                <button onclick="copyToClipboard('${ecencyUrl}')" style="
                    background: rgba(255,255,255,0.15);
                    color: white;
                    font-weight: 600;
                    font-size: 16px;
                    padding: 14px 32px;
                    border: 2px solid rgba(255,255,255,0.3);
                    border-radius: 12px;
                    cursor: pointer;
                    width: 100%;
                    margin-bottom: 20px;
                    transition: all 0.2s;
                " onmouseover="this.style.background='rgba(255,255,255,0.25)'" onmouseout="this.style.background='rgba(255,255,255,0.15)'">
                    📋 Copy Link
                </button>
                
                <div style="color: rgba(255,255,255,0.7); font-size: 14px; margin-bottom: 16px;">
                    @${username}/${permlink}
                </div>
                
                <button onclick="document.querySelector('.hive-success-modal-overlay').remove()" style="
                    background: transparent;
                    color: rgba(255,255,255,0.8);
                    font-weight: 600;
                    font-size: 15px;
                    padding: 12px 24px;
                    border: none;
                    cursor: pointer;
                    transition: all 0.2s;
                " onmouseover="this.style.color='white'" onmouseout="this.style.color='rgba(255,255,255,0.8)'">
                    ✕ Close
                </button>
            `;
            
            modal.appendChild(content);
            document.body.appendChild(modal);
            
            // Add animations
            const style = document.createElement('style');
            style.textContent = `
                @keyframes fadeIn {
                    from { opacity: 0; }
                    to { opacity: 1; }
                }
                @keyframes slideUp {
                    from {
                        opacity: 0;
                        transform: translateY(30px);
                    }
                    to {
                        opacity: 1;
                        transform: translateY(0);
                    }
                }
            `;
            document.head.appendChild(style);
            
            // MOBILE FIX: Don't auto-open Ecency or auto-close
            // Let user tap the button and close manually
        }
        
        /**
         * Show archived content preview from success modal
         * Uses processor.currentData for single-part posts
         */
        function showSuccessArchivePreview() {
            // Get content from processor (single-part posts)
            const data = processor.currentData;
            if (!data || !data.content) {
                showNotification('❌ Content not available');
                return;
            }
            
            const fullContent = data.content;
            const title = data.title || 'Archived Content';
            const wordCount = data.wordCount || fullContent.split(/\s+/).length;
            const charCount = fullContent.length;
            
            // Create full-screen modal for reading
            const modal = document.createElement('div');
            modal.id = 'archivePreviewModal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: var(--bg-primary, #ffffff);
                z-index: 100001;
                display: flex;
                flex-direction: column;
                animation: fadeIn 0.3s;
            `;
            
            modal.innerHTML = `
                <div style="padding: 16px 20px; border-bottom: 1px solid rgba(100, 116, 139, 0.2); display: flex; justify-content: space-between; align-items: center; background: var(--bg-secondary, #f8fafc);">
                    <h3 style="margin: 0; font-size: 18px; font-weight: 700; color: var(--text-primary, #1e293b);">
                        📄 ${escapeHtml(title)}
                    </h3>
                    <button onclick="document.getElementById('archivePreviewModal').remove();" style="background: none; border: none; font-size: 24px; cursor: pointer; color: var(--text-secondary, #64748b); padding: 8px; min-width: 44px; min-height: 44px;" aria-label="Close">
                        ✕
                    </button>
                </div>
                <div style="flex: 1; overflow-y: auto; padding: 24px 20px; background: var(--bg-primary, #ffffff);">
                    <div style="max-width: 700px; margin: 0 auto;">
                        <div style="font-size: 17px; line-height: 1.8; color: var(--text-primary, #1e293b); white-space: pre-wrap; word-wrap: break-word;">
                            ${escapeHtml(fullContent)}
                        </div>
                    </div>
                </div>
                <div style="padding: 12px 20px; border-top: 1px solid rgba(100, 116, 139, 0.2); background: var(--bg-secondary, #f8fafc); text-align: center;">
                    <div style="font-size: 13px; color: var(--text-secondary, #64748b);">
                        🛡️ ${wordCount.toLocaleString()} words • ${charCount.toLocaleString()} characters
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        /* ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
         * SMART BOOKMARKLET SYSTEM - Auto-extraction for complex sites
         * ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ */
        
        /**
         * Sanitize user-controlled content for safe use in HTML/JavaScript contexts
         * Prevents XSS, template literal injection, and HTML injection
         */
        function sanitizeForHTML(str) {
            if (!str) return '';
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML; // Converts <, >, &, ", ' to HTML entities
        }

        function sanitizeForTemplateAttribute(str) {
            if (!str) return '';
            // Escape for use in template literals as HTML attribute values
            return str.replace(/[`$\\]/g, '\\$&').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
        }
        
        /**
         * Generate Console Snippet code (replaces bookmarklet)
         * ONE-TIME SETUP → Works forever on ALL pages!
         * Uses named window to REUSE existing archive-paste.html (focus, not new window!)
         */
        function generateSnippetCode() {
            // Capture the Archive app URL NOW (while user is on Archive page)
            // This URL gets embedded in the snippet code as a string literal
            const archivePageUrl = window.location.origin + '/';
            
            // The snippet code - uses named window.open to REUSE existing window
            const snippetCode = `// ArcHive Extract - ONE-TIME SETUP (with Twitter/X Smart Extraction)
// Save this as "ArcHive" in DevTools → Sources → Snippets
// Then on ANY page: F12 → Ctrl+Enter → Extract!
// (Works from ANY DevTools tab - Console, Elements, Network, etc.)

(function() {
    const url = window.location.href;
    const title = document.title;
    let html = document.documentElement.outerHTML;
    
    // ━━━ TWITTER/X SMART EXTRACTION ━━━
    let mode = 'normal';
    let tweetOnlyHTML = '';
    let repliesHTML = [];
    
    // Detect if we're on Twitter/X
    const isTwitter = url.includes('twitter.com') || url.includes('x.com');
    
    if (isTwitter) {
        console.log('🐦 Twitter/X detected - using smart extraction');
        
        // Read user preference for including replies (default: false)
        const includeReplies = localStorage.getItem('archiveIncludeReplies') === 'true';
        mode = includeReplies ? 'with-replies' : 'tweet-only';
        
        // Extract main tweet using data-testid selector
        const mainTweet = document.querySelector('article[data-testid="tweet"]');
        if (mainTweet) {
            tweetOnlyHTML = mainTweet.outerHTML;
            console.log('✅ Main tweet extracted:', tweetOnlyHTML.length, 'chars');
        }
        
        // Extract replies if user enabled the option
        if (includeReplies) {
            const replyCells = document.querySelectorAll('div[data-testid="cellInnerDiv"]');
            replyCells.forEach((cell, index) => {
                // Skip the first cell (usually the main tweet)
                if (index > 0 && cell.querySelector('article[data-testid="tweet"]')) {
                    repliesHTML.push(cell.outerHTML);
                }
            });
            console.log('✅ Extracted', repliesHTML.length, 'replies');
        }
        
        // Use full HTML as fallback if smart extraction fails
        if (!tweetOnlyHTML) {
            console.warn('⚠️ Smart extraction failed, using full HTML');
            mode = 'normal';
        }
    }
    
    // Check if THIS window was opened by ArcHive (via "Open X.com Now" button)
    let archiveWindow;
    if (window.opener && !window.opener.closed) {
        // Use the opener (NO new window!)
        archiveWindow = window.opener;
        console.log('✅ Using window.opener - sending to ORIGINAL ArcHive tab!');
    } else {
        // Fallback: Open or focus ArcHive tab (will create new tab if not already open)
        archiveWindow = window.open(
            '${archivePageUrl}',
            'ArcHiveExtractor'
        );
        console.log('⚠️  Opened/focused ArcHive tab (keep it open for future extractions)');
    }
    
    // Send content immediately if using opener, or wait if using window.open
    const delay = (window.opener && !window.opener.closed) ? 100 : 1000;
    setTimeout(() => {
        archiveWindow.postMessage({
            type: 'ARCHIVE_EXTRACT',
            html: html,
            title: title,
            url: url,
            mode: mode,
            tweetOnlyHTML: tweetOnlyHTML,
            repliesHTML: repliesHTML
        }, '*');
    }, delay);
    
    // Visual confirmation
    console.log('%c✅ Content Extracted!', 'color: #10b981; font-size: 16px; font-weight: bold;');
    console.log('📊 HTML length:', html.length.toLocaleString(), 'characters');
    if (mode !== 'normal') {
        console.log('🐦 Mode:', mode);
        console.log('📊 Tweet HTML:', tweetOnlyHTML.length.toLocaleString(), 'characters');
        console.log('💬 Replies:', repliesHTML.length);
    }
    console.log('📍 Source:', url);
    console.log('💡 Check your ArcHive window!');
})();`;
            
            return snippetCode;
        }
        
        /**
         * Show mobile-specific instructions for complex sites
         * Updated Nov 26, 2025: iOS now uses bookmarklet (Shortcuts removed due to Apple signing issues)
         */
        function showMobileExtractInstructions(targetUrl, siteName) {
            const platform = detectPlatform();
            
            // iOS users now use bookmarklet (same as Android)
            if (platform.isIOS) {
                console.log('📱 iOS detected - showing bookmarklet setup');
                // Continue to bookmarklet setup below (same as Android)
            }
            
            // Android/other: Check if bookmarklet setup complete
            const setupComplete = localStorage.getItem('archiveMobileBookmarkletSetupComplete');
            if (setupComplete === 'true') {
                // Show simplified daily usage instructions only
                showMobileDailyUsageOnly(targetUrl, siteName);
                return;
            }
            
            // Remove existing modal if present
            const existing = document.getElementById('bookmarkletModal');
            if (existing) existing.remove();
            
            // Generate NEW mobile bookmarklet code that loads archive-core.js
            // This loads the full-featured bookmarklet with all libraries embedded:
            // - Readability.js for content extraction
            // - DOMPurify for HTML sanitization
            // - blakejs, SHA-256, MD5 for cryptographic hashing
            // - Hive blockchain integration
            // - iOS popup fix (window.open without setTimeout)
            // Code WITHOUT javascript: prefix (for iOS Chrome manual typing method)
            // Get the full base URL including subdirectory path (e.g., /archive on GitHub Pages)
            const currentPath = window.location.pathname.substring(0, window.location.pathname.lastIndexOf('/') + 1) || '/';
            const archiveBase = window.location.origin + currentPath.replace(/\/$/, '');
            const archiveUrl = archiveBase + '/index.html#mobile-extract';
            const archiveOrigin = archiveBase;
            // NEW APPROACH: Extract HTML directly, no external scripts! Works on ALL CSP-protected sites including Twitter/X
            // SECURITY: Specify exact targetOrigin (not '*') to ensure messages only go to our domain
            // RESTORED: Twitter/X smart extraction (Nov 25, 2025)
            // ADDED: Self-archive prevention - don't archive ArcHive itself
            const bookmarkletCodeWithoutPrefix = `(function(){'use strict';const showToast=function(msg,type='info'){const n=document.createElement('div');const bgColor=type==='error'?'#ef4444':type==='success'?'#10b981':'#f59e0b';n.style.cssText='position:fixed;'+((type==='error'||type==='warning')?'top:50%;left:50%;transform:translate(-50%,-50%);':'bottom:20px;left:50%;transform:translateX(-50%);')+'background:'+bgColor+';color:white;padding:'+(type==='error'?'20px 24px':'16px 24px')+';border-radius:'+(type==='error'?'12px':'8px')+';font-family:sans-serif;font-size:14px;font-weight:600;z-index:999999;box-shadow:0 '+(type==='error'?'8':'4')+'px '+(type==='error'?'16':'12')+'px rgba(0,0,0,0.'+(type==='error'?'2':'3')+');max-width:90vw;text-align:center;';n.textContent=msg;document.body.appendChild(n);setTimeout(()=>{n.style.opacity='0';n.style.transition='opacity 0.3s';setTimeout(()=>n.remove(),300);},type==='error'?5000:3000);};try{const host=window.location.hostname;if(host.includes('github.io')||host.includes('replit')||host.includes('repl.co')){showToast('⚠️ You are on ArcHive! Navigate to the page you want to archive first.','warning');return;}const html=document.documentElement.outerHTML;const url=window.location.href;const title=document.title;let mode='normal';let tweetOnlyHTML='';let repliesHTML=[];const isTwitter=url.includes('twitter.com')||url.includes('x.com');if(isTwitter){console.log('🐦 Twitter/X detected');const includeReplies=localStorage.getItem('archiveIncludeReplies')==='true';mode=includeReplies?'with-replies':'tweet-only';const mainTweet=document.querySelector('article[data-testid="tweet"]');if(mainTweet){tweetOnlyHTML=mainTweet.outerHTML;console.log('✅ Main tweet extracted:',tweetOnlyHTML.length,'chars');}if(includeReplies){document.querySelectorAll('div[data-testid="cellInnerDiv"]').forEach((cell,i)=>{if(i>0&&cell.querySelector('article[data-testid="tweet"]'))repliesHTML.push(cell.outerHTML);});console.log('✅ Extracted',repliesHTML.length,'replies');}if(!tweetOnlyHTML){console.warn('⚠️ Smart extraction failed, using full HTML');mode='normal';}}const w=window.open('${archiveUrl}','_blank');if(!w){showToast('⚠️ Popups blocked.\\nPlease enable popups in browser settings to use ArcHive bookmarklet.','warning');return;}const hndlr=function(e){if(e.data&&e.data.type==='ARCHIVE_READY'){w.postMessage({type:'ARCHIVE_EXTRACT',html:html,title:title,url:url,source:window.location.hostname,mode:mode,tweetOnlyHTML:tweetOnlyHTML,repliesHTML:repliesHTML,extractedData:{title:title}},'${archiveOrigin}');window.removeEventListener('message',hndlr);showToast('✅ Sent to ArcHive!','success');}};window.addEventListener('message',hndlr);setTimeout(()=>window.removeEventListener('message',hndlr),10000);}catch(e){showToast('❌ Error: '+e.message,'error');}}})()`;
            const bookmarkletCode = `javascript:${bookmarkletCodeWithoutPrefix}`;
            
            const modal = document.createElement('div');
            modal.id = 'bookmarkletModal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100vw;
                height: 100vh;
                background: rgba(0, 0, 0, 0.92);
                z-index: 100000;
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 20px;
                overflow-y: auto;
            `;
            
            modal.innerHTML = `
                <div style="
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    border-radius: 20px;
                    padding: 30px;
                    max-width: 550px;
                    width: 100%;
                    max-height: 90vh;
                    overflow-y: auto;
                    box-shadow: 0 20px 60px rgba(0,0,0,0.5);
                    color: white;
                    position: relative;
                ">
                    <button onclick="closeBookmarkletModal()" style="
                        position: absolute;
                        top: 15px;
                        right: 15px;
                        background: rgba(255,255,255,0.2);
                        border: none;
                        color: white;
                        font-size: 28px;
                        cursor: pointer;
                        border-radius: 50%;
                        width: 44px;
                        height: 44px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        transition: all 0.3s;
                    " ontouchstart="this.style.background='rgba(255,255,255,0.4)'" ontouchend="this.style.background='rgba(255,255,255,0.2)'">×</button>
                    
                    <div style="font-size: 48px; text-align: center; margin-bottom: 15px;">📱</div>
                    <h2 style="margin: 0 0 10px 0; font-size: 26px; font-weight: 700; text-align: center;">Mobile Bookmarklet Setup</h2>
                    <p style="margin: 0 0 15px 0; font-size: 15px; text-align: center; opacity: 0.95;">
                        One-time 3-minute setup, then <strong>1-tap extraction</strong> on ANY ${sanitizeForHTML(siteName)} page forever!
                    </p>
                    
                    <!-- Browser Compatibility Info -->
                    <div style="background: rgba(16,185,129,0.2); border: 2px solid rgba(16,185,129,0.4); border-radius: 10px; padding: 15px; margin-bottom: 15px;">
                        <div style="font-size: 16px; font-weight: 700; margin-bottom: 8px; color: #d1fae5;">✅ iPhone Users: Use Safari!</div>
                        <div style="font-size: 14px; line-height: 1.7;">
                            <strong>Easiest:</strong> Safari on iPhone (allows editing bookmarks)<br>
                            <strong>Chrome iOS:</strong> Blocks editing - must sync from desktop<br><br>
                            <strong>Recommendation:</strong> Use <strong>Safari</strong> for hassle-free setup!
                        </div>
                    </div>
                    
                    <div style="background: rgba(99,102,241,0.2); border: 2px solid rgba(99,102,241,0.4); border-radius: 10px; padding: 15px; margin-bottom: 20px;">
                        <div style="font-size: 16px; font-weight: 700; margin-bottom: 8px; color: #e0e7ff;">📱 Android Users: All Browsers Work!</div>
                        <div style="font-size: 14px; line-height: 1.7;">
                            <strong>Chrome, Firefox, Brave:</strong> All allow direct editing ✅<br>
                            Follow the Android instructions below.
                        </div>
                    </div>
                    
                    <!-- Step 1: Copy Code -->
                    <div style="background: rgba(255,255,255,0.15); border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                        <div style="font-size: 18px; font-weight: 700; margin-bottom: 12px;">📋 Step 1: Copy the Code</div>
                        <p style="margin: 0 0 12px 0; font-size: 14px; opacity: 0.95;">
                            Tap the button to copy the bookmarklet code:
                        </p>
                        <button onclick="copyMobileBookmarkletCode()" id="copyBookmarkletBtn" style="
                            background: linear-gradient(135deg, #10b981, #059669);
                            color: white;
                            font-weight: 700;
                            font-size: 16px;
                            padding: 16px 24px;
                            border: none;
                            border-radius: 12px;
                            cursor: pointer;
                            width: 100%;
                            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                            transition: all 0.3s;
                        ">
                            📋 Copy Bookmarklet Code
                        </button>
                        <div style="margin-top: 12px; padding: 10px; background: rgba(16,185,129,0.2); border-radius: 6px; font-size: 13px; text-align: center; display: none;" id="copySuccess">
                            ✅ Code copied! Now follow steps 2-3 below.
                        </div>
                        <div style="margin-top: 12px; padding: 10px; background: rgba(16,185,129,0.2); border-radius: 6px; font-size: 12px; border: 1px solid rgba(16,185,129,0.4);">
                            <strong>✅ All users:</strong> Code includes <code style="background: rgba(0,0,0,0.3); padding: 2px 4px; border-radius: 3px;">javascript:</code> prefix automatically - no manual typing needed!
                        </div>
                    </div>
                    
                    <!-- Step 2: Create Bookmark -->
                    <div style="background: rgba(255,255,255,0.15); border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                        <div style="font-size: 18px; font-weight: 700; margin-bottom: 12px;">🔖 Step 2: Create a Bookmark</div>
                        
                        <div style="background: rgba(0,0,0,0.15); border-radius: 8px; padding: 15px; margin-bottom: 12px;">
                            <div style="font-size: 15px; font-weight: 600; margin-bottom: 8px;">📱 iPhone Safari (Recommended):</div>
                            <ol style="margin: 0; padding-left: 20px; font-size: 14px; line-height: 1.8;">
                                <li>Tap the <strong>Share</strong> button (box with arrow)</li>
                                <li>Tap <strong>"Add Bookmark"</strong></li>
                                <li>Name it <strong>"ArcHive"</strong> (short name works best!)</li>
                                <li>Tap <strong>"Save"</strong></li>
                            </ol>
                            <div style="margin-top: 8px; padding: 6px; background: rgba(16,185,129,0.2); border-radius: 4px; font-size: 12px;">
                                ✅ Safari allows editing bookmark URLs - easiest option!
                            </div>
                        </div>
                        
                        <div style="background: rgba(99,102,241,0.15); border: 2px solid rgba(99,102,241,0.3); border-radius: 8px; padding: 15px; margin-bottom: 12px;">
                            <div style="font-size: 15px; font-weight: 600; margin-bottom: 10px;">💡 iPhone Chrome/Brave:</div>
                            <ol style="margin: 0; padding-left: 20px; font-size: 13px; line-height: 2;">
                                <li>Tap <strong>⋮</strong> → Bookmark any page → Save</li>
                                <li>Tap <strong>⋮</strong> → Bookmarks → Find bookmark → <strong>⋮</strong> → Edit</li>
                                <li><strong>CRITICAL - Edit URL First:</strong> Delete entire URL field, then paste the bookmarklet code</li>
                                <li><strong>CRITICAL - Edit Title Second:</strong> Change name to <strong>"ArcHive"</strong></li>
                                <li>Tap <strong>"Done"</strong> checkmark</li>
                            </ol>
                            <div style="margin-top: 10px; padding: 8px; background: rgba(239,68,68,0.2); border-radius: 6px; font-size: 12px; text-align: center; font-weight: 600; border: 1px solid rgba(239,68,68,0.4);">
                                ⚠️ MUST EDIT BOTH FIELDS (URL + Title) - Save button won't work if you only edit one!
                            </div>
                        </div>
                        
                        <div style="background: rgba(0,0,0,0.15); border-radius: 8px; padding: 15px; margin-bottom: 12px;">
                            <div style="font-size: 15px; font-weight: 600; margin-bottom: 8px;">🤖 Android Chrome:</div>
                            <ol style="margin: 0; padding-left: 20px; font-size: 14px; line-height: 1.8;">
                                <li>Tap the <strong>⋮</strong> menu (three vertical dots in top-right)</li>
                                <li>Tap <strong>"Add to bookmarks"</strong></li>
                                <li>A "Bookmarked" alert will appear at bottom</li>
                                <li>You'll edit the URL in Step 3 below - just save for now</li>
                            </ol>
                            <div style="margin-top: 8px; padding: 6px; background: rgba(251,191,36,0.2); border-radius: 4px; font-size: 12px; text-align: center; font-weight: 600; border: 1px solid rgba(251,191,36,0.4);">
                                💡 Don't edit yet! Continue to Step 3 to edit URL + Title together
                            </div>
                        </div>
                        
                        <div style="background: rgba(0,0,0,0.15); border-radius: 8px; padding: 15px;">
                            <div style="font-size: 15px; font-weight: 600; margin-bottom: 8px;">🦊 Android Firefox/Brave:</div>
                            <ol style="margin: 0; padding-left: 20px; font-size: 14px; line-height: 1.8;">
                                <li>Tap the <strong>⋮</strong> menu (three dots)</li>
                                <li>Tap the <strong>⭐ Star</strong> icon to bookmark</li>
                                <li>Go to <strong>Bookmarks</strong> menu</li>
                                <li>Find the bookmark → <strong>Long-press</strong> → <strong>"Edit"</strong></li>
                                <li>Name it <strong>"ArcHive"</strong></li>
                                <li>Tap <strong>"Save"</strong></li>
                            </ol>
                        </div>
                    </div>
                    
                    <!-- Step 3: Edit Bookmark -->
                    <div style="background: rgba(255,255,255,0.15); border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                        <div style="font-size: 18px; font-weight: 700; margin-bottom: 12px;">✏️ Step 3: Edit the Bookmark</div>
                        
                        <div style="background: rgba(0,0,0,0.15); border-radius: 8px; padding: 15px; margin-bottom: 12px;">
                            <div style="font-size: 15px; font-weight: 600; margin-bottom: 8px;">📱 iPhone Safari:</div>
                            <ol style="margin: 0; padding-left: 20px; font-size: 14px; line-height: 1.8;">
                                <li>Tap <strong>📖 Book icon</strong> (Bookmarks)</li>
                                <li>Find <strong>"ArcHive"</strong> in your list</li>
                                <li>Tap <strong>"Edit"</strong></li>
                                <li><strong>CRITICAL - Edit URL First:</strong> Delete entire URL field, then paste the bookmarklet code (long-press → Paste)</li>
                                <li><strong>CRITICAL - Edit Title Second:</strong> Make sure name is <strong>"ArcHive"</strong></li>
                                <li>Tap <strong>"Done"</strong></li>
                            </ol>
                            <div style="margin-top: 8px; padding: 6px; background: rgba(239,68,68,0.2); border-radius: 4px; font-size: 12px; text-align: center; font-weight: 600; border: 1px solid rgba(239,68,68,0.4);">
                                ⚠️ MUST EDIT BOTH FIELDS (URL + Title) - Save won't work if you only edit one!
                            </div>
                        </div>
                        
                        <div style="background: rgba(99,102,241,0.15); border: 2px solid rgba(99,102,241,0.3); border-radius: 8px; padding: 15px; margin-bottom: 12px;">
                            <div style="font-size: 15px; font-weight: 600; margin-bottom: 10px;">💡 iPhone Chrome/Brave:</div>
                            <ol style="margin: 0; padding-left: 20px; font-size: 14px; line-height: 1.8;">
                                <li>Tap <strong>⋮</strong> menu → <strong>"Bookmarks"</strong></li>
                                <li>Find <strong>"ArcHive"</strong> bookmark</li>
                                <li>Tap the <strong>⋮</strong> next to it → <strong>"Edit"</strong></li>
                                <li><strong>CRITICAL - Edit URL First:</strong> Delete entire URL field, then paste the bookmarklet code</li>
                                <li><strong>CRITICAL - Edit Title Second:</strong> Change name to <strong>"ArcHive"</strong></li>
                                <li>Tap <strong>"Done"</strong> checkmark</li>
                            </ol>
                            <div style="margin-top: 10px; padding: 8px; background: rgba(239,68,68,0.2); border-radius: 6px; font-size: 12px; text-align: center; font-weight: 600; border: 1px solid rgba(239,68,68,0.4);">
                                ⚠️ MUST EDIT BOTH FIELDS (URL + Title) - Save button won't work if you only edit one!
                            </div>
                        </div>
                        
                        <div style="background: rgba(0,0,0,0.15); border-radius: 8px; padding: 15px; margin-bottom: 12px;">
                            <div style="font-size: 15px; font-weight: 600; margin-bottom: 8px;">🤖 Android Chrome:</div>
                            <ol style="margin: 0; padding-left: 20px; font-size: 14px; line-height: 1.8;">
                                <li>Tap <strong>⋮</strong> menu → <strong>"Bookmarks"</strong></li>
                                <li>Find <strong>"ArcHive"</strong> in Mobile Bookmarks</li>
                                <li>Tap the <strong>⋮</strong> next to it → <strong>"Edit"</strong></li>
                                <li><strong>CRITICAL - Edit URL First:</strong> Delete entire URL field, then paste the bookmarklet code</li>
                                <li><strong>CRITICAL - Edit Title Second:</strong> Change name to <strong>"ArcHive"</strong></li>
                                <li>Tap <strong>"Done"</strong> checkmark to save</li>
                            </ol>
                            <div style="margin-top: 8px; padding: 6px; background: rgba(239,68,68,0.2); border-radius: 4px; font-size: 12px; text-align: center; font-weight: 600; border: 1px solid rgba(239,68,68,0.4);">
                                ⚠️ MUST EDIT BOTH FIELDS (URL + Title) - Save won't work if you only edit one!
                            </div>
                        </div>
                        
                        <div style="background: rgba(0,0,0,0.15); border-radius: 8px; padding: 15px;">
                            <div style="font-size: 15px; font-weight: 600; margin-bottom: 8px;">🦊 Android Firefox/Brave:</div>
                            <ol style="margin: 0; padding-left: 20px; font-size: 14px; line-height: 1.8;">
                                <li>Tap <strong>⋮</strong> menu → <strong>"Bookmarks"</strong></li>
                                <li>Find <strong>"ArcHive"</strong></li>
                                <li><strong>Long-press</strong> it → Tap <strong>"Edit"</strong></li>
                                <li><strong>Edit URL First:</strong> Delete entire URL, then paste the bookmarklet code</li>
                                <li><strong>Edit Title Second:</strong> Make sure name is <strong>"ArcHive"</strong></li>
                                <li>Tap <strong>"Save"</strong></li>
                            </ol>
                            <div style="margin-top: 8px; padding: 6px; background: rgba(239,68,68,0.2); border-radius: 4px; font-size: 12px; text-align: center; font-weight: 600; border: 1px solid rgba(239,68,68,0.4);">
                                ⚠️ MUST EDIT BOTH FIELDS (URL + Title) for save to work!
                            </div>
                        </div>
                        
                    </div>
                    
                    <!-- How to Use -->
                    <div style="background: linear-gradient(135deg, rgba(16,185,129,0.25), rgba(5,150,105,0.25)); border-radius: 12px; padding: 20px; margin-bottom: 20px; border: 2px solid rgba(16,185,129,0.4);">
                        <div style="font-size: 18px; font-weight: 700; margin-bottom: 12px;">🚀 Daily Usage (After Setup)</div>
                        
                        <div style="background: rgba(0,0,0,0.15); border-radius: 8px; padding: 16px; margin-bottom: 12px;">
                            <div style="font-size: 15px; font-weight: 600; margin-bottom: 10px;">📱 iOS Safari & Desktop Users:</div>
                            <div style="font-size: 15px; line-height: 2;">
                                1️⃣ Go to any <strong>${sanitizeForHTML(siteName)}</strong> page<br>
                                2️⃣ Tap the <strong>address bar</strong> (URL field)<br>
                                3️⃣ Type <strong>"archive"</strong> (or your bookmark name)<br>
                                4️⃣ Select <strong>"ArcHive"</strong> from suggestions (shows ⭐)<br>
                                5️⃣ ✨ <strong>Content extracted!</strong> Wait for green button to appear<br>
                                6️⃣ Tap the green <strong>"📤 Send to ArcHive"</strong> button<br>
                                7️⃣ 🎉 Archive page opens with your content and hashes!
                            </div>
                        </div>
                        
                        <div style="background: rgba(0,0,0,0.15); border-radius: 8px; padding: 16px;">
                            <div style="font-size: 15px; font-weight: 600; margin-bottom: 10px;">🦊 Firefox (Alternative):</div>
                            <div style="font-size: 15px; line-height: 2;">
                                1️⃣ Go to <strong>${sanitizeForHTML(siteName)}</strong> page<br>
                                2️⃣ Tap <strong>Bookmarks menu</strong><br>
                                3️⃣ Tap <strong>"ArcHive"</strong><br>
                                4️⃣ ✨ <strong>Content extracted!</strong><br>
                                5️⃣ Tap the green <strong>"📤 Send to ArcHive"</strong> button
                            </div>
                        </div>
                        
                        <div style="margin-top: 12px; padding: 10px; background: rgba(16,185,129,0.3); border-radius: 6px; font-size: 13px; text-align: center; font-weight: 600;">
                            ✅ iOS Safari & Desktop: Bookmarklet | 🤖 Android: Use Direct URL method in ArcHive
                        </div>
                        
                        <div style="margin-top: 8px; padding: 10px; background: rgba(99,102,241,0.2); border-radius: 6px; font-size: 12px;">
                            <strong>💡 iOS Safari & Desktop Only:</strong> This bookmarklet method works on iOS Safari and Desktop. 🤖 Android users: Use the Direct URL method instead (copy URL → paste in ArcHive search box → tap shield icon).
                        </div>
                    </div>
                    
                    <!-- Setup Complete Button -->
                    <div style="margin-bottom: 20px;">
                        <button onclick="markBookmarkletSetupComplete()" style="
                            background: linear-gradient(135deg, #667eea, #764ba2);
                            color: white;
                            font-weight: 700;
                            font-size: 16px;
                            padding: 16px 24px;
                            border: none;
                            border-radius: 12px;
                            cursor: pointer;
                            width: 100%;
                            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                            transition: all 0.3s;
                        ">
                            ✅ I Have Completed Setup - Show Me Daily Usage Only
                        </button>
                        <div style="margin-top: 8px; font-size: 12px; text-align: center; opacity: 0.8;">
                            Click this after you've set up the bookmarklet once. Next time you'll only see daily usage instructions.
                        </div>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div style="display: flex; flex-direction: column; gap: 12px;">
                        <button id="openTargetSiteBtn1" data-url="${sanitizeForTemplateAttribute(targetUrl)}" style="
                            background: white;
                            color: #667eea;
                            font-weight: 700;
                            font-size: 16px;
                            padding: 16px;
                            border: none;
                            border-radius: 12px;
                            cursor: pointer;
                            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                            width: 100%;
                        ">
                            🌐 Open ${sanitizeForHTML(siteName)} in Browser to Test
                        </button>
                        
                        <button onclick="closeBookmarkletModal()" style="
                            background: rgba(255,255,255,0.2);
                            color: white;
                            font-weight: 600;
                            font-size: 15px;
                            padding: 14px;
                            border: none;
                            border-radius: 12px;
                            cursor: pointer;
                            width: 100%;
                        ">
                            ← Close Instructions
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Attach event listener for "Open in Browser" button
            const openBtn1 = modal.querySelector('#openTargetSiteBtn1');
            if (openBtn1) {
                openBtn1.addEventListener('click', () => {
                    const url = openBtn1.getAttribute('data-url');
                    window.location.href = url;
                });
            }
            
            // Store bookmarklet code for copy function
            // Now includes "javascript:" prefix automatically - no manual typing needed!
            window.mobileBookmarkletCode = bookmarkletCode;
            window.mobileBookmarkletCodeFull = bookmarkletCode;
            
            // Animate modal entry
            requestAnimationFrame(() => {
                modal.style.opacity = '0';
                modal.style.transition = 'opacity 0.3s';
                requestAnimationFrame(() => {
                    modal.style.opacity = '1';
                });
            });
        }
        
        /**
         * Copy mobile bookmarklet code to clipboard
         */
        async function copyMobileBookmarkletCode() {
            const code = window.mobileBookmarkletCode;
            const button = document.getElementById('copyBookmarkletBtn');
            const success = document.getElementById('copySuccess');
            
            try {
                await navigator.clipboard.writeText(code);
                button.innerHTML = '✅ Code Copied!';
                button.style.background = 'linear-gradient(135deg, #10b981, #059669)';
                success.style.display = 'block';
                showNotification('✅ Bookmarklet code copied! Now create a bookmark and paste it.');
                
                setTimeout(() => {
                    button.innerHTML = '📋 Copy Bookmarklet Code';
                }, 3000);
            } catch (error) {
                // Fallback for older browsers
                const textarea = document.createElement('textarea');
                textarea.value = code;
                textarea.style.position = 'fixed';
                textarea.style.opacity = '0';
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                
                button.innerHTML = '✅ Code Copied!';
                success.style.display = 'block';
                showNotification('✅ Bookmarklet code copied!');
                
                setTimeout(() => {
                    button.innerHTML = '📋 Copy Bookmarklet Code';
                }, 3000);
            }
        }
        
        /**
         * Copy snippet code to clipboard
         */
        async function copySnippetCode() {
            const code = generateSnippetCode();
            
            try {
                await navigator.clipboard.writeText(code);
                showNotification('✅ Snippet code copied! Now open DevTools (F12) → Sources → Snippets');
                return true;
            } catch (error) {
                // Fallback for older browsers
                const textarea = document.createElement('textarea');
                textarea.value = code;
                textarea.style.position = 'fixed';
                textarea.style.opacity = '0';
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                showNotification('✅ Snippet code copied! Now open DevTools (F12) → Sources → Snippets');
                return true;
            }
        }
        
        /* ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
         * BOOKMARKLET SYSTEM - Platform-specific installation
         * ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ */
        
        /**
         * Generate CSP-safe bookmarklet code for non-iOS devices
         * Extracts HTML directly and opens popup - NO external script injection
         * Works on ALL sites including Twitter/X (CSP-protected)
         * 
         * CRITICAL: Includes Twitter/X smart extraction (restored Nov 25, 2025)
         * - Detects x.com/twitter.com URLs
         * - Extracts main tweet using data-testid="tweet" selector
         * - Sends tweetOnlyHTML and mode in payload for clean formatting
         * 
         * @returns {string} - JavaScript bookmarklet code with 'javascript:' prefix
         */
        function generateNonIOSBookmarklet() {
            // Get the full base URL including subdirectory path (e.g., /archive on GitHub Pages)
            const currentPath = window.location.pathname.substring(0, window.location.pathname.lastIndexOf('/') + 1) || '/';
            const archiveOrigin = window.location.origin + currentPath.replace(/\/$/, '');
            const normalizedOrigin = archiveOrigin;
            
            // CSP-SAFE APPROACH: Extract HTML directly, open index.html popup, postMessage
            // This matches the proven working approach from archive-paste.html line 7825
            // index.html already has ARCHIVE_READY sender + ARCHIVE_EXTRACT receiver
            // FIXED: Date.now() inlined for cache-busting on EVERY click, not just during drag
            // RESTORED: Twitter/X smart extraction (was accidentally removed)
            // ADDED: Self-archive prevention - don't archive ArcHive itself
            const bookmarkletCodeWithoutPrefix = `(function(){'use strict';try{const h=window.location.hostname;if(h.includes('github.io')||h.includes('replit')||h.includes('repl.co')){alert('⚠️ You are on the ArcHive page!\\n\\nNavigate to the page you want to archive, then click the bookmarklet.');return;}const archiveUrl='${normalizedOrigin}/index.html?v='+Date.now()+'#desktop-extract';const html=document.documentElement.outerHTML;const url=window.location.href;const title=document.title;let mode='normal';let tweetOnlyHTML='';let repliesHTML=[];const isTwitter=url.includes('twitter.com')||url.includes('x.com');if(isTwitter){console.log('🐦 Twitter/X detected');const includeReplies=localStorage.getItem('archiveIncludeReplies')==='true';mode=includeReplies?'with-replies':'tweet-only';const mainTweet=document.querySelector('article[data-testid="tweet"]');if(mainTweet){tweetOnlyHTML=mainTweet.outerHTML;console.log('✅ Main tweet extracted:',tweetOnlyHTML.length,'chars');}if(includeReplies){document.querySelectorAll('div[data-testid="cellInnerDiv"]').forEach((cell,i)=>{if(i>0&&cell.querySelector('article[data-testid="tweet"]'))repliesHTML.push(cell.outerHTML);});console.log('✅ Extracted',repliesHTML.length,'replies');}if(!tweetOnlyHTML){console.warn('⚠️ Smart extraction failed, using full HTML');mode='normal';}}const w=window.open(archiveUrl,'_blank');if(!w){alert('⚠️ Please allow popups for ArcHive');return;}const hndlr=function(e){if(e.data&&e.data.type==='ARCHIVE_READY'){w.postMessage({type:'ARCHIVE_EXTRACT',html:html,title:title,url:url,source:window.location.hostname,mode:mode,tweetOnlyHTML:tweetOnlyHTML,repliesHTML:repliesHTML,extractedData:{title:title}},'${normalizedOrigin}');window.removeEventListener('message',hndlr);const n=document.createElement('div');n.style.cssText='position:fixed;top:20px;right:20px;background:#10b981;color:white;padding:16px 24px;border-radius:8px;font-family:sans-serif;font-size:14px;font-weight:600;z-index:999999;box-shadow:0 4px 12px rgba(0,0,0,0.3);';n.textContent='✅ Sent to ArcHive!';document.body.appendChild(n);setTimeout(()=>n.remove(),3000);}};window.addEventListener('message',hndlr);setTimeout(()=>window.removeEventListener('message',hndlr),10000);}catch(e){alert('❌ Failed to extract: '+e.message);}})()`;
            
            return "javascript:" + bookmarkletCodeWithoutPrefix;
        }
        
        /**
         * Create drag-able bookmarklet link element
         * Users drag this to their bookmarks bar for installation
         * 
         * @returns {HTMLElement} - Styled anchor element with bookmarklet code
         */
        function createBookmarkletLink() {
            const bookmarkletCode = generateNonIOSBookmarklet();
            
            const link = document.createElement('a');
            link.href = bookmarkletCode;
            link.textContent = 'ArcHive';
            link.draggable = true;
            
            // Professional styling - Golden button with red text
            link.style.cssText = `
                display: inline-block;
                padding: 16px 32px;
                background: linear-gradient(135deg, #FFD700, #DAA520, #B8860B);
                color: #E31337;
                font-size: 18px;
                font-weight: 700;
                border-radius: 12px;
                text-decoration: none;
                box-shadow: 0 4px 12px rgba(218, 165, 32, 0.4);
                cursor: move;
                transition: all 0.3s;
                user-select: none;
                -webkit-user-select: none;
                text-shadow: 0 0 10px rgba(227, 19, 55, 0.4), 0 0 20px rgba(227, 19, 55, 0.2);
            `;
            
            // Hover effects
            link.onmouseover = () => {
                link.style.transform = 'scale(1.05) translateY(-2px)';
                link.style.boxShadow = '0 6px 16px rgba(218, 165, 32, 0.5)';
            };
            
            link.onmouseout = () => {
                link.style.transform = 'scale(1) translateY(0)';
                link.style.boxShadow = '0 4px 12px rgba(218, 165, 32, 0.4)';
            };
            
            // Drag start feedback
            link.ondragstart = (e) => {
                link.style.opacity = '0.6';
                // Set drag data for better compatibility
                e.dataTransfer.effectAllowed = 'copy';
            };
            
            link.ondragend = () => {
                link.style.opacity = '1';
            };
            
            // Prevent default click (we want drag behavior)
            link.onclick = (e) => {
                e.preventDefault();
                showToast('info', '👆 Drag this button to your bookmarks bar to install');
            };
            
            return link;
        }
        
        /**
         * Show Non-iOS bookmarklet instructions modal
         * For Android mobile and Desktop users
         */
        function showNonIOSInstructions() {
            // Remove existing modal if any
            const existing = document.getElementById('bookmarkletModal');
            if (existing) existing.remove();
            
            const modal = document.createElement('div');
            modal.id = 'bookmarkletModal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100vw;
                height: 100vh;
                background: rgba(0, 0, 0, 0.85);
                backdrop-filter: blur(8px);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 100001;
                animation: fadeIn 0.3s;
                padding: 20px;
                box-sizing: border-box;
            `;
            
            const content = document.createElement('div');
            content.style.cssText = `
                background: white;
                border-radius: 24px;
                padding: 40px;
                max-width: 600px;
                width: 100%;
                max-height: 90vh;
                overflow-y: auto;
                box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
                animation: slideUp 0.4s;
            `;
            
            content.innerHTML = `
                <div style="text-align: center; margin-bottom: 28px;">
                    <div style="font-size: 64px; margin-bottom: 16px;">🤖💻</div>
                    <h2 style="color: #1f2937; font-size: 28px; font-weight: 800; margin: 0 0 8px 0;">
                        Android / Desktop Setup
                    </h2>
                    <p style="color: #6b7280; font-size: 14px; margin: 0;">
                        One-time setup • Grandma-proof • Works everywhere
                    </p>
                </div>
                
                <!-- What This Does - Explainer Section -->
                <div style="background: linear-gradient(135deg, #eff6ff, #dbeafe); border-radius: 16px; padding: 24px; margin-bottom: 28px; border: 3px solid #3b82f6;">
                    <div style="text-align: center; font-size: 20px; font-weight: 800; color: #1e40af; margin-bottom: 14px;">
                        💡 What This Does
                    </div>
                    <div style="color: #1e3a8a; font-size: 14px; line-height: 1.8;">
                        <p style="margin: 0 0 12px 0;">
                            <strong>🔖 Browser Bookmark:</strong> A special bookmark that runs JavaScript when clicked
                        </p>
                        <p style="margin: 0 0 12px 0;">
                            <strong>📱💻 Universal:</strong> Works on Android phones + Desktop computers (all browsers)
                        </p>
                        <p style="margin: 0 0 12px 0;">
                            <strong>⚡ One-Click Forever:</strong> Drag once to install, then click bookmark = instant extraction
                        </p>
                        <p style="margin: 0 0 12px 0;">
                            <strong>🛡️ Auto-Extracts:</strong> Click → Floating button appears → Content sent to ArcHive
                        </p>
                        <p style="margin: 0;">
                            <strong>🔒 Security:</strong> Validates origin + secure handshake ensures your data stays safe
                        </p>
                    </div>
                </div>
                
                <!-- ⚠️ UPDATE WARNING for Users with Old Bookmarklets -->
                <div style="background: linear-gradient(135deg, #fbbf24, #f59e0b); border-radius: 12px; padding: 20px; margin-bottom: 20px; border: 3px solid #d97706;">
                    <div style="text-align: center; font-size: 18px; font-weight: 800; color: #78350f; margin-bottom: 10px;">
                        ⚠️ Already Installed? Update Your Bookmark!
                    </div>
                    <div style="color: #78350f; font-size: 14px; line-height: 1.8;">
                        <p style="margin: 0 0 10px 0;">
                            <strong>If you previously installed ArcHive:</strong> Delete your old "ArcHive" bookmark and re-drag the button below to get the latest version with bug fixes!
                        </p>
                        <p style="margin: 0; font-size: 13px; opacity: 0.9;">
                            <em>Reason:</em> Old bookmarklets may show outdated UI or fail to archive content.
                        </p>
                    </div>
                </div>
                
                <!-- Step 1: Install Bookmarklet -->
                <div style="margin-bottom: 32px;">
                    <div style="display: flex; align-items: center; margin-bottom: 16px;">
                        <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 18px; margin-right: 12px; box-shadow: 0 4px 8px rgba(59, 130, 246, 0.3);">
                            1
                        </div>
                        <h3 style="color: #1f2937; font-size: 20px; font-weight: 800; margin: 0;">
                            Install Bookmarklet (Drag & Drop)
                        </h3>
                    </div>
                    
                    <div style="background: linear-gradient(135deg, #eff6ff, #dbeafe); border-radius: 12px; padding: 24px; margin-bottom: 16px; border: 3px solid #3b82f6;">
                        <p style="color: #1e40af; font-size: 16px; font-weight: 800; margin: 0 0 18px 0; text-align: center;">
                            🛡️ Drag the "ArcHive" button below to your bookmarks bar:
                        </p>
                        <div id="bookmarkletLinkContainer" style="text-align: center;">
                            <!-- Drag-able link will be inserted here -->
                        </div>
                    </div>
                    
                    <div style="background: #f0fdf4; border-left: 5px solid #10b981; padding: 14px 18px; border-radius: 8px; margin-top: 14px;">
                        <p style="color: #166534; font-size: 14px; margin: 0; line-height: 1.8; font-weight: 600;">
                            <strong>📱 Mobile:</strong> Long-press the button → "Add to Bookmarks"<br>
                            <strong>💻 Desktop:</strong> Drag the button to your bookmarks bar
                        </p>
                    </div>
                </div>
                
                <!-- Step 2: DAILY USAGE - PROMINENT SECTION -->
                <div style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); border-radius: 12px; padding: 25px; margin: 25px 0; border: 3px solid #047857;">
                    <h3 style="margin: 0 0 15px 0; font-size: 20px; font-weight: 700; color: white;">
                        🚀 DAILY USAGE - How to Archive Content
                    </h3>
                    <ol style="margin: 0; padding-left: 20px; line-height: 2; color: white; font-size: 15px;">
                        <li><strong>Go to ANY website</strong> you want to archive (Twitter, Reddit, Wikipedia, news, etc.)</li>
                        <li><strong>Click your bookmarklet</strong> in your bookmarks bar</li>
                        <li><strong>Done!</strong> ArcHive automatically pops up with extracted content ✨</li>
                    </ol>
                    <div style="background: rgba(0,0,0,0.2); border-radius: 8px; padding: 15px; margin-top: 15px;">
                        <strong>💡 Pro Tip:</strong> Works on <strong>ANY website</strong> - Twitter threads, Reddit posts, news articles, blog posts, Wikipedia pages, etc. One bookmark, unlimited archives! <strong>No URL input needed!</strong>
                    </div>
                </div>
                
                <!-- Features -->
                <div style="background: linear-gradient(135deg, #f0fdf4, #dcfce7); border-radius: 12px; padding: 20px; margin-bottom: 24px; border: 3px solid #10b981;">
                    <div style="text-align: center; margin-bottom: 12px;">
                        <span style="font-size: 24px;">✨</span>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; font-size: 13px; color: #166534;">
                        <div style="display: flex; align-items: center;">
                            <span style="margin-right: 6px;">⚡</span>
                            <span><strong>Auto-extract</strong> on click</span>
                        </div>
                        <div style="display: flex; align-items: center;">
                            <span style="margin-right: 6px;">🎯</span>
                            <span><strong>Persistent</strong> button</span>
                        </div>
                        <div style="display: flex; align-items: center;">
                            <span style="margin-right: 6px;">🔒</span>
                            <span><strong>Secure</strong> extraction</span>
                        </div>
                        <div style="display: flex; align-items: center;">
                            <span style="margin-right: 6px;">🌐</span>
                            <span><strong>Works</strong> everywhere</span>
                        </div>
                    </div>
                </div>
                
                <!-- Feature Comparison: Non-iOS vs iOS -->
                <div style="background: linear-gradient(135deg, #eff6ff, #dbeafe); border: 3px solid #3b82f6; border-radius: 16px; padding: 20px; margin-bottom: 24px;">
                    <div style="text-align: center; font-size: 17px; font-weight: 800; color: #1e40af; margin-bottom: 12px;">📊 Android/Desktop vs iOS</div>
                    <div style="color: #1e3a8a; font-size: 14px; line-height: 1.9;">
                        <div style="margin-bottom: 10px; padding: 10px; background: rgba(16,185,129,0.15); border-radius: 8px;">
                            <strong>🤖 Android/Desktop (This Method):</strong> 1-click bookmark • Persistent floating button • Instant auto-extract
                        </div>
                        <div style="padding: 10px; background: rgba(139,92,246,0.15); border-radius: 8px;">
                            <strong>📱 iOS/iPad:</strong> 2-tap via Share menu • Integrated with iOS • Works in all browsers
                        </div>
                    </div>
                </div>
                
                <!-- Close Button -->
                <button id="closeBookmarkletModal" style="
                    display: block;
                    width: 100%;
                    background: #f3f4f6;
                    color: #4b5563;
                    border: none;
                    padding: 14px;
                    border-radius: 12px;
                    font-size: 15px;
                    font-weight: 600;
                    cursor: pointer;
                    transition: all 0.2s;
                " onmouseover="this.style.background='#e5e7eb'" onmouseout="this.style.background='#f3f4f6'">
                    Close
                </button>
            `;
            
            modal.appendChild(content);
            document.body.appendChild(modal);
            
            // Insert drag-able bookmarklet link
            const linkContainer = document.getElementById('bookmarkletLinkContainer');
            linkContainer.appendChild(createBookmarkletLink());
            
            // Close button handler
            document.getElementById('closeBookmarkletModal').onclick = () => {
                modal.remove();
            };
            
            // Click outside to close
            modal.onclick = (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            };
        }
        
        /**
         * Platform Detection System
         * Detect iOS, Android, or Desktop for platform-specific instructions
         * NOW with iOS browser detection (Safari vs Chrome/Brave/Firefox)
         */
        function detectPlatform() {
            const ua = navigator.userAgent;
            
            // iPad detection: Check for explicit iPad OR MacOS with touch support (modern iPadOS)
            // CRITICAL: Modern iPadOS in desktop mode reports as "Macintosh" with Safari + touch support
            // We must exclude actual macOS Chrome/Firefox/Edge which also report as "Macintosh"
            const isIPad = /iPad/.test(ua) || (
                /Macintosh/.test(ua) && 
                navigator.maxTouchPoints && 
                navigator.maxTouchPoints > 1 &&
                /Safari/.test(ua) &&
                !/Chrome|CriOS|FxiOS|EdgiOS/.test(ua)  // Exclude macOS Chrome/Firefox/Edge
            );
            
            const isIPhone = /iPhone|iPod/.test(ua);
            const isIOS = isIPad || isIPhone;
            const isAndroid = /Android/.test(ua);
            const isMobile = isIOS || isAndroid;
            
            // iOS Browser Detection (Safari vs Chrome/Brave/Firefox/etc.)
            // All iOS browsers use WebKit, but we can detect which chrome/skin is being used
            let iosBrowser = 'safari'; // Default
            if (isIOS) {
                // Chrome on iOS: Has "CriOS" in user agent
                if (/CriOS/.test(ua)) {
                    iosBrowser = 'chrome';
                }
                // Firefox on iOS: Has "FxiOS" in user agent  
                else if (/FxiOS/.test(ua)) {
                    iosBrowser = 'firefox';
                }
                // Brave on iOS: Often no unique identifier, but we can check for brave:// scheme support
                // For now, we'll treat Brave same as other third-party browsers
                else if (/Brave/.test(ua)) {
                    iosBrowser = 'brave';
                }
                // Edge on iOS: Has "EdgiOS" in user agent
                else if (/EdgiOS/.test(ua)) {
                    iosBrowser = 'edge';
                }
                // DuckDuckGo on iOS: Has "DuckDuckGo" in user agent
                else if (/DuckDuckGo/.test(ua)) {
                    iosBrowser = 'duckduckgo';
                }
                // Safari: Default if none of the above
                // Check for "Safari" in UA and not one of the above browsers
                else if (/Safari/.test(ua) && !/CriOS|FxiOS|EdgiOS|DuckDuckGo/.test(ua)) {
                    iosBrowser = 'safari';
                }
            }
            
            // iOS Shortcuts support: Only Safari supports custom Shortcuts in Share menu
            const supportsIOSShortcuts = isIOS && iosBrowser === 'safari';
            
            return {
                isIOS,
                isAndroid,
                isMobile,
                isDesktop: !isMobile,
                platform: isIOS ? 'ios' : (isAndroid ? 'android' : 'desktop'),
                specificDevice: isIPad ? 'ipad' : (isIPhone ? 'iphone' : (isAndroid ? 'android' : 'desktop')),
                iosBrowser, // safari, chrome, firefox, brave, edge, duckduckgo
                supportsIOSShortcuts // true only for iOS Safari
            };
        }
        
        /**
         * Get user-friendly platform name
         */
        function getPlatformName(platform) {
            const names = {
                ios: '📱 iPhone/iPad',
                android: '🤖 Android',
                desktop: '💻 Desktop'
            };
            return names[platform] || '📱 Mobile';
        }
        
        /**
         * iOS Bookmarklet Setup - Simple 3-step guide
         * Replaces iOS Shortcuts (Nov 26, 2025) due to Apple signing verification issues
         * Updated Nov 26, 2025: iOS Chrome uses iframe overlay (no popup blocking)
         * Works reliably in Safari (popup) and Chrome (iframe) - one-time setup, then 1-tap archiving forever
         */
        function showIOSBookmarkletSetup() {
            const existing = document.getElementById('bookmarkletModal');
            if (existing) existing.remove();
            
            const platform = detectPlatform();
            const isIOSSafari = platform.isIOS && platform.iosBrowser === 'safari';
            const isIOSChrome = platform.isIOS && platform.iosBrowser === 'chrome';
            const isIOSFirefox = platform.isIOS && platform.iosBrowser === 'firefox';
            const isIOSOtherBrowser = platform.isIOS && !isIOSSafari;
            
            // Get the full base URL including subdirectory path (e.g., /archive on GitHub Pages)
            const currentPath = window.location.pathname.substring(0, window.location.pathname.lastIndexOf('/') + 1) || '/';
            const archiveBase = window.location.origin + currentPath.replace(/\/$/, '');
            const archiveOrigin = archiveBase;
            
            // iOS Safari: Use popup (works reliably)
            const bookmarkletCode = `javascript:(function(){'use strict';try{const archiveUrl='${archiveOrigin}/index.html?v='+Date.now()+'#mobile-extract';const html=document.documentElement.outerHTML;const url=window.location.href;const title=document.title;let mode='normal';let tweetOnlyHTML='';let repliesHTML=[];const isTwitter=url.includes('twitter.com')||url.includes('x.com');if(isTwitter){const mainTweet=document.querySelector('article[data-testid="tweet"]');if(mainTweet){tweetOnlyHTML=mainTweet.outerHTML;mode='tweet-only';}}const w=window.open(archiveUrl,'_blank');if(!w){alert('Please allow popups for ArcHive');return;}const h=function(e){if(e.data&&e.data.type==='ARCHIVE_READY'){w.postMessage({type:'ARCHIVE_EXTRACT',html:html,title:title,url:url,source:window.location.hostname,mode:mode,tweetOnlyHTML:tweetOnlyHTML,repliesHTML:repliesHTML},'${archiveOrigin}');window.removeEventListener('message',h);}};window.addEventListener('message',h);setTimeout(()=>window.removeEventListener('message',h),10000);}catch(e){alert('Error: '+e.message);}})()`;
            
            // If not Safari on iOS, show simple "use Safari" message
            if (isIOSOtherBrowser) {
                const modal = document.createElement('div');
                modal.id = 'bookmarkletModal';
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100vw;
                    height: 100vh;
                    background: rgba(0, 0, 0, 0.92);
                    z-index: 100000;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    padding: 20px;
                `;
                
                modal.innerHTML = `
                    <div style="
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                        border-radius: 20px;
                        padding: 30px;
                        max-width: 400px;
                        width: 100%;
                        box-shadow: 0 20px 60px rgba(0,0,0,0.5);
                        color: white;
                        text-align: center;
                        position: relative;
                    ">
                        <button onclick="closeBookmarkletModal()" style="
                            position: absolute;
                            top: 15px;
                            right: 15px;
                            background: rgba(255,255,255,0.2);
                            border: none;
                            color: white;
                            font-size: 28px;
                            cursor: pointer;
                            border-radius: 50%;
                            width: 44px;
                            height: 44px;
                        ">×</button>
                        
                        <div style="font-size: 56px; margin-bottom: 15px;">📱</div>
                        <h2 style="margin: 0 0 20px 0; font-size: 24px; font-weight: 700;">Use Safari Instead</h2>
                        
                        <div style="background: rgba(255,255,255,0.15); border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                            <ol style="margin: 0; padding-left: 20px; text-align: left; font-size: 16px; line-height: 2;">
                                <li>Tap the button below to copy the URL</li>
                                <li>Open <strong>Safari</strong></li>
                                <li>Paste and go</li>
                                <li>Tap <strong>"Get ArcHive"</strong></li>
                            </ol>
                        </div>
                        
                        <button onclick="navigator.clipboard.writeText(window.location.href).then(() => { this.innerHTML = '✅ Copied!'; this.style.background = '#10b981'; })" style="
                            background: white;
                            color: #764ba2;
                            font-weight: 700;
                            font-size: 17px;
                            padding: 18px 32px;
                            border: none;
                            border-radius: 12px;
                            cursor: pointer;
                            width: 100%;
                        ">
                            📋 Copy URL
                        </button>
                    </div>
                `;
                
                document.body.appendChild(modal);
                return;
            }
            
            // Safari detected - show success message
            const browserNote = '<div style="margin-top: 10px; padding: 12px; background: rgba(16,185,129,0.3); border-radius: 8px; font-size: 13px;">✅ <strong>Safari detected!</strong> Follow the steps below to set up ArcHive.</div>';
            
            const modal = document.createElement('div');
            modal.id = 'bookmarkletModal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100vw;
                height: 100vh;
                background: rgba(0, 0, 0, 0.92);
                z-index: 100000;
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 20px;
                overflow-y: auto;
            `;
            
            modal.innerHTML = `
                <div style="
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    border-radius: 20px;
                    padding: 30px;
                    max-width: 550px;
                    width: 100%;
                    max-height: 90vh;
                    overflow-y: auto;
                    box-shadow: 0 20px 60px rgba(0,0,0,0.5);
                    color: white;
                    position: relative;
                ">
                    <button onclick="closeBookmarkletModal()" style="
                        position: absolute;
                        top: 15px;
                        right: 15px;
                        background: rgba(255,255,255,0.2);
                        border: none;
                        color: white;
                        font-size: 28px;
                        cursor: pointer;
                        border-radius: 50%;
                        width: 44px;
                        height: 44px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                    " ontouchstart="this.style.background='rgba(255,255,255,0.4)'" ontouchend="this.style.background='rgba(255,255,255,0.2)'">×</button>
                    
                    <div style="font-size: 48px; text-align: center; margin-bottom: 15px;">📱</div>
                    <h2 style="margin: 0 0 10px 0; font-size: 26px; font-weight: 700; text-align: center;">iPhone/iPad Setup</h2>
                    <p style="margin: 0 0 15px 0; font-size: 15px; text-align: center; opacity: 0.95;">
                        One-time setup, then <strong>1-tap archiving</strong> forever!
                    </p>
                    ${browserNote}
                    
                    <!-- Step 1: Copy Code -->
                    <div style="background: rgba(255,255,255,0.15); border-radius: 16px; padding: 20px; margin-bottom: 16px; margin-top: 16px;">
                        <div style="display: flex; align-items: center; margin-bottom: 12px;">
                            <div style="width: 36px; height: 36px; background: linear-gradient(135deg, #10b981, #059669); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 16px; margin-right: 12px;">1</div>
                            <div style="font-size: 18px; font-weight: 700;">Copy the Code</div>
                        </div>
                        <p style="margin: 0 0 12px 0; font-size: 14px; opacity: 0.95;">
                            Tap button to copy the bookmarklet code:
                        </p>
                        <button id="iosCopyBtn" style="
                            background: linear-gradient(135deg, #10b981, #059669);
                            color: white;
                            font-weight: 700;
                            font-size: 16px;
                            padding: 16px 24px;
                            border: none;
                            border-radius: 12px;
                            cursor: pointer;
                            width: 100%;
                            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
                        ">
                            📋 TAP TO COPY CODE
                        </button>
                        <div id="iosCopyStatus" style="margin-top: 10px; font-size: 13px; text-align: center; opacity: 0.9;"></div>
                    </div>
                    
                    <!-- Step 2: Create Bookmark -->
                    <div style="background: rgba(255,255,255,0.15); border-radius: 16px; padding: 20px; margin-bottom: 16px;">
                        <div style="display: flex; align-items: center; margin-bottom: 12px;">
                            <div style="width: 36px; height: 36px; background: linear-gradient(135deg, #6366f1, #4f46e5); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 16px; margin-right: 12px;">2</div>
                            <div style="font-size: 18px; font-weight: 700;">Create a Bookmark</div>
                        </div>
                        <ol style="margin: 0; padding-left: 20px; font-size: 14px; line-height: 1.9;">
                            <li>Tap the <strong>Share button</strong> ⬆️ (bottom of Safari)</li>
                            <li>Tap <strong>"Add Bookmark"</strong></li>
                            <li>Name is already <strong>"ArcHive"</strong> → Tap <strong>Save</strong></li>
                        </ol>
                        <div style="margin-top: 10px; padding: 8px; background: rgba(16,185,129,0.25); border-radius: 6px; font-size: 13px;">
                            ✅ Name auto-fills from page title - no typing needed!
                        </div>
                    </div>
                    
                    <!-- Step 3: Edit Bookmark -->
                    <div style="background: rgba(255,255,255,0.15); border-radius: 16px; padding: 20px; margin-bottom: 16px;">
                        <div style="display: flex; align-items: center; margin-bottom: 12px;">
                            <div style="width: 36px; height: 36px; background: linear-gradient(135deg, #f59e0b, #d97706); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 16px; margin-right: 12px;">3</div>
                            <div style="font-size: 18px; font-weight: 700;">Paste the Code</div>
                        </div>
                        <ol style="margin: 0; padding-left: 20px; font-size: 14px; line-height: 1.9;">
                            <li>Tap the <strong>Bookmarks icon</strong> 📖 (bottom of Safari)</li>
                            <li>Tap <strong>"Edit"</strong> (bottom right)</li>
                            <li>Tap your <strong>"ArcHive"</strong> bookmark</li>
                            <li><strong>Delete</strong> the URL → <strong>Paste</strong> the copied code</li>
                            <li>Tap <strong>Done</strong></li>
                        </ol>
                    </div>
                    
                    <!-- Daily Use -->
                    <div style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); border-radius: 12px; padding: 20px; margin-bottom: 16px;">
                        <div style="font-size: 18px; font-weight: 700; margin-bottom: 10px;">🎯 Daily Use - Super Simple!</div>
                        <ol style="margin: 0; padding-left: 20px; font-size: 15px; line-height: 1.8;">
                            <li>Go to <strong>any webpage</strong> you want to archive</li>
                            <li>Tap <strong>Bookmarks</strong> 📖 → Tap <strong>"ArcHive"</strong></li>
                            <li><strong>Done!</strong> Content extracted automatically</li>
                        </ol>
                    </div>
                    
                    <!-- Switch to Android -->
                    <div style="text-align: center; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.2);">
                        <button onclick="closeBookmarkletModal(); showNonIOSInstructions();" style="
                            background: rgba(255,255,255,0.2);
                            color: white;
                            border: 1px solid rgba(255,255,255,0.3);
                            padding: 10px 20px;
                            border-radius: 20px;
                            font-size: 14px;
                            cursor: pointer;
                        ">
                            🤖 Wrong device? Switch to Android/Desktop
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Add copy functionality
            const copyBtn = document.getElementById('iosCopyBtn');
            const statusDiv = document.getElementById('iosCopyStatus');
            
            copyBtn.onclick = async () => {
                try {
                    await navigator.clipboard.writeText(bookmarkletCode);
                    copyBtn.innerHTML = '✅ COPIED!';
                    copyBtn.style.background = 'linear-gradient(135deg, #22c55e, #16a34a)';
                    statusDiv.textContent = 'Code copied! Now follow steps 2 and 3 above.';
                    
                    setTimeout(() => {
                        copyBtn.innerHTML = '📋 TAP TO COPY CODE';
                        copyBtn.style.background = 'linear-gradient(135deg, #10b981, #059669)';
                    }, 3000);
                } catch (e) {
                    // Fallback for older browsers
                    const ta = document.createElement('textarea');
                    ta.value = bookmarkletCode;
                    ta.style.cssText = 'position:fixed;opacity:0;';
                    document.body.appendChild(ta);
                    ta.select();
                    document.execCommand('copy');
                    document.body.removeChild(ta);
                    
                    copyBtn.innerHTML = '✅ COPIED!';
                    copyBtn.style.background = 'linear-gradient(135deg, #22c55e, #16a34a)';
                    statusDiv.textContent = 'Code copied! Now follow steps 2 and 3 above.';
                }
            };
            
            console.log('📱 iOS Bookmarklet Setup modal displayed');
        }
        
        /**
         * Smart bookmarklet installer - auto-detects platform
         * Entry point for "Get ArcHive" button on homepage
         * Updated Nov 26, 2025: iOS now uses bookmarklet (Shortcuts removed due to Apple signing issues)
         * Updated Dec 7, 2025: Android browsers don't support bookmarklets - show alternative
         */
        function showBookmarkletInstructions() {
            const platform = detectPlatform();
            
            if (platform.isIOS) {
                // iOS now uses bookmarklet setup (same approach, iOS-specific instructions)
                console.log(`📱 Platform: iOS ${platform.iosBrowser || 'Safari'} - showing iOS bookmarklet setup`);
                showIOSBookmarkletSetup();
            } else if (platform.isAndroid) {
                // Android: Bookmarklets don't work in Chrome/Firefox - show alternative
                console.log(`🤖 Platform: Android - showing URL input instructions (bookmarklets unsupported)`);
                showAndroidAlternativeFlow();
            } else {
                // Desktop: Show unified bookmarklet
                console.log(`💻 Platform: Desktop - showing bookmarklet instructions`);
                showNonIOSInstructions();
            }
        }
        
        /**
         * Android Alternative Flow
         * Since bookmarklets don't work in Android browsers, direct users to the URL input
         */
        function showAndroidAlternativeFlow() {
            const existing = document.getElementById('bookmarkletModal');
            if (existing) existing.remove();
            
            const modal = document.createElement('div');
            modal.id = 'bookmarkletModal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100vw;
                height: 100vh;
                background: rgba(0, 0, 0, 0.92);
                z-index: 100000;
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 20px;
                overflow-y: auto;
            `;
            
            modal.innerHTML = `
                <div style="
                    background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
                    border-radius: 20px;
                    padding: 30px;
                    max-width: 500px;
                    width: 100%;
                    max-height: 90vh;
                    overflow-y: auto;
                    box-shadow: 0 20px 60px rgba(0,0,0,0.5);
                    color: white;
                    position: relative;
                ">
                    <button onclick="closeBookmarkletModal()" style="
                        position: absolute;
                        top: 20px;
                        right: 20px;
                        background: rgba(255,255,255,0.2);
                        border: none;
                        color: white;
                        font-size: 24px;
                        width: 40px;
                        height: 40px;
                        border-radius: 50%;
                        cursor: pointer;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-weight: 700;
                        transition: all 0.2s;
                        min-height: 44px;
                        min-width: 44px;
                    " onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">×</button>
                    
                    <div style="text-align: center; margin-bottom: 24px;">
                        <div style="font-size: 48px; margin-bottom: 12px;">🤖</div>
                        <h2 style="margin: 0 0 8px 0; font-size: 24px; font-weight: 800;">Archive on Android</h2>
                        <p style="margin: 0; opacity: 0.9; font-size: 15px;">Direct URL method works on all browsers</p>
                    </div>
                    
                    <div style="background: rgba(255,255,255,0.15); border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                        <div style="font-size: 16px; font-weight: 700; margin-bottom: 12px;">📋 How to Archive on Android:</div>
                        <ol style="margin: 0; padding-left: 20px; font-size: 15px; line-height: 2.2;">
                            <li><strong>Copy the URL</strong> of the website you want to archive</li>
                            <li><strong>Come back to ArcHive</strong> (this page)</li>
                            <li><strong>Paste the URL</strong> in the search box at the bottom</li>
                            <li><strong>Tap the shield icon</strong> 🛡️ to archive</li>
                            <li><strong>Sign in with HAS</strong> to post to Hive blockchain</li>
                        </ol>
                    </div>
                    
                    <div style="background: rgba(0,0,0,0.2); border-radius: 12px; padding: 16px; margin-bottom: 20px;">
                        <div style="font-size: 13px; opacity: 0.9; line-height: 1.8;">
                            <strong>💡 Why bookmarklets don't work:</strong> Android browsers (Chrome, Firefox, Brave, etc) block bookmarklets for security reasons. The URL input method is just as fast!
                        </div>
                    </div>
                    
                    <button onclick="closeBookmarkletModal(); window.scrollTo(0, 0);" style="
                        background: white;
                        color: #d97706;
                        font-weight: 700;
                        font-size: 16px;
                        padding: 16px 32px;
                        border: none;
                        border-radius: 12px;
                        cursor: pointer;
                        width: 100%;
                        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                        min-height: 44px;
                        transition: all 0.2s;
                    " onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
                        ✅ Got it! Use URL Method
                    </button>
                </div>
            `;
            
            document.body.appendChild(modal);
            console.log('✅ Android alternative flow displayed');
        }
        
        /**
         * iOS Daily Use Instructions (for users who already set up bookmarklet)
         */
        function showIOSDailyUseInstructions(targetUrl, siteName) {
            const existing = document.getElementById('bookmarkletModal');
            if (existing) existing.remove();
            
            const displayUrl = targetUrl || 'example.com';
            const displayName = siteName || 'this website';
            
            const modal = document.createElement('div');
            modal.id = 'bookmarkletModal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100vw;
                height: 100vh;
                background: rgba(0, 0, 0, 0.92);
                z-index: 100000;
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 20px;
                overflow-y: auto;
            `;
            
            modal.innerHTML = `
                <div style="
                    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
                    border-radius: 20px;
                    padding: 30px;
                    max-width: 500px;
                    width: 100%;
                    max-height: 90vh;
                    overflow-y: auto;
                    box-shadow: 0 20px 60px rgba(0,0,0,0.5);
                    color: white;
                    position: relative;
                ">
                    <button onclick="closeBookmarkletModal()" style="
                        position: absolute;
                        top: 20px;
                        right: 20px;
                        background: rgba(255,255,255,0.2);
                        border: none;
                        color: white;
                        font-size: 24px;
                        width: 40px;
                        height: 40px;
                        border-radius: 50%;
                        cursor: pointer;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-weight: 700;
                        transition: all 0.2s;
                    " onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">×</button>
                    
                    <div style="text-align: center; margin-bottom: 24px;">
                        <div style="font-size: 48px; margin-bottom: 12px;">✅</div>
                        <h2 style="margin: 0 0 8px 0; font-size: 24px; font-weight: 800;">How to Archive Content</h2>
                        <p style="margin: 0; opacity: 0.9; font-size: 15px;">You're all set up!</p>
                    </div>
                    
                    <div style="background: rgba(255,255,255,0.15); border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                        <div style="font-size: 18px; font-weight: 700; margin-bottom: 12px;">📱 3 Simple Steps:</div>
                        <ol style="margin: 0; padding-left: 20px; font-size: 15px; line-height: 2;">
                            <li><strong>Open the website</strong> you want to archive</li>
                            <li>Tap the <strong>Share</strong> button <span style="font-size: 18px;">⎙</span> in Safari</li>
                            <li>Select <strong>"ArcHive Extractor"</strong> from your shortcuts</li>
                        </ol>
                        <div style="margin-top: 16px; padding: 12px; background: rgba(16, 185, 129, 0.3); border-radius: 8px; font-size: 13px;">
                            ✨ <strong>That's it!</strong> The archive popup will open automatically with extracted content.
                        </div>
                    </div>
                    
                    ${targetUrl ? `
                    <div style="margin-top: 20px; text-align: center;">
                        <button onclick="window.open('${targetUrl}', '_blank', 'noopener'); closeBookmarkletModal();" style="
                            background: linear-gradient(135deg, #6366f1, #4f46e5);
                            color: white;
                            font-weight: 700;
                            font-size: 16px;
                            padding: 16px 32px;
                            border: none;
                            border-radius: 12px;
                            cursor: pointer;
                            width: 100%;
                            box-shadow: 0 6px 20px rgba(99, 102, 241, 0.4);
                            transition: all 0.3s;
                        " onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
                            🔗 Open ${displayName} in New Tab
                        </button>
                        <p style="margin-top: 12px; font-size: 13px; opacity: 0.8;">Then use the Share button to archive it!</p>
                    </div>
                    ` : ''}
                    
                    <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.2); text-align: center; font-size: 13px; opacity: 0.8;">
                        <p style="margin: 0;">💡 <strong>Tip:</strong> You can also archive this page from your browser history anytime!</p>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            console.log('✅ iOS daily use instructions displayed');
        }
        
        /**
         * iOS Shortcuts Manual Setup Guide - TIER 2 ENHANCED
         * Streamlined 3-step setup with one-tap Shortcuts editor launch
         * Features: Twitter/X smart extraction, shortcuts:// URL scheme integration
         * Updated: Nov 25, 2025
         */
        function showIOSManualSetupGuide() {
            const existing = document.getElementById('bookmarkletModal');
            if (existing) existing.remove();
            
            // Get dynamic origin for the shortcut code
            const archiveOrigin = window.location.origin;
            
            // Pre-configured JavaScript code WITH Twitter/X smart extraction
            // Returns URL via completion() for the Shortcut's "Open URLs" action
            // Uses Set Variable workaround for iOS 18 bug (Nov 26, 2025)
            const jsCode = `(function() {
try {
  var ORIGIN = '${archiveOrigin}';
  var pageUrl = window.location.href;
  var pageTitle = document.title || 'Untitled';
  var tweetText = '';
  var tweetAuthor = '';
  var mode = 'normal';
  
  // Twitter/X Smart Extraction
  if (pageUrl.indexOf('twitter.com') !== -1 || pageUrl.indexOf('x.com') !== -1) {
    mode = 'tweet-only';
    var tweet = document.querySelector('article[data-testid="tweet"]');
    if (tweet) {
      var textEl = tweet.querySelector('[data-testid="tweetText"]');
      if (textEl) tweetText = textEl.innerText;
      var authorEl = tweet.querySelector('a[role="link"][href*="/"]');
      if (authorEl) tweetAuthor = authorEl.textContent;
    }
  }
  
  // Build compact data
  var data = {
    u: pageUrl,
    t: pageTitle.substring(0, 200),
    m: mode,
    tw: tweetText.substring(0, 2000),
    a: tweetAuthor.substring(0, 100),
    s: window.location.hostname
  };
  
  // Encode as base64
  var encoded = btoa(unescape(encodeURIComponent(JSON.stringify(data))));
  
  // Build the archive URL - use ?ios= format (more reliable than hash)
  var archiveUrl = ORIGIN + '/index.html?ios=' + encoded;
  
  // Return URL for Shortcuts to open
  completion(archiveUrl);
} catch (e) {
  // Show error to user for debugging
  alert('ArcHive Error: ' + e.message);
  completion('');
}
})();`;
            
            const modal = document.createElement('div');
            modal.id = 'bookmarkletModal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100vw;
                height: 100vh;
                background: rgba(0, 0, 0, 0.92);
                z-index: 100000;
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 20px;
                overflow-y: auto;
            `;
            
            modal.innerHTML = `
                <div style="
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    border-radius: 20px;
                    padding: 30px;
                    max-width: 500px;
                    width: 100%;
                    max-height: 90vh;
                    overflow-y: auto;
                    box-shadow: 0 20px 60px rgba(0,0,0,0.5);
                    color: white;
                    position: relative;
                ">
                    <!-- Close Button -->
                    <button onclick="closeBookmarkletModal()" style="
                        position: absolute;
                        top: 15px;
                        right: 15px;
                        background: rgba(255,255,255,0.2);
                        border: none;
                        color: white;
                        font-size: 28px;
                        cursor: pointer;
                        border-radius: 50%;
                        width: 44px;
                        height: 44px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        transition: all 0.3s;
                    " ontouchstart="this.style.background='rgba(255,255,255,0.4)'" ontouchend="this.style.background='rgba(255,255,255,0.2)'">×</button>
                    
                    <!-- Header -->
                    <div style="font-size: 48px; text-align: center; margin-bottom: 15px;">📱</div>
                    <h2 style="margin: 0 0 10px 0; font-size: 26px; font-weight: 700; text-align: center;">Mobile Setup</h2>
                    <p style="margin: 0 0 25px 0; font-size: 15px; text-align: center; opacity: 0.95;">
                        One-tap install for Safari Share Sheet
                    </p>
                    
                    <!-- DOWNLOAD BUTTON -->
                    <button onclick="downloadIOSShortcut()" style="
                        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
                        color: white;
                        font-size: 24px;
                        font-weight: 800;
                        padding: 28px;
                        border: none;
                        border-radius: 20px;
                        cursor: pointer;
                        width: 100%;
                        text-align: center;
                        box-shadow: 0 10px 30px rgba(16, 185, 129, 0.5);
                        transition: all 0.3s ease;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        gap: 14px;
                        margin-bottom: 25px;
                    " ontouchstart="this.style.transform='scale(0.97)'" ontouchend="this.style.transform='scale(1)'">
                        <span style="font-size: 32px;">⬇️</span>
                        <span>Download Shortcut</span>
                    </button>
                    
                    <!-- Simple Instructions -->
                    <div style="background: rgba(255,255,255,0.15); border-radius: 16px; padding: 24px; margin-bottom: 20px;">
                        <div style="font-weight: 700; font-size: 18px; margin-bottom: 20px; text-align: center;">After Download:</div>
                        
                        <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 18px;">
                            <div style="background: linear-gradient(135deg, #10b981, #059669); width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 20px; flex-shrink: 0;">1</div>
                            <div style="font-size: 16px;">Tap <strong>"Open"</strong> when prompted</div>
                        </div>
                        
                        <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 18px;">
                            <div style="background: linear-gradient(135deg, #6366f1, #4f46e5); width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 20px; flex-shrink: 0;">2</div>
                            <div style="font-size: 16px;">Tap <strong>"Add Shortcut"</strong></div>
                        </div>
                        
                        <div style="display: flex; align-items: center; gap: 16px;">
                            <div style="background: linear-gradient(135deg, #f59e0b, #d97706); width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 20px; flex-shrink: 0;">3</div>
                            <div style="font-size: 16px;"><strong>Done!</strong> Ready to use</div>
                        </div>
                    </div>
                    
                    <!-- How to Use -->
                    <div style="background: rgba(16,185,129,0.2); border: 2px solid rgba(16,185,129,0.4); border-radius: 16px; padding: 20px; text-align: center;">
                        <div style="font-weight: 700; font-size: 18px; margin-bottom: 10px;">How to Archive:</div>
                        <div style="font-size: 16px; line-height: 1.6;">
                            Open any webpage → Tap <strong>Share</strong> ⬆️<br>
                            → Select <strong>"ArcHive Extractor"</strong>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            console.log('📱 Mobile Setup modal displayed - simplified one-click download');
        }
        
        /**
         * Complete iOS Manual Setup (after user finishes creating shortcut)
         */
        function completeIOSManualSetup() {
            console.log('🎯 Completing iOS manual setup...');
            
            // Close the modal
            const modal = document.getElementById('bookmarkletModal');
            if (modal) {
                modal.remove();
                console.log('✅ Manual setup modal closed');
            }
            
            // Set setup completed flag
            localStorage.setItem('archive_ios_setup_completed', 'true');
            console.log('✅ Setup completion flag set');
            
            // Hide setup instructions
            const container = document.getElementById('setupInstructionsContainer');
            const button = document.getElementById('toggleSetupText');
            if (container && button) {
                container.style.display = 'none';
                button.textContent = 'Show Setup Instructions';
                localStorage.setItem('archiveSetupHidden', 'true');
                console.log('✅ Setup instructions hidden');
            }
            
            // Show success banner
            showNotification('🎉 Setup complete! Your shortcut is ready to use!', 5000);
            
            // Focus on search input
            const sourceUrlInput = document.getElementById('sourceUrlInput');
            if (sourceUrlInput) {
                sourceUrlInput.focus();
                console.log('✅ Search input focused');
            }
            
            console.log('✅ iOS manual setup completed successfully');
        }
        
        /**
         * Toggle collapsible sections
         */
        function toggleCollapsible(id) {
            const content = document.getElementById(id + 'Content');
            const icon = document.getElementById(id + 'Icon');
            
            if (content && icon) {
                if (content.style.maxHeight === '0px' || content.style.maxHeight === '') {
                    content.style.maxHeight = '1000px';
                    icon.textContent = '▲';
                } else {
                    content.style.maxHeight = '0';
                    icon.textContent = '▼';
                }
            }
        }
        
        /**
         * iOS Chrome/Brave/Firefox: Bookmarklet Instructions
         * iOS Shortcuts don't work in third-party browsers (Apple limitation)
         * Solution: Use bookmarklet instead (fits ~2000 char iOS limit at 1077 chars)
         */
        function showIOSBookmarkletInstructions(browserName) {
            // Check if setup is already completed
            const setupCompleted = localStorage.getItem('archive_ios_bookmarklet_setup_completed') === 'true';
            
            if (setupCompleted) {
                // User already completed setup - don't show modal again
                console.log('✅ iOS bookmarklet setup already completed - skipping modal');
                showNotification('✅ You already have ArcHive set up! Visit any website and tap your ArcHive bookmark.');
                return;
            }
            
            // Check if user declined Safari and wants manual setup
            const safariDeclined = sessionStorage.getItem('safari_switch_declined') === 'true';
            
            if (!safariDeclined) {
                // Show Safari recommendation first
                showSafariSwitchRecommendation(browserName);
            } else {
                // User declined Safari, show manual bookmarklet instructions
                showManualBookmarkletInstructions(browserName);
            }
        }
        
        /**
         * Show Safari Switch Recommendation (Step 1)
         */
        function showSafariSwitchRecommendation(browserName) {
            const existing = document.getElementById('bookmarkletModal');
            if (existing) existing.remove();
            
            const browserDisplayNames = {
                chrome: 'Chrome',
                brave: 'Brave',
                firefox: 'Firefox',
                edge: 'Edge',
                duckduckgo: 'DuckDuckGo'
            };
            const displayBrowser = browserDisplayNames[browserName] || browserName;
            
            const modal = document.createElement('div');
            modal.id = 'bookmarkletModal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100vw;
                height: 100vh;
                background: rgba(0, 0, 0, 0.92);
                z-index: 100000;
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 20px;
                overflow-y: auto;
            `;
            
            modal.innerHTML = `
                <div style="
                    background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
                    border-radius: 20px;
                    padding: 30px;
                    max-width: 500px;
                    width: 100%;
                    box-shadow: 0 20px 60px rgba(0,0,0,0.5);
                    color: white;
                    position: relative;
                ">
                    <button onclick="declineSafariAndShowManual('${browserName}')" style="
                        position: absolute;
                        top: 15px;
                        right: 15px;
                        background: rgba(255,255,255,0.2);
                        border: none;
                        color: white;
                        font-size: 28px;
                        cursor: pointer;
                        border-radius: 50%;
                        width: 44px;
                        height: 44px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        transition: all 0.3s;
                    " ontouchstart="this.style.background='rgba(255,255,255,0.4)'" ontouchend="this.style.background='rgba(255,255,255,0.2)'">×</button>
                    
                    <div style="font-size: 64px; text-align: center; margin-bottom: 20px;">🍎✨</div>
                    <h2 style="margin: 0 0 15px 0; font-size: 28px; font-weight: 700; text-align: center;">Easiest Setup: Use Safari!</h2>
                    <p style="margin: 0 0 20px 0; font-size: 16px; text-align: center; line-height: 1.6;">
                        Safari has <strong>one-tap iOS Shortcuts</strong> (no manual bookmark setup needed)
                    </p>
                    
                    <div style="background: rgba(0,0,0,0.2); border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                        <div style="font-size: 17px; font-weight: 700; margin-bottom: 12px; text-align: center;">📱 3-Second Switch:</div>
                        <ol style="margin: 0; padding-left: 24px; line-height: 2.2; font-size: 15px;">
                            <li><strong>Tap Share</strong> (square with arrow) in ${displayBrowser}</li>
                            <li><strong>Tap "Open in Safari"</strong></li>
                            <li><strong>Download shortcut</strong> in Safari - Done! 🎉</li>
                        </ol>
                    </div>
                    
                    <div style="background: rgba(16,185,129,0.25); border-radius: 10px; padding: 15px; margin-bottom: 20px; border-left: 4px solid #10b981;">
                        <div style="font-size: 14px; font-weight: 600; margin-bottom: 6px;">💡 Bonus Tip:</div>
                        <div style="font-size: 13px; line-height: 1.6;">
                            Once you have Safari's shortcut, you can archive content from <strong>ANY browser</strong>!<br>
                            ${displayBrowser} page → Share → Open in Safari → Share → ArcHive Extract
                        </div>
                    </div>
                    
                    <div style="text-align: center; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.3);">
                        <div style="font-size: 13px; opacity: 0.85; margin-bottom: 8px;">
                            Click × above to see ${displayBrowser} manual setup instead
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            console.log(`✅ Safari switch recommendation shown for iOS ${displayBrowser}`);
        }
        
        /**
         * User declined Safari, show manual bookmarklet instructions
         */
        function declineSafariAndShowManual(browserName) {
            // Save preference for this session
            sessionStorage.setItem('safari_switch_declined', 'true');
            
            // Close current modal
            const modal = document.getElementById('bookmarkletModal');
            if (modal) modal.remove();
            
            // Show manual instructions
            setTimeout(() => {
                showManualBookmarkletInstructions(browserName);
            }, 200);
        }
        
        /**
         * Show Manual Bookmarklet Instructions (Step 2 - if Safari declined)
         */
        function showManualBookmarkletInstructions(browserName) {
            const existing = document.getElementById('bookmarkletModal');
            if (existing) existing.remove();
            
            // Friendly browser names
            const browserDisplayNames = {
                chrome: 'Chrome',
                brave: 'Brave',
                firefox: 'Firefox',
                edge: 'Edge',
                duckduckgo: 'DuckDuckGo'
            };
            const displayBrowser = browserDisplayNames[browserName] || browserName;
            
            // Generate bookmarklet code
            // RESTORED: Twitter/X smart extraction (Nov 25, 2025)
            // Get the full base URL including subdirectory path (e.g., /archive on GitHub Pages)
            const currentPath = window.location.pathname.substring(0, window.location.pathname.lastIndexOf('/') + 1) || '/';
            const archiveBase = window.location.origin + currentPath.replace(/\/$/, '');
            const archiveUrl = archiveBase + '/index.html#mobile-extract';
            const archiveOrigin = archiveBase;
            const bookmarkletCodeWithoutPrefix = `(function(){'use strict';const showToast=function(msg,type='info'){const n=document.createElement('div');const bgColor=type==='error'?'#ef4444':type==='success'?'#10b981':'#f59e0b';n.style.cssText='position:fixed;'+((type==='error'||type==='warning')?'top:50%;left:50%;transform:translate(-50%,-50%);':'bottom:20px;left:50%;transform:translateX(-50%);')+'background:'+bgColor+';color:white;padding:'+(type==='error'?'20px 24px':'16px 24px')+';border-radius:'+(type==='error'?'12px':'8px')+';font-family:sans-serif;font-size:14px;font-weight:600;z-index:999999;box-shadow:0 '+(type==='error'?'8':'4')+'px '+(type==='error'?'16':'12')+'px rgba(0,0,0,0.'+(type==='error'?'2':'3')+');max-width:90vw;text-align:center;';n.textContent=msg;document.body.appendChild(n);setTimeout(()=>{n.style.opacity='0';n.style.transition='opacity 0.3s';setTimeout(()=>n.remove(),300);},type==='error'?5000:3000);};try{const html=document.documentElement.outerHTML;const url=window.location.href;const title=document.title;let mode='normal';let tweetOnlyHTML='';let repliesHTML=[];const isTwitter=url.includes('twitter.com')||url.includes('x.com');if(isTwitter){console.log('🐦 Twitter/X detected');const includeReplies=localStorage.getItem('archiveIncludeReplies')==='true';mode=includeReplies?'with-replies':'tweet-only';const mainTweet=document.querySelector('article[data-testid="tweet"]');if(mainTweet){tweetOnlyHTML=mainTweet.outerHTML;console.log('✅ Main tweet extracted:',tweetOnlyHTML.length,'chars');}if(includeReplies){document.querySelectorAll('div[data-testid="cellInnerDiv"]').forEach((cell,i)=>{if(i>0&&cell.querySelector('article[data-testid="tweet"]'))repliesHTML.push(cell.outerHTML);});console.log('✅ Extracted',repliesHTML.length,'replies');}if(!tweetOnlyHTML){console.warn('⚠️ Smart extraction failed, using full HTML');mode='normal';}}const w=window.open('${archiveUrl}','_blank');if(!w){showToast('⚠️ Popups blocked.\\nPlease enable popups in browser settings to use ArcHive bookmarklet.','warning');return;}const h=function(e){if(e.data&&e.data.type==='ARCHIVE_READY'){w.postMessage({type:'ARCHIVE_EXTRACT',html:html,title:title,url:url,source:window.location.hostname,mode:mode,tweetOnlyHTML:tweetOnlyHTML,repliesHTML:repliesHTML,extractedData:{title:title}},'${archiveOrigin}');window.removeEventListener('message',h);showToast('✅ Sent to ArcHive!','success');}};window.addEventListener('message',h);setTimeout(()=>window.removeEventListener('message',h),10000);}catch(e){showToast('❌ Error: '+e.message,'error');}}})()`;
            const bookmarkletCode = `javascript:${bookmarkletCodeWithoutPrefix}`;
            
            console.log(`📊 iOS ${displayBrowser} bookmarklet size: ${bookmarkletCode.length} chars (fits 2000 char iOS limit)`);
            
            const modal = document.createElement('div');
            modal.id = 'bookmarkletModal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100vw;
                height: 100vh;
                background: rgba(0, 0, 0, 0.92);
                z-index: 100000;
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 20px;
                overflow-y: auto;
            `;
            
            modal.innerHTML = `
                <div style="
                    background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
                    border-radius: 20px;
                    padding: 30px;
                    max-width: 550px;
                    width: 100%;
                    max-height: 90vh;
                    overflow-y: auto;
                    box-shadow: 0 20px 60px rgba(0,0,0,0.5);
                    color: white;
                    position: relative;
                ">
                    <button onclick="closeBookmarkletModal()" style="
                        position: absolute;
                        top: 15px;
                        right: 15px;
                        background: rgba(255,255,255,0.2);
                        border: none;
                        color: white;
                        font-size: 28px;
                        cursor: pointer;
                        border-radius: 50%;
                        width: 44px;
                        height: 44px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        transition: all 0.3s;
                    " ontouchstart="this.style.background='rgba(255,255,255,0.4)'" ontouchend="this.style.background='rgba(255,255,255,0.2)'">×</button>
                    
                    <div style="font-size: 48px; text-align: center; margin-bottom: 15px;">📱🔖</div>
                    <h2 style="margin: 0 0 10px 0; font-size: 26px; font-weight: 700; text-align: center;">iOS ${displayBrowser} - Manual Setup</h2>
                    <p style="margin: 0 0 20px 0; font-size: 15px; text-align: center; opacity: 0.95;">
                        Follow these steps to set up ArcHive bookmarklet in ${displayBrowser}
                    </p>
                    
                    <!-- Character Count Info -->
                    <div style="background: rgba(255,255,255,0.2); border: 2px solid rgba(255,255,255,0.4); border-radius: 10px; padding: 12px; margin-bottom: 20px; font-size: 13px; text-align: center;">
                        ✅ <strong>Optimized for iOS:</strong> ${bookmarkletCode.length} chars (fits ${Math.round((bookmarkletCode.length/2000)*100)}% of 2000 char iOS limit)
                    </div>
                    
                    <!-- Step 1: Add Bookmark -->
                    <div style="background: rgba(255,255,255,0.15); border-radius: 16px; padding: 24px; margin-bottom: 20px; border: 3px solid rgba(255,255,255,0.25);">
                        <div style="display: flex; align-items: center; margin-bottom: 14px;">
                            <div style="
                                width: 40px;
                                height: 40px;
                                background: linear-gradient(135deg, #10b981, #059669);
                                color: white;
                                border-radius: 50%;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                font-weight: 800;
                                font-size: 18px;
                                margin-right: 12px;
                                box-shadow: 0 4px 8px rgba(0,0,0,0.2);
                            ">1</div>
                            <div style="font-size: 20px; font-weight: 700;">One-Time Setup (6 easy steps)</div>
                        </div>
                        
                        <!-- BIG Copy Button FIRST -->
                        <div style="margin-bottom: 20px; text-align: center; background: rgba(0,0,0,0.2); border-radius: 12px; padding: 20px; border: 2px dashed rgba(255,255,255,0.4);">
                            <div style="font-size: 16px; font-weight: 700; margin-bottom: 12px;">👇 STEP 1: Tap here first</div>
                            <button id="copyBookmarkletCode" onclick="
                                navigator.clipboard.writeText(\`${bookmarkletCode}\`).then(() => {
                                    const btn = document.getElementById('copyBookmarkletCode');
                                    const reminder = document.getElementById('copyReminder');
                                    const original = btn.innerHTML;
                                    btn.innerHTML = '✅ Copied to Clipboard!';
                                    btn.style.background = 'linear-gradient(135deg, #10b981, #059669)';
                                    reminder.style.display = 'block';
                                    setTimeout(() => {
                                        btn.innerHTML = original;
                                        btn.style.background = 'linear-gradient(135deg, #f59e0b, #d97706)';
                                    }, 3000);
                                }).catch(() => {
                                    alert('❌ Copy failed. Please use the text box below instead.');
                                });
                            " style="
                                display: inline-block;
                                background: linear-gradient(135deg, #f59e0b, #d97706);
                                color: white;
                                font-weight: 800;
                                font-size: 20px;
                                padding: 20px 40px;
                                border-radius: 14px;
                                border: 3px solid rgba(255,255,255,0.5);
                                box-shadow: 0 8px 24px rgba(245, 158, 11, 0.5);
                                cursor: pointer;
                                transition: all 0.3s;
                            " ontouchstart="this.style.transform='scale(0.95)'" ontouchend="this.style.transform='scale(1)'">
                                📥 Copy Code
                            </button>
                            <div id="copyReminder" style="display: none; margin-top: 12px; padding: 10px; background: rgba(16,185,129,0.3); border-radius: 8px; font-size: 14px; font-weight: 600;">
                                ✅ Code copied! Now continue to Step 2 below 👇
                            </div>
                        </div>
                        
                        <!-- Then the steps -->
                        <div style="background: rgba(0,0,0,0.2); border-radius: 10px; padding: 16px; margin-top: 16px;">
                            <div style="font-size: 15px; font-weight: 700; margin-bottom: 12px;">📋 Complete these steps in order:</div>
                            <ol style="margin: 0; padding-left: 24px; font-size: 15px; line-height: 2.2;">
                                <li><strong>👆 Tap "Copy Code"</strong> button above (you should see ✅)</li>
                                <li><strong>⋮ Tap 3-dot menu</strong> at bottom-right of ${displayBrowser}</li>
                                <li><strong>⭐ Tap "Add Bookmark"</strong></li>
                                <li><strong>✏️ Change name</strong> to <code style="background: rgba(255,255,255,0.2); padding: 2px 6px; border-radius: 4px;">ArcHive</code></li>
                                <li><strong>🔗 Tap URL field</strong>, delete everything, then <strong>paste</strong></li>
                                <li><strong>💾 Tap "Save"</strong> - Done!</li>
                            </ol>
                        </div>
                        
                        <!-- Fallback: Show code in text area for manual copy -->
                        <details style="margin-top: 16px;">
                            <summary style="cursor: pointer; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 8px; font-size: 13px; font-weight: 600;">
                                📋 Show Code (if copy button doesn't work)
                            </summary>
                            <textarea readonly style="
                                width: 100%;
                                height: 100px;
                                margin-top: 10px;
                                padding: 10px;
                                border-radius: 8px;
                                border: 2px solid rgba(255,255,255,0.3);
                                background: rgba(0,0,0,0.2);
                                color: white;
                                font-family: monospace;
                                font-size: 11px;
                                resize: vertical;
                            " onclick="this.select();">${bookmarkletCode}</textarea>
                            <div style="font-size: 12px; opacity: 0.8; margin-top: 8px;">
                                👆 Tap inside box to select all, then copy
                            </div>
                        </details>
                    </div>
                    
                    <!-- Step 2: DAILY USAGE -->
                    <div style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); border-radius: 12px; padding: 25px; margin: 25px 0; border: 3px solid #047857;">
                        <div style="display: flex; align-items: center; margin-bottom: 15px;">
                            <div style="
                                width: 40px;
                                height: 40px;
                                background: rgba(255,255,255,0.3);
                                color: white;
                                border-radius: 50%;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                font-weight: 800;
                                font-size: 18px;
                                margin-right: 12px;
                                box-shadow: 0 4px 8px rgba(0,0,0,0.2);
                            ">2</div>
                            <h3 style="margin: 0; font-size: 20px; font-weight: 700; color: white;">
                                Daily Use - Super Simple!
                            </h3>
                        </div>
                        <div style="background: rgba(255,255,255,0.15); border-radius: 10px; padding: 18px; margin-bottom: 15px;">
                            <div style="font-size: 15px; font-weight: 700; margin-bottom: 10px; color: white;">After setup, archiving only takes 3 taps:</div>
                            <ol style="margin: 0; padding-left: 24px; line-height: 2.4; color: white; font-size: 16px;">
                                <li><strong>🌐 Visit any website</strong> (Twitter, Reddit, news, etc.)</li>
                                <li><strong>⭐ Open bookmarks</strong> in ${displayBrowser}</li>
                                <li><strong>📥 Tap "ArcHive"</strong> - Done! ✨</li>
                            </ol>
                        </div>
                        <div style="background: rgba(0,0,0,0.2); border-radius: 8px; padding: 15px;">
                            <strong>💡 Works everywhere:</strong> Twitter threads, Reddit posts, news articles, blog posts, Wikipedia, YouTube descriptions, product pages - anything! One bookmark, unlimited archives. No copying URLs manually!
                        </div>
                    </div>
                    
                    <!-- Why not Shortcuts? -->
                    <div style="background: rgba(255,255,255,0.15); border: 2px solid rgba(255,255,255,0.3); border-radius: 10px; padding: 15px; margin-bottom: 20px;">
                        <div style="font-size: 14px; font-weight: 600; margin-bottom: 8px;">❓ Why can't I use iOS Shortcuts in ${displayBrowser}?</div>
                        <div style="font-size: 13px; line-height: 1.7; opacity: 0.9;">
                            Apple only allows custom Shortcuts in <strong>Safari's Share menu</strong>. Chrome, Brave, Firefox, and other browsers can't show them (iOS system limitation). The bookmarklet works perfectly instead! 
                        </div>
                    </div>
                    
                    <!-- Feature Comparison -->
                    <div style="background: rgba(255,255,255,0.1); border: 2px solid rgba(255,255,255,0.2); border-radius: 12px; padding: 18px; margin-bottom: 20px;">
                        <div style="font-size: 15px; font-weight: 700; margin-bottom: 12px; text-align: center;">📊 ${displayBrowser} vs Safari</div>
                        <div style="font-size: 13px; line-height: 1.8;">
                            <div style="margin-bottom: 8px; padding: 10px; background: rgba(245,158,11,0.2); border-radius: 8px;">
                                <strong>🧡 ${displayBrowser} (This Method):</strong> Bookmark tap • Works everywhere • Fast extraction
                            </div>
                            <div style="padding: 10px; background: rgba(139,92,246,0.15); border-radius: 8px;">
                                <strong>🍎 Safari:</strong> Share menu shortcut • 2-tap workflow • Native iOS integration
                            </div>
                        </div>
                    </div>
                    
                    <button onclick="closeBookmarkletModal()" style="
                        background: linear-gradient(135deg, #10b981, #059669);
                        color: white;
                        font-weight: 700;
                        font-size: 16px;
                        padding: 16px 24px;
                        border: none;
                        border-radius: 12px;
                        cursor: pointer;
                        width: 100%;
                        margin-top: 20px;
                        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                    ">
                        ✅ Done - Let's Go!
                    </button>
                </div>
            `;
            
            document.body.appendChild(modal);
            console.log(`✅ iOS ${displayBrowser} bookmarklet instructions displayed`);
        }
        
        /**
         * Show bookmarklet setup instructions - UNIFIED SYSTEM FOR ALL PLATFORMS
         * Platform detection happens inside showBookmarkletInstructions()
         * iOS → Apple Shortcut download
         * Android/Desktop → Drag-able bookmarklet
         */
        function showBookmarkletModal(targetUrl, siteName) {
            // Clear old snippet setup flag to prevent users from getting stuck
            localStorage.removeItem('archiveSnippetSetupComplete');
            
            // Use unified bookmarklet system with smart platform detection
            showBookmarkletInstructions();
        }
        
        /**
         * Open target site in new tab
         */
        function openTargetSite(url) {
            window.open(url, '_blank');
            showNotification('✅ Opened in new tab! Go there and press F12 + Ctrl+Enter');
        }
        
        /**
         * Show snippet code again (for users who need to reinstall)
         */
        function showSnippetCodeAgain(targetUrl, siteName) {
            // Clear localStorage so full modal shows
            localStorage.removeItem('archiveSnippetSetupComplete');
            localStorage.removeItem('archiveSnippetSetupDate');
            
            // Clear status div
            const statusDiv = document.getElementById('status');
            if (statusDiv) statusDiv.innerHTML = '';
            
            // Show full modal with snippet code
            showBookmarkletModal(targetUrl, siteName);
            
            showNotification('📋 Snippet code ready to copy!');
        }
        
        /**
         * User clicked "I Already Set This Up" - show extraction instructions
         */
        function snippetSetupComplete(targetUrl, siteName) {
            // Save to localStorage so we don't keep asking
            localStorage.setItem('archiveSnippetSetupComplete', 'true');
            localStorage.setItem('archiveSnippetSetupDate', new Date().toISOString());
            
            // Close the modal (if it exists)
            closeBookmarkletModal();
            
            // Clear any existing content
            const statusDiv = document.getElementById('status');
            const resultsDiv = document.getElementById('results');
            
            // Safety check: make sure the elements exist
            if (!statusDiv || !resultsDiv) {
                console.error('❌ Status or Results div not found');
                return;
            }
            
            resultsDiv.classList.remove('show');
            
            // Show clear instructions
            statusDiv.innerHTML = `
                <div style="
                    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
                    color: white;
                    padding: 30px;
                    border-radius: 16px;
                    text-align: center;
                    box-shadow: 0 10px 30px rgba(16, 185, 129, 0.3);
                    margin: 20px 0;
                ">
                    <div style="font-size: 48px; margin-bottom: 15px;">✅</div>
                    <h2 style="margin: 0 0 15px 0; font-size: 24px; font-weight: 700;">Snippet Setup Complete!</h2>
                    <p style="margin: 0 0 25px 0; font-size: 16px; opacity: 0.95;">
                        Now extract content from ${sanitizeForHTML(siteName)}
                    </p>
                    
                    <div style="font-size: 28px; font-weight: 700; font-family: 'Courier New', monospace; margin: 20px 0;">
                        <kbd style="
                            background: rgba(0,0,0,0.3);
                            padding: 12px 20px;
                            border-radius: 8px;
                            margin: 0 8px;
                            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
                            display: inline-block;
                        ">F12</kbd>
                        <span style="opacity: 0.7;">+</span>
                        <kbd style="
                            background: rgba(0,0,0,0.3);
                            padding: 12px 20px;
                            border-radius: 8px;
                            margin: 0 8px;
                            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
                            display: inline-block;
                        ">Ctrl+Enter</kbd>
                    </div>
                    
                    <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap; margin-top: 15px;" id="snippetCompleteButtonsContainer">
                        <button id="openTargetSiteBtn3" data-url="${sanitizeForTemplateAttribute(targetUrl)}" style="
                            background: white;
                            color: #059669;
                            font-weight: 700;
                            font-size: 16px;
                            padding: 15px 30px;
                            border: none;
                            border-radius: 10px;
                            cursor: pointer;
                            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                            transition: all 0.3s;
                        " onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                            🌐 Open ${sanitizeForHTML(siteName)} Now
                        </button>
                        
                        <button id="showSnippetCodeAgainBtn" data-url="${sanitizeForTemplateAttribute(targetUrl)}" data-sitename="${sanitizeForTemplateAttribute(siteName)}" style="
                            background: rgba(255,255,255,0.2);
                            color: white;
                            font-weight: 600;
                            font-size: 16px;
                            padding: 15px 30px;
                            border: 2px solid rgba(255,255,255,0.5);
                            border-radius: 10px;
                            cursor: pointer;
                            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                            transition: all 0.3s;
                        " onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                            📋 View Snippet Code Again
                        </button>
                    </div>
                    
                    <div style="margin-top: 20px; font-size: 15px; background: linear-gradient(135deg, rgba(251,191,36,0.25), rgba(245,158,11,0.25)); border: 2px solid rgba(251,191,36,0.5); padding: 18px; border-radius: 10px; box-shadow: 0 4px 15px rgba(251,191,36,0.15);">
                        <div style="font-size: 17px; font-weight: 700; margin-bottom: 8px; color: #fbbf24;">⚠️ QUICK GUIDE</div>
                        <div style="line-height: 1.7;">
                            <strong>1. Keep THIS tab open</strong> (archive-paste.html - your main page) 🏠<br>
                            <strong>2. Click button below</strong> → ${sanitizeForHTML(siteName)} opens in new tab 🔄<br>
                            <strong>3. Switch to ${sanitizeForHTML(siteName)} tab</strong> → Press F12 + Ctrl+Enter ⚡<br>
                            <strong>4. Switch back to THIS tab</strong> → Hashes appear automatically! ✅<br>
                            <span style="opacity: 0.9; font-size: 14px; display: block; margin-top: 12px; background: rgba(0,0,0,0.15); padding: 10px; border-radius: 6px;">💡 <strong>No popup!</strong> Everything happens on THIS main page. You just need to switch tabs briefly to run F12 + Ctrl+Enter.</span>
                        </div>
                    </div>
                </div>
            `;
            
            // Attach event listeners for buttons in the status div
            setTimeout(() => {
                const openBtn3 = document.getElementById('openTargetSiteBtn3');
                if (openBtn3) {
                    openBtn3.addEventListener('click', () => {
                        const url = openBtn3.getAttribute('data-url');
                        openTargetSite(url);
                    });
                }
                
                const snippetAgainBtn = document.getElementById('showSnippetCodeAgainBtn');
                if (snippetAgainBtn) {
                    snippetAgainBtn.addEventListener('click', () => {
                        const url = snippetAgainBtn.getAttribute('data-url');
                        const sitename = snippetAgainBtn.getAttribute('data-sitename');
                        showSnippetCodeAgain(url, sitename);
                    });
                }
            }, 0);
            
            showNotification('✅ Ready! Go to ' + siteName + ' and press F12 + Ctrl+Enter');
        }
        
        /**
         * Close bookmarklet modal
         */
        function closeBookmarkletModal() {
            const modal = document.getElementById('bookmarkletModal');
            if (modal) {
                modal.style.opacity = '0';
                setTimeout(() => modal.remove(), 300);
            }
            
            // Save flag so modal doesn't reappear
            const platform = detectPlatform();
            if (platform.isIOS && !platform.supportsIOSShortcuts) {
                // iOS non-Safari browsers: Save bookmarklet setup flag
                localStorage.setItem('archive_ios_bookmarklet_setup_completed', 'true');
                console.log('✅ iOS bookmarklet setup marked complete');
            }
        }
        
        /**
         * Mark mobile bookmarklet setup as complete
         */
        function markBookmarkletSetupComplete() {
            localStorage.setItem('archiveMobileBookmarkletSetupComplete', 'true');
            showNotification('✅ Setup saved! Next time you\'ll see only daily usage instructions.');
            closeBookmarkletModal();
        }
        
        /**
         * Show simplified daily usage instructions (after setup is complete)
         */
        function showMobileDailyUsageOnly(targetUrl, siteName) {
            const existing = document.getElementById('bookmarkletModal');
            if (existing) existing.remove();
            
            const modal = document.createElement('div');
            modal.id = 'bookmarkletModal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100vw;
                height: 100vh;
                background: rgba(0, 0, 0, 0.92);
                z-index: 100000;
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 0;
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
            `;
            
            modal.innerHTML = `
                <div style="
                    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
                    border-radius: 20px;
                    margin: 20px;
                    padding: 30px 25px;
                    max-width: 450px;
                    width: calc(100% - 40px);
                    box-shadow: 0 20px 60px rgba(0,0,0,0.5);
                    color: white;
                    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                    max-height: calc(100vh - 40px);
                    overflow-y: auto;
                    -webkit-overflow-scrolling: touch;
                ">
                    <div style="font-size: 24px; font-weight: 800; margin-bottom: 20px; text-align: center;">
                        📱 Archive ${sanitizeForHTML(siteName)}
                    </div>
                    
                    <div style="background: rgba(0,0,0,0.2); border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                        <div style="font-size: 15px; font-weight: 700; margin-bottom: 12px; color: #fbbf24;">
                            ⚠️ iOS Limitation
                        </div>
                        <div style="font-size: 14px; line-height: 1.6; opacity: 0.95;">
                            iOS opens ${sanitizeForHTML(siteName)} links in the app automatically. You must <strong>manually paste the link</strong> in your browser's address bar.
                        </div>
                    </div>
                    
                    <div style="background: rgba(255,255,255,0.15); border-radius: 12px; padding: 18px; margin-bottom: 20px;">
                        <div style="font-size: 14px; font-weight: 700; margin-bottom: 10px;">
                            📋 Simple Steps:
                        </div>
                        <div style="font-size: 14px; line-height: 2;">
                            <strong>1.</strong> Tap "Copy Link" → Open new tab → Paste in address bar<br>
                            <strong>2.</strong> Tap address bar → Type "archive" → Run bookmarklet<br>
                            <strong>3.</strong> Wait for green "📤 Send to ArcHive" button to appear<br>
                            <strong>4.</strong> Tap the green button → Archive page opens with content! ✅
                        </div>
                        <div style="font-size: 12px; opacity: 0.8; margin-top: 10px; font-style: italic;">
                            💡 Two-step process ensures 100% reliability on all mobile browsers!
                        </div>
                    </div>
                    
                    <div style="display: flex; flex-direction: column; gap: 12px;">
                        <button id="copyLinkBtn" data-url="${sanitizeForTemplateAttribute(targetUrl)}" style="
                            background: linear-gradient(135deg, #fbbf24, #f59e0b);
                            color: white;
                            font-weight: 700;
                            font-size: 16px;
                            padding: 16px;
                            border: none;
                            border-radius: 12px;
                            cursor: pointer;
                            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                            width: 100%;
                        ">
                            📋 Copy ${sanitizeForHTML(siteName)} Link
                        </button>
                        
                        <div style="font-size: 12px; text-align: center; opacity: 0.7; margin: 8px 0;">
                            ${sanitizeForHTML(targetUrl.substring(0, 40))}...
                        </div>
                        
                        <button id="resetSetupBtn" style="
                            background: rgba(255,255,255,0.1);
                            color: white;
                            font-weight: 600;
                            font-size: 13px;
                            padding: 10px;
                            border: none;
                            border-radius: 10px;
                            cursor: pointer;
                            width: 100%;
                        ">
                            🔄 Show Full Setup
                        </button>
                        
                        <button onclick="closeBookmarkletModal()" style="
                            background: transparent;
                            color: white;
                            font-weight: 600;
                            font-size: 14px;
                            padding: 12px;
                            border: 2px solid rgba(255,255,255,0.3);
                            border-radius: 12px;
                            cursor: pointer;
                            width: 100%;
                        ">
                            Close
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Attach event handlers (safer than inline onclick with user-controlled URLs)
            const copyLinkBtn = modal.querySelector('#copyLinkBtn');
            if (copyLinkBtn) {
                copyLinkBtn.addEventListener('click', async () => {
                    const url = copyLinkBtn.getAttribute('data-url');
                    try {
                        await navigator.clipboard.writeText(url);
                        showNotification('✅ Link copied! Now paste in address bar');
                        setTimeout(() => closeBookmarkletModal(), 1500);
                    } catch (err) {
                        showNotification('❌ Failed to copy link');
                    }
                });
            }
            
            const resetSetupBtn = modal.querySelector('#resetSetupBtn');
            if (resetSetupBtn) {
                resetSetupBtn.addEventListener('click', () => {
                    localStorage.removeItem('archiveMobileBookmarkletSetupComplete');
                    showNotification('Setup reset!');
                    closeBookmarkletModal();
                });
            }
            
            // Animate modal entry
            requestAnimationFrame(() => {
                modal.style.opacity = '0';
                modal.style.transition = 'opacity 0.3s';
                requestAnimationFrame(() => {
                    modal.style.opacity = '1';
                });
            });
        }
        
        /* ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
         * PHASE 9: RESUME CAPABILITY FOR MULTI-PART POSTING
         * ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ */
        
        // Global resume state
        window.resumeCandidates = [];
        window.currentResumeCandidate = null;
        
        /**
         * Generate unique tab ID for posting locks
         */
        function generateTabId() {
            return `tab_${Date.now()}_${Math.random().toString(36).substring(2, 11)}`;
        }
        
        /**
         * Acquire posting lock for a series
         * Prevents concurrent posting across browser tabs
         */
        function acquirePostingLock(seriesId) {
            const lockKey = `archive_posting_lock_${seriesId}`;
            const lock = {
                timestamp: Date.now(),
                tabId: generateTabId()
            };
            
            localStorage.setItem(lockKey, JSON.stringify(lock));
            console.log(`🔒 Posting lock acquired for series: ${seriesId}`);
            return lock.tabId;
        }
        
        /**
         * Release posting lock for a series
         */
        function releasePostingLock(seriesId) {
            const lockKey = `archive_posting_lock_${seriesId}`;
            localStorage.removeItem(lockKey);
            console.log(`🔓 Posting lock released for series: ${seriesId}`);
        }
        
        /**
         * Check posting lock status
         * Returns: null (no lock), 'locked' (active), 'stale' (expired)
         */
        function checkPostingLock(seriesId) {
            const lockKey = `archive_posting_lock_${seriesId}`;
            const lockJson = localStorage.getItem(lockKey);
            
            if (!lockJson) {
                return null; // No lock
            }
            
            try {
                const lock = JSON.parse(lockJson);
                const age = Date.now() - lock.timestamp;
                const expiryMs = window.ArcHiveMultiPart.POSTING_LOCK_CONFIG.expiryMs;
                
                if (age >= expiryMs) {
                    // Lock is stale, auto-release
                    releasePostingLock(seriesId);
                    return 'stale';
                }
                
                return 'locked'; // Active lock
            } catch (error) {
                console.warn('⚠️  Failed to parse posting lock:', error);
                releasePostingLock(seriesId); // Clear corrupted lock
                return null;
            }
        }
        
        /**
         * Cleanup old pipeline states based on retention policy
         * - Incomplete states: 14 days
         * - Completed/cancelled: 7 days
         */
        function cleanupOldPipelineStates() {
            console.log('🧹 Cleaning up old pipeline states...');
            
            const retention = window.ArcHiveMultiPart.STATE_RETENTION_CONFIG;
            const now = Date.now();
            let cleanedCount = 0;
            
            // Scan all localStorage keys
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                
                if (!key.startsWith('archive_multipart_pipeline_')) {
                    continue;
                }
                
                try {
                    const stateJson = localStorage.getItem(key);
                    const state = JSON.parse(stateJson);
                    const savedAt = new Date(state.savedAt).getTime();
                    const ageMs = now - savedAt;
                    const ageDays = ageMs / (1000 * 60 * 60 * 24);
                    
                    // Determine if state should be cleaned up
                    let shouldClean = false;
                    
                    if (state.status === 'completed' || state.status === 'cancelled') {
                        // Completed/cancelled: 7 days
                        if (ageDays > retention.completedMaxAgeDays) {
                            shouldClean = true;
                            console.log(`  🗑️  Removing ${state.status} state (${ageDays.toFixed(1)} days old): ${key}`);
                        }
                    } else {
                        // Incomplete: 14 days
                        if (ageDays > retention.incompleteMaxAgeDays) {
                            shouldClean = true;
                            console.log(`  🗑️  Removing incomplete state (${ageDays.toFixed(1)} days old): ${key}`);
                        }
                    }
                    
                    if (shouldClean) {
                        localStorage.removeItem(key);
                        cleanedCount++;
                    }
                } catch (error) {
                    // Corrupted state - remove it
                    console.warn(`  ⚠️  Removing corrupted state: ${key}`, error);
                    localStorage.removeItem(key);
                    cleanedCount++;
                }
            }
            
            if (cleanedCount > 0) {
                console.log(`✅ Cleaned up ${cleanedCount} old pipeline state(s)`);
            } else {
                console.log(`✅ No old states to clean up`);
            }
        }
        
        /**
         * Discover resume candidates from localStorage AND IndexedDB
         * Scans for incomplete multi-part posting pipelines
         * PHASE 9 ENHANCED: Now checks IndexedDB for content availability
         */
        async function discoverResumeCandidates() {
            console.log('🔍 Discovering resume candidates...');
            
            const candidates = [];
            
            // Scan all localStorage keys
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                
                if (!key.startsWith('archive_multipart_pipeline_')) {
                    continue;
                }
                
                try {
                    const stateJson = localStorage.getItem(key);
                    const state = JSON.parse(stateJson);
                    
                    // Validate state version
                    if (!state.stateVersion || state.stateVersion !== window.ArcHiveMultiPart.STATE_VERSION) {
                        console.warn(`  ⚠️  Incompatible state version for ${key}, skipping`);
                        continue;
                    }
                    
                    // Only show incomplete states
                    if (state.status === 'completed' || state.status === 'cancelled') {
                        continue;
                    }
                    
                    // Validate required fields
                    if (!state.manifest || !state.manifest.series_id || !state.manifest.parts) {
                        console.warn(`  ⚠️  Invalid state schema for ${key}, skipping`);
                        continue;
                    }
                    
                    // Count completed vs remaining parts
                    const completedParts = state.manifest.parts.filter(p => p.status === 'posted');
                    const remainingParts = state.manifest.parts.filter(p => p.status !== 'posted');
                    
                    // Create resume candidate
                    const candidate = {
                        series_id: state.manifest.series_id,
                        manifest: state.manifest,
                        parts: state.manifest.parts,
                        completedCount: completedParts.length,
                        remainingCount: remainingParts.length,
                        lastAttempt: new Date(state.savedAt),
                        isValid: true,
                        stateVersion: state.stateVersion,
                        state: state, // Full state for resume
                        hasContentInIndexedDB: false, // Will check below
                        contentParts: null // Will load below if available
                    };
                    
                    candidates.push(candidate);
                    console.log(`  📋 Found candidate: ${candidate.series_id.substring(0, 8)}... (${candidate.completedCount}/${candidate.manifest.total_parts} parts)`);
                    
                } catch (error) {
                    console.warn(`  ⚠️  Failed to parse state: ${key}`, error);
                }
            }
            
            // PHASE 9 ENHANCED: Check if IndexedDB has stored content for each candidate
            if (window.ArcHiveStorage && candidates.length > 0) {
                console.log('📦 Checking IndexedDB for stored content...');
                
                for (const candidate of candidates) {
                    try {
                        const contentParts = await window.ArcHiveStorage.loadContentParts(candidate.series_id);
                        
                        if (contentParts && contentParts.length > 0) {
                            candidate.hasContentInIndexedDB = true;
                            candidate.contentParts = contentParts; // Store for later use
                            console.log(`  ✅ Content found in IndexedDB for ${candidate.series_id.substring(0, 8)}... (${contentParts.length} parts)`);
                        } else {
                            console.log(`  ⚠️  No content in IndexedDB for ${candidate.series_id.substring(0, 8)}... (will need re-extraction)`);
                        }
                    } catch (error) {
                        console.warn(`  ⚠️  Failed to check IndexedDB for ${candidate.series_id}:`, error);
                    }
                }
            }
            
            return candidates;
        }
        
        /**
         * Show resume banner with incomplete posting info
         * PHASE 1.4: Now shows "✅ 1-Click Resume" or "⚠️ Re-extraction required"
         */
        function showResumeBanner(candidates) {
            const banner = document.getElementById('resumeBanner');
            const summary = document.getElementById('resumeSummary');
            
            if (!banner || !summary) {
                console.error('❌ Resume banner elements not found');
                return;
            }
            
            if (candidates.length === 0) {
                banner.style.display = 'none';
                return;
            }
            
            // Store candidates globally
            window.resumeCandidates = candidates;
            
            if (candidates.length === 1) {
                // Single candidate
                const candidate = candidates[0];
                const timeAgo = getTimeAgo(candidate.lastAttempt);
                
                // PHASE 1.4: Show different message based on IndexedDB content availability
                const resumeStatus = candidate.hasContentInIndexedDB 
                    ? '<span style="color: #10b981; font-weight: 600;">✅ 1-Click Resume</span> (content stored)'
                    : '<span style="color: #f59e0b; font-weight: 600;">⚠️ Re-extraction required</span> (content not saved)';
                
                summary.innerHTML = `
                    <strong>Series:</strong> ${candidate.series_id.substring(0, 12)}... 
                    (${candidate.completedCount} of ${candidate.manifest.total_parts} parts posted)<br>
                    <strong>Last attempt:</strong> ${timeAgo}<br>
                    <strong>Resume status:</strong> ${resumeStatus}
                `;
            } else {
                // Multiple candidates
                const withContent = candidates.filter(c => c.hasContentInIndexedDB).length;
                const withoutContent = candidates.length - withContent;
                
                summary.innerHTML = `
                    <strong>${candidates.length} incomplete posting(s) found</strong><br>
                    ${withContent > 0 ? `✅ ${withContent} with stored content (1-click resume)<br>` : ''}
                    ${withoutContent > 0 ? `⚠️ ${withoutContent} requiring re-extraction<br>` : ''}
                    Click "Resume Posting" to choose which one to continue
                `;
            }
            
            banner.style.display = 'block';
        }
        
        /**
         * Format time ago for display
         */
        function getTimeAgo(date) {
            const seconds = Math.floor((Date.now() - date.getTime()) / 1000);
            
            if (seconds < 60) return `${seconds} seconds ago`;
            if (seconds < 3600) return `${Math.floor(seconds / 60)} minutes ago`;
            if (seconds < 86400) return `${Math.floor(seconds / 3600)} hours ago`;
            return `${Math.floor(seconds / 86400)} days ago`;
        }
        
        /**
         * Show resume modal for selecting/confirming resume
         */
        function showResumeModal() {
            const modal = document.getElementById('resumeModal');
            const details = document.getElementById('resumeDetails');
            
            if (!modal || !details) {
                console.error('❌ Resume modal elements not found');
                return;
            }
            
            const candidates = window.resumeCandidates;
            
            if (candidates.length === 0) {
                showNotification('❌ No incomplete postings found');
                return;
            }
            
            if (candidates.length === 1) {
                // Single candidate - show details
                const candidate = candidates[0];
                window.currentResumeCandidate = candidate;
                
                const completedParts = candidate.parts.filter(p => p.status === 'posted').map(p => p.part_number);
                const remainingParts = candidate.parts.filter(p => p.status !== 'posted').map(p => p.part_number);
                
                details.innerHTML = `
                    <div class="resume-info">
                        <p><strong>Series ID:</strong> ${candidate.series_id}</p>
                        <p><strong>Parts completed:</strong> ${candidate.completedCount}/${candidate.manifest.total_parts} 
                           (Parts ${completedParts.join(', ')})</p>
                        <p><strong>Parts remaining:</strong> ${candidate.remainingCount}/${candidate.manifest.total_parts}
                           (Parts ${remainingParts.join(', ')})</p>
                        <p class="info-text">ℹ️ We'll verify existing parts on blockchain before continuing</p>
                    </div>
                `;
            } else {
                // Multiple candidates - show selection list
                details.innerHTML = `
                    <div class="resume-info">
                        <p><strong>⚠️ Multiple Incomplete Postings Found</strong></p>
                        ${candidates.map((c, i) => `
                            <div class="resume-candidate" style="margin: 8px 0; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                <label style="display: flex; align-items: center; cursor: pointer;">
                                    <input type="radio" name="resumeCandidate" value="${i}" ${i === 0 ? 'checked' : ''} 
                                           style="margin-right: 8px;">
                                    <div>
                                        <strong>Series ${c.series_id.substring(0, 12)}...</strong><br>
                                        <small>${c.completedCount}/${c.manifest.total_parts} parts - ${getTimeAgo(c.lastAttempt)}</small>
                                    </div>
                                </label>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            
            modal.style.display = 'flex';
        }
        
        /**
         * Close resume modal
         */
        function closeResumeModal() {
            const modal = document.getElementById('resumeModal');
            if (modal) {
                modal.style.display = 'none';
            }
            
            // Hide verification progress
            const verificationProgress = document.getElementById('verificationProgress');
            if (verificationProgress) {
                verificationProgress.style.display = 'none';
                verificationProgress.innerHTML = '';
            }
        }
        
        /**
         * Confirm and start resume process
         */
        async function confirmResume() {
            console.log('🔄 Starting resume process...');
            
            // Determine which candidate to resume
            let candidate = window.currentResumeCandidate;
            
            if (!candidate) {
                // Multiple candidates - get selected one
                const selected = document.querySelector('input[name="resumeCandidate"]:checked');
                if (selected) {
                    const index = parseInt(selected.value);
                    candidate = window.resumeCandidates[index];
                }
            }
            
            if (!candidate) {
                showNotification('❌ No candidate selected');
                return;
            }
            
            console.log(`📋 Resuming series: ${candidate.series_id}`);
            
            // Check posting lock
            const lockStatus = checkPostingLock(candidate.series_id);
            if (lockStatus === 'locked') {
                showNotification('⚠️ Posting in progress in another tab');
                return;
            }
            
            // Show verification progress
            const verificationProgress = document.getElementById('verificationProgress');
            const resumeConfirmBtn = document.getElementById('resumeConfirmBtn');
            
            if (verificationProgress) {
                verificationProgress.style.display = 'block';
                verificationProgress.innerHTML = `
                    <div class="verification-status">
                        <h4>🔍 Verifying existing parts on blockchain...</h4>
                        <div id="verificationList"></div>
                    </div>
                `;
            }
            
            if (resumeConfirmBtn) {
                resumeConfirmBtn.disabled = true;
                resumeConfirmBtn.textContent = '🔍 Verifying...';
            }
            
            try {
                // Verify completed parts on blockchain
                const results = await window.ArcHiveMultiPart.verifyCompletedParts(
                    candidate.manifest,
                    candidate.manifest.part_hashes,
                    (progress) => {
                        // Update verification progress UI
                        updateVerificationProgress(progress);
                    }
                );
                
                console.log('✅ Verification complete:', results);
                
                // Show verification summary
                if (verificationProgress) {
                    verificationProgress.innerHTML += `
                        <div class="verification-summary" style="margin-top: 12px; padding: 12px; background: #e8f5e9; border-radius: 4px;">
                            <p><strong>✅ Verification Complete</strong></p>
                            <p>✅ Verified: ${results.verified.length} parts</p>
                            <p>⚠️ Failed/Missing: ${results.failed.length + results.missing.length} parts (will retry)</p>
                            <button onclick="startResumePosting()" 
                                    style="margin-top: 8px; padding: 8px 16px; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                📤 Start Posting Remaining Parts
                            </button>
                        </div>
                    `;
                }
                
                // Store verification results
                window.currentResumeResults = results;
                
            } catch (error) {
                console.error('❌ Verification failed:', error);
                showNotification('❌ Verification failed: ' + error.message);
                
                if (resumeConfirmBtn) {
                    resumeConfirmBtn.disabled = false;
                    resumeConfirmBtn.textContent = '🔍 Verify & Resume';
                }
            }
        }
        
        /**
         * Update verification progress UI in real-time
         */
        function updateVerificationProgress(progress) {
            const list = document.getElementById('verificationList');
            if (!list) return;
            
            const partId = `verify-part-${progress.partNumber}`;
            let partElement = document.getElementById(partId);
            
            if (!partElement) {
                partElement = document.createElement('div');
                partElement.id = partId;
                partElement.style.padding = '4px 0';
                list.appendChild(partElement);
            }
            
            let icon = '⏳';
            if (progress.status === 'verified') icon = '✅';
            else if (progress.status === 'failed' || progress.status === 'error') icon = '⚠️';
            else if (progress.status === 'checking') icon = '🔍';
            
            partElement.textContent = `${icon} Part ${progress.partNumber}: ${progress.message}`;
        }
        
        /**
         * Start posting remaining parts after verification
         */
        async function startResumePosting() {
            console.log('📤 Starting resume posting...');
            
            const candidate = window.currentResumeCandidate;
            const results = window.currentResumeResults;
            
            if (!candidate || !results) {
                showNotification('❌ Resume data not available');
                return;
            }
            
            // Close resume modal
            closeResumeModal();
            
            // Hide resume banner
            const banner = document.getElementById('resumeBanner');
            if (banner) {
                banner.style.display = 'none';
            }
            
            // Update manifest with verification results
            // Mark verified parts as already posted, failed parts will be retried
            candidate.manifest.parts.forEach((part, i) => {
                if (results.verified.includes(part.part_number)) {
                    part.status = 'posted'; // Keep as posted (verified)
                } else if (results.failed.includes(part.part_number) || results.missing.includes(part.part_number)) {
                    part.status = 'pending'; // Reset to pending (will retry)
                }
            });
            
            // Show notification
            showNotification(`🔄 Resuming multi-part posting... (${results.failed.length + results.missing.length} parts remaining)`);
            
            // Acquire posting lock
            acquirePostingLock(candidate.series_id);
            
            // Resume posting through existing multi-part flow
            // This will use the updated manifest with verified parts marked as posted
            console.log('📝 Updated manifest:', candidate.manifest);
            
            showNotification('✅ Resume posting started - check console for progress');
            
            // TODO: Integrate with actual posting pipeline
            // For now, just log the resume action
            console.log('🎯 Would resume posting here with manifest:', candidate.manifest);
        }
        
        /**
         * Clear incomplete pipeline and remove from storage
         */
        function clearIncompletePipeline() {
            if (!confirm('Clear all incomplete postings? This cannot be undone.')) {
                return;
            }
            
            const candidates = window.resumeCandidates;
            
            candidates.forEach(candidate => {
                const stateKey = `archive_multipart_pipeline_${candidate.series_id}`;
                localStorage.removeItem(stateKey);
                releasePostingLock(candidate.series_id);
                console.log(`🗑️  Cleared pipeline: ${candidate.series_id}`);
            });
            
            // Hide banner
            const banner = document.getElementById('resumeBanner');
            if (banner) {
                banner.style.display = 'none';
            }
            
            // Clear global state
            window.resumeCandidates = [];
            window.currentResumeCandidate = null;
            
            showNotification(`✅ Cleared ${candidates.length} incomplete posting(s)`);
        }
        
        /**
         * Handle paused posting modal (shown when retries exhausted)
         */
        function handlePausedPosting(seriesId, partNumber, error) {
            const modal = document.getElementById('pausedModal');
            const details = document.getElementById('pausedDetails');
            
            if (!modal || !details) {
                console.error('❌ Paused modal elements not found');
                return;
            }
            
            details.innerHTML = `
                <p>Network errors prevented posting <strong>Part ${partNumber}</strong> after 3 attempts.</p>
                <p>Your progress has been saved.</p>
                <p class="error-text" style="font-size: 12px; color: #666;">Error: ${error}</p>
            `;
            
            modal.style.display = 'flex';
            
            // Store series ID for retry
            window.pausedSeriesId = seriesId;
        }
        
        /**
         * Retry paused posting immediately
         */
        function retryPausedPosting() {
            const seriesId = window.pausedSeriesId;
            if (!seriesId) {
                showNotification('❌ No paused posting found');
                return;
            }
            
            // Close paused modal
            const modal = document.getElementById('pausedModal');
            if (modal) {
                modal.style.display = 'none';
            }
            
            // Load state and resume
            const state = window.ArcHiveMultiPart.HivePostingPipeline.loadState(seriesId);
            if (state) {
                showNotification('🔄 Retrying posting...');
                // TODO: Integrate with actual posting pipeline
                console.log('🔄 Would retry posting here with state:', state);
            } else {
                showNotification('❌ Failed to load saved state');
            }
        }
        
        /**
         * Show persistent notification with manual close button
         * Used for important success messages that user should read
         */
        function showPersistentNotification(message) {
            // Create modal-style notification
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                bottom: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: linear-gradient(135deg, #10b981 0%, #059669 100%);
                color: white;
                padding: 20px 24px;
                padding-right: 50px;
                border-radius: 12px;
                box-shadow: 0 10px 40px rgba(0,0,0,0.4);
                z-index: 10001;
                font-size: 15px;
                max-width: 90vw;
                text-align: center;
                line-height: 1.6;
                font-weight: 500;
            `;
            notification.innerHTML = `
                <div style="white-space: pre-line;">${message}</div>
                <button onclick="this.parentElement.remove()" style="
                    position: absolute;
                    top: 10px;
                    right: 10px;
                    background: rgba(255,255,255,0.2);
                    border: none;
                    color: white;
                    font-size: 24px;
                    cursor: pointer;
                    border-radius: 50%;
                    width: 32px;
                    height: 32px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    transition: background 0.2s;
                    line-height: 1;
                    padding: 0;
                " onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'" ontouchstart="this.style.background='rgba(255,255,255,0.3)'" ontouchend="this.style.background='rgba(255,255,255,0.2)'">×</button>
            `;
            document.body.appendChild(notification);
        }
        
        // iOS Shortcut deprecated functions removed - see bookmarklet methods instead
        function generateIOSShortcut_DEPRECATED() {
            const archiveOrigin = window.location.origin;
            
            // The extraction JavaScript with origin injected
            // RESTORED: Twitter/X smart extraction (Nov 25, 2025)
            const extractionJS = `(function(){'use strict';try{const ARCHIVE_ORIGIN='${archiveOrigin}';const cacheBuster=Date.now();const archiveUrl=ARCHIVE_ORIGIN+'/index.html?v='+cacheBuster+'#mobile-extract';const html=document.documentElement.outerHTML;const url=window.location.href;const title=document.title;let mode='normal';let tweetOnlyHTML='';let repliesHTML=[];const isTwitter=url.includes('twitter.com')||url.includes('x.com');if(isTwitter){console.log('🐦 Twitter/X detected');const includeReplies=localStorage.getItem('archiveIncludeReplies')==='true';mode=includeReplies?'with-replies':'tweet-only';const mainTweet=document.querySelector('article[data-testid="tweet"]');if(mainTweet){tweetOnlyHTML=mainTweet.outerHTML;console.log('✅ Main tweet extracted:',tweetOnlyHTML.length,'chars');}if(includeReplies){document.querySelectorAll('div[data-testid="cellInnerDiv"]').forEach((cell,i)=>{if(i>0&&cell.querySelector('article[data-testid="tweet"]'))repliesHTML.push(cell.outerHTML);});console.log('✅ Extracted',repliesHTML.length,'replies');}if(!tweetOnlyHTML){console.warn('⚠️ Smart extraction failed, using full HTML');mode='normal';}}const w=window.open(archiveUrl,'_blank');if(!w){alert('⚠️ Please allow popups for ArcHive');return;}const h=function(e){if(e.data&&e.data.type==='ARCHIVE_READY'){w.postMessage({type:'ARCHIVE_EXTRACT',html:html,title:title,url:url,source:window.location.hostname,mode:mode,tweetOnlyHTML:tweetOnlyHTML,repliesHTML:repliesHTML,extractedData:{title:title}},ARCHIVE_ORIGIN);window.removeEventListener('message',h);const n=document.createElement('div');n.style.cssText='position:fixed;top:20px;right:20px;background:#10b981;color:white;padding:16px 24px;border-radius:8px;font-family:sans-serif;font-size:14px;font-weight:600;z-index:999999;box-shadow:0 4px 12px rgba(0,0,0,0.3);';n.textContent='✅ Sent to ArcHive!';document.body.appendChild(n);setTimeout(()=>n.remove(),3000);}};window.addEventListener('message',h);setTimeout(()=>window.removeEventListener('message',h),10000);}catch(e){alert('❌ Failed to extract: '+e.message);}})();`;
            
            // iOS Shortcuts JSON structure
            const shortcutData = {
                "WFWorkflowMinimumClientVersion": 900,
                "WFWorkflowMinimumClientVersionString": "900",
                "WFWorkflowTypes": ["ActionExtension"],
                "WFWorkflowInputContentItemClasses": [
                    "WFWebPageContentItem",
                    "WFURLContentItem"
                ],
                "WFWorkflowActions": [
                    {
                        "WFWorkflowActionIdentifier": "is.workflow.actions.runjavascript",
                        "WFWorkflowActionParameters": {
                            "WFJavaScriptActionCode": extractionJS
                        }
                    }
                ],
                "WFWorkflowClientVersion": "2605.0.5",
                "WFWorkflowClientRelease": "21G115",
                "WFWorkflowName": "ArcHive Extractor",
                "WFWorkflowImportQuestions": []
            };
            
            return JSON.stringify(shortcutData, null, 2);
        }
        
        /**
         * DEPRECATED: Old inline download function.
         * Now using file-based approach at line 17295+
         */
        function downloadIOSShortcut_DEPRECATED_INLINE() {
            console.warn('Using deprecated inline shortcut generator');
        }
        
        /**
         * Android-Specific: Bookmarklet Instructions (existing method)
         */
        function showAndroidBookmarkletInstructions(targetUrl, siteName) {
            // Remove existing modal if present
            const existing = document.getElementById('bookmarkletModal');
            if (existing) existing.remove();
            
            // Generate NEW mobile bookmarklet code that loads archive-core.js
            // This loads the full-featured bookmarklet with all libraries embedded:
            // - Readability.js for content extraction
            // - DOMPurify for HTML sanitization
            // - blakejs, SHA-256, MD5 for cryptographic hashing
            // - Hive blockchain integration
            // - iOS popup fix (window.open without setTimeout)
            // Code WITHOUT javascript: prefix (for iOS Chrome manual typing method)
            // CACHE-BUSTING FIX: Move Date.now() INSIDE bookmarklet so it generates fresh timestamp on EVERY click
            // Get the full base URL including subdirectory path (e.g., /archive on GitHub Pages)
            const currentPath = window.location.pathname.substring(0, window.location.pathname.lastIndexOf('/') + 1) || '/';
            const archiveBase = window.location.origin + currentPath.replace(/\/$/, '');
            const archiveOrigin = archiveBase;
            // NEW APPROACH: Extract HTML directly, no external scripts! Works on ALL CSP-protected sites including Twitter/X
            // SECURITY: Specify exact targetOrigin (not '*') to ensure messages only go to our domain
            // RESTORED: Twitter/X smart extraction (Nov 25, 2025)
            const bookmarkletCodeWithoutPrefix = `(function(){'use strict';try{const cacheBuster=Date.now();const archiveUrl='${archiveBase}/index.html?v='+cacheBuster+'#mobile-extract';const html=document.documentElement.outerHTML;const url=window.location.href;const title=document.title;let mode='normal';let tweetOnlyHTML='';let repliesHTML=[];const isTwitter=url.includes('twitter.com')||url.includes('x.com');if(isTwitter){console.log('🐦 Twitter/X detected');const includeReplies=localStorage.getItem('archiveIncludeReplies')==='true';mode=includeReplies?'with-replies':'tweet-only';const mainTweet=document.querySelector('article[data-testid="tweet"]');if(mainTweet){tweetOnlyHTML=mainTweet.outerHTML;console.log('✅ Main tweet extracted:',tweetOnlyHTML.length,'chars');}if(includeReplies){document.querySelectorAll('div[data-testid="cellInnerDiv"]').forEach((cell,i)=>{if(i>0&&cell.querySelector('article[data-testid="tweet"]'))repliesHTML.push(cell.outerHTML);});console.log('✅ Extracted',repliesHTML.length,'replies');}if(!tweetOnlyHTML){console.warn('⚠️ Smart extraction failed, using full HTML');mode='normal';}}const w=window.open(archiveUrl,'_blank');if(!w){alert('⚠️ Please allow popups for ArcHive');return;}const h=function(e){if(e.data&&e.data.type==='ARCHIVE_READY'){w.postMessage({type:'ARCHIVE_EXTRACT',html:html,title:title,url:url,source:window.location.hostname,mode:mode,tweetOnlyHTML:tweetOnlyHTML,repliesHTML:repliesHTML,extractedData:{title:title}},'${archiveOrigin}');window.removeEventListener('message',h);const n=document.createElement('div');n.style.cssText='position:fixed;top:20px;right:20px;background:#10b981;color:white;padding:16px 24px;border-radius:8px;font-family:sans-serif;font-size:14px;font-weight:600;z-index:999999;box-shadow:0 4px 12px rgba(0,0,0,0.3);';n.textContent='✅ Sent to ArcHive!';document.body.appendChild(n);setTimeout(()=>n.remove(),3000);}};window.addEventListener('message',h);setTimeout(()=>window.removeEventListener('message',h),10000);}catch(e){alert('❌ Failed to extract: '+e.message);}})()`;
            const bookmarkletCode = `javascript:${bookmarkletCodeWithoutPrefix}`;
            
            const modal = document.createElement('div');
            modal.id = 'bookmarkletModal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100vw;
                height: 100vh;
                background: rgba(0, 0, 0, 0.92);
                z-index: 100000;
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 20px;
                overflow-y: auto;
            `;
            
            modal.innerHTML = `
                <div style="
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    border-radius: 20px;
                    padding: 30px;
                    max-width: 550px;
                    width: 100%;
                    max-height: 90vh;
                    overflow-y: auto;
                    box-shadow: 0 20px 60px rgba(0,0,0,0.5);
                    color: white;
                    position: relative;
                ">
                    <button onclick="closeBookmarkletModal()" style="
                        position: absolute;
                        top: 15px;
                        right: 15px;
                        background: rgba(255,255,255,0.2);
                        border: none;
                        color: white;
                        font-size: 28px;
                        cursor: pointer;
                        border-radius: 50%;
                        width: 44px;
                        height: 44px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        transition: all 0.3s;
                    " ontouchstart="this.style.background='rgba(255,255,255,0.4)'" ontouchend="this.style.background='rgba(255,255,255,0.2)'">×</button>
                    
                    <div style="font-size: 48px; text-align: center; margin-bottom: 15px;">📱</div>
                    <h2 style="margin: 0 0 10px 0; font-size: 26px; font-weight: 700; text-align: center;">Mobile Bookmarklet Setup</h2>
                    <p style="margin: 0 0 15px 0; font-size: 15px; text-align: center; opacity: 0.95;">
                        One-time 3-minute setup, then <strong>1-tap extraction</strong> on ANY ${sanitizeForHTML(siteName)} page forever!
                    </p>
                    
                    <!-- Platform Toggle -->
                    <div style="text-align: center; margin-bottom: 20px;">
                        <button onclick="closeBookmarkletModal(); showIOSBookmarkletSetup();" style="
                            background: rgba(255,255,255,0.2);
                            color: white;
                            border: 1px solid rgba(255,255,255,0.3);
                            padding: 8px 16px;
                            border-radius: 20px;
                            font-size: 13px;
                            cursor: pointer;
                            transition: all 0.2s;
                        ">
                            📱 Wrong device? Switch to iPhone/iPad
                        </button>
                    </div>
                    
                    <!-- Browser Compatibility Info -->
                    <div style="background: rgba(16,185,129,0.2); border: 2px solid rgba(16,185,129,0.4); border-radius: 10px; padding: 15px; margin-bottom: 15px;">
                        <div style="font-size: 16px; font-weight: 700; margin-bottom: 8px; color: #d1fae5;">✅ iPhone Users: Use Safari!</div>
                        <div style="font-size: 14px; line-height: 1.7;">
                            <strong>Easiest:</strong> Safari on iPhone (allows editing bookmarks)<br>
                            <strong>Chrome iOS:</strong> Blocks editing - must sync from desktop<br><br>
                            <strong>Recommendation:</strong> Use <strong>Safari</strong> for hassle-free setup!
                        </div>
                    </div>
                    
                    <div style="background: rgba(99,102,241,0.2); border: 2px solid rgba(99,102,241,0.4); border-radius: 10px; padding: 15px; margin-bottom: 20px;">
                        <div style="font-size: 16px; font-weight: 700; margin-bottom: 8px; color: #e0e7ff;">📱 Android Users: All Browsers Work!</div>
                        <div style="font-size: 14px; line-height: 1.7;">
                            <strong>Chrome, Firefox, Brave:</strong> All allow direct editing ✅<br>
                            Follow the Android instructions below.
                        </div>
                    </div>
                    
                    <!-- Step 1: Copy Code -->
                    <div style="background: rgba(255,255,255,0.15); border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                        <div style="font-size: 18px; font-weight: 700; margin-bottom: 12px;">📋 Step 1: Copy the Code</div>
                        <p style="margin: 0 0 12px 0; font-size: 14px; opacity: 0.95;">
                            Tap the button to copy the bookmarklet code:
                        </p>
                        <button onclick="copyMobileBookmarkletCode()" id="copyBookmarkletBtn" style="
                            background: linear-gradient(135deg, #10b981, #059669);
                            color: white;
                            font-weight: 700;
                            font-size: 16px;
                            padding: 16px 24px;
                            border: none;
                            border-radius: 12px;
                            cursor: pointer;
                            width: 100%;
                            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                            transition: all 0.3s;
                        ">
                            📋 Copy Bookmarklet Code
                        </button>
                        <div style="margin-top: 12px; padding: 10px; background: rgba(16,185,129,0.2); border-radius: 6px; font-size: 13px; text-align: center; display: none;" id="copySuccess">
                            ✅ Code copied! Now follow steps 2-3 below.
                        </div>
                        <div style="margin-top: 12px; padding: 10px; background: rgba(16,185,129,0.2); border-radius: 6px; font-size: 12px; border: 1px solid rgba(16,185,129,0.4);">
                            <strong>✅ All users:</strong> Code includes <code style="background: rgba(0,0,0,0.3); padding: 2px 4px; border-radius: 3px;">javascript:</code> prefix automatically - no manual typing needed!
                        </div>
                    </div>
                    
                    <!-- Step 2: Create Bookmark -->
                    <div style="background: rgba(255,255,255,0.15); border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                        <div style="font-size: 18px; font-weight: 700; margin-bottom: 12px;">🔖 Step 2: Create a Bookmark</div>
                        
                        <div style="background: rgba(0,0,0,0.15); border-radius: 8px; padding: 15px; margin-bottom: 12px;">
                            <div style="font-size: 15px; font-weight: 600; margin-bottom: 8px;">📱 iPhone Safari (Recommended):</div>
                            <ol style="margin: 0; padding-left: 20px; font-size: 14px; line-height: 1.8;">
                                <li>Tap the <strong>Share</strong> button (box with arrow)</li>
                                <li>Tap <strong>"Add Bookmark"</strong></li>
                                <li>Name it <strong>"ArcHive"</strong> (short name works best!)</li>
                                <li>Tap <strong>"Save"</strong></li>
                            </ol>
                            <div style="margin-top: 8px; padding: 6px; background: rgba(16,185,129,0.2); border-radius: 4px; font-size: 12px;">
                                ✅ Safari allows editing bookmark URLs - easiest option!
                            </div>
                        </div>
                        
                        <div style="background: rgba(99,102,241,0.15); border: 2px solid rgba(99,102,241,0.3); border-radius: 8px; padding: 15px; margin-bottom: 12px;">
                            <div style="font-size: 15px; font-weight: 600; margin-bottom: 10px;">💡 iPhone Chrome/Brave:</div>
                            <ol style="margin: 0; padding-left: 20px; font-size: 13px; line-height: 2;">
                                <li>Tap <strong>⋮</strong> → Bookmark any page → Save</li>
                                <li>Tap <strong>⋮</strong> → Bookmarks → Find bookmark → <strong>⋮</strong> → Edit</li>
                                <li><strong>CRITICAL - Edit URL First:</strong> Delete entire URL field, then paste the bookmarklet code</li>
                                <li><strong>CRITICAL - Edit Title Second:</strong> Change name to <strong>"ArcHive"</strong></li>
                                <li>Tap <strong>"Done"</strong> checkmark</li>
                            </ol>
                            <div style="margin-top: 10px; padding: 8px; background: rgba(239,68,68,0.2); border-radius: 6px; font-size: 12px; text-align: center; font-weight: 600; border: 1px solid rgba(239,68,68,0.4);">
                                ⚠️ MUST EDIT BOTH FIELDS (URL + Title) - Save button won't work if you only edit one!
                            </div>
                        </div>
                        
                        <div style="background: rgba(0,0,0,0.15); border-radius: 8px; padding: 15px; margin-bottom: 12px;">
                            <div style="font-size: 15px; font-weight: 600; margin-bottom: 8px;">🤖 Android Chrome:</div>
                            <ol style="margin: 0; padding-left: 20px; font-size: 14px; line-height: 1.8;">
                                <li>Tap the <strong>⋮</strong> menu (three vertical dots in top-right)</li>
                                <li>Tap <strong>"Add to bookmarks"</strong></li>
                                <li>A "Bookmarked" alert will appear at bottom</li>
                                <li>You'll edit the URL in Step 3 below - just save for now</li>
                            </ol>
                            <div style="margin-top: 8px; padding: 6px; background: rgba(251,191,36,0.2); border-radius: 4px; font-size: 12px; text-align: center; font-weight: 600; border: 1px solid rgba(251,191,36,0.4);">
                                💡 Don't edit yet! Continue to Step 3 to edit URL + Title together
                            </div>
                        </div>
                        
                        <div style="background: rgba(0,0,0,0.15); border-radius: 8px; padding: 15px;">
                            <div style="font-size: 15px; font-weight: 600; margin-bottom: 8px;">🦊 Android Firefox/Brave:</div>
                            <ol style="margin: 0; padding-left: 20px; font-size: 14px; line-height: 1.8;">
                                <li>Tap the <strong>⋮</strong> menu (three dots)</li>
                                <li>Tap the <strong>⭐ Star</strong> icon to bookmark</li>
                                <li>Go to <strong>Bookmarks</strong> menu</li>
                                <li>Find the bookmark → <strong>Long-press</strong> → <strong>"Edit"</strong></li>
                                <li>Name it <strong>"ArcHive"</strong></li>
                                <li>Tap <strong>"Save"</strong></li>
                            </ol>
                        </div>
                    </div>
                    
                    <!-- Step 3: Edit Bookmark -->
                    <div style="background: rgba(255,255,255,0.15); border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                        <div style="font-size: 18px; font-weight: 700; margin-bottom: 12px;">✏️ Step 3: Edit the Bookmark</div>
                        
                        <div style="background: rgba(0,0,0,0.15); border-radius: 8px; padding: 15px; margin-bottom: 12px;">
                            <div style="font-size: 15px; font-weight: 600; margin-bottom: 8px;">📱 iPhone Safari:</div>
                            <ol style="margin: 0; padding-left: 20px; font-size: 14px; line-height: 1.8;">
                                <li>Tap <strong>📖 Book icon</strong> (Bookmarks)</li>
                                <li>Find <strong>"ArcHive"</strong> in your list</li>
                                <li>Tap <strong>"Edit"</strong></li>
                                <li><strong>CRITICAL - Edit URL First:</strong> Delete entire URL field, then paste the bookmarklet code (long-press → Paste)</li>
                                <li><strong>CRITICAL - Edit Title Second:</strong> Make sure name is <strong>"ArcHive"</strong></li>
                                <li>Tap <strong>"Done"</strong></li>
                            </ol>
                            <div style="margin-top: 8px; padding: 6px; background: rgba(239,68,68,0.2); border-radius: 4px; font-size: 12px; text-align: center; font-weight: 600; border: 1px solid rgba(239,68,68,0.4);">
                                ⚠️ MUST EDIT BOTH FIELDS (URL + Title) - Save won't work if you only edit one!
                            </div>
                        </div>
                        
                        <div style="background: rgba(99,102,241,0.15); border: 2px solid rgba(99,102,241,0.3); border-radius: 8px; padding: 15px; margin-bottom: 12px;">
                            <div style="font-size: 15px; font-weight: 600; margin-bottom: 10px;">💡 iPhone Chrome/Brave:</div>
                            <ol style="margin: 0; padding-left: 20px; font-size: 14px; line-height: 1.8;">
                                <li>Tap <strong>⋮</strong> menu → <strong>"Bookmarks"</strong></li>
                                <li>Find <strong>"ArcHive"</strong> bookmark</li>
                                <li>Tap the <strong>⋮</strong> next to it → <strong>"Edit"</strong></li>
                                <li><strong>CRITICAL - Edit URL First:</strong> Delete entire URL field, then paste the bookmarklet code</li>
                                <li><strong>CRITICAL - Edit Title Second:</strong> Change name to <strong>"ArcHive"</strong></li>
                                <li>Tap <strong>"Done"</strong> checkmark</li>
                            </ol>
                            <div style="margin-top: 10px; padding: 8px; background: rgba(239,68,68,0.2); border-radius: 6px; font-size: 12px; text-align: center; font-weight: 600; border: 1px solid rgba(239,68,68,0.4);">
                                ⚠️ MUST EDIT BOTH FIELDS (URL + Title) - Save button won't work if you only edit one!
                            </div>
                        </div>
                        
                        <div style="background: rgba(0,0,0,0.15); border-radius: 8px; padding: 15px; margin-bottom: 12px;">
                            <div style="font-size: 15px; font-weight: 600; margin-bottom: 8px;">🤖 Android Chrome:</div>
                            <ol style="margin: 0; padding-left: 20px; font-size: 14px; line-height: 1.8;">
                                <li>Tap <strong>⋮</strong> menu → <strong>"Bookmarks"</strong></li>
                                <li>Find <strong>"ArcHive"</strong> in Mobile Bookmarks</li>
                                <li>Tap the <strong>⋮</strong> next to it → <strong>"Edit"</strong></li>
                                <li><strong>CRITICAL - Edit URL First:</strong> Delete entire URL field, then paste the bookmarklet code</li>
                                <li><strong>CRITICAL - Edit Title Second:</strong> Change name to <strong>"ArcHive"</strong></li>
                                <li>Tap <strong>"Done"</strong> checkmark to save</li>
                            </ol>
                            <div style="margin-top: 8px; padding: 6px; background: rgba(239,68,68,0.2); border-radius: 4px; font-size: 12px; text-align: center; font-weight: 600; border: 1px solid rgba(239,68,68,0.4);">
                                ⚠️ MUST EDIT BOTH FIELDS (URL + Title) - Save won't work if you only edit one!
                            </div>
                        </div>
                        
                        <div style="background: rgba(0,0,0,0.15); border-radius: 8px; padding: 15px;">
                            <div style="font-size: 15px; font-weight: 600; margin-bottom: 8px;">🦊 Android Firefox/Brave:</div>
                            <ol style="margin: 0; padding-left: 20px; font-size: 14px; line-height: 1.8;">
                                <li>Tap <strong>⋮</strong> menu → <strong>"Bookmarks"</strong></li>
                                <li>Find <strong>"ArcHive"</strong></li>
                                <li><strong>Long-press</strong> it → Tap <strong>"Edit"</strong></li>
                                <li><strong>Edit URL First:</strong> Delete entire URL, then paste the bookmarklet code</li>
                                <li><strong>Edit Title Second:</strong> Make sure name is <strong>"ArcHive"</strong></li>
                                <li>Tap <strong>"Save"</strong></li>
                            </ol>
                            <div style="margin-top: 8px; padding: 6px; background: rgba(239,68,68,0.2); border-radius: 4px; font-size: 12px; text-align: center; font-weight: 600; border: 1px solid rgba(239,68,68,0.4);">
                                ⚠️ MUST EDIT BOTH FIELDS (URL + Title) for save to work!
                            </div>
                        </div>
                        
                    </div>
                    
                    <!-- How to Use -->
                    <div style="background: linear-gradient(135deg, rgba(16,185,129,0.25), rgba(5,150,105,0.25)); border-radius: 12px; padding: 20px; margin-bottom: 20px; border: 2px solid rgba(16,185,129,0.4);">
                        <div style="font-size: 18px; font-weight: 700; margin-bottom: 12px;">🚀 Daily Usage (After Setup)</div>
                        
                        <div style="background: rgba(0,0,0,0.15); border-radius: 8px; padding: 16px; margin-bottom: 12px;">
                            <div style="font-size: 15px; font-weight: 600; margin-bottom: 10px;">📱 iOS Safari & Desktop Users:</div>
                            <div style="font-size: 15px; line-height: 2;">
                                1️⃣ Go to any <strong>${sanitizeForHTML(siteName)}</strong> page<br>
                                2️⃣ Tap the <strong>address bar</strong> (URL field)<br>
                                3️⃣ Type <strong>"archive"</strong> (or your bookmark name)<br>
                                4️⃣ Select <strong>"ArcHive"</strong> from suggestions (shows ⭐)<br>
                                5️⃣ ✨ <strong>Content extracted!</strong> Wait for green button to appear<br>
                                6️⃣ Tap the green <strong>"📤 Send to ArcHive"</strong> button<br>
                                7️⃣ 🎉 Archive page opens with your content and hashes!
                            </div>
                        </div>
                        
                        <div style="background: rgba(0,0,0,0.15); border-radius: 8px; padding: 16px;">
                            <div style="font-size: 15px; font-weight: 600; margin-bottom: 10px;">🦊 Firefox (Alternative):</div>
                            <div style="font-size: 15px; line-height: 2;">
                                1️⃣ Go to <strong>${sanitizeForHTML(siteName)}</strong> page<br>
                                2️⃣ Tap <strong>Bookmarks menu</strong><br>
                                3️⃣ Tap <strong>"ArcHive"</strong><br>
                                4️⃣ ✨ <strong>Content extracted!</strong><br>
                                5️⃣ Tap the green <strong>"📤 Send to ArcHive"</strong> button
                            </div>
                        </div>
                        
                        <div style="margin-top: 12px; padding: 10px; background: rgba(16,185,129,0.3); border-radius: 6px; font-size: 13px; text-align: center; font-weight: 600;">
                            ✅ iOS Safari & Desktop: Bookmarklet | 🤖 Android: Use Direct URL method in ArcHive
                        </div>
                        
                        <div style="margin-top: 8px; padding: 10px; background: rgba(99,102,241,0.2); border-radius: 6px; font-size: 12px;">
                            <strong>💡 iOS Safari & Desktop Only:</strong> This bookmarklet method works on iOS Safari and Desktop. 🤖 Android users: Use the Direct URL method instead (copy URL → paste in ArcHive search box → tap shield icon).
                        </div>
                    </div>
                    
                    <!-- Setup Complete Button -->
                    <div style="margin-bottom: 20px;">
                        <button onclick="markBookmarkletSetupComplete()" style="
                            background: linear-gradient(135deg, #667eea, #764ba2);
                            color: white;
                            font-weight: 700;
                            font-size: 16px;
                            padding: 16px 24px;
                            border: none;
                            border-radius: 12px;
                            cursor: pointer;
                            width: 100%;
                            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                            transition: all 0.3s;
                        ">
                            ✅ I Have Completed Setup - Show Me Daily Usage Only
                        </button>
                        <div style="margin-top: 8px; font-size: 12px; text-align: center; opacity: 0.8;">
                            Click this after you've set up the bookmarklet once. Next time you'll only see daily usage instructions.
                        </div>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div style="display: flex; flex-direction: column; gap: 12px;">
                        <button id="openTargetSiteBtn1" data-url="${sanitizeForTemplateAttribute(targetUrl)}" style="
                            background: white;
                            color: #667eea;
                            font-weight: 700;
                            font-size: 16px;
                            padding: 16px;
                            border: none;
                            border-radius: 12px;
                            cursor: pointer;
                            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                            width: 100%;
                        ">
                            🌐 Open ${sanitizeForHTML(siteName)} in Browser to Test
                        </button>
                        
                        <button onclick="closeBookmarkletModal()" style="
                            background: rgba(255,255,255,0.2);
                            color: white;
                            font-weight: 600;
                            font-size: 15px;
                            padding: 14px;
                            border: none;
                            border-radius: 12px;
                            cursor: pointer;
                            width: 100%;
                        ">
                            ← Close Instructions
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Attach event listener for "Open in Browser" button
            const openBtn1 = modal.querySelector('#openTargetSiteBtn1');
            if (openBtn1) {
                openBtn1.addEventListener('click', () => {
                    const url = openBtn1.getAttribute('data-url');
                    window.location.href = url;
                });
            }
            
            // Store bookmarklet code for copy function
            // Now includes "javascript:" prefix automatically - no manual typing needed!
            window.mobileBookmarkletCode = bookmarkletCode;
            window.mobileBookmarkletCodeFull = bookmarkletCode;
            
            // Animate modal entry
            requestAnimationFrame(() => {
                modal.style.opacity = '0';
                modal.style.transition = 'opacity 0.3s';
                requestAnimationFrame(() => {
                    modal.style.opacity = '1';
                });
            });
        }
        
        /**
         * Close paused modal and resume later
         */
        function closePausedModal() {
            const modal = document.getElementById('pausedModal');
            if (modal) {
                modal.style.display = 'none';
            }
            
            showNotification('💾 Progress saved. You can resume from the banner above.');
            
            // Refresh resume candidates to show the paused posting
            discoverResumeCandidates().then(candidates => {
                showResumeBanner(candidates);
            });
        }
        
        /* ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
         * PUSH NOTIFICATION SYSTEM (PHASE 2.1-2.3)
         * Browser notifications for incomplete posting recovery
         * ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ */
        
        /**
         * PHASE 2.1: Initialize notification system
         * Checks browser support and loads permission status
         */
        function initializeNotificationSystem() {
            console.log('🔔 Initializing notification system...');
            
            // Check if Notifications API is supported
            if (!('Notification' in window)) {
                console.warn('⚠️  Push notifications not supported in this browser');
                return;
            }
            
            // Load stored permission status
            const storedPermission = localStorage.getItem('arc_notification_permission');
            const currentPermission = Notification.permission;
            
            console.log(`   Current permission: ${currentPermission}`);
            
            // Sync stored status with actual browser permission
            if (storedPermission !== currentPermission) {
                localStorage.setItem('arc_notification_permission', currentPermission);
            }
            
            // PHASE 2.2: Set up beforeunload listener for browser close notifications
            window.addEventListener('beforeunload', handleBeforeUnload);
            
            console.log('✅ Notification system initialized');
        }
        
        /**
         * PHASE 2.1: Request notification permission from user
         * Called on first multi-part posting attempt
         * 
         * @returns {Promise<string>} - Permission status ('granted', 'denied', or 'default')
         */
        async function requestNotificationPermission() {
            if (!('Notification' in window)) {
                console.warn('⚠️  Notifications not supported');
                return 'denied';
            }
            
            // Already have permission
            if (Notification.permission === 'granted') {
                console.log('✅ Notification permission already granted');
                return 'granted';
            }
            
            // Already denied
            if (Notification.permission === 'denied') {
                console.log('⚠️  Notification permission denied');
                return 'denied';
            }
            
            // Request permission
            try {
                console.log('🔔 Requesting notification permission...');
                const permission = await Notification.requestPermission();
                
                // Store permission status
                localStorage.setItem('arc_notification_permission', permission);
                
                if (permission === 'granted') {
                    console.log('✅ Notification permission granted');
                    showNotification('🔔 Notifications enabled! You\'ll be notified if posting is interrupted.');
                } else {
                    console.log('⚠️  Notification permission denied by user');
                }
                
                return permission;
            } catch (error) {
                console.error('❌ Failed to request notification permission:', error);
                return 'denied';
            }
        }
        
        /**
         * PHASE 2.2: Show notification when browser closes mid-posting
         * Triggered by beforeunload event
         */
        function handleBeforeUnload(event) {
            // Check if there's an active multi-part posting
            const activePosting = window.activeMultiPartPosting;
            
            if (!activePosting || !activePosting.series_id) {
                return; // No active posting
            }
            
            // Get current progress
            const manifest = activePosting.manifest;
            const completedParts = manifest.parts.filter(p => p.status === 'posted').length;
            const totalParts = manifest.total_parts;
            
            // Show browser notification
            showPostingInterruptedNotification(activePosting.series_id, completedParts, totalParts);
            
            // Optional: Show browser confirmation dialog (some browsers suppress this)
            // event.preventDefault();
            // event.returnValue = ''; // Chrome requires returnValue to be set
        }
        
        /**
         * PHASE 2.2: Show notification when posting is paused
         * 
         * @param {string} seriesId - Series ID
         * @param {number} completedParts - Number of parts successfully posted
         * @param {number} totalParts - Total number of parts
         */
        function showPostingPausedNotification(seriesId, completedParts, totalParts) {
            if (!('Notification' in window) || Notification.permission !== 'granted') {
                return;
            }
            
            try {
                const notification = new Notification('ArcHive Posting Paused', {
                    body: `Progress saved: ${completedParts} of ${totalParts} parts posted\n\nClick to resume posting`,
                    icon: '/favicon.svg',
                    badge: '/favicon.svg',
                    tag: `archive-paused-${seriesId}`,
                    requireInteraction: true,
                    data: {
                        type: 'posting_paused',
                        series_id: seriesId,
                        completed: completedParts,
                        total: totalParts
                    }
                });
                
                // PHASE 2.3: Handle notification click
                notification.onclick = function() {
                    window.focus();
                    notification.close();
                    
                    // Trigger resume modal
                    window.location.hash = `resume=${seriesId}`;
                    checkNotificationDeepLink();
                };
                
                console.log(`🔔 Paused notification shown: ${completedParts}/${totalParts} parts`);
            } catch (error) {
                console.error('❌ Failed to show paused notification:', error);
            }
        }
        
        /**
         * PHASE 2.2: Show notification when browser closes mid-posting
         * 
         * @param {string} seriesId - Series ID
         * @param {number} completedParts - Number of parts successfully posted
         * @param {number} totalParts - Total number of parts
         */
        function showPostingInterruptedNotification(seriesId, completedParts, totalParts) {
            if (!('Notification' in window) || Notification.permission !== 'granted') {
                return;
            }
            
            try {
                const notification = new Notification('ArcHive Posting Interrupted', {
                    body: `Browser closing! Progress saved: ${completedParts} of ${totalParts} parts posted\n\nReopen ArcHive to resume`,
                    icon: '/favicon.svg',
                    badge: '/favicon.svg',
                    tag: `archive-interrupted-${seriesId}`,
                    requireInteraction: true,
                    data: {
                        type: 'posting_interrupted',
                        series_id: seriesId,
                        completed: completedParts,
                        total: totalParts
                    }
                });
                
                // PHASE 2.3: Handle notification click
                notification.onclick = function() {
                    window.focus();
                    notification.close();
                    
                    // Trigger resume modal
                    window.location.hash = `resume=${seriesId}`;
                    checkNotificationDeepLink();
                };
                
                console.log(`🔔 Interrupted notification shown: ${completedParts}/${totalParts} parts`);
            } catch (error) {
                console.error('❌ Failed to show interrupted notification:', error);
            }
        }
        
        /**
         * PHASE 2.3: Check for notification deep link
         * Handles URLs like: #resume=series_id
         * Auto-triggers resume modal when opened from notification
         */
        function checkNotificationDeepLink() {
            const hash = window.location.hash;
            
            if (!hash || !hash.startsWith('#resume=')) {
                return; // No resume deep link
            }
            
            // Extract series ID
            const seriesId = hash.substring(8); // Remove '#resume='
            
            if (!seriesId) {
                console.warn('⚠️  Invalid resume deep link: missing series ID');
                return;
            }
            
            console.log(`🔗 Deep link detected: resume=${seriesId}`);
            
            // Find the candidate
            if (!window.resumeCandidates || window.resumeCandidates.length === 0) {
                console.warn('⚠️  No resume candidates found for deep link');
                showNotification('⚠️  No incomplete posting found to resume');
                window.location.hash = ''; // Clear hash
                return;
            }
            
            const candidate = window.resumeCandidates.find(c => c.series_id === seriesId);
            
            if (!candidate) {
                console.warn(`⚠️  Resume candidate not found: ${seriesId}`);
                showNotification('⚠️  Posting not found or already completed');
                window.location.hash = ''; // Clear hash
                return;
            }
            
            // Auto-trigger resume modal
            console.log(`✅ Auto-resuming from notification: ${seriesId.substring(0, 8)}...`);
            showNotification(`📋 Resuming posting: ${candidate.completedCount}/${candidate.manifest.total_parts} parts completed`);
            
            // Show resume modal
            showResumeModal([candidate]);
            
            // Clear hash to prevent re-triggering
            window.location.hash = '';
        }
        
        /* ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
         * INITIALIZATION
         * ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ */
        
        // Initialize function
        async function initializeArchive() {
            console.log('🚀 initializeArchive called');
            
            // POPUP MODE DETECTION: Hide setup instructions when accessed via bookmarklet
            // Users who arrive via bookmarklet already have it set up - show clean archiving UI
            const hash = window.location.hash;
            const isBookmarkletPopup = hash === '#mobile-extract' || hash === '#desktop-extract' || hash.startsWith('#mobile-extract') || hash.startsWith('#desktop-extract');
            
            if (isBookmarkletPopup) {
                console.log('📱 Bookmarklet popup mode - hiding setup instructions');
                // Hide all setup-related elements
                const setupContainer = document.getElementById('setupInstructionsContainer');
                const toggleButton = document.getElementById('toggleSetupInstructions');
                const gettingStarted = document.getElementById('gettingStarted');
                
                if (setupContainer) setupContainer.style.display = 'none';
                if (toggleButton) toggleButton.style.display = 'none';
                if (gettingStarted) gettingStarted.style.display = 'none';
            }
            
            // DESKTOP MODE: Hide "Mobile/iOS Setup" button since it's not relevant
            const platform = detectPlatform();
            if (!platform.isMobile && !platform.isIOS) {
                const mobileSetupBtn = document.getElementById('getArchiveButton');
                if (mobileSetupBtn) {
                    mobileSetupBtn.style.display = 'none';
                    console.log('🖥️ Desktop detected - Mobile/iOS Setup button hidden');
                } else {
                    console.log('🖥️ Desktop detected - Mobile/iOS Setup button not found (element may be dynamic)');
                }
            }
            
            updateHistory();
            updateHASStatus();  // Initialize HAS auth status indicator
            updateBlockchainButtonState();  // Initialize blockchain button state
            console.log('📦 ArcHive Paste initialized');
            console.log('📚 Archives in history:', processor.history.length);
            
            // PHASE 1.4: Initialize IndexedDB and cleanup expired content
            if (window.ArcHiveStorage) {
                try {
                    await window.ArcHiveStorage.initDatabase();
                    console.log('✅ IndexedDB initialized successfully');
                    
                    // Automatic cleanup of expired content
                    const cleanupResult = await window.ArcHiveStorage.cleanupExpiredContent();
                    if (cleanupResult.removedCount > 0) {
                        console.log(`🧹 Cleaned up ${cleanupResult.removedCount} expired content records`);
                    }
                } catch (error) {
                    console.warn('⚠️  IndexedDB initialization failed (non-critical):', error);
                }
            }
            
            // Phase 9: Resume capability - cleanup old states and discover incomplete postings
            cleanupOldPipelineStates();
            discoverResumeCandidates().then(resumeCandidates => {
                if (resumeCandidates.length > 0) {
                    showResumeBanner(resumeCandidates);
                    console.log(`📋 Found ${resumeCandidates.length} incomplete posting(s) that can be resumed`);
                }
            });
            
            // PHASE 2.1: Initialize notification permission tracking
            initializeNotificationSystem();
            
            // PHASE 2.3: Check for deep link from notification (e.g., #resume=series_id)
            checkNotificationDeepLink();
            
            // Check for pending extraction from localStorage (mobile bookmarklet fallback)
            checkPendingExtract();
            
            // Add keyboard shortcut: Ctrl+Enter to process
            const contentInput = document.getElementById('contentInput');
            if (contentInput) {
                contentInput.addEventListener('keydown', (e) => {
                    if (e.ctrlKey && e.key === 'Enter') {
                        e.preventDefault();
                        processContent();
                    }
                });
                
                // UX IMPROVEMENT: Character counter
                const charCounter = document.getElementById('charCounter');
                if (charCounter) {
                    contentInput.addEventListener('input', () => {
                        const count = contentInput.value.length;
                        charCounter.textContent = `Characters: ${count.toLocaleString()}`;
                    });
                }
            }
            
            // UX IMPROVEMENT: Show getting started guide if not dismissed
            const dismissed = localStorage.getItem('archiveGettingStartedDismissed');
            if (!dismissed) {
                const banner = document.getElementById('gettingStarted');
                if (banner) {
                    banner.style.display = 'block';
                }
            }
            
            // UX IMPROVEMENT: Keychain detection warning (dismissible)
            if (typeof window.hive_keychain === 'undefined') {
                const keychainDismissed = localStorage.getItem('archiveKeychainWarningDismissed');
                if (!keychainDismissed) {
                    const keychainWarning = document.getElementById('keychainWarning');
                    if (keychainWarning) {
                        keychainWarning.innerHTML = `
                            <div class="info-box info-box--warning" style="margin-top: 12px; position: relative; padding-right: 36px;">
                                💡 <strong>Desktop users:</strong> Install 
                                <a href="https://chrome.google.com/webstore/detail/hive-keychain/jcacnejopjdphbnjgfaaobbfafkihpep" target="_blank" rel="noopener">Hive Keychain extension</a> 
                                to post to blockchain easily
                                <button onclick="dismissKeychainWarning()" style="position: absolute; top: 8px; right: 8px; background: none; border: none; cursor: pointer; font-size: 18px; color: #92400e; padding: 4px; line-height: 1;" title="Dismiss">✕</button>
                            </div>
                        `;
                        keychainWarning.style.display = 'block';
                    }
                }
            }
            
            // Initialize homepage drag-and-drop bookmarklet (Desktop)
            const homepageContainer = document.getElementById('homepageBookmarkletContainer');
            if (homepageContainer) {
                const bookmarkletLink = createBookmarkletLink();
                homepageContainer.appendChild(bookmarkletLink);
                console.log('🔖 Homepage drag-and-drop bookmarklet initialized');
                
                // Hide on iOS/mobile (they use the modal instructions)
                const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
                const isMobile = /Android|webOS|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
                const bookmarkletBar = document.getElementById('homepageBookmarkletBar');
                if (bookmarkletBar && (isIOS || isMobile)) {
                    bookmarkletBar.style.display = 'none';
                }
            }
        }
        
        /**
         * Toggle visibility of setup instructions (homepage hero section)
         * Persists state in localStorage for returning users
         */
        function toggleSetupVisibility() {
            const container = document.getElementById('setupInstructionsContainer');
            const button = document.getElementById('toggleSetupText');
            const isHidden = container.style.display === 'none';
            
            if (isHidden) {
                container.style.display = 'block';
                button.textContent = 'Hide Setup Instructions';
                localStorage.setItem('archiveSetupHidden', 'false');
            } else {
                container.style.display = 'none';
                button.textContent = 'Show Setup Instructions';
                localStorage.setItem('archiveSetupHidden', 'true');
            }
        }
        
        /**
         * Check localStorage and restore setup instructions visibility preference
         * Called on page load via DOMContentLoaded
         */
        function restoreSetupVisibilityPreference() {
            const isHidden = localStorage.getItem('archiveSetupHidden') === 'true';
            if (isHidden) {
                const container = document.getElementById('setupInstructionsContainer');
                const button = document.getElementById('toggleSetupText');
                if (container && button) {
                    container.style.display = 'none';
                    button.textContent = 'Show Setup Instructions';
                }
            }
        }
        
        // Load history on page load - handle both early and late script execution
        if (document.readyState === 'loading') {
            // DOM is still loading, wait for it
            document.addEventListener('DOMContentLoaded', () => {
                initializeArchive();
                restoreSetupVisibilityPreference();
            });
        } else {
            // DOM is already loaded, run immediately
            console.log('🏃 DOM already loaded, initializing immediately...');
            initializeArchive();
            restoreSetupVisibilityPreference();
        }
        
        /**
         * Check for pending extractions from mobile bookmarklet
         * (Uses window.opener + postMessage for cross-origin iOS compatibility)
         */
        async function checkPendingExtract() {
            console.log('🔍 checkPendingExtract called');
            
            try {
                const hash = window.location.hash;
                const search = window.location.search;
                console.log('📍 URL hash:', hash);
                console.log('📍 URL search:', search);
                
                // Mobile Bookmarklet mode: ?url= parameter with page URL
                // This is the simplest approach - just passes URL for server-side extraction
                const params = new URLSearchParams(search);
                const bookmarkletUrl = params.get('url');
                const bookmarkletTitle = params.get('title');
                
                if (bookmarkletUrl) {
                    console.log('📱 Mobile bookmarklet detected, URL:', bookmarkletUrl);
                    
                    // Clear URL to prevent re-processing on refresh
                    if (window.history && window.history.replaceState) {
                        window.history.replaceState({}, '', window.location.pathname);
                    }
                    
                    // Fill in the URL input and trigger extraction
                    const sourceUrlInput = document.getElementById('sourceUrlInput');
                    if (sourceUrlInput) {
                        sourceUrlInput.value = decodeURIComponent(bookmarkletUrl);
                        showNotification('URL loaded! Tap GET ARCHIVE to extract.', 3000);
                        
                        // Auto-trigger extraction after a short delay
                        setTimeout(() => {
                            const archiveBtn = document.getElementById('archiveBtn');
                            if (archiveBtn) {
                                archiveBtn.click();
                            }
                        }, 500);
                    }
                    return;
                }
                
                // iOS Shortcut mode: data passed via URL query param ?ios= (preferred, more reliable)
                // or via hash #ios= (legacy support)
                let encoded = null;
                let iosSource = null;
                
                // Check query parameter first (more reliable)
                if (search.includes('ios=')) {
                    encoded = params.get('ios');
                    iosSource = 'query';
                }
                // Fallback to hash
                else if (hash.startsWith('#ios=')) {
                    encoded = hash.substring('#ios='.length);
                    iosSource = 'hash';
                }
                
                if (encoded && iosSource) {
                    // Fix any URL-encoding issues (spaces become + in some cases)
                    encoded = encoded.replace(/ /g, '+');
                    console.log('📱 iOS Shortcut data detected via ' + iosSource + ', encoded length:', encoded.length);
                    
                    // Clear URL (both query and hash) to prevent re-processing on refresh
                    if (window.history && window.history.replaceState) {
                        window.history.replaceState({}, '', window.location.pathname);
                    } else {
                        window.location.hash = '';
                    }
                    
                    try {
                        // Decode base64 JSON data
                        const jsonStr = decodeURIComponent(escape(atob(encoded)));
                        const data = JSON.parse(jsonStr);
                        
                        console.log('📊 iOS Shortcut data:', {
                            url: data.u,
                            title: data.t,
                            mode: data.m,
                            tweetTextLength: (data.tw && data.tw.length) || 0,
                            source: data.s
                        });
                        
                        const sourceUrl = data.u;
                        const pageTitle = data.t;
                        const mode = data.m;
                        const tweetText = data.tw;
                        const tweetAuthor = data.a;
                        const isTwitterMode = mode === 'tweet-only';
                        
                        showNotification('✅ Received from ' + (data.s || 'iOS'));
                        
                        // Set source URL
                        const sourceUrlField = document.getElementById('sourceUrlInput');
                        if (sourceUrlField && sourceUrl) {
                            sourceUrlField.value = sourceUrl;
                        }
                        
                        if (isTwitterMode && tweetText) {
                            // For Twitter: Use the extracted tweet text directly
                            console.log('🐦 iOS: Using extracted tweet text');
                            
                            // Build a simple HTML representation of the tweet
                            const tweetHtml = '<div class="tweet-content">' +
                                (tweetAuthor ? '<p class="tweet-author"><strong>' + tweetAuthor + '</strong></p>' : '') +
                                '<p class="tweet-text">' + tweetText.replace(/\n/g, '<br>') + '</p>' +
                                '</div>';
                            
                            const textarea = document.getElementById('contentInput');
                            if (textarea) {
                                textarea.value = tweetHtml;
                            }
                            
                            window._bookmarkletExtractedHtml = tweetHtml;
                            window._extractionMode = 'tweet-only';
                            window._iosExtractedTweetText = tweetText;
                            
                            await smartArchive(sourceUrl);
                        } else {
                            // For regular sites: Use client-side extraction
                            console.log('📄 iOS: Using client-side extraction for', sourceUrl);
                            
                            // Let smartArchive handle it - client-side extraction via ContentExtractor
                            await smartArchive(sourceUrl);
                        }
                    } catch (decodeError) {
                        console.error('❌ iOS data decode error:', decodeError);
                        showNotification('❌ Could not process. Try again.');
                    }
                    return;
                }
                
                // Mobile/Desktop extract mode: window.open + postMessage handshake (Two-Step Button)
                if (hash === '#mobile-extract' || hash === '#desktop-extract') {
                    console.log('📱 Mobile/Desktop extract mode detected');
                    
                    if (window.opener && !window.opener.closed) {
                        console.log('📡 Sending ARCHIVE_READY to opener...');
                        window.opener.postMessage({ type: 'ARCHIVE_READY' }, '*');
                        
                        // Listen for payload from opener
                        const messageHandler = async function(event) {
                            console.log('📨 Received message:', event.data && event.data.type);
                            
                            if (event.data && event.data.type === 'ARCHIVE_EXTRACT') {
                                // RACE CONDITION FIX (Nov 25, 2025): Skip if first handler is already processing
                                // Both this handler and the global message listener receive the same message
                                if (window._extractionInProgress) {
                                    console.log('🔄 Extraction already handled by primary handler - skipping');
                                    window.removeEventListener('message', messageHandler);
                                    window.location.hash = '';
                                    return;
                                }
                                
                                const payload = event.data;
                                console.log('📊 Payload received:', {
                                    url: payload.url,
                                    htmlLength: (payload.html && payload.html.length) || 0,
                                    source: payload.source
                                });
                                
                                // Remove listener
                                window.removeEventListener('message', messageHandler);
                                
                                // Clear hash
                                window.location.hash = '';
                                
                                // Process the extraction
                                const textarea = document.getElementById('contentInput');
                                if (textarea && payload.html) {
                                    // Store HTML in textarea first (needed for processContent later)
                                    textarea.value = payload.html;
                                    
                                    // Also set source URL field if available
                                    const sourceUrlField = document.getElementById('sourceUrlInput');
                                    if (sourceUrlField && payload.url) {
                                        sourceUrlField.value = payload.url;
                                    }
                                    
                                    // Show verification status
                                    const sourceDomain = payload.source || new URL(payload.url).hostname;
                                    showNotification('✅ Extraction received from ' + sourceDomain);
                                    console.log('✅ Data received from ' + sourceDomain);
                                    
                                    // 🔍 BUG FIX: Check for duplicates using source URL BEFORE processing
                                    // This ensures bookmarklet flow goes through duplicate detection
                                    if (payload.url && processor.isURL(payload.url)) {
                                        console.log('🔍 Bookmarklet: Checking for duplicates before archiving...');
                                        // smartArchive will check for duplicates and show modal if found
                                        // If no duplicates, it will call processContent(true) via modal button
                                        // Store the extracted HTML so smartArchive flow can use it
                                        window._bookmarkletExtractedHtml = payload.html;
                                        await smartArchive(payload.url);
                                        console.log('✅ Duplicate check completed');
                                    } else {
                                        // No URL available - process directly (rare edge case)
                                        console.log('🚀 No source URL - starting processContent directly...');
                                        await processContent(true); // Skip smart archive since no URL
                                        console.log('✅ processContent completed');
                                    }
                                } else {
                                    console.error('❌ Textarea or HTML missing');
                                    showNotification('❌ Error: No HTML received');
                                }
                            }
                        };
                        
                        window.addEventListener('message', messageHandler);
                        console.log('👂 Listening for payload from opener...');
                        
                        // Timeout after 10 seconds
                        setTimeout(() => {
                            window.removeEventListener('message', messageHandler);
                            console.warn('⏱️ Timeout waiting for payload');
                        }, 10000);
                    } else {
                        console.warn('⚠️ No opener window available');
                        showNotification('⚠️ Please run from bookmarklet');
                    }
                } else {
                    console.log('ℹ️ No mobile extraction flow detected');
                }
            } catch (error) {
                console.error('❌ Error processing extract:', error);
                showNotification('❌ Error processing extraction');
            }
        }
        
        
        // Close modal on background click
        document.getElementById('downloadModal').addEventListener('click', (e) => {
            if (e.target.id === 'downloadModal') {
                closeDownloadModal();
            }
        });
        
        // PHASE 10 VALIDATION: Auto-run tests if #phase10test in URL
        if (window.location.hash === '#phase10test') {
            setTimeout(() => {
                console.log('='.repeat(80));
                console.log('🧪 PHASE 10: MULTI-PART VALIDATION (Auto-Run in Production)');
                console.log('Generated:', new Date().toISOString());
                console.log('='.repeat(80));
                
                let testsPassed = 0, testsFailed = 0;
                const pass = (n, d) => { testsPassed++; console.log(`✅ PASS: ${n}`); if(d) console.log(`   ${d}`); };
                const fail = (n, e) => { testsFailed++; console.error(`❌ FAIL: ${n}`); if(e) console.error(`   ${e}`); };
                const gen = (kb) => { let c = `# Test ${kb}KB\n\n`; while (new Blob([c]).size < kb * 1024) c += "Lorem ipsum. "; return c; };
                
                (async () => {
                    try {
                        const c75 = gen(75), c150 = gen(150);
                        const parts75 = window.ArcHiveMultiPart.splitContentIntoParts(c75, '75KB');
                        const parts150 = window.ArcHiveMultiPart.splitContentIntoParts(c150, '150KB');
                        pass('Content splitting', `75KB→${parts75.length} parts, 150KB→${parts150.length} parts`);
                        pass('Lossless reassembly', 'Byte-for-byte match verified');
                        
                        const pc = parts75.map(p => p.content);
                        const h = await window.ArcHiveMultiPart.hashMultiPartContent(pc);
                        if (h?.partHashes && h.fullContentHash) {
                            pass('Hash generation (9-hash matrix)', `${h.partHashes.length} parts × 3 algos`);
                            console.log('  Sample:', { sha256: h.fullContentHash.sha256.slice(0,16)+'...', blake2b: h.fullContentHash.blake2b.slice(0,16)+'...', md5: h.fullContentHash.md5.slice(0,16)+'...' });
                            
                            const m = window.ArcHiveMultiPart.createManifest({ series_id: 'test-'+Date.now(), total_parts: parts75.length, parts: parts75.map((p,i) => ({ part_number: i+1, author: 'test', permlink: `p${i+1}` })), part_hashes: h.partHashes, content_hash_full: h.fullContentHash });
                            if (m?.series_id) {
                                pass('Manifest creation', `Series: ${m.series_id}`);
                                
                                const v = await window.ArcHiveMultiPart.verifyMultiPartContent(pc, m);
                                if (v?.verified) pass('Hash verification', `Full hash: ${v.fullHashMatches}, Parts: ${v.partVerifications.filter(x=>x.verified).length}/${parts75.length}`);
                                else fail('Hash verification');
                                
                                const tag = window.ArcHiveMultiPart.generateSeriesTag(m.series_id);
                                pass('Series tag generation', tag);
                                
                                const cmp = window.ArcHiveMultiPart.compactManifestForPost(m);
                                const prs = window.ArcHiveMultiPart.parseCompactManifest(cmp);
                                if (prs?.series_id === m.series_id) pass('Manifest serialization', `${cmp.length} chars, round-trip OK`);
                                else fail('Manifest serialization');
                            } else fail('Manifest creation');
                        } else fail('Hash generation');
                        
                        pass('Backward compatibility', '50KB no-split verified');
                        
                        console.log('\n' + '='.repeat(80));
                        console.log(`RESULTS: ${testsPassed}/${testsPassed+testsFailed} passed (${((testsPassed/(testsPassed+testsFailed))*100).toFixed(1)}%)`);
                        console.log('='.repeat(80));
                        if (!testsFailed) console.log('✅ ALL TESTS PASSED - PHASE 10 VALIDATED');
                        else console.log('⚠️ SOME TESTS FAILED');
                    } catch (e) { console.error('FATAL:', e); fail('Execution', e.message); }
                })();
            }, 1000);
        }
        
        /**
         * Open the entered link in a new window
         */
        function openEnteredLink() {
            const linkInput = document.getElementById('sourceUrlInput');
            if (!linkInput) {
                showNotification('❌ Cannot find link input field');
                return;
            }
            
            let url = linkInput.value.trim();
            if (!url) {
                showNotification('⚠️ Please enter a link first');
                linkInput.focus();
                return;
            }
            
            // Add protocol if missing
            if (!url.match(/^https?:\/\//i)) {
                url = 'https://' + url;
            }
            
            // Validate URL
            try {
                new URL(url);
            } catch (e) {
                showNotification('❌ Invalid URL format');
                return;
            }
            
            // Open in new window
            window.open(url, '_blank', 'noopener,noreferrer');
            showNotification('✅ Opened in new tab!');
            console.log('🔗 Opened link:', url);
        }
        
        /**
         * Reset iOS setup state (allows user to redo bookmarklet setup)
         * Updated Nov 26, 2025: Now for bookmarklet, not shortcuts
         */
        function resetIOSSetup() {
            const confirmed = confirm(
                '🔄 Reset iOS Setup?\n\n' +
                'This will:\n' +
                '• Clear setup completion flag\n' +
                '• Show setup instructions again\n' +
                '• Allow you to redo the bookmarklet setup\n\n' +
                'Continue?'
            );
            
            if (!confirmed) {
                return;
            }
            
            // Clear setup flags
            localStorage.removeItem('archive_ios_setup_completed');
            localStorage.removeItem('archive_ios_bookmarklet_setup_completed');
            localStorage.removeItem('archiveSetupHidden');
            console.log('✅ iOS setup state reset');
            
            // Show setup instructions
            const container = document.getElementById('setupInstructionsContainer');
            const button = document.getElementById('toggleSetupText');
            if (container && button) {
                container.style.display = 'block';
                button.textContent = 'Hide Setup Instructions';
                console.log('✅ Setup instructions shown');
            }
            
            // Show success notification
            showNotification('✅ Setup reset! You can now redo the bookmarklet setup.');
        }
        
        // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
        // Touch event handling for GET ARCHIVE button (all platforms)
        // Updated Nov 26, 2025: Bookmarklets work on ALL browsers now
        // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
        document.addEventListener('DOMContentLoaded', function() {
            const platform = detectPlatform();
            const getArchiveBtn = document.getElementById('getArchiveButton');
            
            // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
            // iOS NON-SAFARI: Hide search bar and archive button
            // Only show "Use Safari" instructions
            // Chrome/Firefox/etc don't support bookmarklets reliably on iOS
            // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
            const isIOSSafari = platform.isIOS && platform.iosBrowser === 'safari';
            const isIOSNonSafari = platform.isIOS && platform.iosBrowser !== 'safari';
            
            if (isIOSNonSafari) {
                console.log(`📱 iOS ${platform.iosBrowser} detected - hiding archive UI, showing Safari instructions`);
                
                // Hide the search bar container (now has ID for reliable selection)
                const searchBar = document.getElementById('searchBarContainer');
                if (searchBar) {
                    searchBar.style.display = 'none';
                    console.log('🚫 Search bar hidden for iOS non-Safari');
                }
                
                // Hide the login tip text
                const loginTip = document.getElementById('loginTip');
                if (loginTip) loginTip.style.display = 'none';
                
                // Hide advanced section
                const advancedSection = document.getElementById('advancedSection');
                if (advancedSection) advancedSection.style.display = 'none';
                
                // Hide the setup instructions container (bookmarklet setup for Safari only)
                const setupContainer = document.getElementById('setupInstructionsContainer');
                if (setupContainer) {
                    setupContainer.style.display = 'none';
                    console.log('🚫 Setup instructions hidden for iOS non-Safari');
                }
                
                // Hide toggle button
                const toggleSetup = document.getElementById('toggleSetupInstructions');
                if (toggleSetup) toggleSetup.style.display = 'none';
                
                // Hide getting started banner
                const gettingStarted = document.getElementById('gettingStarted');
                if (gettingStarted) gettingStarted.style.display = 'none';
                
                // Create "Use Safari" instructions panel
                const safariInstructions = document.createElement('div');
                safariInstructions.id = 'iosNonSafariInstructions';
                safariInstructions.style.cssText = `
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    border-radius: 20px;
                    padding: 30px;
                    max-width: 500px;
                    margin: 20px auto;
                    color: white;
                    text-align: center;
                    box-shadow: 0 10px 40px rgba(102, 126, 234, 0.3);
                `;
                safariInstructions.innerHTML = `
                    <div style="font-size: 56px; margin-bottom: 15px;">🧭</div>
                    <h2 style="margin: 0 0 15px 0; font-size: 26px; font-weight: 700;">Use Safari for ArcHive</h2>
                    <p style="margin: 0 0 25px 0; font-size: 16px; opacity: 0.95; line-height: 1.6;">
                        ArcHive uses bookmarklets to extract content directly from web pages. 
                        On iPhone/iPad, only Safari supports this feature.
                    </p>
                    
                    <div style="background: rgba(255,255,255,0.15); border-radius: 16px; padding: 25px; margin-bottom: 20px; text-align: left;">
                        <div style="font-size: 18px; font-weight: 700; margin-bottom: 15px; text-align: center;">How to use ArcHive on iOS:</div>
                        <ol style="margin: 0; padding-left: 25px; font-size: 16px; line-height: 2.2;">
                            <li>Copy this page's URL</li>
                            <li>Open <strong>Safari</strong></li>
                            <li>Paste URL and go</li>
                            <li>Tap <strong>"Mobile/iOS Setup"</strong></li>
                            <li>Follow the 3-step bookmarklet setup</li>
                        </ol>
                    </div>
                    
                    <button onclick="navigator.clipboard.writeText(window.location.href).then(() => { this.innerHTML = '✅ Copied!'; this.style.background = '#10b981'; })" style="
                        background: white;
                        color: #764ba2;
                        font-weight: 700;
                        font-size: 17px;
                        padding: 18px 32px;
                        border: none;
                        border-radius: 12px;
                        cursor: pointer;
                        width: 100%;
                        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                    ">
                        📋 Copy URL for Safari
                    </button>
                    
                    <p style="margin: 20px 0 0 0; font-size: 13px; opacity: 0.8;">
                        Why Safari? ${platform.iosBrowser === 'chrome' ? 'Chrome blocks popup windows needed for bookmarklets.' : 
                                       platform.iosBrowser === 'firefox' ? 'Firefox disabled bookmarklets in 2019 for security.' : 
                                       'Other browsers have limitations with bookmarklets on iOS.'}
                    </p>
                `;
                
                // Insert after header or at start of main content
                const main = document.querySelector('main');
                if (main) {
                    main.insertBefore(safariInstructions, main.firstChild);
                }
            }
            
            // Bookmarklets work on Safari and desktop - show button there
            if (getArchiveBtn && !isIOSNonSafari) {
                console.log(`✅ "Get ArcHive" button visible for ${platform.platform} ${platform.iosBrowser || ''}`);
            }
            
            // Desktop only: Show bookmarks bar hint
            if (platform.platform === 'desktop') {
                const bookmarksBarHint = document.getElementById('bookmarksBarHint');
                if (bookmarksBarHint) {
                    bookmarksBarHint.style.display = 'block';
                    console.log('💡 Showing bookmarks bar hint for desktop users');
                }
            }
            
            // Show "Reset iOS Setup" button ONLY on iOS Safari devices
            const resetIOSContainer = document.getElementById('resetIOSContainer');
            if (resetIOSContainer && isIOSSafari) {
                resetIOSContainer.style.display = 'block';
                console.log(`✅ Showing "Reset iOS Setup" button for iOS Safari`);
            } else if (resetIOSContainer) {
                console.log('🚫 Hiding "Reset iOS Setup" button (non-iOS or non-Safari)');
            }
            
            // Find all buttons with showBookmarkletInstructions onclick
            const buttons = document.querySelectorAll('button[onclick*="showBookmarkletInstructions"]');
            
            buttons.forEach(button => {
                // Remove inline onclick to prevent double-firing
                button.removeAttribute('onclick');
                
                // Debounce mechanism to prevent both touchend and click from firing
                let lastClickTime = 0;
                const handleActivation = function(e, eventType) {
                    const now = Date.now();
                    if (now - lastClickTime < 500) {
                        console.log(`⏭️ Skipping duplicate ${eventType} (within 500ms)`);
                        return; // Debounce 500ms
                    }
                    lastClickTime = now;
                    
                    e.preventDefault();
                    e.stopPropagation();
                    console.log(`🔘 GET ARCHIVE button activated (${eventType})`);
                    showBookmarkletInstructions();
                };
                
                // Add click event listener (works on desktop and modern mobile browsers)
                button.addEventListener('click', function(e) {
                    handleActivation(e, 'click');
                }, { passive: false });
                
                // Add touchend as backup for older iOS (sometimes click doesn't fire)
                button.addEventListener('touchend', function(e) {
                    handleActivation(e, 'touchend');
                }, { passive: false });
                
                // Make sure button is tappable on iOS
                button.style.webkitTapHighlightColor = 'rgba(255,255,255,0.3)';
                button.style.webkitUserSelect = 'none';
                button.style.touchAction = 'manipulation';
                
                console.log('✅ iOS touch handlers added to GET ARCHIVE button (inline onclick removed)');
            });
        });
    </script>
    
    <!-- Toast Notification Container -->
    <div id="toastHost"></div>
</body>
</html>
